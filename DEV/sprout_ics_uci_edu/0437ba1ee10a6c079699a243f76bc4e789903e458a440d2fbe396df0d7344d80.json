{"url": "http://sprout.ics.uci.edu/projects/uwsnwebpage/security_uwsn.html", "content": "<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Strict//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd\">\n<html xmlns=\"http://www.w3.org/1999/xhtml\" xml:lang=\"en\" lang=\"en\">\n<head>\n<script type=\"text/javascript\">\n//<![CDATA[\nvar version = {major: 2, minor: 1, revision: 3, date: new Date(\"Nov 3, 2006\"), extensions: {}};\n//]]>\n</script>\n<!--\nTiddlyWiki 2.1.3 by Jeremy Ruston, (jeremy [at] osmosoft [dot] com)\n\nCopyright (c) Osmosoft Limited 2004-2006\n\nRedistribution and use in source and binary forms, with or without modification,\nare permitted provided that the following conditions are met:\n\nRedistributions of source code must retain the above copyright notice, this\nlist of conditions and the following disclaimer.\n\nRedistributions in binary form must reproduce the above copyright notice, this\nlist of conditions and the following disclaimer in the documentation and/or other\nmaterials provided with the distribution.\n\nNeither the name of the Osmosoft Limited nor the names of its contributors may be\nused to endorse or promote products derived from this software without specific\nprior written permission.\n\nTHIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS \"AS IS\" AND ANY\nEXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES\nOF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT\nSHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,\nINCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED\nTO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR\nBUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN\nCONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN\nANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH\nDAMAGE.\n-->\n<meta http-equiv=\"Content-Type\" content=\"text/html;charset=utf-8\"/>\n<!--PRE-HEAD-START-->\n<!--{{{-->\n<link rel='alternate' type='application/rss+xml' title='RSS' href='index.xml'/>\n<!--}}}-->\n<!--PRE-HEAD-END-->\n<title> Security in Unattended Wireless Sensor Netoworks -  </title>\n<script type=\"text/javascript\">\n//<![CDATA[\n// ---------------------------------------------------------------------------------\n// Configuration repository\n// ---------------------------------------------------------------------------------\n\n// Miscellaneous options\nvar config = {\n\tnumRssItems: 20, // Number of items in the RSS feed\n\tanimFast: 0.12, // Speed for animations (lower == slower)\n\tanimSlow: 0.01, // Speed for EasterEgg animations\n\tcascadeFast: 20, // Speed for cascade animations (higher == slower)\n\tcascadeSlow: 60, // Speed for EasterEgg cascade animations\n\tcascadeDepth: 5, // Depth of cascade animation\n\tdisplayStartupTime: false // Whether to display startup time\n\t};\n\n// Messages\nconfig.messages = {\n\tmessageClose: {},\n\tdates: {}\n};\n\n// Options that can be set in the options panel and/or cookies\nconfig.options = {\n\tchkRegExpSearch: false,\n\tchkCaseSensitiveSearch: false,\n\tchkAnimate: true,\n\tchkSaveBackups: true,\n\tchkAutoSave: false,\n\tchkGenerateAnRssFeed: false,\n\tchkSaveEmptyTemplate: false,\n\tchkOpenInNewWindow: true,\n\tchkToggleLinks: false,\n\tchkHttpReadOnly: true,\n\tchkForceMinorUpdate: false,\n\tchkConfirmDelete: true,\n\tchkInsertTabs: false,\n\ttxtBackupFolder: \"\",\n\ttxtMainTab: \"tabTimeline\",\n\ttxtMoreTab: \"moreTabAll\",\n\ttxtMaxEditRows: \"30\"\n\t};\n\n// List of notification functions to be called when certain tiddlers are changed or deleted\nconfig.notifyTiddlers = [\n\t{name: \"StyleSheetLayout\", notify: refreshStyles},\n\t{name: \"StyleSheetColors\", notify: refreshStyles},\n\t{name: \"StyleSheet\", notify: refreshStyles},\n\t{name: \"StyleSheetPrint\", notify: refreshStyles},\n\t{name: \"PageTemplate\", notify: refreshPageTemplate},\n\t{name: \"SiteTitle\", notify: refreshPageTitle},\n\t{name: \"SiteSubtitle\", notify: refreshPageTitle},\n\t{name: \"ColorPalette\", notify: refreshColorPalette},\n\t{name: null, notify: refreshDisplay}\n\t];\n\n// Default tiddler templates\nvar DEFAULT_VIEW_TEMPLATE = 1;\nvar DEFAULT_EDIT_TEMPLATE = 2;\nconfig.tiddlerTemplates = {\n\t1: \"ViewTemplate\",\n\t2: \"EditTemplate\"\n\t};\n\n// More messages (rather a legacy layout that shouldn't really be like this)\nconfig.views = {\n\twikified: {\n\t\ttag: {}\n\t\t},\n\teditor: {\n\t\ttagChooser: {}\n\t\t}\n\t};\n\n// Macros; each has a 'handler' member that is inserted later\nconfig.macros = {\n\ttoday: {},\n\tversion: {},\n\tsearch: {sizeTextbox: 15},\n\ttiddler: {},\n\ttag: {},\n\ttags: {},\n\ttagging: {},\n\ttimeline: {},\n\tallTags: {},\n\tlist: {\n\t\tall: {},\n\t\tmissing: {},\n\t\torphans: {},\n\t\tshadowed: {}\n\t\t},\n\tcloseAll: {},\n\tpermaview: {},\n\tsaveChanges: {},\n\tslider: {},\n\toption: {},\n\tnewTiddler: {},\n\tnewJournal: {},\n\tsparkline: {},\n\ttabs: {},\n\tgradient: {},\n\tmessage: {},\n\tview: {},\n\tedit: {},\n\ttagChooser: {},\n\ttoolbar: {},\n\tbr: {},\n\tplugins: {},\n\trefreshDisplay: {},\n\timportTiddlers: {}\n\t};\n\n// Commands supported by the toolbar macro\nconfig.commands = {\n\tcloseTiddler: {},\n\tcloseOthers: {},\n\teditTiddler: {hideReadOnly: true},\n\tsaveTiddler: {hideReadOnly: true},\n\tcancelTiddler: {hideReadOnly: true},\n\tdeleteTiddler: {hideReadOnly: true},\n\tpermalink: {hideReadOnly: true},\n\treferences: {hideReadOnly: true},\n\tjump: {hideReadOnly: true}\n\t};\n\n// Browser detection... In a very few places, there's nothing else for it but to\n// know what browser we're using.\nconfig.userAgent = navigator.userAgent.toLowerCase();\nconfig.browser = {\n\tisIE: config.userAgent.indexOf(\"msie\") != -1 && config.userAgent.indexOf(\"opera\") == -1,\n\tieVersion: /MSIE (\\d.\\d)/i.exec(config.userAgent), // config.browser.ieVersion[1], if it exists, will be the IE version string, eg \"6.0\"\n\tisSafari: config.userAgent.indexOf(\"applewebkit\") != -1,\n\tisBadSafari: !((new RegExp(\"[\\u0150\\u0170]\",\"g\")).test(\"\\u0150\")),\n\tfirefoxDate: /Gecko\\/(\\d{8})/i.exec(config.userAgent), // config.browser.firefoxDate[1], if it exists, will be Firefox release date as \"YYYYMMDD\"\n\tisOpera: config.userAgent.indexOf(\"opera\") != -1,\n\tisLinux: config.userAgent.indexOf(\"linux\") != -1,\n\tisUnix: config.userAgent.indexOf(\"x11\") != -1,\n\tisMac: config.userAgent.indexOf(\"mac\") != -1,\n\tisWindows: config.userAgent.indexOf(\"win\") != -1\n\t};\n\n// Basic regular expressions\nconfig.textPrimitives = {\n\tupperLetter: \"[A-Z\\u00c0-\\u00de\\u0150\\u0170]\",\n\tlowerLetter: \"[a-z0-9_\\\\-\\u00df-\\u00ff\\u0151\\u0171]\",\n\tanyLetter:   \"[A-Za-z0-9_\\\\-\\u00c0-\\u00de\\u00df-\\u00ff\\u0150\\u0170\\u0151\\u0171]\",\n\tanyLetterStrict: \"[A-Za-z0-9\\u00c0-\\u00de\\u00df-\\u00ff\\u0150\\u0170\\u0151\\u0171]\"\n\t};\nif(config.browser.isBadSafari)\n\tconfig.textPrimitives = {\n\t\tupperLetter: \"[A-Z\\u00c0-\\u00de]\",\n\t\tlowerLetter: \"[a-z0-9_\\\\-\\u00df-\\u00ff]\",\n\t\tanyLetter:   \"[A-Za-z0-9_\\\\-\\u00c0-\\u00de\\u00df-\\u00ff]\",\n\t\tanyLetterStrict: \"[A-Za-z0-9\\u00c0-\\u00de\\u00df-\\u00ff]\"\n\t\t}\nconfig.textPrimitives.sliceSeparator = \"::\";\nconfig.textPrimitives.urlPattern = \"[a-z]{3,8}:[^\\\\s:'\\\"][^\\\\s'\\\"]*(?:/|\\\\b)\";\nconfig.textPrimitives.unWikiLink = \"~\";\nconfig.textPrimitives.wikiLink = \"(?:(?:\" + config.textPrimitives.upperLetter + \"+\" +\n\t\t\t\t\t\t\t\t\t\t\t\tconfig.textPrimitives.lowerLetter + \"+\" +\n\t\t\t\t\t\t\t\t\t\t\t\tconfig.textPrimitives.upperLetter +\n\t\t\t\t\t\t\t\t\t\t\t\tconfig.textPrimitives.anyLetter + \"*)|(?:\" +\n\t\t\t\t\t\t\t\t\t\t\t\tconfig.textPrimitives.upperLetter + \"{2,}\" +\n\t\t\t\t\t\t\t\t\t\t\t\tconfig.textPrimitives.lowerLetter + \"+))\";\n\nconfig.textPrimitives.cssLookahead = \"(?:(\" + config.textPrimitives.anyLetter + \"+)\\\\(([^\\\\)\\\\|\\\\n]+)(?:\\\\):))|(?:(\" + config.textPrimitives.anyLetter + \"+):([^;\\\\|\\\\n]+);)\";\nconfig.textPrimitives.cssLookaheadRegExp = new RegExp(config.textPrimitives.cssLookahead,\"mg\");\n\nconfig.textPrimitives.brackettedLink = \"\\\\[\\\\[([^\\\\]]+)\\\\]\\\\]\";\nconfig.textPrimitives.titledBrackettedLink = \"\\\\[\\\\[([^\\\\[\\\\]\\\\|]+)\\\\|([^\\\\[\\\\]\\\\|]+)\\\\]\\\\]\";\nconfig.textPrimitives.tiddlerForcedLinkRegExp = new RegExp(\"(?:\" + config.textPrimitives.titledBrackettedLink + \")|(?:\" +\n\tconfig.textPrimitives.brackettedLink + \")|(?:\" +\n\tconfig.textPrimitives.urlPattern + \")\",\"mg\");\nconfig.textPrimitives.tiddlerAnyLinkRegExp = new RegExp(\"(\"+ config.textPrimitives.wikiLink + \")|(?:\" +\n\tconfig.textPrimitives.titledBrackettedLink + \")|(?:\" +\n\tconfig.textPrimitives.brackettedLink + \")|(?:\" +\n\tconfig.textPrimitives.urlPattern + \")\",\"mg\");\n\n// ---------------------------------------------------------------------------------\n// Shadow tiddlers\n// ---------------------------------------------------------------------------------\n\nconfig.shadowTiddlers = {\n\tColorPalette: \"Background: #fff\\n\" +\n\t\t\t\t  \"Foreground: #000\\n\" +\n\t\t\t\t  \"PrimaryPale: #8cf\\n\" +\n\t\t\t\t  \"PrimaryLight: #18f\\n\" +\n\t\t\t\t  \"PrimaryMid: #04b\\n\" +\n\t\t\t\t  \"PrimaryDark: #014\\n\" +\n\t\t\t\t  \"SecondaryPale: #ffc\\n\" +\n\t\t\t\t  \"SecondaryLight: #fe8\\n\" +\n\t\t\t\t  \"SecondaryMid: #db4\\n\" +\n\t\t\t\t  \"SecondaryDark: #841\\n\" +\n\t\t\t\t  \"TertiaryPale: #eee\\n\" +\n\t\t\t\t  \"TertiaryLight: #ccc\\n\" +\n\t\t\t\t  \"TertiaryMid: #999\\n\" +\n\t\t\t\t  \"TertiaryDark: #666\\n\" +\n\t\t\t\t  \"Error: #f88\\n\",\n\tStyleSheet: \"\",\n\tStyleSheetColors: \"/*{{{*/\\nbody {\\n\tbackground: [[ColorPalette::Background]];\\n\tcolor: [[ColorPalette::Foreground]];\\n}\\n\\na{\\n\tcolor: [[ColorPalette::PrimaryMid]];\\n}\\n\\na:hover{\\n\tbackground: [[ColorPalette::PrimaryMid]];\\n\tcolor: [[ColorPalette::Background]];\\n}\\n\\na img{\\n\tborder: 0;\\n}\\n\\nh1,h2,h3,h4,h5 {\\n\tcolor: [[ColorPalette::SecondaryDark]];\\n\tbackground: [[ColorPalette::PrimaryPale]];\\n}\\n\\n.button {\\n\tcolor: [[ColorPalette::PrimaryDark]];\\n\tborder: 1px solid [[ColorPalette::Background]];\\n}\\n\\n.button:hover {\\n\tcolor: [[ColorPalette::PrimaryDark]];\\n\tbackground: [[ColorPalette::SecondaryLight]];\\n\tborder-color: [[ColorPalette::SecondaryMid]];\\n}\\n\\n.button:active {\\n\tcolor: [[ColorPalette::Background]];\\n\tbackground: [[ColorPalette::SecondaryMid]];\\n\tborder: 1px solid [[ColorPalette::SecondaryDark]];\\n}\\n\\n.header {\\n\tbackground: [[ColorPalette::PrimaryMid]];\\n}\\n\\n.headerShadow {\\n\tcolor: [[ColorPalette::Foreground]];\\n}\\n\\n.headerShadow a {\\n\tfont-weight: normal;\\n\tcolor: [[ColorPalette::Foreground]];\\n}\\n\\n.headerForeground {\\n\tcolor: [[ColorPalette::Background]];\\n}\\n\\n.headerForeground a {\\n\tfont-weight: normal;\\n\tcolor: [[ColorPalette::PrimaryPale]];\\n}\\n\\n.tabSelected{\\n\tcolor: [[ColorPalette::PrimaryDark]];\\n\tbackground: [[ColorPalette::TertiaryPale]];\\n\tborder-left: 1px solid [[ColorPalette::TertiaryLight]];\\n\tborder-top: 1px solid [[ColorPalette::TertiaryLight]];\\n\tborder-right: 1px solid [[ColorPalette::TertiaryLight]];\\n}\\n\\n.tabUnselected {\\n\tcolor: [[ColorPalette::Background]];\\n\tbackground: [[ColorPalette::TertiaryMid]];\\n}\\n\\n.tabContents {\\n\tcolor: [[ColorPalette::PrimaryDark]];\\n\tbackground: [[ColorPalette::TertiaryPale]];\\n\tborder: 1px solid [[ColorPalette::TertiaryLight]];\\n}\\n\\n.tabContents .button {\\n\t border: 0;}\\n\\n#sidebar {\\n}\\n\\n#sidebarOptions input {\\n\tborder: 1px solid [[ColorPalette::PrimaryMid]];\\n}\\n\\n#sidebarOptions .sliderPanel {\\n\tbackground: [[ColorPalette::PrimaryPale]];\\n}\\n\\n#sidebarOptions .sliderPanel a {\\n\tborder: none;\\n\tcolor: [[ColorPalette::PrimaryMid]];\\n}\\n\\n#sidebarOptions .sliderPanel a:hover {\\n\tcolor: [[ColorPalette::Background]];\\n\tbackground: [[ColorPalette::PrimaryMid]];\\n}\\n\\n#sidebarOptions .sliderPanel a:active {\\n\tcolor: [[ColorPalette::PrimaryMid]];\\n\tbackground: [[ColorPalette::Background]];\\n}\\n\\n.wizard {\\n\tbackground: [[ColorPalette::SecondaryLight]];\\n\tborder-top: 1px solid [[ColorPalette::SecondaryMid]];\\n\tborder-left: 1px solid [[ColorPalette::SecondaryMid]];\\n}\\n\\n.wizard h1 {\\n\tcolor: [[ColorPalette::SecondaryDark]];\\n}\\n\\n.wizard h2 {\\n\tcolor: [[ColorPalette::Foreground]];\\n}\\n\\n.wizardStep {\\n\tbackground: [[ColorPalette::Background]];\\n\tborder-top: 1px solid [[ColorPalette::SecondaryMid]];\\n\tborder-bottom: 1px solid [[ColorPalette::SecondaryMid]];\\n\tborder-left: 1px solid [[ColorPalette::SecondaryMid]];\\n}\\n\\n.wizard .button {\\n\tcolor: [[ColorPalette::Background]];\\n\tbackground: [[ColorPalette::PrimaryMid]];\\n\tborder-top: 1px solid [[ColorPalette::PrimaryLight]];\\n\tborder-right: 1px solid [[ColorPalette::PrimaryDark]];\\n\tborder-bottom: 1px solid [[ColorPalette::PrimaryDark]];\\n\tborder-left: 1px solid [[ColorPalette::PrimaryLight]];\\n}\\n\\n.wizard .button:hover {\\n\tcolor: [[ColorPalette::PrimaryLight]];\\n\tbackground: [[ColorPalette::PrimaryDark]];\\n\tborder-color: [[ColorPalette::PrimaryLight]];\\n}\\n\\n.wizard .button:active {\\n\tcolor: [[ColorPalette::Background]];\\n\tbackground: [[ColorPalette::PrimaryMid]];\\n\tborder-top: 1px solid [[ColorPalette::PrimaryLight]];\\n\tborder-right: 1px solid [[ColorPalette::PrimaryDark]];\\n\tborder-bottom: 1px solid [[ColorPalette::PrimaryDark]];\\n\tborder-left: 1px solid [[ColorPalette::PrimaryLight]];\\n}\\n\\n#messageArea {\\n\tborder: 1px solid [[ColorPalette::SecondaryDark]];\\n\tbackground: [[ColorPalette::SecondaryMid]];\\n\tcolor: [[ColorPalette::PrimaryDark]];\\n}\\n\\n#messageArea .button {\\n\tpadding: 0.2em 0.2em 0.2em 0.2em;\\n\tcolor: [[ColorPalette::PrimaryDark]];\\n\tbackground: [[ColorPalette::Background]];\\n}\\n\\n.popup {\\n\tbackground: [[ColorPalette::PrimaryLight]];\\n\tborder: 1px solid [[ColorPalette::PrimaryMid]];\\n}\\n\\n.popup hr {\\n\tcolor: [[ColorPalette::PrimaryDark]];\\n\tbackground: [[ColorPalette::PrimaryDark]];\\n\tborder-bottom: 1px;\\n}\\n\\n.listBreak div{\\n\tborder-bottom: 1px solid [[ColorPalette::PrimaryDark]];\\n}\\n\\n.popup li.disabled {\\n\tcolor: [[ColorPalette::PrimaryMid]];\\n}\\n\\n.popup li a, .popup li a:visited {\\n\tcolor: [[ColorPalette::TertiaryPale]];\\n\tborder: none;\\n}\\n\\n.popup li a:hover {\\n\tbackground: [[ColorPalette::PrimaryDark]];\\n\tcolor: [[ColorPalette::Background]];\\n\tborder: none;\\n}\\n\\n.tiddler .defaultCommand {\\n font-weight: bold;\\n}\\n\\n.shadow .title {\\n\tcolor: [[ColorPalette::TertiaryDark]];\\n}\\n\\n.title {\\n\tcolor: [[ColorPalette::SecondaryDark]];\\n}\\n\\n.subtitle {\\n\tcolor: [[ColorPalette::TertiaryDark]];\\n}\\n\\n.toolbar {\\n\tcolor: [[ColorPalette::PrimaryMid]];\\n}\\n\\n.tagging, .tagged {\\n\tborder: 1px solid [[ColorPalette::TertiaryPale]];\\n\tbackground-color: [[ColorPalette::TertiaryPale]];\\n}\\n\\n.selected .tagging, .selected .tagged {\\n\tbackground-color: [[ColorPalette::TertiaryLight]];\\n\tborder: 1px solid [[ColorPalette::TertiaryMid]];\\n}\\n\\n.tagging .listTitle, .tagged .listTitle {\\n\tcolor: [[ColorPalette::PrimaryDark]];\\n}\\n\\n.tagging .button, .tagged .button {\\n\t\tborder: none;\\n}\\n\\n.footer {\\n\tcolor: [[ColorPalette::TertiaryLight]];\\n}\\n\\n.selected .footer {\\n\tcolor: [[ColorPalette::TertiaryMid]];\\n}\\n\\n.sparkline {\\n\tbackground: [[ColorPalette::PrimaryPale]];\\n\tborder: 0;\\n}\\n\\n.sparktick {\\n\tbackground: [[ColorPalette::PrimaryDark]];\\n}\\n\\n.error, .errorButton {\\n\tcolor: [[ColorPalette::Foreground]];\\n\tbackground: [[ColorPalette::Error]];\\n}\\n\\n.warning {\\n\tcolor: [[ColorPalette::Foreground]];\\n\tbackground: [[ColorPalette::SecondaryPale]];\\n}\\n\\n.cascade {\\n\tbackground: [[ColorPalette::TertiaryPale]];\\n\tcolor: [[ColorPalette::TertiaryMid]];\\n\tborder: 1px solid [[ColorPalette::TertiaryMid]];\\n}\\n\\n.imageLink, #displayArea .imageLink {\\n\tbackground: transparent;\\n}\\n\\n.viewer .listTitle {list-style-type: none; margin-left: -2em;}\\n\\n.viewer .button {\\n\tborder: 1px solid [[ColorPalette::SecondaryMid]];\\n}\\n\\n.viewer blockquote {\\n\tborder-left: 3px solid [[ColorPalette::TertiaryDark]];\\n}\\n\\n.viewer table {\\n\tborder: 2px solid [[ColorPalette::TertiaryDark]];\\n}\\n\\n.viewer th, thead td {\\n\tbackground: [[ColorPalette::SecondaryMid]];\\n\tborder: 1px solid [[ColorPalette::TertiaryDark]];\\n\tcolor: [[ColorPalette::Background]];\\n}\\n\\n.viewer td, .viewer tr {\\n\tborder: 1px solid [[ColorPalette::TertiaryDark]];\\n}\\n\\n.viewer pre {\\n\tborder: 1px solid [[ColorPalette::SecondaryLight]];\\n\tbackground: [[ColorPalette::SecondaryPale]];\\n}\\n\\n.viewer code {\\n\tcolor: [[ColorPalette::SecondaryDark]];\\n}\\n\\n.viewer hr {\\n\tborder: 0;\\n\tborder-top: dashed 1px [[ColorPalette::TertiaryDark]];\\n\tcolor: [[ColorPalette::TertiaryDark]];\\n}\\n\\n.highlight, .marked {\\n\tbackground: [[ColorPalette::SecondaryLight]];\\n}\\n\\n.editor input {\\n\tborder: 1px solid [[ColorPalette::PrimaryMid]];\\n}\\n\\n.editor textarea {\\n\tborder: 1px solid [[ColorPalette::PrimaryMid]];\\n\twidth: 100%;\\n}\\n\\n.editorFooter {\\n\tcolor: [[ColorPalette::TertiaryMid]];\\n}\\n\\n/*}}}*/\",\n\tStyleSheetLayout: \"/*{{{*/\\n* html .tiddler {\\n    height: 1%;\\n}\\n\\nbody {\\n\tfont-size: .75em;\\n\tfont-family: arial,helvetica;\\n\tmargin: 0;\\n\tpadding: 0;\\n}\\n\\nh1,h2,h3,h4,h5 {\\n\tfont-weight: bold;\\n\ttext-decoration: none;\\n\tpadding-left: 0.4em;\\n}\\n\\nh1 {font-size: 1.35em;}\\nh2 {font-size: 1.25em;}\\nh3 {font-size: 1.1em;}\\nh4 {font-size: 1em;}\\nh5 {font-size: .9em;}\\n\\nhr {\\n\theight: 1px;\\n}\\n\\na{\\n\ttext-decoration: none;\\n}\\n\\ndt {font-weight: bold;}\\n\\nol { list-style-type: decimal }\\nol ol { list-style-type: lower-alpha }\\nol ol ol { list-style-type: lower-roman }\\nol ol ol ol { list-style-type: decimal }\\nol ol ol ol ol { list-style-type: lower-alpha }\\nol ol ol ol ol ol { list-style-type: lower-roman }\\nol ol ol ol ol ol ol { list-style-type: decimal }\\n\\n.txtOptionInput {\\n\twidth: 11em;\\n}\\n\\n#contentWrapper .chkOptionInput {\\n\tborder: 0;\\n}\\n\\n.externalLink {\\n\ttext-decoration: underline;\\n}\\n\\n.indent {margin-left:3em;}\\n.outdent {margin-left:3em; text-indent:-3em;}\\ncode.escaped {white-space:nowrap;}\\n\\n.tiddlyLinkExisting {\\n\tfont-weight: bold;\\n}\\n\\n.tiddlyLinkNonExisting {\\n\tfont-style: italic;\\n}\\n\\n/* the 'a' is required for IE, otherwise it renders the whole tiddler a bold */\\na.tiddlyLinkNonExisting.shadow {\\n\tfont-weight: bold;\\n}\\n\\n#mainMenu .tiddlyLinkExisting, \\n#mainMenu .tiddlyLinkNonExisting,\\n#sidebarTabs .tiddlyLinkNonExisting{\\n font-weight: normal;\\n font-style: normal;\\n}\\n\\n#sidebarTabs .tiddlyLinkExisting {\\n font-weight: bold;\\n font-style: normal;\\n}\\n\\n.header {\\n\t\tposition: relative;\\n}\\n\\n.header a:hover {\\n\tbackground: transparent;\\n}\\n\\n.headerShadow {\\n\tposition: relative;\\n\tpadding: 4.5em 0em 1em 1em;\\n\tleft: -1px;\\n\ttop: -1px;\\n}\\n\\n.headerForeground {\\n\tposition: absolute;\\n\tpadding: 4.5em 0em 1em 1em;\\n\tleft: 0px;\\n\ttop: 0px;\\n}\\n\\n.siteTitle {\\n\tfont-size: 3em;\\n}\\n\\n.siteSubtitle {\\n\tfont-size: 1.2em;\\n}\\n\\n#mainMenu {\\n\tposition: absolute;\\n\tleft: 0;\\n\twidth: 10em;\\n\ttext-align: right;\\n\tline-height: 1.6em;\\n\tpadding: 1.5em 0.5em 0.5em 0.5em;\\n\tfont-size: 1.1em;\\n}\\n\\n#sidebar {\\n\tposition: absolute;\\n\tright: 3px;\\n\twidth: 16em;\\n\tfont-size: .9em;\\n}\\n\\n#sidebarOptions {\\n\tpadding-top: 0.3em;\\n}\\n\\n#sidebarOptions a {\\n\tmargin: 0em 0.2em;\\n\tpadding: 0.2em 0.3em;\\n\tdisplay: block;\\n}\\n\\n#sidebarOptions input {\\n\tmargin: 0.4em 0.5em;\\n}\\n\\n#sidebarOptions .sliderPanel {\\n\tmargin-left: 1em;\\n\tpadding: 0.5em;\\n\tfont-size: .85em;\\n}\\n\\n#sidebarOptions .sliderPanel a {\\n\tfont-weight: bold;\\n\tdisplay: inline;\\n\tpadding: 0;\\n}\\n\\n#sidebarOptions .sliderPanel input {\\n\tmargin: 0 0 .3em 0;\\n}\\n\\n#sidebarTabs .tabContents {\\n\twidth: 15em;\\n\toverflow: hidden;\\n}\\n\\n.wizard {\\n\tpadding: 0.1em 0em 0em 2em;\\n}\\n\\n.wizard h1 {\\n\tfont-size: 2em;\\n\tfont-weight: bold;\\n\tbackground: none;\\n\tpadding: 0em 0em 0em 0em;\\n\tmargin: 0.4em 0em 0.2em 0em;\\n}\\n\\n.wizard h2 {\\n\tfont-size: 1.2em;\\n\tfont-weight: bold;\\n\tbackground: none;\\n\tpadding: 0em 0em 0em 0em;\\n\tmargin: 0.2em 0em 0.2em 0em;\\n}\\n\\n.wizardStep {\\n\tpadding: 1em 1em 1em 1em;\\n}\\n\\n.wizard .button {\\n\tmargin: 0.5em 0em 0em 0em;\\n\tfont-size: 1.2em;\\n}\\n\\n#messageArea {\\nposition:absolute; top:0; right:0; margin: 0.5em; padding: 0.5em;\\n}\\n\\n*[id='messageArea'] {\\nposition:fixed !important; z-index:99;}\\n\\n.messageToolbar {\\ndisplay: block;\\ntext-align: right;\\n}\\n\\n#messageArea a{\\n\ttext-decoration: underline;\\n}\\n\\n.popup {\\n\tfont-size: .9em;\\n\tpadding: 0.2em;\\n\tlist-style: none;\\n\tmargin: 0;\\n}\\n\\n.popup hr {\\n\tdisplay: block;\\n\theight: 1px;\\n\twidth: auto;\\n\tpadding: 0;\\n\tmargin: 0.2em 0em;\\n}\\n\\n.listBreak {\\n\tfont-size: 1px;\\n\tline-height: 1px;\\n}\\n\\n.listBreak div {\\n\tmargin: 2px 0;\\n}\\n\\n.popup li.disabled {\\n\tpadding: 0.2em;\\n}\\n\\n.popup li a{\\n\tdisplay: block;\\n\tpadding: 0.2em;\\n}\\n\\n.tabset {\\n\tpadding: 1em 0em 0em 0.5em;\\n}\\n\\n.tab {\\n\tmargin: 0em 0em 0em 0.25em;\\n\tpadding: 2px;\\n}\\n\\n.tabContents {\\n\tpadding: 0.5em;\\n}\\n\\n.tabContents ul, .tabContents ol {\\n\tmargin: 0;\\n\tpadding: 0;\\n}\\n\\n.txtMainTab .tabContents li {\\n\tlist-style: none;\\n}\\n\\n.tabContents li.listLink {\\n\t margin-left: .75em;\\n}\\n\\n#displayArea {\\n\tmargin: 1em 20em 0em 14em;\\n}\\n\\n\\n.toolbar {\\n\ttext-align: right;\\n\tfont-size: .9em;\\n\tvisibility: hidden;\\n}\\n\\n.selected .toolbar {\\n\tvisibility: visible;\\n}\\n\\n.tiddler {\\n\tpadding: 1em 1em 0em 1em;\\n}\\n\\n.missing .viewer,.missing .title {\\n\tfont-style: italic;\\n}\\n\\n.title {\\n\tfont-size: 1.6em;\\n\tfont-weight: bold;\\n}\\n\\n.missing .subtitle {\\n display: none;\\n}\\n\\n.subtitle {\\n\tfont-size: 1.1em;\\n}\\n\\n.tiddler .button {\\n\tpadding: 0.2em 0.4em;\\n}\\n\\n.tagging {\\nmargin: 0.5em 0.5em 0.5em 0;\\nfloat: left;\\ndisplay: none;\\n}\\n\\n.isTag .tagging {\\ndisplay: block;\\n}\\n\\n.tagged {\\nmargin: 0.5em;\\nfloat: right;\\n}\\n\\n.tagging, .tagged {\\nfont-size: 0.9em;\\npadding: 0.25em;\\n}\\n\\n.tagging ul, .tagged ul {\\nlist-style: none;margin: 0.25em;\\npadding: 0;\\n}\\n\\n.tagClear {\\nclear: both;\\n}\\n\\n.footer {\\n\tfont-size: .9em;\\n}\\n\\n.footer li {\\ndisplay: inline;\\n}\\n\\n* html .viewer pre {\\n\twidth: 99%;\\n\tpadding: 0 0 1em 0;\\n}\\n\\n.viewer {\\n\tline-height: 1.4em;\\n\tpadding-top: 0.5em;\\n}\\n\\n.viewer .button {\\n\tmargin: 0em 0.25em;\\n\tpadding: 0em 0.25em;\\n}\\n\\n.viewer blockquote {\\n\tline-height: 1.5em;\\n\tpadding-left: 0.8em;\\n\tmargin-left: 2.5em;\\n}\\n\\n.viewer ul, .viewer ol{\\n\tmargin-left: 0.5em;\\n\tpadding-left: 1.5em;\\n}\\n\\n.viewer table {\\n\tborder-collapse: collapse;\\n\tmargin: 0.8em 1.0em;\\n}\\n\\n.viewer th, .viewer td, .viewer tr,.viewer caption{\\n\tpadding: 3px;\\n}\\n\\n.viewer table.listView {\\n\tfont-size: 0.85em;\\n\tmargin: 0.8em 1.0em;\\n}\\n\\n.viewer table.listView th, .viewer table.listView td, .viewer table.listView tr {\\n\tpadding: 0px 3px 0px 3px;\\n}\\n\\n.viewer pre {\\n\tpadding: 0.5em;\\n\tmargin-left: 0.5em;\\n\tfont-size: 1.2em;\\n\tline-height: 1.4em;\\n\toverflow: auto;\\n}\\n\\n.viewer code {\\n\tfont-size: 1.2em;\\n\tline-height: 1.4em;\\n}\\n\\n.editor {\\nfont-size: 1.1em;\\n}\\n\\n.editor input, .editor textarea {\\n\tdisplay: block;\\n\twidth: 100%;\\n\tfont: inherit;\\n}\\n\\n.editorFooter {\\n\tpadding: 0.25em 0em;\\n\tfont-size: .9em;\\n}\\n\\n.editorFooter .button {\\npadding-top: 0px; padding-bottom: 0px;}\\n\\n.fieldsetFix {border: 0;\\npadding: 0;\\nmargin: 1px 0px 1px 0px;\\n}\\n\\n.sparkline {\\n\tline-height: 1em;\\n}\\n\\n.sparktick {\\n\toutline: 0;\\n}\\n\\n.zoomer {\\n\tfont-size: 1.1em;\\n\tposition: absolute;\\n\tpadding: 1em;\\n}\\n\\n.cascade {\\n\tfont-size: 1.1em;\\n\tposition: absolute;\\n\toverflow: hidden;\\n}\\n/*}}}*/\",\n\tStyleSheetPrint: \"/*{{{*/\\n@media print {\\n#mainMenu, #sidebar, #messageArea, .toolbar {display: none ! important;}\\n#displayArea {margin: 1em 1em 0em 1em;}\\n/* Fixes a feature in Firefox 1.5.0.2 where print preview displays the noscript content */\\nnoscript {display:none;}\\n}\\n/*}}}*/\",\n\tPageTemplate: \"<!--{{{--><div id='mainMenu' refresh='content' tiddler='MainMenu'></div>\\n<div id='sidebar'>\\n<div id='sidebarOptions' refresh='content' tiddler='SideBarOptions'></div>\\n<div id='sidebarTabs' refresh='content' force='true' tiddler='SideBarTabs'></div>\\n</div>\\n<div id='displayArea'>\\n<div id='messageArea'></div>\\n<div id='tiddlerDisplay'></div>\\n</div>\\n<!--}}}-->\",\n\tViewTemplate: \"<!--{{{-->\\n<div class='toolbar' macro='toolbar closeTiddler closeOthers +editTiddler permalink references jump'></div>\\n<div class='title' macro='view title'></div>\\n<div class='subtitle'><span macro='view modifier link'></span>, <span macro='view modified date [[DD MMM YYYY]]'></span> (<span macro='message views.wikified.createdPrompt'></span> <span macro='view created date [[DD MMM YYYY]]'></span>)</div>\\n<div class='tagging' macro='tagging'></div>\\n<div class='tagged' macro='tags'></div>\\n<div class='viewer' macro='view text wikified'></div>\\n<div class='tagClear'></div>\\n<!--}}}-->\",\n\tEditTemplate: \"<!--{{{-->\\n<div class='toolbar' macro='toolbar +saveTiddler -cancelTiddler deleteTiddler'></div>\\n<div class='title' macro='view title'></div>\\n<div class='editor' macro='edit title'></div>\\n<div class='editor' macro='edit text'></div>\\n<div class='editor' macro='edit tags'></div><div class='editorFooter'><span macro='message views.editor.tagPrompt'></span><span macro='tagChooser'></span></div>\\n<!--}}}-->\",\n\tMarkupPreHead: \"<!--{{{-->\\n<link rel='alternate' type='application/rss+xml' title='RSS' href='index.xml'/>\\n<!--}}}-->\",\n\tMarkupPostHead: \"\",\n\tMarkupPreBody: \"\",\n\tMarkupPostBody: \"\"\n\t};\n\n// ---------------------------------------------------------------------------------\n// Translateable strings\n// ---------------------------------------------------------------------------------\n\n// Strings in \"double quotes\" should be translated; strings in 'single quotes' should be left alone\n\nmerge(config.options,{\n\ttxtUserName: \"YourName\"});\n\nmerge(config.messages,{\n\tcustomConfigError: \"Problems were encountered loading plugins. See PluginManager for details\",\n\tpluginError: \"Error: %0\",\n\tpluginDisabled: \"Not executed because disabled via 'systemConfigDisable' tag\",\n\tpluginForced: \"Executed because forced via 'systemConfigForce' tag\",\n\tpluginVersionError: \"Not executed because this plugin needs a newer version of TiddlyWiki\",\n\tnothingSelected: \"Nothing is selected. You must select one or more items first\",\n\tsavedSnapshotError: \"It appears that this TiddlyWiki has been incorrectly saved. Please see http://www.tiddlywiki.com/#DownloadSoftware for details\",\n\tsubtitleUnknown: \"(unknown)\",\n\tundefinedTiddlerToolTip: \"The tiddler '%0' doesn't yet exist\",\n\tshadowedTiddlerToolTip: \"The tiddler '%0' doesn't yet exist, but has a pre-defined shadow value\",\n\ttiddlerLinkTooltip: \"%0 - %1, %2\",\n\texternalLinkTooltip: \"External link to %0\",\n\tnoTags: \"There are no tagged tiddlers\",\n\tnotFileUrlError: \"You need to save this TiddlyWiki to a file before you can save changes\",\n\tcantSaveError: \"It's not possible to save changes. This could be because your browser doesn't support saving (instead, use FireFox if you can), or because the pathname to your TiddlyWiki file contains illegal characters\",\n\tinvalidFileError: \"The original file '%0' does not appear to be a valid TiddlyWiki\",\n\tbackupSaved: \"Backup saved\",\n\tbackupFailed: \"Failed to save backup file\",\n\trssSaved: \"RSS feed saved\",\n\trssFailed: \"Failed to save RSS feed file\",\n\temptySaved: \"Empty template saved\",\n\temptyFailed: \"Failed to save empty template file\",\n\tmainSaved: \"Main TiddlyWiki file saved\",\n\tmainFailed: \"Failed to save main TiddlyWiki file. Your changes have not been saved\",\n\tmacroError: \"Error in macro <<%0>>\",\n\tmacroErrorDetails: \"Error while executing macro <<%0>>:\\n%1\",\n\tmissingMacro: \"No such macro\",\n\toverwriteWarning: \"A tiddler named '%0' already exists. Choose OK to overwrite it\",\n\tunsavedChangesWarning: \"WARNING! There are unsaved changes in TiddlyWiki\\n\\nChoose OK to save\\nChoose CANCEL to discard\",\n\tconfirmExit: \"--------------------------------\\n\\nThere are unsaved changes in TiddlyWiki. If you continue you will lose those changes\\n\\n--------------------------------\",\n\tsaveInstructions: \"SaveChanges\",\n\tunsupportedTWFormat: \"Unsupported TiddlyWiki format '%0'\",\n\ttiddlerSaveError: \"Error when saving tiddler '%0'\",\n\ttiddlerLoadError: \"Error when loading tiddler '%0'\",\n\twrongSaveFormat: \"Cannot save with storage format '%0'. Using standard format for save.\",\n\tinvalidFieldName: \"Invalid field name %0\",\n\tfieldCannotBeChanged: \"Field '%0' cannot be changed\"});\n\nmerge(config.messages.messageClose,{\n\ttext: \"close\",\n\ttooltip: \"close this message area\"});\n\nconfig.messages.dates.months = [\"January\", \"February\", \"March\", \"April\", \"May\", \"June\", \"July\", \"August\", \"September\", \"October\", \"November\",\"December\"];\nconfig.messages.dates.days = [\"Sunday\", \"Monday\", \"Tuesday\", \"Wednesday\", \"Thursday\", \"Friday\", \"Saturday\"];\nconfig.messages.dates.shortMonths = [\"Jan\", \"Feb\", \"Mar\", \"Apr\", \"May\", \"Jun\", \"Jul\", \"Aug\", \"Sep\", \"Oct\", \"Nov\", \"Dec\"];\nconfig.messages.dates.shortDays = [\"Sun\", \"Mon\", \"Tue\", \"Wed\", \"Thu\", \"Fri\", \"Sat\"];\n\nmerge(config.views.wikified.tag,{\n\tlabelNoTags: \"no tags\",\n\tlabelTags: \"tags: \",\n\topenTag: \"Open tag '%0'\",\n\ttooltip: \"Show tiddlers tagged with '%0'\",\n\topenAllText: \"Open all\",\n\topenAllTooltip: \"Open all of these tiddlers\",\n\tpopupNone: \"No other tiddlers tagged with '%0'\"});\n\nmerge(config.views.wikified,{\n\tdefaultText: \"The tiddler '%0' doesn't yet exist. Double-click to create it\",\n\tdefaultModifier: \"(missing)\",\n\tshadowModifier: \"(built-in shadow tiddler)\",\n\tcreatedPrompt: \"created\"});\n\nmerge(config.views.editor,{\n\ttagPrompt: \"Type tags separated with spaces, [[use double square brackets]] if necessary, or add existing\",\n\tdefaultText: \"Type the text for '%0'\"});\n\nmerge(config.views.editor.tagChooser,{\n\ttext: \"tags\",\n\ttooltip: \"Choose existing tags to add to this tiddler\",\n\tpopupNone: \"There are no tags defined\",\n\ttagTooltip: \"Add the tag '%0'\"});\n\nmerge(config.macros.search,{\n\tlabel: \"search\",\n\tprompt: \"Search this TiddlyWiki\",\n\taccessKey: \"F\",\n\tsuccessMsg: \"%0 tiddlers found matching %1\",\n\tfailureMsg: \"No tiddlers found matching %0\"});\n\nmerge(config.macros.tagging,{\n\tlabel: \"tagging: \",\n\tlabelNotTag: \"not tagging\",\n\ttooltip: \"List of tiddlers tagged with '%0'\"});\n\nmerge(config.macros.timeline,{\n\tdateFormat: \"DD MMM YYYY\"});\n\nmerge(config.macros.allTags,{\n\ttooltip: \"Show tiddlers tagged with '%0'\",\n\tnoTags: \"There are no tagged tiddlers\"});\n\nconfig.macros.list.all.prompt = \"All tiddlers in alphabetical order\";\nconfig.macros.list.missing.prompt = \"Tiddlers that have links to them but are not defined\";\nconfig.macros.list.orphans.prompt = \"Tiddlers that are not linked to from any other tiddlers\";\nconfig.macros.list.shadowed.prompt = \"Tiddlers shadowed with default contents\";\n\nmerge(config.macros.closeAll,{\n\tlabel: \"close all\",\n\tprompt: \"Close all displayed tiddlers (except any that are being edited)\"});\n\nmerge(config.macros.permaview,{\n\tlabel: \"permaview\",\n\tprompt: \"Link to an URL that retrieves all the currently displayed tiddlers\"});\n\nmerge(config.macros.saveChanges,{\n\tlabel: \"save changes\",\n\tprompt: \"Save all tiddlers to create a new TiddlyWiki\",\n\taccessKey: \"S\"});\n\nmerge(config.macros.newTiddler,{\n\tlabel: \"new tiddler\",\n\tprompt: \"Create a new tiddler\",\n\ttitle: \"New Tiddler\",\n\taccessKey: \"N\"});\n\nmerge(config.macros.newJournal,{\n\tlabel: \"new journal\",\n\tprompt: \"Create a new tiddler from the current date and time\",\n\taccessKey: \"J\"});\n\nmerge(config.macros.plugins,{\n\tskippedText: \"(This plugin has not been executed because it was added since startup)\",\n\tnoPluginText: \"There are no plugins installed\",\n\tconfirmDeleteText: \"Are you sure you want to delete these tiddlers:\\n\\n%0\",\n\tlistViewTemplate : {\n\t\tcolumns: [\n\t\t\t{name: 'Selected', field: 'Selected', rowName: 'title', type: 'Selector'},\n\t\t\t{name: 'Title', field: 'title', tiddlerLink: 'title', title: \"Title\", type: 'TiddlerLink'},\n\t\t\t{name: 'Forced', field: 'forced', title: \"Forced\", tag: 'systemConfigForce', type: 'TagCheckbox'},\n\t\t\t{name: 'Disabled', field: 'disabled', title: \"Disabled\", tag: 'systemConfigDisable', type: 'TagCheckbox'},\n\t\t\t{name: 'Executed', field: 'executed', title: \"Loaded\", type: 'Boolean', trueText: \"Yes\", falseText: \"No\"},\n\t\t\t{name: 'Error', field: 'error', title: \"Status\", type: 'Boolean', trueText: \"Error\", falseText: \"OK\"},\n\t\t\t{name: 'Log', field: 'log', title: \"Log\", type: 'StringList'}\n\t\t\t],\n\t\trowClasses: [\n\t\t\t{className: 'error', field: 'error'},\n\t\t\t{className: 'warning', field: 'warning'}\n\t\t\t],\n\t\tactions: [\n\t\t\t{caption: \"More actions...\", name: ''},\n\t\t\t{caption: \"Remove systemConfig tag\", name: 'remove'},\n\t\t\t{caption: \"Delete these tiddlers forever\", name: 'delete'}\n\t\t\t]}\n\t});\n\nmerge(config.macros.refreshDisplay,{\n\tlabel: \"refresh\",\n\tprompt: \"Redraw the entire TiddlyWiki display\"\n\t});\n\nmerge(config.macros.importTiddlers,{\n\treadOnlyWarning: \"You cannot import tiddlers into a read-only TiddlyWiki. Try opening the TiddlyWiki file from a file:// URL\",\n\tdefaultPath: \"http://www.tiddlywiki.com/index.html\",\n\tfetchLabel: \"fetch\",\n\tfetchPrompt: \"Fetch the tiddlywiki file\",\n\tfetchError: \"There were problems fetching the tiddlywiki file\",\n\tconfirmOverwriteText: \"Are you sure you want to overwrite these tiddlers:\\n\\n%0\",\n\twizardTitle: \"Import tiddlers from another TiddlyWiki file\",\n\tstep1: \"Step 1: Locate the TiddlyWiki file\",\n\tstep1prompt: \"Enter the URL or pathname here: \",\n\tstep1promptFile: \"...or browse for a file: \",\n\tstep1promptFeeds: \"...or select a pre-defined feed: \",\n\tstep1feedPrompt: \"Choose...\",\n\tstep2: \"Step 2: Loading TiddlyWiki file\",\n\tstep2Text: \"Please wait while the file is loaded from: %0\",\n\tstep3: \"Step 3: Choose the tiddlers to import\",\n\tstep4: \"%0 tiddler(s) imported\",\n\tstep5: \"Done\",\n\tlistViewTemplate: {\n\t\tcolumns: [\n\t\t\t{name: 'Selected', field: 'Selected', rowName: 'title', type: 'Selector'},\n\t\t\t{name: 'Title', field: 'title', title: \"Title\", type: 'String'},\n\t\t\t{name: 'Snippet', field: 'text', title: \"Snippet\", type: 'String'},\n\t\t\t{name: 'Tags', field: 'tags', title: \"Tags\", type: 'Tags'}\n\t\t\t],\n\t\trowClasses: [\n\t\t\t],\n\t\tactions: [\n\t\t\t{caption: \"More actions...\", name: ''},\n\t\t\t{caption: \"Import these tiddlers\", name: 'import'}\n\t\t\t]}\n\t});\n\nmerge(config.commands.closeTiddler,{\n\ttext: \"close\",\n\ttooltip: \"Close this tiddler\"});\n\nmerge(config.commands.closeOthers,{\n\ttext: \"close others\",\n\ttooltip: \"Close all other tiddlers\"});\n\nmerge(config.commands.editTiddler,{\n\ttext: \"edit\",\n\ttooltip: \"Edit this tiddler\",\n\treadOnlyText: \"view\",\n\treadOnlyTooltip: \"View the source of this tiddler\"});\n\nmerge(config.commands.saveTiddler,{\n\ttext: \"done\",\n\ttooltip: \"Save changes to this tiddler\"});\n\nmerge(config.commands.cancelTiddler,{\n\ttext: \"cancel\",\n\ttooltip: \"Undo changes to this tiddler\",\n\twarning: \"Are you sure you want to abandon your changes to '%0'?\",\n\treadOnlyText: \"done\",\n\treadOnlyTooltip: \"View this tiddler normally\"});\n\nmerge(config.commands.deleteTiddler,{\n\ttext: \"delete\",\n\ttooltip: \"Delete this tiddler\",\n\twarning: \"Are you sure you want to delete '%0'?\"});\n\nmerge(config.commands.permalink,{\n\ttext: \"permalink\",\n\ttooltip: \"Permalink for this tiddler\"});\n\nmerge(config.commands.references,{\n\ttext: \"references\",\n\ttooltip: \"Show tiddlers that link to this one\",\n\tpopupNone: \"No references\"});\n\nmerge(config.commands.jump,{\n\ttext: \"jump\",\n\ttooltip: \"Jump to another open tiddler\"});\n\nmerge(config.shadowTiddlers,{\n\tDefaultTiddlers: \"GettingStarted\",\n\tMainMenu: \"GettingStarted\",\n\tSiteTitle: \"My TiddlyWiki\",\n\tSiteSubtitle: \"a reusable non-linear personal web notebook\",\n\tSiteUrl: \"http://www.tiddlywiki.com/\",\n\tGettingStarted: \"To get started with this blank TiddlyWiki, you'll need to modify the following tiddlers:\\n* SiteTitle & SiteSubtitle: The title and subtitle of the site, as shown above (after saving, they will also appear in the browser title bar)\\n* MainMenu: The menu (usually on the left)\\n* DefaultTiddlers: Contains the names of the tiddlers that you want to appear when the TiddlyWiki is opened\\nYou'll also need to enter your username for signing your edits: <<option txtUserName>>\",\n\tSideBarOptions: \"<<search>><<closeAll>><<permaview>><<newTiddler>><<newJournal 'DD MMM YYYY'>><<saveChanges>><<slider chkSliderOptionsPanel OptionsPanel 'options \u00bb' 'Change TiddlyWiki advanced options'>>\",\n\tOptionsPanel: \"These InterfaceOptions for customising TiddlyWiki are saved in your browser\\n\\nYour username for signing your edits. Write it as a WikiWord (eg JoeBloggs)\\n\\n<<option txtUserName>>\\n<<option chkSaveBackups>> SaveBackups\\n<<option chkAutoSave>> AutoSave\\n<<option chkRegExpSearch>> RegExpSearch\\n<<option chkCaseSensitiveSearch>> CaseSensitiveSearch\\n<<option chkAnimate>> EnableAnimations\\n\\n----\\nAdvancedOptions\\nPluginManager\\nImportTiddlers\",\n\tAdvancedOptions: \"<<option chkGenerateAnRssFeed>> GenerateAnRssFeed\\n<<option chkOpenInNewWindow>> OpenLinksInNewWindow\\n<<option chkSaveEmptyTemplate>> SaveEmptyTemplate\\n<<option chkToggleLinks>> Clicking on links to tiddlers that are already open causes them to close\\n^^(override with Control or other modifier key)^^\\n<<option chkHttpReadOnly>> HideEditingFeatures when viewed over HTTP\\n<<option chkForceMinorUpdate>> Treat edits as MinorChanges by preserving date and time\\n^^(override with Shift key when clicking 'done' or by pressing Ctrl-Shift-Enter^^\\n<<option chkConfirmDelete>> ConfirmBeforeDeleting\\nMaximum number of lines in a tiddler edit box: <<option txtMaxEditRows>>\\nFolder name for backup files: <<option txtBackupFolder>>\\n<<option chkInsertTabs>> Use tab key to insert tab characters instead of jumping to next field\",\n\tSideBarTabs: \"<<tabs txtMainTab Timeline Timeline TabTimeline All 'All tiddlers' TabAll Tags 'All tags' TabTags More 'More lists' TabMore>>\",\n\tTabTimeline: \"<<timeline>>\",\n\tTabAll: \"<<list all>>\",\n\tTabTags: \"<<allTags>>\",\n\tTabMore: \"<<tabs txtMoreTab Missing 'Missing tiddlers' TabMoreMissing Orphans 'Orphaned tiddlers' TabMoreOrphans Shadowed 'Shadowed tiddlers' TabMoreShadowed>>\",\n\tTabMoreMissing: \"<<list missing>>\",\n\tTabMoreOrphans: \"<<list orphans>>\",\n\tTabMoreShadowed: \"<<list shadowed>>\",\n\tPluginManager: \"<<plugins>>\",\n\tImportTiddlers: \"<<importTiddlers>>\"});\n\n// ---------------------------------------------------------------------------------\n// Main\n// ---------------------------------------------------------------------------------\n\nvar params = null; // Command line parameters\nvar store = null; // TiddlyWiki storage\nvar story = null; // Main story\nvar formatter = null; // Default formatters for the wikifier\nconfig.parsers = {}; // Hashmap of alternative parsers for the wikifier\nvar anim = new Animator(); // Animation engine\nvar readOnly = false; // Whether we're in readonly mode\nvar highlightHack = null; // Embarrassing hack department...\nvar hadConfirmExit = false; // Don't warn more than once\nvar safeMode = false; // Disable all plugins and cookies\nvar installedPlugins = []; // Information filled in when plugins are executed\nvar startingUp = false; // Whether we're in the process of starting up\nvar pluginInfo,tiddler; // Used to pass information to plugins in loadPlugins()\n\n// Whether to use the JavaSaver applet\nvar useJavaSaver = config.browser.isSafari || config.browser.isOpera;\n\n// Starting up\nfunction main()\n{\n\tvar now, then = new Date();\n\tstartingUp = true;\n\twindow.onbeforeunload = function(e) {if(window.confirmExit) return confirmExit();};\n\tparams = getParameters();\n\tif(params)\n\t\tparams = params.parseParams(\"open\",null,false);\n\tstore = new TiddlyWiki();\n\tinvokeParamifier(params,\"oninit\");\n\tstory = new Story(\"tiddlerDisplay\",\"tiddler\");\n\taddEvent(document,\"click\",Popup.onDocumentClick);\n\tsaveTest();\n\tloadOptionsCookie();\n\tfor(var s=0; s<config.notifyTiddlers.length; s++)\n\t\tstore.addNotification(config.notifyTiddlers[s].name,config.notifyTiddlers[s].notify);\n\tstore.loadFromDiv(\"storeArea\",\"store\",true);\n\tinvokeParamifier(params,\"onload\");\n\tvar pluginProblem = loadPlugins();\n\tformatter = new Formatter(config.formatters);\n\treadOnly = (window.location.protocol == \"file:\") ? false : config.options.chkHttpReadOnly;\n\tinvokeParamifier(params,\"onconfig\");\n\tstore.notifyAll();\n\trestart();\n\tif(pluginProblem)\n\t\t{\n\t\tstory.displayTiddler(null,\"PluginManager\");\n\t\tdisplayMessage(config.messages.customConfigError);\n\t\t}\n\tnow = new Date();\n\tif(config.displayStartupTime)\n\t\tdisplayMessage(\"TiddlyWiki startup in \" + (now-then)/1000 + \" seconds\");\n\tstartingUp = false;\n}\n\n// Restarting\nfunction restart()\n{\n\tinvokeParamifier(params,\"onstart\");\n\tif(story.isEmpty())\n\t\t{\n\t\tvar defaultParams = store.getTiddlerText(\"DefaultTiddlers\").parseParams(\"open\",null,false);\n\t\tinvokeParamifier(defaultParams,\"onstart\");\n\t\t}\n\twindow.scrollTo(0,0);\n}\n\nfunction saveTest()\n{\n\tvar saveTest = document.getElementById(\"saveTest\");\n\tif(saveTest.hasChildNodes())\n\t\talert(config.messages.savedSnapshotError);\n\tsaveTest.appendChild(document.createTextNode(\"savetest\"));\n}\n\nfunction loadPlugins()\n{\n\tif(safeMode)\n\t\treturn false;\n\tvar configTiddlers = store.getTaggedTiddlers(\"systemConfig\");\n\tinstalledPlugins = [];\n\tvar hadProblem = false;\n\tfor(var t=0; t<configTiddlers.length; t++)\n\t\t{\n\t\ttiddler = configTiddlers[t];\n\t\tpluginInfo = getPluginInfo(tiddler);\n\t\tif(isPluginExecutable(pluginInfo))\n\t\t\t{\n\t\t\tpluginInfo.executed = true;\n\t\t\tpluginInfo.error = false;\n\t\t\ttry\n\t\t\t\t{\n\t\t\t\tif(tiddler.text && tiddler.text != \"\")\n\t\t\t\t\twindow.eval(tiddler.text);\n\t\t\t\t}\n\t\t\tcatch(e)\n\t\t\t\t{\n\t\t\t\tpluginInfo.log.push(config.messages.pluginError.format([exceptionText(e)]));\n\t\t\t\tpluginInfo.error = true;\n\t\t\t\thadProblem = true;\n\t\t\t\t}\n\t\t\t}\n\t\telse\n\t\t\tpluginInfo.warning = true;\n\t\tinstalledPlugins.push(pluginInfo);\n\t\t}\n\treturn hadProblem;\n}\n\nfunction getPluginInfo(tiddler)\n{\n\tvar p = store.getTiddlerSlices(tiddler.title,[\"Name\",\"Description\",\"Version\",\"CoreVersion\",\"Date\",\"Source\",\"Author\",\"License\",\"Browsers\"]);\n\tp.tiddler = tiddler;\n\tp.title = tiddler.title;\n\tp.log = [];\n\treturn p;\n}\n\n// Check that a particular plugin is valid for execution\nfunction isPluginExecutable(plugin)\n{\n\tif(plugin.tiddler.isTagged(\"systemConfigDisable\"))\n\t\treturn verifyTail(plugin,false,config.messages.pluginDisabled);\n\tif(plugin.tiddler.isTagged(\"systemConfigForce\"))\n\t\treturn verifyTail(plugin,true,config.messages.pluginForced);\n\tif(plugin[\"CoreVersion\"])\n\t\t{\n\t\tvar coreVersion = plugin[\"CoreVersion\"].split(\".\");\n\t\tvar w = parseInt(coreVersion[0]) - version.major;\n\t\tif(w == 0 && coreVersion[1])\n\t\t\tw = parseInt(coreVersion[1]) - version.minor;\n\t\tif(w == 0 && coreVersion[2])\n\t\t \tw = parseInt(coreVersion[2]) - version.revision;\n\t\tif(w > 0)\n\t\t\treturn verifyTail(plugin,false,config.messages.pluginVersionError);\n\t\t}\n\treturn true;\n}\n\nfunction verifyTail(plugin,result,message)\n{\n\tplugin.log.push(message);\n\treturn result;\n}\n\nfunction invokeMacro(place,macro,params,wikifier,tiddler)\n{\n\ttry\n\t\t{\n\t\tvar m = config.macros[macro];\n\t\tif(m && m.handler)\n\t\t\tm.handler(place,macro,params.readMacroParams(),wikifier,params,tiddler);\n\t\telse\n\t\t\tcreateTiddlyError(place,config.messages.macroError.format([macro]),config.messages.macroErrorDetails.format([macro,config.messages.missingMacro]));\n\t\t}\n\tcatch(ex)\n\t\t{\n\t\tcreateTiddlyError(place,config.messages.macroError.format([macro]),config.messages.macroErrorDetails.format([macro,ex.toString()]));\n\t\t}\n}\n\n// ---------------------------------------------------------------------------------\n// Paramifiers\n// ---------------------------------------------------------------------------------\n\nfunction getParameters()\n{\n\tvar p = null;\n\tif(window.location.hash)\n\t\t{\n\t\tp = decodeURI(window.location.hash.substr(1));\n\t\tif(config.browser.firefoxDate != null && config.browser.firefoxDate[1] < \"20051111\")\n\t\t\tp = convertUTF8ToUnicode(p);\n\t\t}\n\treturn p;\n}\n\nfunction invokeParamifier(params,handler)\n{\n\tif(!params || params.length == undefined || params.length <= 1)\n\t\treturn;\n\tfor(var t=1; t<params.length; t++)\n\t\t{\n\t\tvar p = config.paramifiers[params[t].name];\n\t\tif(p && p[handler] instanceof Function)\n\t\t\tp[handler](params[t].value);\n\t\t}\n}\n\nconfig.paramifiers = {};\n\nconfig.paramifiers.start = {\n\toninit: function(v) {\n\t\tsafeMode = v.toLowerCase() == \"safe\";\n\t\t}\n};\n\nconfig.paramifiers.open = {\n\tonstart: function(v) {\n\t\tstory.displayTiddler(\"bottom\",v,null,false,false);\n\t\t}\n};\n\nconfig.paramifiers.story = {\n\tonstart: function(v) {\n\t\tvar list = store.getTiddlerText(v,\"\").parseParams(\"open\",null,false);\n\t\tinvokeParamifier(list,\"onstart\");\n\t\t}\n};\n\nconfig.paramifiers.search = {\n\tonstart: function(v) {\n\t\tstory.search(v,false,false);\n\t\t}\n};\n\nconfig.paramifiers.searchRegExp = {\n\tonstart: function(v) {\n\t\tstory.prototype.search(v,false,true);\n\t\t}\n};\n\nconfig.paramifiers.tag = {\n\tonstart: function(v) {\n\t\tvar tagged = store.getTaggedTiddlers(v,\"title\");\n\t\tfor(var t=0; t<tagged.length; t++)\n\t\t\tstory.displayTiddler(\"bottom\",tagged[t].title,null,false,false);\n\t\t}\n};\n\nconfig.paramifiers.newTiddler = {\n\tonstart: function(v) {\n\t\tif(!readOnly)\n\t\t\t{\n\t\t\tstory.displayTiddler(null,v,DEFAULT_EDIT_TEMPLATE);\n\t\t\tstory.focusTiddler(v,\"text\");\n\t\t\t}\n\t\t}\n};\n\nconfig.paramifiers.newJournal = {\n\tonstart: function(v) {\n\t\tif(!readOnly)\n\t\t\t{\n\t\t\tvar now = new Date();\n\t\t\tvar title = now.formatString(v.trim());\n\t\t\tstory.displayTiddler(null,title,DEFAULT_EDIT_TEMPLATE);\n\t\t\tstory.focusTiddler(title,\"text\");\n\t\t\t}\n\t\t}\n};\n\n// ---------------------------------------------------------------------------------\n// Formatter helpers\n// ---------------------------------------------------------------------------------\n\nfunction Formatter(formatters)\n{\n\tthis.formatters = [];\n\tvar pattern = [];\n\tfor(var n=0; n<formatters.length; n++)\n\t\t{\n\t\tpattern.push(\"(\" + formatters[n].match + \")\");\n\t\tthis.formatters.push(formatters[n]);\n\t\t}\n\tthis.formatterRegExp = new RegExp(pattern.join(\"|\"),\"mg\");\n}\n\nconfig.formatterHelpers = {\n\n\tcreateElementAndWikify: function(w)\n\t{\n\t\tw.subWikifyTerm(createTiddlyElement(w.output,this.element),this.termRegExp);\n\t},\n\n\tinlineCssHelper: function(w)\n\t{\n\t\tvar styles = [];\n\t\tconfig.textPrimitives.cssLookaheadRegExp.lastIndex = w.nextMatch;\n\t\tvar lookaheadMatch = config.textPrimitives.cssLookaheadRegExp.exec(w.source);\n\t\twhile(lookaheadMatch && lookaheadMatch.index == w.nextMatch)\n\t\t\t{\n\t\t\tvar s,v;\n\t\t\tif(lookaheadMatch[1])\n\t\t\t\t{\n\t\t\t\ts = lookaheadMatch[1].unDash();\n\t\t\t\tv = lookaheadMatch[2];\n\t\t\t\t}\n\t\t\telse\n\t\t\t\t{\n\t\t\t\ts = lookaheadMatch[3].unDash();\n\t\t\t\tv = lookaheadMatch[4];\n\t\t\t\t}\n\t\t\tif (s==\"bgcolor\")\n\t\t\t\ts = \"backgroundColor\";\n\t\t\tstyles.push({style: s, value: v});\n\t\t\tw.nextMatch = lookaheadMatch.index + lookaheadMatch[0].length;\n\t\t\tconfig.textPrimitives.cssLookaheadRegExp.lastIndex = w.nextMatch;\n\t\t\tlookaheadMatch = config.textPrimitives.cssLookaheadRegExp.exec(w.source);\n\t\t\t}\n\t\treturn styles;\n\t},\n\n\tapplyCssHelper: function(e,styles)\n\t{\n\t\tfor(var t=0; t< styles.length; t++)\n\t\t\t{\n\t\t\ttry\n\t\t\t\t{\n\t\t\t\te.style[styles[t].style] = styles[t].value;\n\t\t\t\t}\n\t\t\tcatch (ex)\n\t\t\t\t{\n\t\t\t\t}\n\t\t\t}\n\t},\n\n\tenclosedTextHelper: function(w)\n\t{\n\t\tthis.lookaheadRegExp.lastIndex = w.matchStart;\n\t\tvar lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n\t\tif(lookaheadMatch && lookaheadMatch.index == w.matchStart)\n\t\t\t{\n\t\t\tvar text = lookaheadMatch[1];\n\t\t\tif(config.browser.isIE)\n\t\t\t\ttext = text.replace(/\\n/g,\"\\r\");\n\t\t\tcreateTiddlyElement(w.output,this.element,null,null,text);\n\t\t\tw.nextMatch = lookaheadMatch.index + lookaheadMatch[0].length;\n\t\t\t}\n\t},\n\n\tisExternalLink: function(link)\n\t{\n\t\tif(store.tiddlerExists(link) || store.isShadowTiddler(link))\n\t\t\t{\n\t\t\t//# Definitely not an external link\n\t\t\treturn false;\n\t\t\t}\n\t\tvar urlRegExp = new RegExp(config.textPrimitives.urlPattern,\"mg\");\n\t\tif(urlRegExp.exec(link))\n\t\t\t{\n\t\t\t// Definitely an external link\n\t\t\treturn true;\n\t\t\t}\n\t\tif (link.indexOf(\".\")!=-1 || link.indexOf(\"\\\\\")!=-1 || link.indexOf(\"/\")!=-1)\n\t\t\t{\n\t\t\t//# Link contains . / or \\ so is probably an external link\n\t\t\treturn true;\n\t\t\t}\n\t\t//# Otherwise assume it is not an external link\n\t\treturn false;\n\t}\n\n};\n\n// ---------------------------------------------------------------------------------\n// Standard formatters\n// ---------------------------------------------------------------------------------\n\nconfig.formatters = [\n{\n\tname: \"table\",\n\tmatch: \"^\\\\|(?:[^\\\\n]*)\\\\|(?:[fhck]?)$\",\n\tlookaheadRegExp: /^\\|([^\\n]*)\\|([fhck]?)$/mg,\n\trowTermRegExp: /(\\|(?:[fhck]?)$\\n?)/mg,\n\tcellRegExp: /(?:\\|([^\\n\\|]*)\\|)|(\\|[fhck]?$\\n?)/mg,\n\tcellTermRegExp: /((?:\\x20*)\\|)/mg,\n\trowTypes: {\"c\":\"caption\", \"h\":\"thead\", \"\":\"tbody\", \"f\":\"tfoot\"},\n\n\thandler: function(w)\n\t{\n\t\tvar table = createTiddlyElement(w.output,\"table\");\n\t\tvar prevColumns = [];\n\t\tvar currRowType = null;\n\t\tvar rowContainer;\n\t\tvar rowCount = 0;\n\t\tw.nextMatch = w.matchStart;\n\t\tthis.lookaheadRegExp.lastIndex = w.nextMatch;\n\t\tvar lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n\t\twhile(lookaheadMatch && lookaheadMatch.index == w.nextMatch)\n\t\t\t{\n\t\t\tvar nextRowType = lookaheadMatch[2];\n\t\t\tif(nextRowType == \"k\")\n\t\t\t\t{\n\t\t\t\ttable.className = lookaheadMatch[1];\n\t\t\t\tw.nextMatch += lookaheadMatch[0].length+1;\n\t\t\t\t}\n\t\t\telse\n\t\t\t\t{\n\t\t\t\tif(nextRowType != currRowType)\n\t\t\t\t\t{\n\t\t\t\t\trowContainer = createTiddlyElement(table,this.rowTypes[nextRowType]);\n\t\t\t\t\tcurrRowType = nextRowType;\n\t\t\t\t\t}\n\t\t\t\tif(currRowType == \"c\")\n\t\t\t\t\t{\n\t\t\t\t\t// Caption\n\t\t\t\t\tw.nextMatch++;\n\t\t\t\t\tif(rowContainer != table.firstChild)\n\t\t\t\t\t\ttable.insertBefore(rowContainer,table.firstChild);\n\t\t\t\t\trowContainer.setAttribute(\"align\",rowCount == 0?\"top\":\"bottom\");\n\t\t\t\t\tw.subWikifyTerm(rowContainer,this.rowTermRegExp);\n\t\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\tthis.rowHandler(w,createTiddlyElement(rowContainer,\"tr\",null,(rowCount&1)?\"oddRow\":\"evenRow\"),prevColumns);\n\t\t\t\t\trowCount++;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\tthis.lookaheadRegExp.lastIndex = w.nextMatch;\n\t\t\tlookaheadMatch = this.lookaheadRegExp.exec(w.source);\n\t\t\t}\n\t},\n\trowHandler: function(w,e,prevColumns)\n\t{\n\t\tvar col = 0;\n\t\tvar colSpanCount = 1;\n\t\tvar prevCell = null;\n\t\tthis.cellRegExp.lastIndex = w.nextMatch;\n\t\tvar cellMatch = this.cellRegExp.exec(w.source);\n\t\twhile(cellMatch && cellMatch.index == w.nextMatch)\n\t\t\t{\n\t\t\tif(cellMatch[1] == \"~\")\n\t\t\t\t{\n\t\t\t\t// Rowspan\n\t\t\t\tvar last = prevColumns[col];\n\t\t\t\tif(last)\n\t\t\t\t\t{\n\t\t\t\t\tlast.rowSpanCount++;\n\t\t\t\t\tlast.element.setAttribute(\"rowspan\",last.rowSpanCount);\n\t\t\t\t\tlast.element.setAttribute(\"rowSpan\",last.rowSpanCount); // Needed for IE\n\t\t\t\t\tlast.element.valign = \"center\";\n\t\t\t\t\t}\n\t\t\t\tw.nextMatch = this.cellRegExp.lastIndex-1;\n\t\t\t\t}\n\t\t\telse if(cellMatch[1] == \">\")\n\t\t\t\t{\n\t\t\t\t// Colspan\n\t\t\t\tcolSpanCount++;\n\t\t\t\tw.nextMatch = this.cellRegExp.lastIndex-1;\n\t\t\t\t}\n\t\t\telse if(cellMatch[2])\n\t\t\t\t{\n\t\t\t\t// End of row\n\t\t\t\tif(prevCell && colSpanCount > 1)\n\t\t\t\t\t{\n\t\t\t\t\tprevCell.setAttribute(\"colspan\",colSpanCount);\n\t\t\t\t\tprevCell.setAttribute(\"colSpan\",colSpanCount); // Needed for IE\n\t\t\t\t\t}\n\t\t\t\tw.nextMatch = this.cellRegExp.lastIndex;\n\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\telse\n\t\t\t\t{\n\t\t\t\t// Cell\n\t\t\t\tw.nextMatch++;\n\t\t\t\tvar styles = config.formatterHelpers.inlineCssHelper(w);\n\t\t\t\tvar spaceLeft = false;\n\t\t\t\tvar chr = w.source.substr(w.nextMatch,1);\n\t\t\t\twhile(chr == \" \")\n\t\t\t\t\t{\n\t\t\t\t\tspaceLeft = true;\n\t\t\t\t\tw.nextMatch++;\n\t\t\t\t\tchr = w.source.substr(w.nextMatch,1);\n\t\t\t\t\t}\n\t\t\t\tvar cell;\n\t\t\t\tif(chr == \"!\")\n\t\t\t\t\t{\n\t\t\t\t\tcell = createTiddlyElement(e,\"th\");\n\t\t\t\t\tw.nextMatch++;\n\t\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t\tcell = createTiddlyElement(e,\"td\");\n\t\t\t\tprevCell = cell;\n\t\t\t\tprevColumns[col] = {rowSpanCount:1, element:cell};\n\t\t\t\tif(colSpanCount > 1)\n\t\t\t\t\t{\n\t\t\t\t\tcell.setAttribute(\"colspan\",colSpanCount);\n\t\t\t\t\tcell.setAttribute(\"colSpan\",colSpanCount); // Needed for IE\n\t\t\t\t\tcolSpanCount = 1;\n\t\t\t\t\t}\n\t\t\t\tconfig.formatterHelpers.applyCssHelper(cell,styles);\n\t\t\t\tw.subWikifyTerm(cell,this.cellTermRegExp);\n\t\t\t\tif(w.matchText.substr(w.matchText.length-2,1) == \" \") // spaceRight\n\t\t\t\t\tcell.align = spaceLeft ? \"center\" : \"left\";\n\t\t\t\telse if(spaceLeft)\n\t\t\t\t\tcell.align = \"right\";\n\t\t\t\tw.nextMatch--;\n\t\t\t\t}\n\t\t\tcol++;\n\t\t\tthis.cellRegExp.lastIndex = w.nextMatch;\n\t\t\tcellMatch = this.cellRegExp.exec(w.source);\n\t\t\t}\n\t}\n},\n\n{\n\tname: \"heading\",\n\tmatch: \"^!{1,5}\",\n\ttermRegExp: /(\\n)/mg,\n\thandler: function(w)\n\t{\n\t\tw.subWikifyTerm(createTiddlyElement(w.output,\"h\" + w.matchLength),this.termRegExp);\n\t}\n},\n\n{\n\tname: \"list\",\n\tmatch: \"^(?:(?:(?:\\\\*)|(?:#)|(?:;)|(?::))+)\",\n\tlookaheadRegExp: /^(?:(?:(\\*)|(#)|(;)|(:))+)/mg,\n\ttermRegExp: /(\\n)/mg,\n\thandler: function(w)\n\t{\n\t\tvar placeStack = [w.output];\n\t\tvar currLevel = 0, currType = null;\n\t\tvar listLevel, listType, itemType;\n\t\tw.nextMatch = w.matchStart;\n\t\tthis.lookaheadRegExp.lastIndex = w.nextMatch;\n\t\tvar lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n\t\twhile(lookaheadMatch && lookaheadMatch.index == w.nextMatch)\n\t\t\t{\n\t\t\tif(lookaheadMatch[1])\n\t\t\t\t{\n\t\t\t\tlistType = \"ul\";\n\t\t\t\titemType = \"li\";\n\t\t\t\t}\n\t\t\telse if(lookaheadMatch[2])\n\t\t\t\t{\n\t\t\t\tlistType = \"ol\";\n\t\t\t\titemType = \"li\";\n\t\t\t\t}\n\t\t\telse if(lookaheadMatch[3])\n\t\t\t\t{\n\t\t\t\tlistType = \"dl\";\n\t\t\t\titemType = \"dt\";\n\t\t\t\t}\n\t\t\telse if(lookaheadMatch[4])\n\t\t\t\t{\n\t\t\t\tlistType = \"dl\";\n\t\t\t\titemType = \"dd\";\n\t\t\t\t}\n\t\t\tlistLevel = lookaheadMatch[0].length;\n\t\t\tw.nextMatch += lookaheadMatch[0].length;\n\t\t\tif(listLevel > currLevel)\n\t\t\t\t{\n\t\t\t\tfor(var t=currLevel; t<listLevel; t++)\n\t\t\t\t\tplaceStack.push(createTiddlyElement(placeStack[placeStack.length-1],listType));\n\t\t\t\t}\n\t\t\telse if(listLevel < currLevel)\n\t\t\t\t{\n\t\t\t\tfor(var t=currLevel; t>listLevel; t--)\n\t\t\t\t\tplaceStack.pop();\n\t\t\t\t}\n\t\t\telse if(listLevel == currLevel && listType != currType)\n\t\t\t\t{\n\t\t\t\tplaceStack.pop();\n\t\t\t\tplaceStack.push(createTiddlyElement(placeStack[placeStack.length-1],listType));\n\t\t\t\t}\n\t\t\tcurrLevel = listLevel;\n\t\t\tcurrType = listType;\n\t\t\tvar e = createTiddlyElement(placeStack[placeStack.length-1],itemType);\n\t\t\tw.subWikifyTerm(e,this.termRegExp);\n\t\t\tthis.lookaheadRegExp.lastIndex = w.nextMatch;\n\t\t\tlookaheadMatch = this.lookaheadRegExp.exec(w.source);\n\t\t}\n\t}\n},\n\n{\n\tname: \"quoteByBlock\",\n\tmatch: \"^<<<\\\\n\",\n\ttermRegExp: /(^<<<(\\n|$))/mg,\n\telement: \"blockquote\",\n\thandler: config.formatterHelpers.createElementAndWikify\n},\n\n{\n\tname: \"quoteByLine\",\n\tmatch: \"^>+\",\n\tlookaheadRegExp: /^>+/mg,\n\ttermRegExp: /(\\n)/mg,\n\telement: \"blockquote\",\n\thandler: function(w)\n\t{\n\t\tvar placeStack = [w.output];\n\t\tvar currLevel = 0;\n\t\tvar newLevel = w.matchLength;\n\t\tvar t;\n\t\tdo {\n\t\t\tif(newLevel > currLevel)\n\t\t\t\t{\n\t\t\t\tfor(t=currLevel; t<newLevel; t++)\n\t\t\t\t\tplaceStack.push(createTiddlyElement(placeStack[placeStack.length-1],this.element));\n\t\t\t\t}\n\t\t\telse if(newLevel < currLevel)\n\t\t\t\t{\n\t\t\t\tfor(t=currLevel; t>newLevel; t--)\n\t\t\t\t\tplaceStack.pop();\n\t\t\t\t}\n\t\t\tcurrLevel = newLevel;\n\t\t\tw.subWikifyTerm(placeStack[placeStack.length-1],this.termRegExp);\n\t\t\tcreateTiddlyElement(placeStack[placeStack.length-1],\"br\");\n\t\t\tthis.lookaheadRegExp.lastIndex = w.nextMatch;\n\t\t\tvar lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n\t\t\tvar matched = lookaheadMatch && lookaheadMatch.index == w.nextMatch;\n\t\t\tif(matched)\n\t\t\t\t{\n\t\t\t\tnewLevel = lookaheadMatch[0].length;\n\t\t\t\tw.nextMatch += lookaheadMatch[0].length;\n\t\t\t\t}\n\t\t} while(matched);\n\t}\n},\n\n{\n\tname: \"rule\",\n\tmatch: \"^----+$\\\\n?\",\n\thandler: function(w)\n\t{\n\t\tcreateTiddlyElement(w.output,\"hr\");\n\t}\n},\n\n{\n\tname: \"monospacedByLine\",\n\tmatch: \"^\\\\{\\\\{\\\\{\\\\n\",\n\tlookaheadRegExp: /^\\{\\{\\{\\n((?:^[^\\n]*\\n)+?)(^\\}\\}\\}$\\n?)/mg,\n\telement: \"pre\",\n\thandler: config.formatterHelpers.enclosedTextHelper\n},\n\n{\n\tname: \"monospacedByLineForCSS\",\n\tmatch: \"^/\\\\*[\\\\{]{3}\\\\*/\\\\n\",\n\tlookaheadRegExp: /\\/\\*[\\{]{3}\\*\\/\\n*((?:^[^\\n]*\\n)+?)(\\n*^\\/\\*[\\}]{3}\\*\\/$\\n?)/mg,\n\telement: \"pre\",\n\thandler: config.formatterHelpers.enclosedTextHelper\n},\n\n{\n\tname: \"monospacedByLineForPlugin\",\n\tmatch: \"^//\\\\{\\\\{\\\\{\\\\n\",\n\tlookaheadRegExp: /^\\/\\/\\{\\{\\{\\n\\n*((?:^[^\\n]*\\n)+?)(\\n*^\\/\\/\\}\\}\\}$\\n?)/mg,\n\telement: \"pre\",\n\thandler: config.formatterHelpers.enclosedTextHelper\n},\n\n{\n\tname: \"monospacedByLineForTemplate\",\n\tmatch: \"^<!--[\\\\{]{3}-->\\\\n\",\n\tlookaheadRegExp: /<!--[\\{]{3}-->\\n*((?:^[^\\n]*\\n)+?)(\\n*^<!--[\\}]{3}-->$\\n?)/mg,\n\telement: \"pre\",\n\thandler: config.formatterHelpers.enclosedTextHelper\n},\n\n{\n\tname: \"wikifyCommentForPlugin\",\n\tmatch: \"^/\\\\*\\\\*\\\\*\\\\n\",\n\ttermRegExp: /(^\\*\\*\\*\\/\\n)/mg,\n\thandler: function(w)\n\t{\n\t\tw.subWikifyTerm(w.output,this.termRegExp);\n\t}\n},\n\n{\n\tname: \"wikifyCommentForTemplate\",\n\tmatch: \"^<!---\\\\n\",\n\ttermRegExp: /(^--->\\n)/mg,\n\thandler: function(w)\n\t{\n\t\tw.subWikifyTerm(w.output,this.termRegExp);\n\t}\n},\n\n{\n\tname: \"macro\",\n\tmatch: \"<<\",\n\tlookaheadRegExp: /<<([^>\\s]+)(?:\\s*)((?:[^>]|(?:>(?!>)))*)>>/mg,\n\thandler: function(w)\n\t{\n\t\tthis.lookaheadRegExp.lastIndex = w.matchStart;\n\t\tvar lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n\t\tif(lookaheadMatch && lookaheadMatch.index == w.matchStart && lookaheadMatch[1])\n\t\t\t{\n\t\t\tw.nextMatch = this.lookaheadRegExp.lastIndex;\n\t\t\tinvokeMacro(w.output,lookaheadMatch[1],lookaheadMatch[2],w,w.tiddler);\n\t\t\t}\n\t}\n},\n\n{\n\tname: \"prettyLink\",\n\tmatch: \"\\\\[\\\\[\",\n\tlookaheadRegExp: /\\[\\[(.*?)(?:\\|(~)?(.*?))?\\]\\]/mg,\n\thandler: function(w)\n\t{\n\t\tthis.lookaheadRegExp.lastIndex = w.matchStart;\n\t\tvar lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n\t\tif(lookaheadMatch && lookaheadMatch.index == w.matchStart)\n\t\t\t{\n\t\t\tvar e;\n\t\t\tvar text = lookaheadMatch[1];\n\t\t\tif(lookaheadMatch[3])\n\t\t\t\t{\n\t\t\t\t// Pretty bracketted link\n\t\t\t\tvar link = lookaheadMatch[3];\n\t\t\t\te = (!lookaheadMatch[2] && config.formatterHelpers.isExternalLink(link))\n\t\t\t\t\t\t? createExternalLink(w.output,link)\n\t\t\t\t\t\t: createTiddlyLink(w.output,link,false,null,w.isStatic);\n\t\t\t\t}\n\t\t\telse\n\t\t\t\t{\n\t\t\t\t// Simple bracketted link\n\t\t\t\te = createTiddlyLink(w.output,text,false,null,w.isStatic);\n\t\t\t\t}\n\t\t\tcreateTiddlyText(e,text);\n\t\t\tw.nextMatch = this.lookaheadRegExp.lastIndex;\n\t\t\t}\n\t}\n},\n\n{\n\tname: \"unWikiLink\",\n\tmatch: config.textPrimitives.unWikiLink+config.textPrimitives.wikiLink,\n\thandler: function(w)\n\t{\n\t\tw.outputText(w.output,w.matchStart+1,w.nextMatch);\n\t}\n},\n\n{\n\tname: \"wikiLink\",\n\tmatch: config.textPrimitives.wikiLink,\n\thandler: function(w)\n\t{\n\t\tif(w.matchStart > 0)\n\t\t\t{\n\t\t\tvar preRegExp = new RegExp(config.textPrimitives.anyLetterStrict,\"mg\");\n\t\t\tpreRegExp.lastIndex = w.matchStart-1;\n\t\t\tvar preMatch = preRegExp.exec(w.source);\n\t\t\tif(preMatch.index == w.matchStart-1)\n\t\t\t\t{\n\t\t\t\tw.outputText(w.output,w.matchStart,w.nextMatch);\n\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\t\tif(w.autoLinkWikiWords == true || store.isShadowTiddler(w.matchText))\n\t\t\t{\n\t\t\tvar link = createTiddlyLink(w.output,w.matchText,false,null,w.isStatic);\n\t\t\tw.outputText(link,w.matchStart,w.nextMatch);\n\t\t\t}\n\t\telse\n\t\t\t{\n\t\t\tw.outputText(w.output,w.matchStart,w.nextMatch);\n\t\t\t}\n\t}\n},\n\n{\n\tname: \"urlLink\",\n\tmatch: config.textPrimitives.urlPattern,\n\thandler: function(w)\n\t{\n\t\tw.outputText(createExternalLink(w.output,w.matchText),w.matchStart,w.nextMatch);\n\t}\n},\n\n{\n\tname: \"image\",\n\tmatch: \"\\\\[[<>]?[Ii][Mm][Gg]\\\\[\",\n\tlookaheadRegExp: /\\[(<?)(>?)[Ii][Mm][Gg]\\[(?:([^\\|\\]]+)\\|)?([^\\[\\]\\|]+)\\](?:\\[([^\\]]*)\\])?\\]/mg,\n\thandler: function(w)\n\t{\n\t\tthis.lookaheadRegExp.lastIndex = w.matchStart;\n\t\tvar lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n\t\tif(lookaheadMatch && lookaheadMatch.index == w.matchStart) // Simple bracketted link\n\t\t\t{\n\t\t\tvar e = w.output;\n\t\t\tif(lookaheadMatch[5])\n\t\t\t\t{\n\t\t\t\tvar link = lookaheadMatch[5];\n\t\t\t\te = config.formatterHelpers.isExternalLink(link) ? createExternalLink(w.output,link) : createTiddlyLink(w.output,link,false,null,w.isStatic);\n\t\t\t\taddClass(e,\"imageLink\");\n\t\t\t\t}\n\t\t\tvar img = createTiddlyElement(e,\"img\");\n\t\t\tif(lookaheadMatch[1])\n\t\t\t\timg.align = \"left\";\n\t\t\telse if(lookaheadMatch[2])\n\t\t\t\timg.align = \"right\";\n\t\t\tif(lookaheadMatch[3])\n\t\t\t\timg.title = lookaheadMatch[3];\n\t\t\timg.src = lookaheadMatch[4];\n\t\t\tw.nextMatch = this.lookaheadRegExp.lastIndex;\n\t\t\t}\n\t}\n},\n\n{\n\tname: \"html\",\n\tmatch: \"<[Hh][Tt][Mm][Ll]>\",\n\tlookaheadRegExp: /<[Hh][Tt][Mm][Ll]>((?:.|\\n)*?)<\\/[Hh][Tt][Mm][Ll]>/mg,\n\thandler: function(w)\n\t{\n\t\tthis.lookaheadRegExp.lastIndex = w.matchStart;\n\t\tvar lookaheadMatch = this.lookaheadRegExp.exec(w.source)\n\t\tif(lookaheadMatch && lookaheadMatch.index == w.matchStart)\n\t\t\t{\n\t\t\tcreateTiddlyElement(w.output,\"span\").innerHTML = lookaheadMatch[1];\n\t\t\tw.nextMatch = this.lookaheadRegExp.lastIndex;\n\t\t\t}\n\t}\n},\n\n{\n\tname: \"commentByBlock\",\n\tmatch: \"/%\",\n\tlookaheadRegExp: /\\/%((?:.|\\n)*?)%\\//mg,\n\thandler: function(w)\n\t{\n\t\tthis.lookaheadRegExp.lastIndex = w.matchStart;\n\t\tvar lookaheadMatch = this.lookaheadRegExp.exec(w.source)\n\t\tif(lookaheadMatch && lookaheadMatch.index == w.matchStart)\n\t\t\tw.nextMatch = this.lookaheadRegExp.lastIndex;\n\t}\n},\n\n{\n\tname: \"boldByChar\",\n\tmatch: \"''\",\n\ttermRegExp: /('')/mg,\n\telement: \"strong\",\n\thandler: config.formatterHelpers.createElementAndWikify\n},\n\n{\n\tname: \"italicByChar\",\n\tmatch: \"//\",\n\ttermRegExp: /(\\/\\/)/mg,\n\telement: \"em\",\n\thandler: config.formatterHelpers.createElementAndWikify\n},\n\n{\n\tname: \"underlineByChar\",\n\tmatch: \"__\",\n\ttermRegExp: /(__)/mg,\n\telement: \"u\",\n\thandler: config.formatterHelpers.createElementAndWikify\n},\n\n{\n\tname: \"strikeByChar\",\n\tmatch: \"--(?!\\\\s|$)\",\n\ttermRegExp: /((?!\\s)--|(?=\\n\\n))/mg,\n\telement: \"strike\",\n\thandler: config.formatterHelpers.createElementAndWikify\n},\n\n{\n\tname: \"superscriptByChar\",\n\tmatch: \"\\\\^\\\\^\",\n\ttermRegExp: /(\\^\\^)/mg,\n\telement: \"sup\",\n\thandler: config.formatterHelpers.createElementAndWikify\n},\n\n{\n\tname: \"subscriptByChar\",\n\tmatch: \"~~\",\n\ttermRegExp: /(~~)/mg,\n\telement: \"sub\",\n\thandler: config.formatterHelpers.createElementAndWikify\n},\n\n{\n\tname: \"monospacedByChar\",\n\tmatch: \"\\\\{\\\\{\\\\{\",\n\tlookaheadRegExp: /\\{\\{\\{((?:.|\\n)*?)\\}\\}\\}/mg,\n\thandler: function(w)\n\t{\n\t\tthis.lookaheadRegExp.lastIndex = w.matchStart;\n\t\tvar lookaheadMatch = this.lookaheadRegExp.exec(w.source)\n\t\tif(lookaheadMatch && lookaheadMatch.index == w.matchStart)\n\t\t\t{\n\t\t\tcreateTiddlyElement(w.output,\"code\",null,null,lookaheadMatch[1]);\n\t\t\tw.nextMatch = this.lookaheadRegExp.lastIndex;\n\t\t\t}\n\t}\n},\n\n{\n\tname: \"styleByChar\",\n\tmatch: \"@@\",\n\ttermRegExp: /(@@)/mg,\n\thandler:  function(w)\n\t{\n\t\tvar e = createTiddlyElement(w.output,\"span\");\n\t\tvar styles = config.formatterHelpers.inlineCssHelper(w);\n\t\tif(styles.length == 0)\n\t\t\te.className = \"marked\";\n\t\telse\n\t\t\tconfig.formatterHelpers.applyCssHelper(e,styles);\n\t\tw.subWikifyTerm(e,this.termRegExp);\n\t}\n},\n\n{\n\tname: \"lineBreak\",\n\tmatch: \"\\\\n|<br ?/?>\",\n\thandler: function(w)\n\t{\n\t\tcreateTiddlyElement(w.output,\"br\");\n\t}\n},\n\n{\n\tname: \"rawText\",\n\tmatch: \"\\\\\\\"{3}|<nowiki>\",\n\tlookaheadRegExp: /(?:\\\"{3}|<nowiki>)((?:.|\\n)*?)(?:\\\"{3}|<\\/nowiki>)/mg,\n\thandler: function(w)\n\t{\n\t\tthis.lookaheadRegExp.lastIndex = w.matchStart;\n\t\tvar lookaheadMatch = this.lookaheadRegExp.exec(w.source)\n\t\tif(lookaheadMatch && lookaheadMatch.index == w.matchStart)\n\t\t\t{\n\t\t\tcreateTiddlyElement(w.output,\"span\",null,null,lookaheadMatch[1]);\n\t\t\tw.nextMatch = this.lookaheadRegExp.lastIndex;\n\t\t\t}\n\t}\n},\n\n{\n\tname: \"mdash\",\n\tmatch: \"--\",\n\thandler: function(w)\n\t\t{\n\t\tcreateTiddlyElement(w.output,\"span\").innerHTML = \"&mdash;\";\n\t\t}\n},\n\n{\n\tname: \"htmlEntitiesEncoding\",\n\tmatch: \"(?:(?:&#?[a-zA-Z0-9]{2,8};|.)(?:&#?(?:x0*(?:3[0-6][0-9a-fA-F]|1D[c-fC-F][0-9a-fA-F]|20[d-fD-F][0-9a-fA-F]|FE2[0-9a-fA-F])|0*(?:76[89]|7[7-9][0-9]|8[0-7][0-9]|761[6-9]|76[2-7][0-9]|84[0-3][0-9]|844[0-7]|6505[6-9]|6506[0-9]|6507[0-1]));)+|&#?[a-zA-Z0-9]{2,8};)\",\n\thandler: function(w)\n\t\t{\n\t\tcreateTiddlyElement(w.output,\"span\").innerHTML = w.matchText;\n\t\t}\n},\n\n{\n\tname: \"customClasses\",\n\tmatch: \"\\\\{\\\\{\",\n\ttermRegExp: /(\\}\\}\\})/mg,\n\tlookaheadRegExp: /\\{\\{[\\s]*([\\w]+[\\s\\w]*)[\\s]*\\{(\\n?)/mg,\n\thandler: function(w)\n\t{\n\t\tthis.lookaheadRegExp.lastIndex = w.matchStart;\n\t\tvar lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n\t\tif(lookaheadMatch)\n\t\t\t{\n\t\t\tvar e = createTiddlyElement(w.output,lookaheadMatch[2] == \"\\n\" ? \"div\" : \"span\",null,lookaheadMatch[1]);\n\t\t\tw.nextMatch = this.lookaheadRegExp.lastIndex;\n\t\t\tw.subWikifyTerm(e,this.termRegExp);\n\t\t\t}\n\t}\n}\n\n];\n\n// ---------------------------------------------------------------------------------\n// Wikifier\n// ---------------------------------------------------------------------------------\n\nfunction getParser(tiddler)\n{\n\tvar f = formatter;\n\tif(tiddler!=null)\n\t\t{\n\t\tfor(var i in config.parsers)\n\t\t\t{\n\t\t\tif(tiddler.isTagged(config.parsers[i].formatTag))\n\t\t\t\t{\n\t\t\t\tf = config.parsers[i];\n\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\treturn f;\n}\n\nfunction wikify(source,output,highlightRegExp,tiddler)\n{\n\tif(source && source != \"\")\n\t\t{\n\t\tvar wikifier = new Wikifier(source,getParser(tiddler),highlightRegExp,tiddler);\n\t\twikifier.subWikifyUnterm(output);\n\t\t}\n}\n\nfunction wikifyStatic(source,highlightRegExp,tiddler)\n{\n\tvar e = createTiddlyElement(document.body,\"div\");\n\te.style.display = \"none\";\n\tvar html = \"\";\n\tif(source && source != \"\")\n\t\t{\n\t\tvar wikifier = new Wikifier(source,getParser(tiddler),highlightRegExp,tiddler);\n\t\twikifier.isStatic = true;\n\t\twikifier.subWikifyUnterm(e);\n\t\thtml = e.innerHTML;\n\t\te.parentNode.removeChild(e);\n\t\t}\n\treturn html;\n}\n\n// Wikify a named tiddler to plain text\nfunction wikifyPlain(title)\n{\n\tif(store.tiddlerExists(title) || store.isShadowTiddler(title))\n\t\t{\n\t\tvar wikifier = new Wikifier(store.getTiddlerText(title),formatter,null,store.getTiddler(title));\n\t\treturn wikifier.wikifyPlain();\n\t\t}\n\telse\n\t\treturn \"\";\n}\n\n// Highlight plain text into an element\nfunction highlightify(source,output,highlightRegExp)\n{\n\tif(source && source != \"\")\n\t\t{\n\t\tvar wikifier = new Wikifier(source,formatter,highlightRegExp);\n\t\twikifier.outputText(output,0,source.length);\n\t\t}\n}\n\n// Construct a wikifier object\n// source - source string that's going to be wikified\n// formatter - Formatter() object containing the list of formatters to be used\n// highlightRegExp - regular expression of the text string to highlight\n// tiddler - reference to the tiddler that's taken to be the container for this wikification\nfunction Wikifier(source,formatter,highlightRegExp,tiddler)\n{\n\tthis.source = source;\n\tthis.output = null;\n\tthis.formatter = formatter;\n\tthis.nextMatch = 0;\n\tthis.autoLinkWikiWords = tiddler && tiddler.autoLinkWikiWords() == false ? false : true;\n\tthis.highlightRegExp = highlightRegExp;\n\tthis.highlightMatch = null;\n\tthis.isStatic = false;\n\tif(highlightRegExp)\n\t\t{\n\t\thighlightRegExp.lastIndex = 0;\n\t\tthis.highlightMatch = highlightRegExp.exec(source);\n\t\t}\n\tthis.tiddler = tiddler;\n}\n\nWikifier.prototype.wikifyPlain = function()\n{\n\tvar e = createTiddlyElement(document.body,\"div\");\n\te.style.display = \"none\";\n\tthis.subWikify(e);\n\tvar text = getPlainText(e);\n\te.parentNode.removeChild(e);\n\treturn text;\n}\n\nWikifier.prototype.subWikify = function(output,terminator)\n{\n\t// Handle the terminated and unterminated cases separately\n\tif (terminator)\n\t\tthis.subWikifyTerm(output,new RegExp(\"(\" + terminator + \")\",\"mg\"));\n\telse\n\t\tthis.subWikifyUnterm(output);\n}\n\nWikifier.prototype.subWikifyUnterm = function(output)\n{\n\t// subWikify() can be indirectly recursive, so we need to save the old output pointer\n\tvar oldOutput = this.output;\n\tthis.output = output;\n\t// Get the first match\n\tthis.formatter.formatterRegExp.lastIndex = this.nextMatch;\n\tvar formatterMatch = this.formatter.formatterRegExp.exec(this.source);\n\twhile(formatterMatch)\n\t\t{\n\t\t// Output any text before the match\n\t\tif(formatterMatch.index > this.nextMatch)\n\t\t\tthis.outputText(this.output,this.nextMatch,formatterMatch.index);\n\t\t// Set the match parameters for the handler\n\t\tthis.matchStart = formatterMatch.index;\n\t\tthis.matchLength = formatterMatch[0].length;\n\t\tthis.matchText = formatterMatch[0];\n\t\tthis.nextMatch = this.formatter.formatterRegExp.lastIndex;\n\t\t// Figure out which formatter matched and call its handler\n\t\tfor(var t=1; t<formatterMatch.length; t++)\n\t\t\t{\n\t\t\tif(formatterMatch[t])\n\t\t\t\t{\n\t\t\t\tthis.formatter.formatters[t-1].handler(this);\n\t\t\t\tthis.formatter.formatterRegExp.lastIndex = this.nextMatch;\n\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t// Get the next match\n\t\tformatterMatch = this.formatter.formatterRegExp.exec(this.source);\n\t\t}\n\t// Output any text after the last match\n\tif(this.nextMatch < this.source.length)\n\t\t{\n\t\tthis.outputText(this.output,this.nextMatch,this.source.length);\n\t\tthis.nextMatch = this.source.length;\n\t\t}\n\t// Restore the output pointer\n\tthis.output = oldOutput;\n}\n\nWikifier.prototype.subWikifyTerm = function(output,terminatorRegExp)\n{\n\t// subWikify() can be indirectly recursive, so we need to save the old output pointer\n\tvar oldOutput = this.output;\n\tthis.output = output;\n\t// Get the first matches for the formatter and terminator RegExps\n\tterminatorRegExp.lastIndex = this.nextMatch;\n\tvar terminatorMatch = terminatorRegExp.exec(this.source);\n\tthis.formatter.formatterRegExp.lastIndex = this.nextMatch;\n\tvar formatterMatch = this.formatter.formatterRegExp.exec(terminatorMatch ? this.source.substr(0,terminatorMatch.index) : this.source);\n\twhile(terminatorMatch || formatterMatch)\n\t\t{\n\t\t// Check for a terminator match  before the next formatter match\n\t\tif(terminatorMatch && (!formatterMatch || terminatorMatch.index <= formatterMatch.index))\n\t\t\t{\n\t\t\t// Output any text before the match\n\t\t\tif(terminatorMatch.index > this.nextMatch)\n\t\t\t\tthis.outputText(this.output,this.nextMatch,terminatorMatch.index);\n\t\t\t// Set the match parameters\n\t\t\tthis.matchText = terminatorMatch[1];\n\t\t\tthis.matchLength = terminatorMatch[1].length;\n\t\t\tthis.matchStart = terminatorMatch.index;\n\t\t\tthis.nextMatch = this.matchStart + this.matchLength;\n\t\t\t// Restore the output pointer\n\t\t\tthis.output = oldOutput;\n\t\t\treturn;\n\t\t\t}\n\t\t// It must be a formatter match; output any text before the match\n\t\tif(formatterMatch.index > this.nextMatch)\n\t\t\tthis.outputText(this.output,this.nextMatch,formatterMatch.index);\n\t\t// Set the match parameters\n\t\tthis.matchStart = formatterMatch.index;\n\t\tthis.matchLength = formatterMatch[0].length;\n\t\tthis.matchText = formatterMatch[0];\n\t\tthis.nextMatch = this.formatter.formatterRegExp.lastIndex;\n\t\t// Figure out which formatter matched and call its handler\n\t\tfor(var t=1; t<formatterMatch.length; t++)\n\t\t\t{\n\t\t\tif(formatterMatch[t])\n\t\t\t\t{\n\t\t\t\tthis.formatter.formatters[t-1].handler(this);\n\t\t\t\tthis.formatter.formatterRegExp.lastIndex = this.nextMatch;\n\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t// Get the next match\n\t\tterminatorRegExp.lastIndex = this.nextMatch;\n\t\tterminatorMatch = terminatorRegExp.exec(this.source);\n\t\tformatterMatch = this.formatter.formatterRegExp.exec(terminatorMatch ? this.source.substr(0,terminatorMatch.index) : this.source);\n\t\t}\n\t// Output any text after the last match\n\tif(this.nextMatch < this.source.length)\n\t\t{\n\t\tthis.outputText(this.output,this.nextMatch,this.source.length);\n\t\tthis.nextMatch = this.source.length;\n\t\t}\n\t// Restore the output pointer\n\tthis.output = oldOutput;\n}\n\nWikifier.prototype.outputText = function(place,startPos,endPos)\n{\n\t// Check for highlights\n\twhile(this.highlightMatch && (this.highlightRegExp.lastIndex > startPos) && (this.highlightMatch.index < endPos) && (startPos < endPos))\n\t\t{\n\t\t// Deal with any plain text before the highlight\n\t\tif(this.highlightMatch.index > startPos)\n\t\t\t{\n\t\t\tcreateTiddlyText(place,this.source.substring(startPos,this.highlightMatch.index));\n\t\t\tstartPos = this.highlightMatch.index;\n\t\t\t}\n\t\t// Deal with the highlight\n\t\tvar highlightEnd = Math.min(this.highlightRegExp.lastIndex,endPos);\n\t\tvar theHighlight = createTiddlyElement(place,\"span\",null,\"highlight\",this.source.substring(startPos,highlightEnd));\n\t\tstartPos = highlightEnd;\n\t\t// Nudge along to the next highlight if we're done with this one\n\t\tif(startPos >= this.highlightRegExp.lastIndex)\n\t\t\tthis.highlightMatch = this.highlightRegExp.exec(this.source);\n\t\t}\n\t// Do the unhighlighted text left over\n\tif(startPos < endPos)\n\t\t{\n\t\tcreateTiddlyText(place,this.source.substring(startPos,endPos));\n\t\t}\n}\n\n// ---------------------------------------------------------------------------------\n// Macro definitions\n// ---------------------------------------------------------------------------------\n\nconfig.macros.today.handler = function(place,macroName,params)\n{\n\tvar now = new Date();\n\tvar text;\n\tif(params[0])\n\t\ttext = now.formatString(params[0].trim());\n\telse\n\t\ttext = now.toLocaleString();\n\tcreateTiddlyElement(place,\"span\",null,null,text);\n}\n\nconfig.macros.version.handler = function(place)\n{\n\tcreateTiddlyElement(place,\"span\",null,null,version.major + \".\" + version.minor + \".\" + version.revision + (version.beta ? \" (beta \" + version.beta + \")\" : \"\"));\n}\n\nconfig.macros.list.handler = function(place,macroName,params)\n{\n\tvar type = params[0] ? params[0] : \"all\";\n\tvar theList = document.createElement(\"ul\");\n\tplace.appendChild(theList);\n\tif(this[type].prompt)\n\t\tcreateTiddlyElement(theList,\"li\",null,\"listTitle\",this[type].prompt);\n\tvar results;\n\tif(this[type].handler)\n\t\tresults = this[type].handler(params);\n\tfor(var t = 0; t < results.length; t++)\n\t\t{\n\t\tvar theListItem = document.createElement(\"li\")\n\t\ttheList.appendChild(theListItem);\n\t\tif(typeof results[t] == \"string\")\n\t\t\tcreateTiddlyLink(theListItem,results[t],true);\n\t\telse\n\t\t\tcreateTiddlyLink(theListItem,results[t].title,true);\n\t\t}\n}\n\nconfig.macros.list.all.handler = function(params)\n{\n\treturn store.reverseLookup(\"tags\",\"excludeLists\",false,\"title\");\n}\n\nconfig.macros.list.missing.handler = function(params)\n{\n\treturn store.getMissingLinks();\n}\n\nconfig.macros.list.orphans.handler = function(params)\n{\n\treturn store.getOrphans();\n}\n\nconfig.macros.list.shadowed.handler = function(params)\n{\n\treturn store.getShadowed();\n}\n\nconfig.macros.allTags.handler = function(place,macroName,params)\n{\n\tvar tags = store.getTags();\n\tvar theDateList = createTiddlyElement(place,\"ul\");\n\tif(tags.length == 0)\n\t\tcreateTiddlyElement(theDateList,\"li\",null,\"listTitle\",this.noTags);\n\tfor(var t=0; t<tags.length; t++)\n\t\t{\n\t\tvar theListItem =createTiddlyElement(theDateList,\"li\");\n\t\tvar theTag = createTiddlyButton(theListItem,tags[t][0] + \" (\" + tags[t][1] + \")\",this.tooltip.format([tags[t][0]]),onClickTag);\n\t\ttheTag.setAttribute(\"tag\",tags[t][0]);\n\t\t}\n}\n\nconfig.macros.timeline.handler = function(place,macroName,params)\n{\n\tvar field = params[0] ? params[0] : \"modified\";\n\tvar tiddlers = store.reverseLookup(\"tags\",\"excludeLists\",false,field);\n\tvar lastDay = \"\";\n\tvar last = params[1] ? tiddlers.length-Math.min(tiddlers.length,parseInt(params[1])) : 0;\n\tfor(var t=tiddlers.length-1; t>=last; t--)\n\t\t{\n\t\tvar tiddler = tiddlers[t];\n\t\tvar theDay = tiddler[field].convertToLocalYYYYMMDDHHMM().substr(0,8);\n\t\tif(theDay != lastDay)\n\t\t\t{\n\t\t\tvar theDateList = document.createElement(\"ul\");\n\t\t\tplace.appendChild(theDateList);\n\t\t\tcreateTiddlyElement(theDateList,\"li\",null,\"listTitle\",tiddler[field].formatString(this.dateFormat));\n\t\t\tlastDay = theDay;\n\t\t\t}\n\t\tvar theDateListItem = createTiddlyElement(theDateList,\"li\",null,\"listLink\");\n\t\ttheDateListItem.appendChild(createTiddlyLink(place,tiddler.title,true));\n\t\t}\n}\n\nconfig.macros.search.handler = function(place,macroName,params)\n{\n\tvar searchTimeout = null;\n\tvar btn = createTiddlyButton(place,this.label,this.prompt,this.onClick);\n\tvar txt = createTiddlyElement(place,\"input\",null,\"txtOptionInput\");\n\tif(params[0])\n\t\ttxt.value = params[0];\n\ttxt.onkeyup = this.onKeyPress;\n\ttxt.onfocus = this.onFocus;\n\ttxt.setAttribute(\"size\",this.sizeTextbox);\n\ttxt.setAttribute(\"accessKey\",this.accessKey);\n\ttxt.setAttribute(\"autocomplete\",\"off\");\n\ttxt.setAttribute(\"lastSearchText\",\"\");\n\tif(config.browser.isSafari)\n\t\t{\n\t\ttxt.setAttribute(\"type\",\"search\");\n\t\ttxt.setAttribute(\"results\",\"5\");\n\t\t}\n\telse\n\t\ttxt.setAttribute(\"type\",\"text\");\n}\n\n// Global because there's only ever one outstanding incremental search timer\nconfig.macros.search.timeout = null;\n\nconfig.macros.search.doSearch = function(txt)\n{\n\tif(txt.value.length > 0)\n\t\t{\n\t\tstory.search(txt.value,config.options.chkCaseSensitiveSearch,config.options.chkRegExpSearch);\n\t\ttxt.setAttribute(\"lastSearchText\",txt.value);\n\t\t}\n}\n\nconfig.macros.search.onClick = function(e)\n{\n\tconfig.macros.search.doSearch(this.nextSibling);\n\treturn false;\n}\n\nconfig.macros.search.onKeyPress = function(e)\n{\n\tif(!e) var e = window.event;\n\tswitch(e.keyCode)\n\t\t{\n\t\tcase 13: // Ctrl-Enter\n\t\tcase 10: // Ctrl-Enter on IE PC\n\t\t\tconfig.macros.search.doSearch(this);\n\t\t\tbreak;\n\t\tcase 27: // Escape\n\t\t\tthis.value = \"\";\n\t\t\tclearMessage();\n\t\t\tbreak;\n\t\t}\n\tif(this.value.length > 2)\n\t\t{\n\t\tif(this.value != this.getAttribute(\"lastSearchText\"))\n\t\t\t{\n\t\t\tif(config.macros.search.timeout)\n\t\t\t\tclearTimeout(config.macros.search.timeout);\n\t\t\tvar txt = this;\n\t\t\tconfig.macros.search.timeout = setTimeout(function() {config.macros.search.doSearch(txt);},500);\n\t\t\t}\n\t\t}\n\telse\n\t\t{\n\t\tif(config.macros.search.timeout)\n\t\t\tclearTimeout(config.macros.search.timeout);\n\t\t}\n}\n\nconfig.macros.search.onFocus = function(e)\n{\n\tthis.select();\n}\n\nconfig.macros.tiddler.handler = function(place,macroName,params,wikifier,paramString,tiddler)\n{\n\tparams = paramString.parseParams(\"name\",null,true,false,true);\n\tvar names = params[0][\"name\"];\n\tvar tiddlerName = names[0];\n\tvar className = names[1] ? names[1] : null;\n\tvar args = params[0][\"with\"];\n\tvar wrapper = createTiddlyElement(place,\"span\",null,className);\n\tif(!args)\n\t\t{\n\t\twrapper.setAttribute(\"refresh\",\"content\");\n\t\twrapper.setAttribute(\"tiddler\",tiddlerName);\n\t\t}\n\tvar text = store.getTiddlerText(tiddlerName);\n\tif(text)\n\t\t{\n\t\tvar stack = config.macros.tiddler.tiddlerStack;\n\t\tif(stack.indexOf(tiddlerName) !== -1)\n\t\t\treturn;\n\t\tstack.push(tiddlerName);\n\t\ttry\n\t\t\t{\n\t\t\tvar n = args ? Math.min(args.length,9) : 0;\n\t\t\tfor(var i=0; i<n; i++)\n\t\t\t\t{\n\t\t\t\tvar placeholderRE = new RegExp(\"\\\\$\" + (i + 1),\"mg\");\n\t\t\t\ttext = text.replace(placeholderRE,args[i]);\n\t\t\t\t}\n\t\t\tconfig.macros.tiddler.renderText(wrapper,text,tiddlerName,params);\n\t\t\t}\n\t\tfinally\n\t\t\t{\n\t\t\tstack.pop();\n\t\t\t}\n\t\t}\n}\n\nconfig.macros.tiddler.renderText = function(place,text,tiddlerName,params)\n{\n\twikify(text,place,null,store.getTiddler(tiddlerName));\n}\n\nconfig.macros.tiddler.tiddlerStack = [];\n\nconfig.macros.tag.handler = function(place,macroName,params)\n{\n\tcreateTagButton(place,params[0]);\n}\n\nconfig.macros.tags.handler = function(place,macroName,params,wikifier,paramString,tiddler)\n{\n\tparams = paramString.parseParams(\"anon\",null,true,false,false);\n\tvar theList = createTiddlyElement(place,\"ul\");\n\tvar title = getParam(params,\"anon\",\"\");\n\tif(title && store.tiddlerExists(title))\n\t\ttiddler = store.getTiddler(title);\n\tvar sep = getParam(params,\"sep\",\" \");\n\tvar lingo = config.views.wikified.tag;\n\tvar prompt = tiddler.tags.length == 0 ? lingo.labelNoTags : lingo.labelTags;\n\tcreateTiddlyElement(theList,\"li\",null,\"listTitle\",prompt.format([tiddler.title]));\n\tfor(var t=0; t<tiddler.tags.length; t++)\n\t\t{\n\t\tcreateTagButton(createTiddlyElement(theList,\"li\"),tiddler.tags[t],tiddler.title);\n\t\tif(t<tiddler.tags.length-1)\n\t\t\tcreateTiddlyText(theList,sep);\n\t\t}\n}\n\nconfig.macros.tagging.handler = function(place,macroName,params,wikifier,paramString,tiddler)\n{\n\tparams = paramString.parseParams(\"anon\",null,true,false,false);\n\tvar theList = createTiddlyElement(place,\"ul\");\n\tvar title = getParam(params,\"anon\",\"\");\n\tif(title == \"\" && tiddler instanceof Tiddler)\n\t\ttitle = tiddler.title;\n\tvar sep = getParam(params,\"sep\",\" \");\n\ttheList.setAttribute(\"title\",this.tooltip.format([title]));\n\tvar tagged = store.getTaggedTiddlers(title);\n\tvar prompt = tagged.length == 0 ? this.labelNotTag : this.label;\n\tcreateTiddlyElement(theList,\"li\",null,\"listTitle\",prompt.format([title,tagged.length]));\n\tfor(var t=0; t<tagged.length; t++)\n\t\t{\n\t\tcreateTiddlyLink(createTiddlyElement(theList,\"li\"),tagged[t].title,true);\n\t\tif(t<tagged.length-1)\n\t\t\tcreateTiddlyText(theList,sep);\n\t\t}\n}\n\nconfig.macros.closeAll.handler = function(place)\n{\n\tcreateTiddlyButton(place,this.label,this.prompt,this.onClick);\n}\n\nconfig.macros.closeAll.onClick = function(e)\n{\n\tstory.closeAllTiddlers();\n\treturn false;\n}\n\nconfig.macros.permaview.handler = function(place)\n{\n\tcreateTiddlyButton(place,this.label,this.prompt,this.onClick);\n}\n\nconfig.macros.permaview.onClick = function(e)\n{\n\tstory.permaView();\n\treturn false;\n}\n\nconfig.macros.saveChanges.handler = function(place)\n{\n\tif(!readOnly)\n\t\tcreateTiddlyButton(place,this.label,this.prompt,this.onClick,null,null,this.accessKey);\n}\n\nconfig.macros.saveChanges.onClick = function(e)\n{\n\tsaveChanges();\n\treturn false;\n}\n\nconfig.macros.slider.onClickSlider = function(e)\n{\n\tif(!e) var e = window.event;\n\tvar n = this.nextSibling;\n\tvar cookie = n.getAttribute(\"cookie\");\n\tvar isOpen = n.style.display != \"none\";\n\tif(anim && config.options.chkAnimate)\n\t\tanim.startAnimating(new Slider(n,!isOpen,e.shiftKey || e.altKey,\"none\"));\n\telse\n\t\tn.style.display = isOpen ? \"none\" : \"block\";\n\tconfig.options[cookie] = !isOpen;\n\tsaveOptionCookie(cookie);\n\treturn false;\n}\n\nconfig.macros.slider.createSlider = function(place,cookie,title,tooltip)\n{\n\tvar cookie = cookie ? cookie : \"\";\n\tvar btn = createTiddlyButton(place,title,tooltip,this.onClickSlider);\n\tvar panel = createTiddlyElement(null,\"div\",null,\"sliderPanel\");\n\tpanel.setAttribute(\"cookie\",cookie);\n\tpanel.style.display = config.options[cookie] ? \"block\" : \"none\";\n\tplace.appendChild(panel);\n\treturn panel;\n}\n\nconfig.macros.slider.handler = function(place,macroName,params)\n{\n\tvar panel = this.createSlider(place,params[0],params[2],params[3]);\n\tvar text = store.getTiddlerText(params[1]);\n\tpanel.setAttribute(\"refresh\", \"content\");\n\tpanel.setAttribute(\"tiddler\", params[1]);\n\tif(text)\n\t\twikify(text,panel,null,store.getTiddler(params[1]));\n}\n\nconfig.macros.option.onChangeOption = function(e)\n{\n\tvar opt = this.getAttribute(\"option\");\n\tvar elementType,valueField;\n\tif(opt)\n\t\t{\n\t\tswitch(opt.substr(0,3))\n\t\t\t{\n\t\t\tcase \"txt\":\n\t\t\t\telementType = \"input\";\n\t\t\t\tvalueField = \"value\";\n\t\t\t\tbreak;\n\t\t\tcase \"chk\":\n\t\t\t\telementType = \"input\";\n\t\t\t\tvalueField = \"checked\";\n\t\t\t\tbreak;\n\t\t\t}\n\t\tconfig.options[opt] = this[valueField];\n\t\tsaveOptionCookie(opt);\n\t\tvar nodes = document.getElementsByTagName(elementType);\n\t\tfor(var t=0; t<nodes.length; t++)\n\t\t\t{\n\t\t\tvar optNode = nodes[t].getAttribute(\"option\");\n\t\t\tif(opt == optNode)\n\t\t\t\tnodes[t][valueField] = this[valueField];\n\t\t\t}\n\t\t}\n\treturn(true);\n}\n\nconfig.macros.option.handler = function(place,macroName,params)\n{\n\tvar opt = params[0];\n\tif(config.options[opt] == undefined)\n\t\treturn;\n\tvar c;\n\tswitch(opt.substr(0,3))\n\t\t{\n\t\tcase \"txt\":\n\t\t\tc = document.createElement(\"input\");\n\t\t\tc.onkeyup = this.onChangeOption;\n\t\t\tc.setAttribute(\"option\",opt);\n\t\t\tc.className = \"txtOptionInput\";\n\t\t\tplace.appendChild(c);\n\t\t\tc.value = config.options[opt];\n\t\t\tbreak;\n\t\tcase \"chk\":\n\t\t\tc = document.createElement(\"input\");\n\t\t\tc.setAttribute(\"type\",\"checkbox\");\n\t\t\tc.onclick = this.onChangeOption;\n\t\t\tc.setAttribute(\"option\",opt);\n\t\t\tc.className = \"chkOptionInput\";\n\t\t\tplace.appendChild(c);\n\t\t\tc.checked = config.options[opt];\n\t\t\tbreak;\n\t\t}\n}\n\n\n\nconfig.macros.newTiddler.createNewTiddlerButton = function(place,title,params,label,prompt,accessKey,newFocus,isJournal)\n{\n\tvar tags = [];\n\tfor(var t=1; t<params.length; t++)\n\t\tif((params[t].name == \"anon\" && t != 1) || (params[t].name == \"tag\"))\n\t\t\ttags.push(params[t].value);\n\tlabel = getParam(params,\"label\",label);\n\tprompt = getParam(params,\"prompt\",prompt);\n\taccessKey = getParam(params,\"accessKey\",accessKey);\n\tnewFocus = getParam(params,\"focus\",newFocus);\n\tvar btn = createTiddlyButton(place,label,prompt,this.onClickNewTiddler,null,null,accessKey);\n\tbtn.setAttribute(\"newTitle\",title);\n\tbtn.setAttribute(\"isJournal\",isJournal);\n\tbtn.setAttribute(\"params\",tags.join(\"|\"));\n\tbtn.setAttribute(\"newFocus\",newFocus);\n\tbtn.setAttribute(\"newTemplate\",getParam(params,\"template\",DEFAULT_EDIT_TEMPLATE));\n\tvar text = getParam(params,\"text\");\n\tif(text !== undefined)\n\t\tbtn.setAttribute(\"newText\",text);\n\treturn btn;\n}\n\nconfig.macros.newTiddler.onClickNewTiddler = function()\n{\n\tvar title = this.getAttribute(\"newTitle\");\n\tif(this.getAttribute(\"isJournal\"))\n\t\t{\n\t\tvar now = new Date();\n\t\ttitle = now.formatString(title.trim());\n\t\t}\n\tvar params = this.getAttribute(\"params\").split(\"|\");\n\tvar focus = this.getAttribute(\"newFocus\");\n\tvar template = this.getAttribute(\"newTemplate\");\n\tstory.displayTiddler(null,title,template);\n\tvar text = this.getAttribute(\"newText\");\n\tif(typeof text == \"string\")\n\t\tstory.getTiddlerField(title,\"text\").value = text.format([title]);\n\tfor(var t=0;t<params.length;t++)\n\t\tstory.setTiddlerTag(title,params[t],+1);\n\tstory.focusTiddler(title,focus);\n\treturn false;\n}\n\nconfig.macros.newTiddler.handler = function(place,macroName,params,wikifier,paramString,tiddler)\n{\n\tif(!readOnly)\n\t\t{\n\t\tparams = paramString.parseParams(\"anon\",null,true,false,false);\n\t\tvar title = params[1] && params[1].name == \"anon\" ? params[1].value : this.title;\n\t\ttitle = getParam(params,\"title\",title);\n\t\tthis.createNewTiddlerButton(place,title,params,this.label,this.prompt,this.accessKey,\"title\",false);\n\t\t}\n}\n\nconfig.macros.newJournal.handler = function(place,macroName,params,wikifier,paramString,tiddler)\n{\n\tif(!readOnly)\n\t\t{\n\t\tparams = paramString.parseParams(\"anon\",null,true,false,false);\n\t\tvar title = params[1] && params[1].name == \"anon\" ? params[1].value : \"\";\n\t\ttitle = getParam(params,\"title\",title);\n\t\tconfig.macros.newTiddler.createNewTiddlerButton(place,title,params,this.label,this.prompt,this.accessKey,\"text\",true);\n\t\t}\n}\n\nconfig.macros.sparkline.handler = function(place,macroName,params)\n{\n\tvar data = [];\n\tvar min = 0;\n\tvar max = 0;\n\tfor(var t=0; t<params.length; t++)\n\t\t{\n\t\tvar v = parseInt(params[t]);\n\t\tif(v < min)\n\t\t\tmin = v;\n\t\tif(v > max)\n\t\t\tmax = v;\n\t\tdata.push(v);\n\t\t}\n\tif(data.length < 1)\n\t\treturn;\n\tvar box = createTiddlyElement(place,\"span\",null,\"sparkline\",String.fromCharCode(160));\n\tbox.title = data.join(\",\");\n\tvar w = box.offsetWidth;\n\tvar h = box.offsetHeight;\n\tbox.style.paddingRight = (data.length * 2 - w) + \"px\";\n\tbox.style.position = \"relative\";\n\tfor(var d=0; d<data.length; d++)\n\t\t{\n\t\tvar tick = document.createElement(\"img\");\n\t\ttick.border = 0;\n\t\ttick.className = \"sparktick\";\n\t\ttick.style.position = \"absolute\";\n\t\ttick.src = \"data:image/gif,GIF89a%01%00%01%00%91%FF%00%FF%FF%FF%00%00%00%C0%C0%C0%00%00%00!%F9%04%01%00%00%02%00%2C%00%00%00%00%01%00%01%00%40%02%02T%01%00%3B\";\n\t\ttick.style.left = d*2 + \"px\";\n\t\ttick.style.width = \"2px\";\n\t\tvar v = Math.floor(((data[d] - min)/(max-min)) * h);\n\t\ttick.style.top = (h-v) + \"px\";\n\t\ttick.style.height = v + \"px\";\n\t\tbox.appendChild(tick);\n\t\t}\n}\n\nconfig.macros.tabs.handler = function(place,macroName,params)\n{\n\tvar cookie = params[0];\n\tvar numTabs = (params.length-1)/3;\n\tvar wrapper = createTiddlyElement(null,\"div\",null,cookie);\n\tvar tabset = createTiddlyElement(wrapper,\"div\",null,\"tabset\");\n\ttabset.setAttribute(\"cookie\",cookie);\n\tvar validTab = false;\n\tfor(var t=0; t<numTabs; t++)\n\t\t{\n\t\tvar label = params[t*3+1];\n\t\tvar prompt = params[t*3+2];\n\t\tvar content = params[t*3+3];\n\t\tvar tab = createTiddlyButton(tabset,label,prompt,this.onClickTab,\"tab tabUnselected\");\n\t\ttab.setAttribute(\"tab\",label);\n\t\ttab.setAttribute(\"content\",content);\n\t\ttab.title = prompt;\n\t\tif(config.options[cookie] == label)\n\t\t\tvalidTab = true;\n\t\t}\n\tif(!validTab)\n\t\tconfig.options[cookie] = params[1];\n\tplace.appendChild(wrapper);\n\tthis.switchTab(tabset,config.options[cookie]);\n}\n\nconfig.macros.tabs.onClickTab = function(e)\n{\n\tconfig.macros.tabs.switchTab(this.parentNode,this.getAttribute(\"tab\"));\n\treturn false;\n}\n\nconfig.macros.tabs.switchTab = function(tabset,tab)\n{\n\tvar cookie = tabset.getAttribute(\"cookie\");\n\tvar theTab = null\n\tvar nodes = tabset.childNodes;\n\tfor(var t=0; t<nodes.length; t++)\n\t\tif(nodes[t].getAttribute && nodes[t].getAttribute(\"tab\") == tab)\n\t\t\t{\n\t\t\ttheTab = nodes[t];\n\t\t\ttheTab.className = \"tab tabSelected\";\n\t\t\t}\n\t\telse\n\t\t\tnodes[t].className = \"tab tabUnselected\"\n\tif(theTab)\n\t\t{\n\t\tif(tabset.nextSibling && tabset.nextSibling.className == \"tabContents\")\n\t\t\ttabset.parentNode.removeChild(tabset.nextSibling);\n\t\tvar tabContent = createTiddlyElement(null,\"div\",null,\"tabContents\");\n\t\ttabset.parentNode.insertBefore(tabContent,tabset.nextSibling);\n\t\tvar contentTitle = theTab.getAttribute(\"content\");\n\t\twikify(store.getTiddlerText(contentTitle),tabContent,null,store.getTiddler(contentTitle));\n\t\tif(cookie)\n\t\t\t{\n\t\t\tconfig.options[cookie] = tab;\n\t\t\tsaveOptionCookie(cookie);\n\t\t\t}\n\t\t}\n}\n\n// <<gradient [[tiddler name]] vert|horiz rgb rgb rgb rgb... >>\nconfig.macros.gradient.handler = function(place,macroName,params,wikifier)\n{\n\tvar terminator = \">>\";\n\tvar panel;\n\tif(wikifier)\n\t\tpanel = createTiddlyElement(place,\"div\",null,\"gradient\");\n\telse\n\t\tpanel = place;\n\tpanel.style.position = \"relative\";\n\tpanel.style.overflow = \"hidden\";\n\tpanel.style.zIndex = \"0\";\n\tvar t;\n\tif(wikifier)\n\t\t{\n\t\tvar styles = config.formatterHelpers.inlineCssHelper(wikifier);\n\t\tconfig.formatterHelpers.applyCssHelper(panel,styles);\n\t\t}\n\tvar colours = [];\n\tfor(t=1; t<params.length; t++)\n\t\t{\n\t\tvar c = new RGB(params[t]);\n\t\tif(c)\n\t\t\tcolours.push(c);\n\t\t}\n\tdrawGradient(panel,params[0] != \"vert\",colours);\n\tif(wikifier)\n\t\twikifier.subWikify(panel,terminator);\n\tif(document.all)\n\t\t{\n\t\tpanel.style.height = \"100%\";\n\t\tpanel.style.width = \"100%\";\n\t\t}\n}\n\nconfig.macros.message.handler = function(place,macroName,params)\n{\n\tif(params[0])\n\t\t{\n\t\tvar m = config;\n\t\tvar p = params[0].split(\".\");\n\t\tfor(var t=0; t<p.length; t++)\n\t\t\t{\n\t\t\tif(p[t] in m)\n\t\t\t\tm = m[p[t]];\n\t\t\telse\n\t\t\t\tbreak;\n\t\t\t}\n\t\tcreateTiddlyText(place,m.toString().format(params.splice(1)));\n\t\t}\n}\n\nconfig.macros.view.handler = function(place,macroName,params,wikifier,paramString,tiddler)\n{\n\tif((tiddler instanceof Tiddler) && params[0])\n\t\t{\n\t\tvar value = store.getValue(tiddler,params[0]);\n\t\tif(value != undefined)\n\t\t\tswitch(params[1])\n\t\t\t\t{\n\t\t\t\tcase undefined:\n\t\t\t\t\thighlightify(value,place,highlightHack);\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"link\":\n\t\t\t\t\tcreateTiddlyLink(place,value,true);\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"wikified\":\n\t\t\t\t\twikify(value,place,highlightHack,tiddler);\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"date\":\n\t\t\t\t\tvalue = Date.convertFromYYYYMMDDHHMM(value);\n\t\t\t\t\tif(params[2])\n\t\t\t\t\t\tcreateTiddlyText(place,value.formatString(params[2]));\n\t\t\t\t\telse\n\t\t\t\t\t\tcreateTiddlyText(place,value);\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t}\n}\n\nconfig.macros.edit.handler = function(place,macroName,params,wikifier,paramString,tiddler)\n{\n\tvar field = params[0];\n\tif((tiddler instanceof Tiddler) && field)\n\t\t{\n\t\tstory.setDirty(tiddler.title,true);\n\t\tif(field != \"text\")\n\t\t\t{\n\t\t\t\tvar e = createTiddlyElement(null,\"input\");\n\t\t\t\tif(tiddler.isReadOnly())\n\t\t\t\t\te.setAttribute(\"readOnly\",\"readOnly\");\n\t\t\t\te.setAttribute(\"edit\",field);\n\t\t\t\te.setAttribute(\"type\",\"text\");\n\t\t\t\tvar v = store.getValue(tiddler,field);\n\t\t\t\tif(!v)\n\t\t\t\t\tv = \"\";\n\t\t\t\te.value = v;\n\t\t\t\te.setAttribute(\"size\",\"40\");\n\t\t\t\te.setAttribute(\"autocomplete\",\"off\");\n\t\t\t\tplace.appendChild(e);\n\t\t\t}\n\t\telse\n\t\t\t{\n\t\t\t\tvar wrapper1 = createTiddlyElement(null,\"fieldset\",null,\"fieldsetFix\");\n\t\t\t\tvar wrapper2 = createTiddlyElement(wrapper1,\"div\");\n\t\t\t\tvar e = createTiddlyElement(wrapper2,\"textarea\");\n\t\t\t\tif(tiddler.isReadOnly())\n\t\t\t\t\te.setAttribute(\"readOnly\",\"readOnly\");\n\t\t\t\tvar v = store.getValue(tiddler,field);\n\t\t\t\tif(!v)\n\t\t\t\t\tv = \"\";\n\t\t\t\te.value = v;\n\t\t\t\tvar rows = 10;\n\t\t\t\tvar lines = v.match(/\\n/mg);\n\t\t\t\tvar maxLines = Math.max(parseInt(config.options.txtMaxEditRows),5);\n\t\t\t\tif(lines != null && lines.length > rows)\n\t\t\t\t\trows = lines.length + 5;\n\t\t\t\trows = Math.min(rows,maxLines);\n\t\t\t\te.setAttribute(\"rows\",rows);\n\t\t\t\te.setAttribute(\"edit\",field);\n\t\t\t\tplace.appendChild(wrapper1);\n\t\t\t}\n\t\t}\n}\n\nconfig.macros.tagChooser.onClick = function(e)\n{\n\tif(!e) var e = window.event;\n\tvar lingo = config.views.editor.tagChooser;\n\tvar popup = Popup.create(this);\n\tvar tags = store.getTags();\n\tif(tags.length == 0)\n\t\tcreateTiddlyText(createTiddlyElement(popup,\"li\"),lingo.popupNone);\n\tfor(var t=0; t<tags.length; t++)\n\t\t{\n\t\tvar theTag = createTiddlyButton(createTiddlyElement(popup,\"li\"),tags[t][0],lingo.tagTooltip.format([tags[t][0]]),config.macros.tagChooser.onTagClick);\n\t\ttheTag.setAttribute(\"tag\",tags[t][0]);\n\t\ttheTag.setAttribute(\"tiddler\", this.getAttribute(\"tiddler\"));\n\t\t}\n\tPopup.show(popup,false);\n\te.cancelBubble = true;\n\tif(e.stopPropagation) e.stopPropagation();\n\treturn(false);\n}\n\nconfig.macros.tagChooser.onTagClick = function(e)\n{\n\tif(!e) var e = window.event;\n\tvar tag = this.getAttribute(\"tag\");\n\tvar title = this.getAttribute(\"tiddler\");\n\tif(!readOnly)\n\t\tstory.setTiddlerTag(title,tag,0);\n\treturn(false);\n}\n\nconfig.macros.tagChooser.handler = function(place,macroName,params,wikifier,paramString,tiddler)\n{\n\tif(tiddler instanceof Tiddler)\n\t\t{\n\t\tvar title = tiddler.title;\n\t\tvar lingo = config.views.editor.tagChooser;\n\t\tvar btn = createTiddlyButton(place,lingo.text,lingo.tooltip,this.onClick);\n\t\tbtn.setAttribute(\"tiddler\", title);\n\t\t}\n}\n\n// Create a toolbar command button\n// place - parent DOM element\n// command - reference to config.commands[] member -or- name of member\n// tiddler - reference to tiddler that toolbar applies to\n// theClass - the class to give the button\nconfig.macros.toolbar.createCommand = function(place,commandName,tiddler,theClass)\n{\n\tif(typeof commandName != \"string\")\n\t\t{\n\t\tvar c = null;\n\t\tfor(var t in config.commands)\n\t\t\tif(config.commands[t] == commandName)\n\t\t\t\tc = t;\n\t\tcommandName = c;\n\t\t}\n\tif((tiddler instanceof Tiddler) && (typeof commandName == \"string\"))\n\t\t{\n\t\tvar title = tiddler.title;\n\t\tvar command = config.commands[commandName];\n\t\tvar ro = tiddler.isReadOnly();\n\t\tvar shadow = store.isShadowTiddler(title) && !store.tiddlerExists(title);\n\t\tvar text = ro && command.readOnlyText ? command.readOnlyText : command.text;\n\t\tvar tooltip = ro && command.readOnlyTooltip ? command.readOnlyTooltip : command.tooltip;\n\t\tif((!ro || (ro && !command.hideReadOnly)) && !(shadow && command.hideShadow))\n\n\t\t\t{\n\t\t\tvar btn = createTiddlyButton(null,text,tooltip,this.onClickCommand);\n\t\t\tbtn.setAttribute(\"commandName\", commandName);\n\t\t\tbtn.setAttribute(\"tiddler\", title);\n\t\t\tif(theClass)\n\t\t\t\taddClass(btn,theClass);\n\t\t\tplace.appendChild(btn);\n\t\t\t}\n\t\t}\n}\n\nconfig.macros.toolbar.onClickCommand = function(e)\n{\n\tif(!e) var e = window.event;\n\tvar command = config.commands[this.getAttribute(\"commandName\")];\n\treturn command.handler(e,this,this.getAttribute(\"tiddler\"));\n}\n\n// Invoke the first command encountered from a given place that is tagged with a specified class\nconfig.macros.toolbar.invokeCommand = function(place,theClass,event)\n{\n\tvar children = place.getElementsByTagName(\"a\")\n\tfor(var t=0; t<children.length; t++)\n\t\t{\n\t\tvar c = children[t];\n\t\tif(hasClass(c,theClass) && c.getAttribute && c.getAttribute(\"commandName\"))\n\t\t\t{\n\t\t\tif(c.onclick instanceof Function)\n\t\t\t\tc.onclick.call(c,event);\n\t\t\tbreak;\n\t\t\t}\n\t\t}\n}\n\nconfig.macros.toolbar.handler = function(place,macroName,params,wikifier,paramString,tiddler)\n{\n\tfor(var t=0; t<params.length; t++)\n\t\t{\n\t\tvar c = params[t];\n\t\tvar theClass = \"\";\n\t\tswitch(c.substr(0,1))\n\t\t\t{\n\t\t\tcase \"+\":\n\t\t\t\ttheClass = \"defaultCommand\";\n\t\t\t\tc = c.substr(1);\n\t\t\t\tbreak;\n\t\t\tcase \"-\":\n\t\t\t\ttheClass = \"cancelCommand\";\n\t\t\t\tc = c.substr(1);\n\t\t\t\tbreak;\n\t\t\t}\n\t\tif(c in config.commands)\n\t\t\tthis.createCommand(place,c,tiddler,theClass);\n\t\t}\n}\n\nconfig.macros.plugins.handler = function(place,macroName,params,wikifier,paramString,tiddler)\n{\n\tvar e = createTiddlyElement(place,\"div\");\n\te.setAttribute(\"refresh\",\"macro\");\n\te.setAttribute(\"macroName\",\"plugins\");\n\te.setAttribute(\"params\",paramString);\n\tthis.refresh(e,paramString);\n}\n\nconfig.macros.plugins.refresh = function(place,params)\n{\n\tvar selectedRows = [];\n\tListView.forEachSelector(place,function(e,rowName) {\n\t\t\tif(e.checked)\n\t\t\t\tselectedRows.push(e.getAttribute(\"rowName\"));\n\t\t});\n\tremoveChildren(place);\n\tparams = params.parseParams(\"anon\");\n\tvar plugins = installedPlugins.slice(0);\n\tvar t,tiddler,p;\n\tvar configTiddlers = store.getTaggedTiddlers(\"systemConfig\");\n\tfor(t=0; t<configTiddlers.length; t++)\n\t\t{\n\t\ttiddler = configTiddlers[t];\n\t\tif(plugins.findByField(\"title\",tiddler.title) == null)\n\t\t\t{\n\t\t\tp = getPluginInfo(tiddler);\n\t\t\tp.executed = false;\n\t\t\tp.log.splice(0,0,this.skippedText);\n\t\t\tplugins.push(p);\n\t\t\t}\n\t\t}\n\tfor(t=0; t<plugins.length; t++)\n\t\t{\n\t\tvar p = plugins[t];\n\t\tp.forced = p.tiddler.isTagged(\"systemConfigForce\");\n\t\tp.disabled = p.tiddler.isTagged(\"systemConfigDisable\");\n\t\tp.Selected = selectedRows.indexOf(plugins[t].title) != -1;\n\t\t}\n\tif(plugins.length == 0)\n\t\tcreateTiddlyElement(place,\"em\",null,null,this.noPluginText);\n\telse\n\t\tListView.create(place,plugins,this.listViewTemplate,this.onSelectCommand);\n}\n\nconfig.macros.plugins.onSelectCommand = function(command,rowNames)\n{\n\tvar t;\n\tswitch(command)\n\t\t{\n\t\tcase \"remove\":\n\t\t\tfor(t=0; t<rowNames.length; t++)\n\t\t\t\tstore.setTiddlerTag(rowNames[t],false,\"systemConfig\");\n\t\t\tbreak;\n\t\tcase \"delete\":\n\t\t\tif(rowNames.length > 0 && confirm(config.macros.plugins.confirmDeleteText.format([rowNames.join(\", \")])))\n\t\t\t\t{\n\t\t\t\tfor(t=0; t<rowNames.length; t++)\n\t\t\t\t\t{\n\t\t\t\t\tstore.removeTiddler(rowNames[t]);\n\t\t\t\t\tstory.closeTiddler(rowNames[t],true,false);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\tbreak;\n\t\t}\n\tif(config.options.chkAutoSave)\n\t\tsaveChanges(true);\n}\n\nconfig.macros.refreshDisplay.handler = function(place)\n{\n\tcreateTiddlyButton(place,this.label,this.prompt,this.onClick);\n}\n\nconfig.macros.refreshDisplay.onClick = function(e)\n{\n\trefreshAll();\n\treturn false;\n}\n\nconfig.macros.importTiddlers.handler = function(place,macroName,params,wikifier,paramString,tiddler)\n{\n\tif(readOnly)\n\t\t{\n\t\tcreateTiddlyElement(place,\"div\",null,\"marked\",this.readOnlyWarning);\n\t\treturn;\n\t\t}\n\tvar importer = createTiddlyElement(null,\"div\",null,\"importTiddler wizard\");\n\tcreateTiddlyElement(importer,\"h1\",null,null,this.wizardTitle);\n\tcreateTiddlyElement(importer,\"h2\",null,\"step1\",this.step1);\n\tvar step = createTiddlyElement(importer,\"div\",null,\"wizardStep\");\n\tcreateTiddlyText(step,this.step1prompt);\n\tvar input = createTiddlyElement(null,\"input\",null,\"txtOptionInput\");\n\tinput.type = \"text\";\n\tinput.size = 50;\n\tstep.appendChild(input);\n\timporter.inputBox = input;\n\tcreateTiddlyElement(step,\"br\");\n\tcreateTiddlyText(step,this.step1promptFile);\n\tvar fileInput = createTiddlyElement(null,\"input\",null,\"txtOptionInput\");\n\tfileInput.type = \"file\";\n\tfileInput.size = 50;\n\tfileInput.onchange = this.onBrowseChange;\n\tfileInput.onkeyup = this.onBrowseChange;\n\tstep.appendChild(fileInput);\n\tcreateTiddlyElement(step,\"br\");\n\tcreateTiddlyText(step,this.step1promptFeeds);\n\tvar feeds = this.getFeeds([{caption: this.step1feedPrompt, name: \"\"}]);\n\tcreateTiddlyDropDown(step,this.onFeedChange,feeds);\n\tcreateTiddlyElement(step,\"br\");\n\tcreateTiddlyButton(step,this.fetchLabel,this.fetchPrompt,this.onFetch,null,null,null);\n        place.appendChild(importer);\n}\n\nconfig.macros.importTiddlers.getFeeds = function(feeds)\n{\n\tvar tagged = store.getTaggedTiddlers(\"contentPublisher\",\"title\");\n\tfor(var t=0; t<tagged.length; t++)\n\t\tfeeds.push({caption: tagged[t].title, name: store.getTiddlerSlice(tagged[t].title,\"URL\")});\n\treturn feeds;\n}\n\nconfig.macros.importTiddlers.onFeedChange = function(e)\n{\n\tvar importer = findRelated(this,\"importTiddler\",\"className\",\"parentNode\");\n\timporter.inputBox.value = this.value;\n\tthis.selectedIndex = 0;\n}\n\nconfig.macros.importTiddlers.onBrowseChange = function(e)\n{\n\tvar importer = findRelated(this,\"importTiddler\",\"className\",\"parentNode\");\n\timporter.inputBox.value = \"file://\" + this.value;\n}\n\nconfig.macros.importTiddlers.onFetch = function(e)\n{\n\tvar importer = findRelated(this,\"importTiddler\",\"className\",\"parentNode\");\n\tvar url = importer.inputBox.value;\n\tvar cutoff = findRelated(importer.firstChild,\"step2\",\"className\",\"nextSibling\");\n\twhile(cutoff)\n\t\t{\n\t\tvar temp = cutoff.nextSibling;\n\t\tcutoff.parentNode.removeChild(cutoff);\n\t\tcutoff = temp;\n\t\t}\n\tcreateTiddlyElement(importer,\"h2\",null,\"step2\",config.macros.importTiddlers.step2);\n\tvar step = createTiddlyElement(importer,\"div\",null,\"wizardStep\",config.macros.importTiddlers.step2Text.format([url]));\n\tloadRemoteFile(url,config.macros.importTiddlers.onLoad,importer);\n}\n\nconfig.macros.importTiddlers.onLoad = function(status,params,responseText,url,xhr)\n{\n\tif(!status)\n\t\t{\n\t\tdisplayMessage(this.fetchError);\n\t\treturn;\n\t\t}\n\tvar importer = params;\n\t// Check that the tiddler we're in hasn't been closed - doesn't work on IE\n//\tvar p = importer;\n//\twhile(p.parentNode)\n//\t\tp = p.parentNode;\n//\tif(!(p instanceof HTMLDocument))\n//\t\treturn;\n\t// Crack out the content - (should be refactored)\n\tvar posOpeningDiv = responseText.indexOf(startSaveArea);\n\tvar limitClosingDiv = responseText.indexOf(\"<!--POST-BODY-START--\"+\">\");\n\tvar posClosingDiv = responseText.lastIndexOf(endSaveArea,limitClosingDiv == -1 ? responseText.length : limitClosingDiv);\n\tif((posOpeningDiv == -1) || (posClosingDiv == -1))\n\t\t{\n\t\talert(config.messages.invalidFileError.format([url]));\n\t\treturn;\n\t\t}\n\tvar content = \"<html><body>\" + responseText.substring(posOpeningDiv,posClosingDiv + endSaveArea.length) + \"</body></html>\";\n\t// Create the iframe\n\tvar iframe = document.createElement(\"iframe\");\n\tiframe.style.display = \"none\";\n\timporter.insertBefore(iframe,importer.firstChild);\n\tvar doc = iframe.document;\n\tif(iframe.contentDocument)\n\t\tdoc = iframe.contentDocument; // For NS6\n\telse if(iframe.contentWindow)\n\t\tdoc = iframe.contentWindow.document; // For IE5.5 and IE6\n\t// Put the content in the iframe\n\tdoc.open();\n\tdoc.writeln(content);\n\tdoc.close();\n\t// Load the content into a TiddlyWiki() object\n\tvar storeArea = doc.getElementById(\"storeArea\");\n\tvar importStore = new TiddlyWiki();\n\timportStore.loadFromDiv(storeArea,\"store\");\n\t// Get rid of the iframe\n\tiframe.parentNode.removeChild(iframe);\n\t// Extract data for the listview\n\tvar tiddlers = [];\n\timportStore.forEachTiddler(function(title,tiddler)\n\t\t{\n\t\tvar t = {};\n\t\tt.title = title;\n\t\tt.modified = tiddler.modified;\n\t\tt.modifier = tiddler.modifier;\n\t\tt.text = tiddler.text.substr(0,50);\n\t\tt.tags = tiddler.tags;\n\t\ttiddlers.push(t);\n\t\t});\n\t// Display the listview\n\tcreateTiddlyElement(importer,\"h2\",null,\"step3\",config.macros.importTiddlers.step3);\n\tvar step = createTiddlyElement(importer,\"div\",null,\"wizardStep\");\n\tListView.create(step,tiddlers,config.macros.importTiddlers.listViewTemplate,config.macros.importTiddlers.onSelectCommand);\n\t// Save the importer\n\timporter.store = importStore;\n}\n\nconfig.macros.importTiddlers.onSelectCommand = function(listView,command,rowNames)\n{\n\tvar importer = findRelated(listView,\"importTiddler\",\"className\",\"parentNode\");\n\tswitch(command)\n\t\t{\n\t\tcase \"import\":\n\t\t\tconfig.macros.importTiddlers.doImport(importer,rowNames);\n\t\t\tbreak;\n\t\t}\n\tif(config.options.chkAutoSave)\n\t\tsaveChanges(true);\n}\n\nconfig.macros.importTiddlers.doImport = function(importer,rowNames)\n{\n\tvar theStore = importer.store;\n\tvar overwrite = new Array();\n\tvar t;\n\tfor(t=0; t<rowNames.length; t++)\n\t\t{\n\t\tif(store.tiddlerExists(rowNames[t]))\n\t\t\toverwrite.push(rowNames[t]);\n\t}\n\tif(overwrite.length > 0)\n\t\tif(!confirm(this.confirmOverwriteText.format([overwrite.join(\", \")])))\n\t\t\treturn;\n\tfor(t=0; t<rowNames.length; t++)\n\t\t{\n\t\tvar inbound = theStore.fetchTiddler(rowNames[t]);\n\t\tstore.saveTiddler(inbound.title, inbound.title, inbound.text, inbound.modifier, inbound.modified, inbound.tags);\n\t\tstore.fetchTiddler(inbound.title).created = inbound.created;\n\t\tstore.notify(rowNames[t],false);\n\t\t}\n\tstore.notifyAll();\n\tstore.setDirty(true);\n\tcreateTiddlyElement(importer,\"h2\",null,\"step4\",this.step4.format([rowNames.length]));\n\tvar step = createTiddlyElement(importer,\"div\",null,\"wizardStep\");\n\tfor(t=0; t<rowNames.length; t++)\n\t\t{\n\t\tcreateTiddlyLink(step,rowNames[t],true);\n\t\tcreateTiddlyElement(step,\"br\");\n\t\t}\n\tcreateTiddlyElement(importer,\"h2\",null,\"step5\",this.step5);\n}\n// ---------------------------------------------------------------------------------\n// Menu and toolbar commands\n// ---------------------------------------------------------------------------------\n\nconfig.commands.closeTiddler.handler = function(event,src,title)\n{\n\tstory.closeTiddler(title,true,event.shiftKey || event.altKey);\n\treturn false;\n}\n\nconfig.commands.closeOthers.handler = function(event,src,title)\n{\n\tstory.closeAllTiddlers(title);\n\treturn false;\n}\n\nconfig.commands.editTiddler.handler = function(event,src,title)\n{\n\tclearMessage();\n\tstory.displayTiddler(null,title,DEFAULT_EDIT_TEMPLATE);\n\tstory.focusTiddler(title,\"text\");\n\treturn false;\n}\n\nconfig.commands.saveTiddler.handler = function(event,src,title)\n{\n\tvar newTitle = story.saveTiddler(title,event.shiftKey);\n\tif(newTitle)\n\t   story.displayTiddler(null,newTitle);\n\treturn false;\n}\n\nconfig.commands.cancelTiddler.handler = function(event,src,title)\n{\n\tif(story.hasChanges(title) && !readOnly)\n\t\tif(!confirm(this.warning.format([title])))\n\t\t\treturn false;\n\tstory.setDirty(title,false);\n\tstory.displayTiddler(null,title);\n\treturn false;\n}\n\nconfig.commands.deleteTiddler.handler = function(event,src,title)\n{\n\tvar deleteIt = true;\n\tif (config.options.chkConfirmDelete)\n\t\tdeleteIt = confirm(this.warning.format([title]));\n\tif (deleteIt)\n\t\t{\n\t\tstore.removeTiddler(title);\n\t\tstory.closeTiddler(title,true,event.shiftKey || event.altKey);\n\t\tif(config.options.chkAutoSave)\n\t\t\tsaveChanges();\n\t\t}\n\treturn false;\n}\n\nconfig.commands.permalink.handler = function(event,src,title)\n{\n\tvar t = encodeURIComponent(String.encodeTiddlyLink(title));\n\tif(window.location.hash != t)\n\t\twindow.location.hash = t;\n\treturn false;\n}\n\nconfig.commands.references.handler = function(event,src,title)\n{\n\tvar popup = Popup.create(src);\n\tif(popup)\n\t\t{\n\t\tvar references = store.getReferringTiddlers(title);\n\t\tvar c = false;\n\t\tfor(var r=0; r<references.length; r++)\n\t\t\tif(references[r].title != title && !references[r].isTagged(\"excludeLists\"))\n\t\t\t\t{\n\t\t\t\tcreateTiddlyLink(createTiddlyElement(popup,\"li\"),references[r].title,true);\n\t\t\t\tc = true;\n\t\t\t\t}\n\t\tif(!c)\n\t\t\tcreateTiddlyText(createTiddlyElement(popup,\"li\",null,\"disabled\"),this.popupNone);\n\t\t}\n\tPopup.show(popup,false);\n\tevent.cancelBubble = true;\n\tif (event.stopPropagation) event.stopPropagation();\n\treturn false;\n}\n\nconfig.commands.jump.handler = function(event,src,title)\n{\n\tvar popup = Popup.create(src);\n\tif(popup)\n\t\t{\n\t\tstory.forEachTiddler(function(title,element) {\n\t\t\tcreateTiddlyLink(createTiddlyElement(popup,\"li\"),title,true);\n\t\t\t});\n\t\t}\n\tPopup.show(popup,false);\n\tevent.cancelBubble = true;\n\tif (event.stopPropagation) event.stopPropagation();\n\treturn false;\n}\n\n// ---------------------------------------------------------------------------------\n// Tiddler() object\n// ---------------------------------------------------------------------------------\n\nfunction Tiddler()\n{\n\tthis.title = null;\n\tthis.text = null;\n\tthis.modifier = null;\n\tthis.modified = new Date();\n\tthis.created = new Date();\n\tthis.links = [];\n\tthis.linksUpdated = false;\n\tthis.tags = [];\n\treturn this;\n}\n\nTiddler.prototype.getLinks = function()\n{\n\tif(this.linksUpdated==false)\n\t\tthis.changed();\n\treturn this.links;\n}\n\n// Format the text for storage in an RSS item\nTiddler.prototype.saveToRss = function(url)\n{\n\tvar s = [];\n\ts.push(\"<item>\");\n\ts.push(\"<title\" + \">\" + this.title.htmlEncode() + \"</title\" + \">\");\n\ts.push(\"<description>\" + wikifyStatic(this.text,null,this).htmlEncode() + \"</description>\");\n\tfor(var t=0; t<this.tags.length; t++)\n\t\ts.push(\"<category>\" + this.tags[t] + \"</category>\");\n\ts.push(\"<link>\" + url + \"#\" + encodeURIComponent(String.encodeTiddlyLink(this.title)) + \"</link>\");\n\ts.push(\"<pubDate>\" + this.modified.toGMTString() + \"</pubDate>\");\n\ts.push(\"</item>\");\n\treturn(s.join(\"\\n\"));\n}\n\n// Change the text and other attributes of a tiddler\nTiddler.prototype.set = function(title,text,modifier,modified,tags,created,fields)\n{\n\tthis.assign(title,text,modifier,modified,tags,created,fields);\n\tthis.changed();\n\treturn this;\n}\n\n// Change the text and other attributes of a tiddler without triggered a tiddler.changed() call\nTiddler.prototype.assign = function(title,text,modifier,modified,tags,created,fields)\n{\n\tif(title != undefined)\n\t\tthis.title = title;\n\tif(text != undefined)\n\t\tthis.text = text;\n\tif(modifier != undefined)\n\t\tthis.modifier = modifier;\n\tif(modified != undefined)\n\t\tthis.modified = modified;\n\tif(created != undefined)\n\t\tthis.created = created;\n\tif(fields != undefined)\n\t\tthis.fields = fields;\n\tif(tags != undefined)\n\t\tthis.tags = (typeof tags == \"string\") ? tags.readBracketedList() : tags;\n\telse if(this.tags == undefined)\n\t\tthis.tags = [];\n\treturn this;\n}\n\n// Get the tags for a tiddler as a string (space delimited, using [[brackets]] for tags containing spaces)\nTiddler.prototype.getTags = function()\n{\n\treturn String.encodeTiddlyLinkList(this.tags);\n}\n\n// Test if a tiddler carries a tag\nTiddler.prototype.isTagged = function(tag)\n{\n\treturn this.tags.indexOf(tag) != -1;\n}\n\n// Static method to convert \"\\n\" to newlines, \"\\s\" to \"\\\"\nTiddler.unescapeLineBreaks = function(text)\n{\n\treturn text ? text.unescapeLineBreaks() : \"\";\n}\n\n// Convert newlines to \"\\n\", \"\\\" to \"\\s\"\nTiddler.prototype.escapeLineBreaks = function()\n{\n\treturn this.text.escapeLineBreaks();\n}\n\n// Updates the secondary information (like links[] array) after a change to a tiddler\nTiddler.prototype.changed = function()\n{\n\tthis.links = [];\n\tvar t = this.autoLinkWikiWords() ? 0 : 1;\n\tvar tiddlerLinkRegExp = t==0 ? config.textPrimitives.tiddlerAnyLinkRegExp : config.textPrimitives.tiddlerForcedLinkRegExp;\n\ttiddlerLinkRegExp.lastIndex = 0;\n\tvar formatMatch = tiddlerLinkRegExp.exec(this.text);\n\twhile(formatMatch)\n\t\t{\n\t\tif(t==0 && formatMatch[1] && formatMatch[1] != this.title) // wikiWordLink\n\t\t\t{\n\t\t\tif(formatMatch.index > 0)\n\t\t\t\t{\n\t\t\t\tvar preRegExp = new RegExp(config.textPrimitives.unWikiLink+\"|\"+config.textPrimitives.anyLetter,\"mg\");\n\t\t\t\tpreRegExp.lastIndex = formatMatch.index-1;\n\t\t\t\tvar preMatch = preRegExp.exec(this.text);\n\t\t\t\tif(preMatch.index != formatMatch.index-1)\n\t\t\t\t\tthis.links.pushUnique(formatMatch[1]);\n\t\t\t\t}\n\t\t\telse\n\t\t\t\tthis.links.pushUnique(formatMatch[1]);\n\t\t\t}\n\t\telse if(formatMatch[2-t] && (store.tiddlerExists(formatMatch[3-t]) || store.isShadowTiddler(formatMatch[3-t]))) // titledBrackettedLink\n\t\t\tthis.links.pushUnique(formatMatch[3-t]);\n\t\telse if(formatMatch[4-t] && formatMatch[4-t] != this.title) // brackettedLink\n\t\t\tthis.links.pushUnique(formatMatch[4-t]);\n\t\t// Do not add link if match urlPattern (formatMatch[5-t])\n\t\tformatMatch = tiddlerLinkRegExp.exec(this.text);\n\t\t}\n\tthis.linksUpdated = true;\n\treturn;\n}\n\nTiddler.prototype.getSubtitle = function()\n{\n\tvar theModifier = this.modifier;\n\tif(!theModifier)\n\t\ttheModifier = config.messages.subtitleUnknown;\n\tvar theModified = this.modified;\n\tif(theModified)\n\t\ttheModified = theModified.toLocaleString();\n\telse\n\t\ttheModified = config.messages.subtitleUnknown;\n\treturn(config.messages.tiddlerLinkTooltip.format([this.title,theModifier,theModified]));\n}\n\nTiddler.prototype.isReadOnly = function()\n{\n\treturn readOnly;\n}\n\nTiddler.prototype.autoLinkWikiWords = function()\n{\n\treturn !(this.isTagged(\"systemConfig\") || this.isTagged(\"excludeMissing\"));\n}\n\nTiddler.prototype.generateFingerprint = function()\n{\n\treturn \"0x\" + Crypto.hexSha1Str(this.text);\n}\n\n// ---------------------------------------------------------------------------------\n// TiddlyWiki() object contains Tiddler()s\n// ---------------------------------------------------------------------------------\n\nfunction TiddlyWiki()\n{\n\tvar tiddlers = {}; // Hashmap by name of tiddlers\n\tthis.tiddlersUpdated = false;\n\tthis.namedNotifications = []; // Array of {name:,notify:} of notification functions\n\tthis.notificationLevel = 0;\n\tthis.slices = {}; // map tiddlerName->(map sliceName->sliceValue). Lazy.\n\tthis.clear = function() {\n\t\ttiddlers = {};\n\t\tthis.setDirty(false);\n\t\t};\n\tthis.fetchTiddler = function(title) {\n\t\treturn tiddlers[title];\n\t\t};\n\tthis.deleteTiddler = function(title) {\n\t\tdelete this.slices[title];\n\t\tdelete tiddlers[title];\n\t\t};\n\tthis.addTiddler = function(tiddler) {\n\t\tdelete this.slices[tiddler.title];\n\t\ttiddlers[tiddler.title] = tiddler;\n\t\t};\n\tthis.forEachTiddler = function(callback) {\n\t\tfor(var t in tiddlers)\n\t\t\t{\n\t\t\tvar tiddler = tiddlers[t];\n\t\t\tif(tiddler instanceof Tiddler)\n\t\t\t\tcallback.call(this,t,tiddler);\n\t\t\t}\n\t\t};\n}\n\n// Set the dirty flag\nTiddlyWiki.prototype.setDirty = function(dirty)\n{\n\tthis.dirty = dirty;\n}\n\nTiddlyWiki.prototype.isDirty = function()\n{\n\treturn this.dirty;\n}\n\nTiddlyWiki.prototype.suspendNotifications = function()\n{\n\tthis.notificationLevel--;\n}\n\nTiddlyWiki.prototype.resumeNotifications = function()\n{\n\tthis.notificationLevel++;\n}\n\n// Invoke the notification handlers for a particular tiddler\nTiddlyWiki.prototype.notify = function(title,doBlanket)\n{\n\tif(!this.notificationLevel)\n\t\tfor(var t=0; t<this.namedNotifications.length; t++)\n\t\t\t{\n\t\t\tvar n = this.namedNotifications[t];\n\t\t\tif((n.name == null && doBlanket) || (n.name == title))\n\t\t\t\tn.notify(title);\n\t\t\t}\n}\n\n// Invoke the notification handlers for all tiddlers\nTiddlyWiki.prototype.notifyAll = function()\n{\n\tif(!this.notificationLevel)\n\t\tfor(var t=0; t<this.namedNotifications.length; t++)\n\t\t\t{\n\t\t\tvar n = this.namedNotifications[t];\n\t\t\tif(n.name)\n\t\t\t\tn.notify(n.name);\n\t\t\t}\n}\n\n// Add a notification handler to a tiddler\nTiddlyWiki.prototype.addNotification = function(title,fn)\n{\n\tfor (var i=0; i<this.namedNotifications.length; i++)\n\t\tif((this.namedNotifications[i].name == title) && (this.namedNotifications[i].notify == fn))\n\t\t\treturn this;\n\tthis.namedNotifications.push({name: title, notify: fn});\n\treturn this;\n}\n\nTiddlyWiki.prototype.removeTiddler = function(title)\n{\n\tvar tiddler = this.fetchTiddler(title);\n\tif(tiddler)\n\t\t{\n\t\tthis.deleteTiddler(title);\n\t\tthis.notify(title,true);\n\t\tthis.setDirty(true);\n\t\t}\n}\n\nTiddlyWiki.prototype.tiddlerExists = function(title)\n{\n\tvar t = this.fetchTiddler(title);\n\treturn (t != undefined);\n}\n\nTiddlyWiki.prototype.isShadowTiddler = function(title)\n{\n\treturn typeof config.shadowTiddlers[title] == \"string\";\n}\n\nTiddlyWiki.prototype.getTiddler = function(title)\n{\n\tvar t = this.fetchTiddler(title);\n\tif(t != undefined)\n\t\treturn t;\n\telse\n\t\treturn null;\n}\n\nTiddlyWiki.prototype.getTiddlerText = function(title,defaultText)\n{\n\tvar tiddler = this.fetchTiddler(title);\n\tif(tiddler)\n\t\treturn tiddler.text;\n\tif(!title)\n\t\treturn defaultText;\n\tvar pos = title.indexOf(config.textPrimitives.sliceSeparator);\n\tif(pos != -1)\n\t\t{\n\t\tvar slice = this.getTiddlerSlice(title.substr(0,pos),title.substr(pos + config.textPrimitives.sliceSeparator.length));\n\t\tif(slice)\n\t\t\treturn slice;\n\t\t}\n\tif(this.isShadowTiddler(title))\n\t\treturn config.shadowTiddlers[title];\n\tif(defaultText != undefined)\n\t\treturn defaultText;\n\treturn null;\n}\n\nTiddlyWiki.prototype.slicesRE = /(?:[\\'\\/]*~?(\\w+)[\\'\\/]*\\:[\\'\\/]*\\s*(.*?)\\s*$)|(?:\\|[\\'\\/]*~?(\\w+)\\:?[\\'\\/]*\\|\\s*(.*?)\\s*\\|)/gm\n\n// @internal\nTiddlyWiki.prototype.calcAllSlices = function(title)\n{\n\tvar slices = {};\n\tvar text = this.getTiddlerText(title,\"\");\n\tthis.slicesRE.lastIndex = 0;\n\tdo\n\t\t{\n\t\t\tvar m = this.slicesRE.exec(text);\n\t\t\tif (m)\n\t\t\t\t{\n\t\t\t\t\tif (m[1])\n\t\t\t\t\t\tslices[m[1]] = m[2];\n\t\t\t\t\telse\n\t\t\t\t\t\tslices[m[3]] = m[4];\n\t\t\t\t}\n\t\t}\n\twhile(m);\n\treturn slices;\n}\n\n// Returns the slice of text of the given name\n//#\n//# A text slice is a substring in the tiddler's text that is defined\n//# either like this\n//#    aName:  textSlice\n//# or\n//#    |aName:| textSlice |\n//# or\n//#    |aName| textSlice |\n//#\n//# In the text the name (or name:) may be decorated with '' or //. I.e.\n//# this would also a possible text slice:\n//#\n//#    |''aName:''| textSlice |\n//#\n//# @param name should only contain \"word characters\" (i.e. \"a-ZA-Z_0-9\")\n//# @return [may be undefined] the (trimmed) text of the specified slice.\nTiddlyWiki.prototype.getTiddlerSlice = function(title,sliceName)\n{\n\tvar slices = this.slices[title];\n\tif (!slices) {\n\t\tslices = this.calcAllSlices(title);\n\t\tthis.slices[title] = slices;\n\t}\n\treturn slices[sliceName];\n}\n\n// Build an hashmap of the specified named slices of a tiddler\nTiddlyWiki.prototype.getTiddlerSlices = function(title,sliceNames)\n{\n\tvar r = {};\n\tfor(var t=0; t<sliceNames.length; t++)\n\t\t{\n\t\tvar slice = this.getTiddlerSlice(title,sliceNames[t]);\n\t\tif(slice)\n\t\t\tr[sliceNames[t]] = slice;\n\t\t}\n\treturn r;\n}\n\nTiddlyWiki.prototype.getRecursiveTiddlerText = function(title,defaultText,depth)\n{\n\tvar bracketRegExp = new RegExp(\"(?:\\\\[\\\\[([^\\\\]]+)\\\\]\\\\])\",\"mg\");\n\tvar text = this.getTiddlerText(title,null);\n\tif(text == null)\n\t\treturn defaultText;\n\tvar textOut = [];\n\tvar lastPos = 0;\n\tdo {\n\t\tvar match = bracketRegExp.exec(text);\n\t\tif(match)\n\t\t\t{\n\t\t\ttextOut.push(text.substr(lastPos,match.index-lastPos));\n\t\t\tif(match[1])\n\t\t\t\t{\n\t\t\t\tif(depth <= 0)\n\t\t\t\t\ttextOut.push(match[1]);\n\t\t\t\telse\n\t\t\t\t\ttextOut.push(this.getRecursiveTiddlerText(match[1],\"[[\" + match[1] + \"]]\",depth-1));\n\t\t\t\t}\n\t\t\tlastPos = match.index + match[0].length;\n\t\t\t}\n\t\telse\n\t\t\ttextOut.push(text.substr(lastPos));\n\t} while(match);\n\treturn(textOut.join(\"\"));\n}\n\nTiddlyWiki.prototype.setTiddlerTag = function(title,status,tag)\n{\n\tvar tiddler = this.fetchTiddler(title);\n\tif(tiddler)\n\t\t{\n\t\tvar t = tiddler.tags.indexOf(tag);\n\t\tif(t != -1)\n\t\t\ttiddler.tags.splice(t,1);\n\t\tif(status)\n\t\t\ttiddler.tags.push(tag);\n\t\ttiddler.changed();\n\t\tthis.notify(title,true);\n\t\tthis.setDirty(true);\n\t\t}\n}\n\nTiddlyWiki.prototype.saveTiddler = function(title,newTitle,newBody,modifier,modified,tags,fields)\n{\n\tvar tiddler = this.fetchTiddler(title);\n\tvar created;\n\tif(tiddler)\n\t\t{\n\t\tcreated = tiddler.created; // Preserve created date\n\t\tthis.deleteTiddler(title);\n\t\t}\n\telse\n\t\t{\n\t\ttiddler = new Tiddler();\n\t\tcreated = modified;\n\t\t}\n\ttiddler.set(newTitle,newBody,modifier,modified,tags,created,fields);\n\tthis.addTiddler(tiddler);\n\tif(title != newTitle)\n\t\tthis.notify(title,true);\n\tthis.notify(newTitle,true);\n\tthis.setDirty(true);\n\treturn tiddler;\n}\n\nTiddlyWiki.prototype.createTiddler = function(title)\n{\n\tvar tiddler = this.fetchTiddler(title);\n\tif(!tiddler)\n\t\t{\n\t\ttiddler = new Tiddler();\n\t\ttiddler.title = title;\n\t\tthis.addTiddler(tiddler);\n\t\tthis.setDirty(true);\n\t\t}\n\treturn tiddler;\n}\n\n// Load contents of a tiddlywiki from an HTML DIV\nTiddlyWiki.prototype.loadFromDiv = function(src,idPrefix,noUpdate)\n{\n\tthis.idPrefix = idPrefix;\n\tvar storeElem = (typeof src == \"string\") ? document.getElementById(src) : src;\n\tvar tiddlers = this.getLoader().loadTiddlers(this,storeElem.childNodes);\n\tthis.setDirty(false);\n\tif(!noUpdate)\n\t\t{\n\t\tfor(var i = 0;i<tiddlers.length; i++)\n\t\t\ttiddlers[i].changed();\n\t\t}\n}\n\nTiddlyWiki.prototype.updateTiddlers = function()\n{\n\tthis.tiddlersUpdated = true;\n\tthis.forEachTiddler(function(title,tiddler) {\n\t\ttiddler.changed();\n\t\t});\n}\n\n// Return all tiddlers formatted as an HTML string\nTiddlyWiki.prototype.allTiddlersAsHtml = function()\n{\n\treturn store.getSaver().externalize(store);\n}\n\n// Return an array of tiddlers matching a search regular expression\nTiddlyWiki.prototype.search = function(searchRegExp,sortField,excludeTag)\n{\n\tvar candidates = this.reverseLookup(\"tags\",excludeTag,false);\n\tvar results = [];\n\tfor(var t=0; t<candidates.length; t++)\n\t\t{\n\t\tif((candidates[t].title.search(searchRegExp) != -1) || (candidates[t].text.search(searchRegExp) != -1))\n\t\t\tresults.push(candidates[t]);\n\t\t}\n\tif(!sortField)\n\t\tsortField = \"title\";\n\tresults.sort(function(a,b) {return a[sortField] < b[sortField] ? -1 : (a[sortField] == b[sortField] ? 0 : +1);});\n\treturn results;\n}\n\n// Return an array of all the tags in use. Each member of the array is another array where [0] is the name of the tag and [1] is the number of occurances\nTiddlyWiki.prototype.getTags = function()\n{\n\tvar results = [];\n\tthis.forEachTiddler(function(title,tiddler) {\n\t\tfor(var g=0; g<tiddler.tags.length; g++)\n\t\t\t{\n\t\t\tvar tag = tiddler.tags[g];\n\t\t\tvar f = false;\n\t\t\tfor(var c=0; c<results.length; c++)\n\t\t\t\tif(results[c][0] == tag)\n\t\t\t\t\t{\n\t\t\t\t\tf = true;\n\t\t\t\t\tresults[c][1]++;\n\t\t\t\t\t}\n\t\t\tif(!f)\n\t\t\t\tresults.push([tag,1]);\n\t\t\t}\n\t\t});\n\tresults.sort(function(a,b) {return a[0].toLowerCase() < b[0].toLowerCase() ? -1 : (a[0].toLowerCase() == b[0].toLowerCase() ? 0 : +1);});\n\treturn results;\n}\n\n// Return an array of the tiddlers that are tagged with a given tag\nTiddlyWiki.prototype.getTaggedTiddlers = function(tag,sortField)\n{\n\treturn this.reverseLookup(\"tags\",tag,true,sortField);\n}\n\n// Return an array of the tiddlers that link to a given tiddler\nTiddlyWiki.prototype.getReferringTiddlers = function(title,unusedParameter,sortField)\n{\n\tif(!this.tiddlersUpdated)\n\t\tthis.updateTiddlers();\n\treturn this.reverseLookup(\"links\",title,true,sortField);\n}\n\n// Return an array of the tiddlers that do or do not have a specified entry in the specified storage array (ie, \"links\" or \"tags\")\n// lookupMatch == true to match tiddlers, false to exclude tiddlers\nTiddlyWiki.prototype.reverseLookup = function(lookupField,lookupValue,lookupMatch,sortField)\n{\n\tvar results = [];\n\tthis.forEachTiddler(function(title,tiddler) {\n\t\tvar f = !lookupMatch;\n\t\tfor(var lookup=0; lookup<tiddler[lookupField].length; lookup++)\n\t\t\tif(tiddler[lookupField][lookup] == lookupValue)\n\t\t\t\tf = lookupMatch;\n\t\tif(f)\n\t\t\tresults.push(tiddler);\n\t\t});\n\tif(!sortField)\n\t\tsortField = \"title\";\n\tresults.sort(function(a,b) {return a[sortField] < b[sortField] ? -1 : (a[sortField] == b[sortField] ? 0 : +1);});\n\treturn results;\n}\n\n// Return the tiddlers as a sorted array\nTiddlyWiki.prototype.getTiddlers = function(field,excludeTag)\n{\n\tvar results = [];\n\tthis.forEachTiddler(function(title,tiddler) {\n\t\tif(excludeTag == undefined || !tiddler.isTagged(excludeTag))\n\t\t\tresults.push(tiddler);\n\t\t});\n\tif(field)\n\t\tresults.sort(function(a,b) {return a[field] < b[field] ? -1 : (a[field] == b[field] ? 0 : +1);});\n\treturn results;\n}\n\n// Return array of names of tiddlers that are referred to but not defined\nTiddlyWiki.prototype.getMissingLinks = function(sortField)\n{\n\tif(!this.tiddlersUpdated)\n\t\tthis.updateTiddlers();\n\tvar results = [];\n\tthis.forEachTiddler(function (title,tiddler) {\n\t\tfor(var n=0; n<tiddler.links.length;n++)\n\t\t\t{\n\t\t\tvar link = tiddler.links[n];\n\t\t\tif(this.fetchTiddler(link) == null && !this.isShadowTiddler(link))\n\t\t\t\tresults.pushUnique(link);\n\t\t\t}\n\t\t});\n\tresults.sort();\n\treturn results;\n}\n\n// Return an array of names of tiddlers that are defined but not referred to\nTiddlyWiki.prototype.getOrphans = function()\n{\n\tvar results = [];\n\tthis.forEachTiddler(function (title,tiddler) {\n\t\tif(this.getReferringTiddlers(title).length == 0 && !tiddler.isTagged(\"excludeLists\"))\n\t\t\tresults.push(title);\n\t\t});\n\tresults.sort();\n\treturn results;\n}\n\n// Return an array of names of all the shadow tiddlers\nTiddlyWiki.prototype.getShadowed = function()\n{\n\tvar results = [];\n\tfor(var t in config.shadowTiddlers)\n\t\tif(typeof config.shadowTiddlers[t] == \"string\")\n\t\t\tresults.push(t);\n\tresults.sort();\n\treturn results;\n}\n\n// Resolves a Tiddler reference or tiddler title into a Tiddler object, or null if it doesn't exist\nTiddlyWiki.prototype.resolveTiddler = function(tiddler)\n{\n\tvar t = (typeof tiddler == 'string') ? this.getTiddler(tiddler) : tiddler;\n\treturn t instanceof Tiddler ? t : null;\n}\n\nTiddlyWiki.prototype.getLoader = function()\n{\n\tif (!this.loader)\n\t\tthis.loader = new TW21Loader();\n\treturn this.loader;\n}\n\nTiddlyWiki.prototype.getSaver = function()\n{\n\tif (!this.saver)\n\t\tthis.saver = new TW21Saver();\n\treturn this.saver;\n}\n\n// Returns true if path is a valid field name (path),\n// i.e. a sequence of identifiers, separated by '.'\nTiddlyWiki.isValidFieldName = function (name) {\n\tvar match = /[a-zA-Z_]\\w*(\\.[a-zA-Z_]\\w*)*/.exec(name);\n\treturn match && (match[0] == name);\n}\n\n// Throws an exception when name is not a valid field name.\nTiddlyWiki.checkFieldName = function(name) {\n\tif (!TiddlyWiki.isValidFieldName(name))\n\t\tthrow config.messages.invalidFieldName.format([name]);\n}\n\nfunction StringFieldAccess(n, readOnly) {\n\tthis.set = readOnly\n\t\t? function(t,v) {if (v != t[n]) throw config.messages.fieldCannotBeChanged.format([n]);}\n\t\t: function(t,v) {if (v != t[n]) {t[n] = v; return true;}};\n\tthis.get = function(t) {return t[n];};\n}\n\nfunction DateFieldAccess(n) {\n\tthis.set = function(t,v) {\n\t\t\tvar d = v instanceof Date ? v : Date.convertFromYYYYMMDDHHMM(v);\n\t\t\tif (d != t[n]) {\n\t\t\t\tt[n] = d; return true;\n\t\t\t}\n\t\t};\n\tthis.get = function(t)   {return t[n].convertToYYYYMMDDHHMM();}\n}\n\nfunction LinksFieldAccess(n) {\n\tthis.set = function(t,v) {\n\t\t\tvar s = (typeof v == \"string\") ? v.readBracketedList() : v;\n\t\t\tif (s.toString() != t[n].toString()) {\n\t\t\t\tt[n] = s; return true;\n\t\t\t}\n\t\t};\n\tthis.get = function(t)   {return String.encodeTiddlyLinkList(t[n]);}\n}\n\nTiddlyWiki.standardFieldAccess = {\n\t// The set functions return true when setting the data has changed the value.\n\n\t\"title\":    new StringFieldAccess(\"title\", true),\n\t// Handle the \"tiddler\" field name as the title\n\t\"tiddler\":  new StringFieldAccess(\"title\", true),\n\n\t\"text\":     new StringFieldAccess(\"text\"),\n\t\"modifier\": new StringFieldAccess(\"modifier\"),\n\t\"modified\": new DateFieldAccess(\"modified\"),\n\t\"created\":  new DateFieldAccess(\"created\"),\n\t\"tags\":     new LinksFieldAccess(\"tags\")\n};\n\nTiddlyWiki.isStandardField = function(name) {\n\treturn TiddlyWiki.standardFieldAccess[name] != undefined;\n}\n\n// Sets the value of the given field of the tiddler to the value.\n// Setting an ExtendedField's value to null or undefined removes the field.\n// Setting a namespace to undefined removes all fields of that namespace.\n// The fieldName is case-insensitive.\n// All values will be converted to a string value.\nTiddlyWiki.prototype.setValue = function(tiddler, fieldName, value) {\n\tTiddlyWiki.checkFieldName(fieldName);\n\tvar t = this.resolveTiddler(tiddler);\n\tif (!t)\n\t\treturn;\n\n\tfieldName = fieldName.toLowerCase();\n\n\tvar isRemove = (value === undefined) || (value === null);\n\n\tif (!t.fields)\n\t\tt.fields = {};\n\n\tvar accessor = TiddlyWiki.standardFieldAccess[fieldName];\n\tif (accessor) {\n\t\tif (isRemove)\n\t\t\t// don't remove StandardFields\n\t\t\treturn;\n\t\tvar h = TiddlyWiki.standardFieldAccess[fieldName];\n\t\tif (!h.set(t, value))\n\t\t\treturn;\n\n\t} else {\n\t\tvar oldValue = t.fields[fieldName];\n\n\t\tif (isRemove) {\n\t\t\tif (oldValue !== undefined) {\n\t\t\t\t// deletes a single field\n\t\t\t\tdelete t.fields[fieldName];\n\t\t\t} else {\n\t\t\t\t// no concrete value is defined for the fieldName\n\t\t\t\t// so we guess this is a namespace path.\n\n\t\t\t\t// delete all fields in a namespace\n\t\t\t\tvar re = new RegExp('^'+fieldName+'\\\\.');\n\t\t\t\tvar dirty = false;\n\t\t\t\tfor (var n in t.fields) {\n\t\t\t\t\tif (n.match(re)) {\n\t\t\t\t\t\tdelete t.fields[n];\n\t\t\t\t\t\tdirty = true;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif (!dirty)\n\t\t\t\t\treturn\n\t\t\t}\n\n\t\t} else {\n\t\t\t// the \"normal\" set case. value is defined (not null/undefined)\n\t\t\t// For convenience provide a nicer conversion Date->String\n \t\t\tvalue = value instanceof Date\n\t\t\t\t? value.convertToYYYYMMDDHHMMSSMMM()\n\t\t\t\t: String(value);\n\t\t\tif (oldValue == value)\n\t\t\t\treturn;\n\t\t\tt.fields[fieldName] = value;\n\t\t}\n\t}\n\n\t// When we are here the tiddler/store really was changed.\n\tthis.notify(t.title,true);\n\tif (!fieldName.match(/^temp\\./))\n\t\tthis.setDirty(true);\n}\n\n// Returns the value of the given field of the tiddler.\n// The fieldName is case-insensitive.\n// Will only return String values (or undefined).\nTiddlyWiki.prototype.getValue = function(tiddler, fieldName) {\n\tvar t = this.resolveTiddler(tiddler);\n\tif (!t)\n\t\treturn undefined;\n\n\tfieldName = fieldName.toLowerCase();\n\n\tvar accessor = TiddlyWiki.standardFieldAccess[fieldName];\n\tif (accessor) {\n\t\treturn accessor.get(t);\n\t}\n\n\treturn t.fields ? t.fields[fieldName] : undefined;\n}\n\n// Calls the callback function for every field in the tiddler.\n//\n// When callback function returns a non-false value the iteration stops\n// and that value is returned.\n//\n// The order of the fields is not defined.\n//\n// @param callback a function(tiddler, fieldName, value).\n//\nTiddlyWiki.prototype.forEachField = function(tiddler, callback, onlyExtendedFields) {\n\tvar t = this.resolveTiddler(tiddler);\n\tif (!t)\n\t\treturn undefined;\n\n\tif (t.fields) {\n\t\tfor (var n in t.fields) {\n\t\t\tvar result = callback(t, n, t.fields[n]);\n\t\t\tif (result)\n\t\t\t\treturn result;\n\t\t}\n\t}\n\n\tif (onlyExtendedFields)\n\t\treturn undefined;\n\n\tfor (var n in TiddlyWiki.standardFieldAccess) {\n\t\tif (n == \"tiddler\")\n\t\t\t// even though the \"title\" field can also be referenced through the name \"tiddler\"\n\t\t\t// we only visit this field once.\n\t\t\tcontinue;\n\n\t\tvar result = callback(t, n, TiddlyWiki.standardFieldAccess[n].get(t));\n\t\tif (result)\n\t\t\treturn result;\n\t}\n\n\treturn undefined;\n};\n// ---------------------------------------------------------------------------------\n// Story functions\n// ---------------------------------------------------------------------------------\n\n// A story is a HTML div containing a sequence of tiddlers that can be manipulated\n// container - id of containing element\n// idPrefix - string prefix prepended to title to make ids for tiddlers in this story\nfunction Story(container,idPrefix)\n{\n\tthis.container = container;\n\tthis.idPrefix = idPrefix;\n\tthis.highlightRegExp = null;\n}\n\n// Iterate through all the tiddlers in a story\n// fn - callback function to be called for each tiddler. Arguments are:\n//\t\ttiddler - reference to Tiddler object\n//\t\telement - reference to tiddler display element\nStory.prototype.forEachTiddler = function(fn)\n{\n\tvar place = document.getElementById(this.container);\n\tif(!place)\n\t\treturn;\n\tvar e = place.firstChild;\n\twhile(e)\n\t\t{\n\t\tvar n = e.nextSibling;\n\t\tvar title = e.getAttribute(\"tiddler\");\n\t\tfn.call(this,title,e);\n\t\te = n;\n\t\t}\n}\n\n// Display several tiddlers given their titles in an array. Parameters same as displayTiddler(), except:\n// titles - array of string titles\nStory.prototype.displayTiddlers = function(srcElement,titles,template,animate,slowly)\n{\n\tfor(var t = titles.length-1;t>=0;t--)\n\t\tthis.displayTiddler(srcElement,titles[t],template,animate,slowly);\n}\n\n// Display a given tiddler with a given template. If the tiddler is already displayed but with a different\n// template, it is switched to the specified template\n// srcElement - reference to element from which this one is being opened -or-\n//              special positions \"top\", \"bottom\"\n// title - title of tiddler to display\n// template - the name of the tiddler containing the template -or-\n//\t\t\t  one of the constants DEFAULT_VIEW_TEMPLATE and DEFAULT_EDIT_TEMPLATE -or-\n//\t\t\t  null or undefined to indicate the current template if there is one, DEFAULT_VIEW_TEMPLATE if not\n// animate - whether to perform animations\n// slowly - whether to perform animations in slomo\nStory.prototype.displayTiddler = function(srcElement,title,template,animate,slowly)\n{\n\tvar place = document.getElementById(this.container);\n\tvar tiddlerElem = document.getElementById(this.idPrefix + title);\n\tif(tiddlerElem)\n\t\tthis.refreshTiddler(title,template);\n\telse\n\t\t{\n\t\tvar before = this.positionTiddler(srcElement);\n\t\ttiddlerElem = this.createTiddler(place,before,title,template);\n\t\t}\n\tif(srcElement && typeof srcElement !== \"string\")\n\t\t{\n\t\tif(anim && config.options.chkAnimate && (animate == undefined || animate == true))\n\t\t\tanim.startAnimating(new Cascade(title,srcElement,tiddlerElem,slowly),new Scroller(tiddlerElem,slowly));\n\t\telse\n\t\t\twindow.scrollTo(0,ensureVisible(tiddlerElem));\n\t\t}\n}\n\n// Figure out the appropriate position for a newly opened tiddler\n// srcElement - reference to the element containing the link to the tiddler -or-\n//              special positions \"top\", \"bottom\"\n// returns - reference to the tiddler that the new one should appear before (null for the bottom of the story)\nStory.prototype.positionTiddler = function(srcElement)\n{\n\tvar place = document.getElementById(this.container);\n\tvar before;\n\tif(typeof srcElement == \"string\")\n\t\t{\n\t\tswitch(srcElement)\n\t\t\t{\n\t\t\tcase \"top\":\n\t\t\t\tbefore = place.firstChild;\n\t\t\t\tbreak;\n\t\t\tcase \"bottom\":\n\t\t\t\tbefore = null;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\telse\n\t\t{\n\t\tvar after = this.findContainingTiddler(srcElement);\n\t\tif(after == null)\n\t\t\tbefore = place.firstChild;\n\t\telse if(after.nextSibling)\n\t\t\tbefore = after.nextSibling;\n\t\telse\n\t\t\tbefore = null;\n\t\t}\n\treturn before;\n}\n\n// Create a tiddler frame at the appropriate place in a story column\n// place - reference to parent element\n// before - null, or reference to element before which to insert new tiddler\n// title - title of new tiddler\n// template - the name of the tiddler containing the template or one of the constants DEFAULT_VIEW_TEMPLATE and DEFAULT_EDIT_TEMPLATE\nStory.prototype.createTiddler = function(place,before,title,template)\n{\n\tvar tiddlerElem = createTiddlyElement(null,\"div\",this.idPrefix + title,\"tiddler\");\n\ttiddlerElem.setAttribute(\"refresh\",\"tiddler\");\n\tplace.insertBefore(tiddlerElem,before);\n\tthis.refreshTiddler(title,template);\n\treturn tiddlerElem;\n}\n\n// Overridable for choosing the name of the template to apply for a tiddler\nStory.prototype.chooseTemplateForTiddler = function(title,template)\n{\n\tif(!template)\n\t\ttemplate = DEFAULT_VIEW_TEMPLATE;\n\tif(template == DEFAULT_VIEW_TEMPLATE || template == DEFAULT_EDIT_TEMPLATE)\n\t\ttemplate = config.tiddlerTemplates[template];\n\treturn template;\n}\n\n// Overridable for extracting the text of a template from a tiddler\nStory.prototype.getTemplateForTiddler = function(title,template,tiddler)\n{\n\treturn store.getRecursiveTiddlerText(template,null,10);\n}\n\n// Apply a template to an existing tiddler if it is not already displayed using that template\n// title - title of tiddler to update\n// template - the name of the tiddler containing the template or one of the constants DEFAULT_VIEW_TEMPLATE and DEFAULT_EDIT_TEMPLATE\n// force - if true, forces the refresh even if the template hasn't changedd\nStory.prototype.refreshTiddler = function(title,template,force)\n{\n\tvar tiddlerElem = document.getElementById(this.idPrefix + title);\n\tif(tiddlerElem)\n\t\t{\n\t\tif(tiddlerElem.getAttribute(\"dirty\") == \"true\" && !force)\n\t\t\treturn tiddlerElem;\n\t\ttemplate = this.chooseTemplateForTiddler(title,template);\n\t\tvar currTemplate = tiddlerElem.getAttribute(\"template\");\n\t\tif((template != currTemplate) || force)\n\t\t\t{\n\t\t\tvar tiddler = store.getTiddler(title);\n\t\t\tif(!tiddler)\n\t\t\t\t{\n\t\t\t\ttiddler = new Tiddler();\n\t\t\t\tif(store.isShadowTiddler(title))\n\t\t\t\t\ttiddler.set(title,store.getTiddlerText(title),config.views.wikified.shadowModifier,version.date,[],version.date);\n\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\tvar text = template==\"EditTemplate\"\n\t\t\t\t\t\t\t\t? config.views.editor.defaultText.format([title])\n\t\t\t\t\t\t\t\t: config.views.wikified.defaultText.format([title]);\n\t\t\t\t\ttiddler.set(title,text,config.views.wikified.defaultModifier,version.date,[],version.date);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\ttiddlerElem.setAttribute(\"tags\",tiddler.tags.join(\" \"));\n\t\t\ttiddlerElem.setAttribute(\"tiddler\",title);\n\t\t\ttiddlerElem.setAttribute(\"template\",template);\n\t\t\tvar me = this;\n\t\t\ttiddlerElem.onmouseover = this.onTiddlerMouseOver;\n\t\t\ttiddlerElem.onmouseout = this.onTiddlerMouseOut;\n\t\t\ttiddlerElem.ondblclick = this.onTiddlerDblClick;\n\t\t\ttiddlerElem[window.event?\"onkeydown\":\"onkeypress\"] = this.onTiddlerKeyPress;\n\t\t\tvar html = this.getTemplateForTiddler(title,template,tiddler);\n\t\t\ttiddlerElem.innerHTML = html;\n\t\t\tapplyHtmlMacros(tiddlerElem,tiddler);\n\t\t\tif(store.getTaggedTiddlers(title).length > 0)\n\t\t\t\taddClass(tiddlerElem,\"isTag\");\n\t\t\telse\n\t\t\t\tremoveClass(tiddlerElem,\"isTag\");\n\t\t\tif(!store.tiddlerExists(title))\n\t\t\t\t{\n\t\t\t\tif(store.isShadowTiddler(title))\n\t\t\t\t\taddClass(tiddlerElem,\"shadow\");\n\t\t\t\telse\n\t\t\t\t\taddClass(tiddlerElem,\"missing\");\n\t\t\t\t}\n\t\t\telse\n\t\t\t\t{\n\t\t\t\tremoveClass(tiddlerElem,\"shadow\");\n\t\t\t\tremoveClass(tiddlerElem,\"missing\");\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\treturn tiddlerElem;\n}\n\n// Refresh all tiddlers in the Story\nStory.prototype.refreshAllTiddlers = function()\n{\n\tvar place = document.getElementById(this.container);\n\tvar e = place.firstChild;\n\tif(!e)\n\t\treturn;\n\tthis.refreshTiddler(e.getAttribute(\"tiddler\"),e.getAttribute(\"template\"),true);\n\twhile((e = e.nextSibling) != null)\n\t\tthis.refreshTiddler(e.getAttribute(\"tiddler\"),e.getAttribute(\"template\"),true);\n}\n\n// Default tiddler onmouseover/out event handlers\nStory.prototype.onTiddlerMouseOver = function(e)\n{\n\tif(window.addClass instanceof Function)\n\t\taddClass(this,\"selected\");\n}\n\nStory.prototype.onTiddlerMouseOut = function(e)\n{\n\tif(window.removeClass instanceof Function)\n\t\tremoveClass(this,\"selected\");\n}\n\n// Default tiddler ondblclick event handler\nStory.prototype.onTiddlerDblClick = function(e)\n{\n\tif(!e) var e = window.event;\n\tvar theTarget = resolveTarget(e);\n\tif(theTarget && theTarget.nodeName.toLowerCase() != \"input\" && theTarget.nodeName.toLowerCase() != \"textarea\")\n\t\t{\n\t\tif(document.selection && document.selection.empty)\n\t\t\tdocument.selection.empty();\n\t\tconfig.macros.toolbar.invokeCommand(this,\"defaultCommand\",e);\n\t\te.cancelBubble = true;\n\t\tif (e.stopPropagation) e.stopPropagation();\n\t\treturn true;\n\t\t}\n\telse\n\t\treturn false;\n}\n\nStory.prototype.onTiddlerKeyPress = function(e)\n{\n\tif(!e) var e = window.event;\n\tclearMessage();\n\tvar consume = false;\n\tvar title = this.getAttribute(\"tiddler\");\n\tvar target = resolveTarget(e);\n\tswitch(e.keyCode)\n\t\t{\n\t\tcase 9: // Tab\n\t\t\tif(config.options.chkInsertTabs && target.tagName.toLowerCase() == \"textarea\")\n\t\t\t\t{\n\t\t\t\treplaceSelection(target,String.fromCharCode(9));\n\t\t\t\tconsume = true;\n\t\t\t\t}\n\t\t\tif(config.isOpera)\n\t\t\t\t{\n\t\t\t\ttarget.onblur = function()\n\t\t\t\t\t{\n\t\t\t\t\tthis.focus();\n\t\t\t\t\tthis.onblur = null;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\tbreak;\n\t\tcase 13: // Ctrl-Enter\n\t\tcase 10: // Ctrl-Enter on IE PC\n\t\tcase 77: // Ctrl-Enter is \"M\" on some platforms\n\t\t\tif(e.ctrlKey)\n\t\t\t\t{\n\t\t\t\tblurElement(this);\n\t\t\t\tconfig.macros.toolbar.invokeCommand(this,\"defaultCommand\",e);\n\t\t\t\tconsume = true;\n\t\t\t\t}\n\t\t\tbreak;\n\t\tcase 27: // Escape\n\t\t\tblurElement(this);\n\t\t\tconfig.macros.toolbar.invokeCommand(this,\"cancelCommand\",e);\n\t\t\tconsume = true;\n\t\t\tbreak;\n\t\t}\n\te.cancelBubble = consume;\n\tif(consume)\n\t\t{\n\t\tif(e.stopPropagation) e.stopPropagation(); // Stop Propagation\n\t\te.returnValue = true; // Cancel The Event in IE\n\t\tif(e.preventDefault ) e.preventDefault(); // Cancel The Event in Moz\n\t\t}\n\treturn(!consume);\n};\n\n// Returns the specified field (input or textarea element) in a tiddler, otherwise the first edit field it finds\n// or null if it found no edit field at all\nStory.prototype.getTiddlerField = function(title,field)\n{\n\tvar tiddlerElem = document.getElementById(this.idPrefix + title);\n\tvar e = null;\n\tif(tiddlerElem != null)\n\t\t{\n\t\tvar children = tiddlerElem.getElementsByTagName(\"*\");\n\t\tfor (var t=0; t<children.length; t++)\n\t\t\t{\n\t\t\tvar c = children[t];\n\t\t\tif(c.tagName.toLowerCase() == \"input\" || c.tagName.toLowerCase() == \"textarea\")\n\t\t\t\t{\n\t\t\t\tif(!e)\n\t\t\t\t\te = c;\n\t\t\t\tif(c.getAttribute(\"edit\") == field)\n\t\t\t\t\te = c;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\treturn e;\n}\n\n// Focus a specified tiddler. Attempts to focus the specified field, otherwise the first edit field it finds\nStory.prototype.focusTiddler = function(title,field)\n{\n\tvar e = this.getTiddlerField(title,field);\n\tif(e)\n\t\t{\n\t\te.focus();\n\t\te.select();\n\t\t}\n}\n\n// Ensures that a specified tiddler does not have the focus\nStory.prototype.blurTiddler = function(title)\n{\n\tvar tiddlerElem = document.getElementById(this.idPrefix + title);\n\tif(tiddlerElem != null && tiddlerElem.focus && tiddlerElem.blur)\n\t\t{\n\t\ttiddlerElem.focus();\n\t\ttiddlerElem.blur();\n\t\t}\n}\n\n// Adds a specified value to the edit controls (if any) of a particular\n// array-formatted field of a particular tiddler (eg \"tags\")\n//  title - name of tiddler\n//  tag - value of field, without any [[brackets]]\n//  mode - +1 to add the tag, -1 to remove it, 0 to toggle it\n//  field - name of field (eg \"tags\")\nStory.prototype.setTiddlerField = function(title,tag,mode,field)\n{\n\tvar c = story.getTiddlerField(title,field);\n\n\tvar tags = c.value.readBracketedList();\n\ttags.setItem(tag,mode);\n\tc.value = String.encodeTiddlyLinkList(tags);\n}\n\n// The same as setTiddlerField but preset to the \"tags\" field\nStory.prototype.setTiddlerTag = function(title,tag,mode)\n{\n\tStory.prototype.setTiddlerField(title,tag,mode,\"tags\");\n}\n\n// Close a specified tiddler\n// title - name of tiddler to close\n// animate - whether to perform animations\n// slowly - whether to perform animations in slomo\nStory.prototype.closeTiddler = function(title,animate,slowly)\n{\n\tvar tiddlerElem = document.getElementById(this.idPrefix + title);\n\tif(tiddlerElem != null)\n\t\t{\n\t\tclearMessage();\n\t\tthis.scrubTiddler(tiddlerElem);\n\t\tif(anim && config.options.chkAnimate && animate)\n\t\t\tanim.startAnimating(new Slider(tiddlerElem,false,slowly,\"all\"));\n\t\telse\n\t\t\ttiddlerElem.parentNode.removeChild(tiddlerElem);\n\t\t}\n}\n\n// Scrub IDs from a tiddler. This is so that the 'ghost' of a tiddler while it is being closed\n// does not interfere with things\n// tiddler - reference to the tiddler element\nStory.prototype.scrubTiddler = function(tiddlerElem)\n{\n\ttiddlerElem.id = null;\n}\n\n// Set the 'dirty' flag of a tiddler\n// title - title of tiddler to change\n// dirty - new boolean status of flag\nStory.prototype.setDirty = function(title,dirty)\n{\n\tvar tiddlerElem = document.getElementById(this.idPrefix + title);\n\tif(tiddlerElem != null)\n\t\ttiddlerElem.setAttribute(\"dirty\",dirty ? \"true\" : \"false\");\n}\n\n// Is a particular tiddler dirty (with unsaved changes)?\nStory.prototype.isDirty = function(title)\n{\n\tvar tiddlerElem = document.getElementById(this.idPrefix + title);\n\tif(tiddlerElem != null)\n\t\treturn tiddlerElem.getAttribute(\"dirty\") == \"true\";\n\treturn null;\n}\n\n// Determine whether any open tiddler are dirty\nStory.prototype.areAnyDirty = function()\n{\n\tvar r = false;\n\tthis.forEachTiddler(function(title,element) {\n\t\tif(this.isDirty(title))\n\t\t\tr = true;\n\t\t});\n\treturn r;\n}\n\n// Close all tiddlers in the story\nStory.prototype.closeAllTiddlers = function(exclude)\n{\n\tclearMessage();\n\tthis.forEachTiddler(function(title,element) {\n\t\tif((title != exclude) && element.getAttribute(\"dirty\") != \"true\")\n\t\t\tthis.closeTiddler(title);\n\t\t});\n\twindow.scrollTo(0,0);\n}\n\n// Check if there are any tiddlers in the story\nStory.prototype.isEmpty = function()\n{\n\tvar place = document.getElementById(this.container);\n\treturn(place && place.firstChild == null);\n}\n\n// Perform a search and display the result\n// text - text to search for\n// useCaseSensitive - true for case sensitive matching\n// useRegExp - true to interpret text as a RegExp\nStory.prototype.search = function(text,useCaseSensitive,useRegExp)\n{\n\tthis.closeAllTiddlers();\n\thighlightHack = new RegExp(useRegExp ?\t text : text.escapeRegExp(),useCaseSensitive ? \"mg\" : \"img\");\n\tvar matches = store.search(highlightHack,\"title\",\"excludeSearch\");\n\tvar titles = [];\n\tfor(var t=matches.length-1; t>=0; t--)\n\t\ttitles.push(matches[t].title);\n\tthis.displayTiddlers(null,titles);\n\thighlightHack = null;\n\tvar q = useRegExp ? \"/\" : \"'\";\n\tif(matches.length > 0)\n\t\tdisplayMessage(config.macros.search.successMsg.format([titles.length.toString(),q + text + q]));\n\telse\n\t\tdisplayMessage(config.macros.search.failureMsg.format([q + text + q]));\n}\n\n// Determine if the specified element is within a tiddler in this story\n// e - reference to an element\n// returns: reference to a tiddler element or null if none\nStory.prototype.findContainingTiddler = function(e)\n{\n\twhile(e && !hasClass(e,\"tiddler\"))\n\t\te = e.parentNode;\n\treturn(e);\n}\n\n// Gather any saveable fields from a tiddler element\n// e - reference to an element to scan recursively\n// fields - object to contain gathered field values\nStory.prototype.gatherSaveFields = function(e,fields)\n{\n\tif(e && e.getAttribute)\n\t\t{\n\t\tvar f = e.getAttribute(\"edit\");\n\t\tif(f)\n\t\t\tfields[f] = e.value.replace(/\\r/mg,\"\");;\n\t\tif(e.hasChildNodes())\n\t\t\t{\n\t\t\tvar c = e.childNodes;\n\t\t\tfor(var t=0; t<c.length; t++)\n\t\t\t\tthis.gatherSaveFields(c[t],fields)\n\t\t\t}\n\t\t}\n}\n\n// Determine whether a tiddler has any edit fields, and if so if their values have been changed\n// title - name of tiddler\nStory.prototype.hasChanges = function(title)\n{\n\tvar e = document.getElementById(this.idPrefix + title);\n\tif(e != null)\n\t\t{\n\t\tvar fields = {};\n\t\tthis.gatherSaveFields(e,fields);\n\t\tvar tiddler = store.fetchTiddler(title);\n\t\tif (!tiddler)\n\t\t\treturn false;\n\t\tfor(var n in fields)\n\t\t\tif (store.getValue(title,n) != fields[n])\n\t\t\t\treturn true;\n\t\t}\n\treturn false;\n}\n\n// Save any open edit fields of a tiddler and updates the display as necessary\n// title - name of tiddler\n// minorUpdate - true if the modified date shouldn't be updated\n// returns: title of saved tiddler, or null if not saved\nStory.prototype.saveTiddler = function(title,minorUpdate)\n{\n\tvar tiddlerElem = document.getElementById(this.idPrefix + title);\n\tif(tiddlerElem != null)\n\t\t{\n\t\tvar fields = {};\n\t\tthis.gatherSaveFields(tiddlerElem,fields);\n\t\tvar newTitle = fields.title ? fields.title : title;\n\t\tif(store.tiddlerExists(newTitle) && newTitle != title)\n\t\t\t{\n\t\t\tif(confirm(config.messages.overwriteWarning.format([newTitle.toString()])))\n\t\t\t\tthis.closeTiddler(newTitle,false,false);\n\t\t\telse\n\t\t\t\treturn null;\n\t\t\t}\n\t\ttiddlerElem.id = this.idPrefix + newTitle;\n\t\ttiddlerElem.setAttribute(\"tiddler\",newTitle);\n\t\ttiddlerElem.setAttribute(\"template\",DEFAULT_VIEW_TEMPLATE);\n\t\ttiddlerElem.setAttribute(\"dirty\",\"false\");\n\t\tif(config.options.chkForceMinorUpdate)\n\t\t\tminorUpdate = !minorUpdate;\n\t\tvar newDate = new Date();\n\t\tstore.saveTiddler(title,newTitle,fields.text,config.options.txtUserName,minorUpdate ? undefined : newDate,fields.tags);\n\t\tfor (var n in fields)\n\t\t\tif (!TiddlyWiki.isStandardField(n))\n\t\t\t\tstore.setValue(newTitle,n,fields[n]);\n\t\tif(config.options.chkAutoSave)\n\t\t\tsaveChanges();\n\t\treturn newTitle;\n\t\t}\n\treturn null;\n}\n\nStory.prototype.permaView = function()\n{\n\tvar links = [];\n\tthis.forEachTiddler(function(title,element) {\n\t\tlinks.push(String.encodeTiddlyLink(title));\n\t\t});\n\tvar t = encodeURIComponent(links.join(\" \"));\n\tif(t == \"\")\n\t\tt = \"#\";\n\tif(window.location.hash != t)\n\t\twindow.location.hash = t;\n}\n\n// ---------------------------------------------------------------------------------\n// Message area\n// ---------------------------------------------------------------------------------\n\nfunction getMessageDiv()\n{\n\tvar msgArea = document.getElementById(\"messageArea\");\n\tif(!msgArea)\n\t\treturn null;\n\tif(!msgArea.hasChildNodes())\n\t\tcreateTiddlyButton(createTiddlyElement(msgArea,\"div\",null,\"messageToolbar\"),\n\t\t\tconfig.messages.messageClose.text,\n\t\t\tconfig.messages.messageClose.tooltip,\n\t\t\tclearMessage);\n\tmsgArea.style.display = \"block\";\n\treturn createTiddlyElement(msgArea,\"div\");\n}\n\nfunction displayMessage(text,linkText)\n{\n\tvar e = getMessageDiv();\n\tif(!e)\n\t\t{\n\t\talert(text);\n\t\treturn;\n\t\t}\n\tif(linkText)\n\t\t{\n\t\tvar link = createTiddlyElement(e,\"a\",null,null,text);\n\t\tlink.href = linkText;\n\t\tlink.target = \"_blank\";\n\t\t}\n\telse\n\t\te.appendChild(document.createTextNode(text));\n}\n\nfunction clearMessage()\n{\n\tvar msgArea = document.getElementById(\"messageArea\");\n\tif(msgArea)\n\t\t{\n\t\tremoveChildren(msgArea);\n\t\tmsgArea.style.display = \"none\";\n\t\t}\n\treturn false;\n}\n\n// ---------------------------------------------------------------------------------\n// Refresh mechanism\n// ---------------------------------------------------------------------------------\n\nconfig.refreshers = {\n\tlink: function(e,changeList)\n\t\t{\n\t\tvar title = e.getAttribute(\"tiddlyLink\");\n\t\trefreshTiddlyLink(e,title);\n\t\treturn true;\n\t\t},\n\n\ttiddler: function(e,changeList)\n\t\t{\n\t\tvar title = e.getAttribute(\"tiddler\");\n\t\tvar template = e.getAttribute(\"template\");\n\t\tif(changeList && changeList.indexOf(title) != -1 && !story.isDirty(title))\n\t\t\tstory.refreshTiddler(title,template,true);\n\t\telse\n\t\t\trefreshElements(e,changeList);\n\t\treturn true;\n\t\t},\n\n\tcontent: function(e,changeList)\n\t\t{\n\t\tvar title = e.getAttribute(\"tiddler\");\n\t\tvar force = e.getAttribute(\"force\");\n\t\tif(force != null || changeList == null || changeList.indexOf(title) != -1)\n\t\t\t{\n\t\t\tremoveChildren(e);\n\t\t\twikify(store.getTiddlerText(title,title),e);\n\t\t\treturn true;\n\t\t\t}\n\t\telse\n\t\t\treturn false;\n\t\t},\n\n\tmacro: function(e,changeList)\n\t\t{\n\t\tvar macro = e.getAttribute(\"macroName\");\n\t\tvar params = e.getAttribute(\"params\");\n\t\tif(macro)\n\t\t\tmacro = config.macros[macro];\n\t\tif(macro && macro.refresh)\n\t\t\tmacro.refresh(e,params);\n\t\treturn true;\n\t\t}\n};\n\nfunction refreshElements(root,changeList)\n{\n\tvar nodes = root.childNodes;\n\tfor(var c=0; c<nodes.length; c++)\n\t\t{\n\t\tvar e = nodes[c],type;\n\t\tif(e.getAttribute)\n\t\t\ttype = e.getAttribute(\"refresh\");\n\t\telse\n\t\t\ttype = null;\n\t\tvar refresher = config.refreshers[type];\n\t\tvar refreshed = false;\n\t\tif(refresher != undefined)\n\t\t\trefreshed = refresher(e,changeList);\n\t\tif(e.hasChildNodes() && !refreshed)\n\t\t\trefreshElements(e,changeList);\n\t\t}\n}\n\nfunction applyHtmlMacros(root,tiddler)\n{\n\tvar e = root.firstChild;\n\twhile(e)\n\t\t{\n\t\tvar nextChild = e.nextSibling;\n\t\tif(e.getAttribute)\n\t\t\t{\n\t\t\tvar macro = e.getAttribute(\"macro\");\n\t\t\tif(macro)\n\t\t\t\t{\n\t\t\t\tvar params = \"\";\n\t\t\t\tvar p = macro.indexOf(\" \");\n\t\t\t\tif(p != -1)\n\t\t\t\t\t{\n\t\t\t\t\tparams = macro.substr(p+1);\n\t\t\t\t\tmacro = macro.substr(0,p);\n\t\t\t\t\t}\n\t\t\t\tinvokeMacro(e,macro,params,null,tiddler);\n\t\t\t\t}\n\t\t\t}\n\t\tif(e.hasChildNodes())\n\t\t\tapplyHtmlMacros(e,tiddler);\n\t\te = nextChild;\n\t\t}\n}\n\nfunction refreshPageTemplate(title)\n{\n\tvar stash = createTiddlyElement(document.body,\"div\");\n\tstash.style.display = \"none\";\n\tvar display = document.getElementById(\"tiddlerDisplay\");\n\tvar nodes,t;\n\tif(display)\n\t\t{\n\t\tnodes = display.childNodes;\n\t\tfor(t=nodes.length-1; t>=0; t--)\n\t\t\tstash.appendChild(nodes[t]);\n\t\t}\n\tvar wrapper = document.getElementById(\"contentWrapper\");\n\tif(!title)\n\t\ttitle = \"PageTemplate\";\n\tvar html = store.getRecursiveTiddlerText(title,null,10);\n\twrapper.innerHTML = html;\n\tapplyHtmlMacros(wrapper);\n\trefreshElements(wrapper);\n\tdisplay = document.getElementById(\"tiddlerDisplay\");\n\tremoveChildren(display);\n\tif(!display)\n\t\tdisplay = createTiddlyElement(wrapper,\"div\",\"tiddlerDisplay\");\n\tnodes = stash.childNodes;\n\tfor(t=nodes.length-1; t>=0; t--)\n\t\tdisplay.appendChild(nodes[t]);\n\tstash.parentNode.removeChild(stash);\n}\n\nfunction refreshDisplay(hint)\n{\n\tvar e = document.getElementById(\"contentWrapper\");\n\tif(typeof hint == \"string\")\n\t\thint = [hint];\n\trefreshElements(e,hint);\n}\n\nfunction refreshPageTitle()\n{\n\tdocument.title = wikifyPlain(\"SiteTitle\") + \" - \" + wikifyPlain(\"SiteSubtitle\");\n}\n\nfunction refreshStyles(title)\n{\n\tsetStylesheet(title == null ? \"\" : store.getRecursiveTiddlerText(title,\"\",10),title);\n}\n\nfunction refreshColorPalette(title)\n{\n\tif(!startingUp)\n\t\trefreshAll();\n}\n\nfunction refreshAll()\n{\n\trefreshPageTemplate();\n\trefreshDisplay();\n\trefreshStyles(\"StyleSheetLayout\");\n\trefreshStyles(\"StyleSheetColors\");\n\trefreshStyles(\"StyleSheet\");\n\trefreshStyles(\"StyleSheetPrint\");\n}\n\n// ---------------------------------------------------------------------------------\n// Options cookie stuff\n// ---------------------------------------------------------------------------------\n\nfunction loadOptionsCookie()\n{\n\tif(safeMode)\n\t\treturn;\n\tvar cookies = document.cookie.split(\";\");\n\tfor(var c=0; c<cookies.length; c++)\n\t\t{\n\t\tvar p = cookies[c].indexOf(\"=\");\n\t\tif(p != -1)\n\t\t\t{\n\t\t\tvar name = cookies[c].substr(0,p).trim();\n\t\t\tvar value = cookies[c].substr(p+1).trim();\n\t\t\tswitch(name.substr(0,3))\n\t\t\t\t{\n\t\t\t\tcase \"txt\":\n\t\t\t\t\tconfig.options[name] = unescape(value);\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"chk\":\n\t\t\t\t\tconfig.options[name] = value == \"true\";\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n}\n\nfunction saveOptionCookie(name)\n{\n\tif(safeMode)\n\t\treturn;\n\tvar c = name + \"=\";\n\tswitch(name.substr(0,3))\n\t\t{\n\t\tcase \"txt\":\n\t\t\tc += escape(config.options[name].toString());\n\t\t\tbreak;\n\t\tcase \"chk\":\n\t\t\tc += config.options[name] ? \"true\" : \"false\";\n\t\t\tbreak;\n\t\t}\n\tc += \"; expires=Fri, 1 Jan 2038 12:00:00 UTC; path=/\";\n\tdocument.cookie = c;\n}\n\n// ---------------------------------------------------------------------------------\n// Saving\n// ---------------------------------------------------------------------------------\n\nvar saveUsingSafari = false;\n\nvar startSaveArea = '<div id=\"' + 'storeArea\">'; // Split up into two so that indexOf() of this source doesn't find it\nvar endSaveArea = '</d' + 'iv>';\n\n// If there are unsaved changes, force the user to confirm before exitting\nfunction confirmExit()\n{\n\thadConfirmExit = true;\n\tif((store && store.isDirty && store.isDirty()) || (story && story.areAnyDirty && story.areAnyDirty()))\n\t\treturn config.messages.confirmExit;\n}\n\n// Give the user a chance to save changes before exitting\nfunction checkUnsavedChanges()\n{\n\tif(store && store.isDirty && store.isDirty() && window.hadConfirmExit === false)\n\t\t{\n\t\tif(confirm(config.messages.unsavedChangesWarning))\n\t\t\tsaveChanges();\n\t\t}\n}\n\nfunction updateMarkupBlock(s,blockName,tiddlerName)\n{\n\treturn s.replaceChunk(\n\t\t\t\"<!--%0-START-->\".format([blockName]),\n\t\t\t\"<!--%0-END-->\".format([blockName]),\n\t\t\t\"\\n\" + store.getRecursiveTiddlerText(tiddlerName,\"\") + \"\\n\");\n}\n\n// Save this tiddlywiki with the pending changes\nfunction saveChanges(onlyIfDirty)\n{\n\tif(onlyIfDirty && !store.isDirty())\n\t\treturn;\n\tclearMessage();\n\t// Get the URL of the document\n\tvar originalPath = document.location.toString();\n\t// Check we were loaded from a file URL\n\tif(originalPath.substr(0,5) != \"file:\")\n\t\t{\n\t\talert(config.messages.notFileUrlError);\n\t\tif(store.tiddlerExists(config.messages.saveInstructions))\n\t\t\tstory.displayTiddler(null,config.messages.saveInstructions);\n\t\treturn;\n\t\t}\n\tvar localPath = getLocalPath(originalPath);\n\t// Load the original file\n\tvar original = loadFile(localPath);\n\tif(original == null)\n\t\t{\n\t\talert(config.messages.cantSaveError);\n\t\tif(store.tiddlerExists(config.messages.saveInstructions))\n\t\t\tstory.displayTiddler(null,config.messages.saveInstructions);\n\t\treturn;\n\t\t}\n\t// Locate the storeArea div's\n\tvar posOpeningDiv = original.indexOf(startSaveArea);\n\tvar limitClosingDiv = original.indexOf(\"<!--POST-BODY-START--\"+\">\");\n\tvar posClosingDiv = original.lastIndexOf(endSaveArea,limitClosingDiv == -1 ? original.length : limitClosingDiv);\n\tif((posOpeningDiv == -1) || (posClosingDiv == -1))\n\t\t{\n\t\talert(config.messages.invalidFileError.format([localPath]));\n\t\treturn;\n\t\t}\n\t// Save the backup\n\tif(config.options.chkSaveBackups)\n\t\t{\n\t\tvar backupPath = getBackupPath(localPath);\n\t\tvar backup = saveFile(backupPath,original);\n\t\tif(backup)\n\t\t\tdisplayMessage(config.messages.backupSaved,\"file://\" + backupPath);\n\t\telse\n\t\t\talert(config.messages.backupFailed);\n\t\t}\n\t// Save Rss\n\tif(config.options.chkGenerateAnRssFeed)\n\t\t{\n\t\tvar rssPath = localPath.substr(0,localPath.lastIndexOf(\".\")) + \".xml\";\n\t\tvar rssSave = saveFile(rssPath,convertUnicodeToUTF8(generateRss()));\n\t\tif(rssSave)\n\t\t\tdisplayMessage(config.messages.rssSaved,\"file://\" + rssPath);\n\t\telse\n\t\t\talert(config.messages.rssFailed);\n\t\t}\n\t// Save empty template\n\tif(config.options.chkSaveEmptyTemplate)\n\t\t{\n\t\tvar emptyPath,p;\n\t\tif((p = localPath.lastIndexOf(\"/\")) != -1)\n\t\t\temptyPath = localPath.substr(0,p) + \"/empty.html\";\n\t\telse if((p = localPath.lastIndexOf(\"\\\\\")) != -1)\n\t\t\temptyPath = localPath.substr(0,p) + \"\\\\empty.html\";\n\t\telse\n\t\t\temptyPath = localPath + \".empty.html\";\n\t\tvar empty = original.substr(0,posOpeningDiv + startSaveArea.length) + original.substr(posClosingDiv);\n\t\tvar emptySave = saveFile(emptyPath,empty);\n\t\tif(emptySave)\n\t\t\tdisplayMessage(config.messages.emptySaved,\"file://\" + emptyPath);\n\t\telse\n\t\t\talert(config.messages.emptyFailed);\n\t\t}\n\tvar save;\n\ttry\n\t\t{\n\t\t// Save new file\n\t\tvar revised = original.substr(0,posOpeningDiv + startSaveArea.length) + \"\\n\" +\n\t\t\t\t\tconvertUnicodeToUTF8(store.allTiddlersAsHtml()) + \"\\n\" +\n\t\t\t\t\toriginal.substr(posClosingDiv);\n\t\tvar newSiteTitle = convertUnicodeToUTF8((wikifyPlain(\"SiteTitle\") + \" - \" + wikifyPlain(\"SiteSubtitle\")).htmlEncode());\n\t\trevised = revised.replaceChunk(\"<title\"+\">\",\"</title\"+\">\",\" \" + newSiteTitle + \" \");\n\t\trevised = updateMarkupBlock(revised,\"PRE-HEAD\",\"MarkupPreHead\");\n\t\trevised = updateMarkupBlock(revised,\"POST-HEAD\",\"MarkupPostHead\");\n\t\trevised = updateMarkupBlock(revised,\"PRE-BODY\",\"MarkupPreBody\");\n\t\trevised = updateMarkupBlock(revised,\"POST-BODY\",\"MarkupPostBody\");\n\t\tsave = saveFile(localPath,revised);\n\t\t}\n\tcatch (e)\n\t\t{\n\t\tshowException(e);\n\t\t}\n\tif(save)\n\t\t{\n\t\tdisplayMessage(config.messages.mainSaved,\"file://\" + localPath);\n\t\tstore.setDirty(false);\n\t\t}\n\telse\n\t\talert(config.messages.mainFailed);\n}\n\nfunction getLocalPath(originalPath)\n{\n\t// Remove any location or query part of the URL\n\tvar argPos = originalPath.indexOf(\"?\");\n\tif(argPos != -1)\n\t\toriginalPath = originalPath.substr(0,argPos);\n\tvar hashPos = originalPath.indexOf(\"#\");\n\tif(hashPos != -1)\n\t\toriginalPath = originalPath.substr(0,hashPos);\n\t// Convert file://localhost/ to file:///\n\tif(originalPath.indexOf(\"file://localhost/\") == 0)\n\t\toriginalPath = \"file://\" + originalPath.substr(16);\n\t// Convert to a native file format assuming\n\t// \"file:///x:/path/path/path...\" - pc local file --> \"x:\\path\\path\\path...\"\n\t// \"file://///server/share/path/path/path...\" - FireFox pc network file --> \"\\\\server\\share\\path\\path\\path...\"\n\t// \"file:///path/path/path...\" - mac/unix local file --> \"/path/path/path...\"\n\t// \"file://server/share/path/path/path...\" - pc network file --> \"\\\\server\\share\\path\\path\\path...\"\n\tvar localPath;\n\tif(originalPath.charAt(9) == \":\") // pc local file\n\t\tlocalPath = unescape(originalPath.substr(8)).replace(new RegExp(\"/\",\"g\"),\"\\\\\");\n\telse if(originalPath.indexOf(\"file://///\") == 0) // FireFox pc network file\n\t\tlocalPath = \"\\\\\\\\\" + unescape(originalPath.substr(10)).replace(new RegExp(\"/\",\"g\"),\"\\\\\");\n\telse if(originalPath.indexOf(\"file:///\") == 0) // mac/unix local file\n\t\tlocalPath = unescape(originalPath.substr(7));\n\telse if(originalPath.indexOf(\"file:/\") == 0) // mac/unix local file\n\t\tlocalPath = unescape(originalPath.substr(5));\n\telse // pc network file\n\t\tlocalPath = \"\\\\\\\\\" + unescape(originalPath.substr(7)).replace(new RegExp(\"/\",\"g\"),\"\\\\\");\n\treturn localPath;\n}\n\nfunction getBackupPath(localPath)\n{\n\tvar backSlash = true;\n\tvar dirPathPos = localPath.lastIndexOf(\"\\\\\");\n\tif(dirPathPos == -1)\n\t\t{\n\t\tdirPathPos = localPath.lastIndexOf(\"/\");\n\t\tbackSlash = false;\n\t\t}\n\tvar backupFolder = config.options.txtBackupFolder;\n\tif(!backupFolder || backupFolder == \"\")\n\t\tbackupFolder = \".\";\n\tvar backupPath = localPath.substr(0,dirPathPos) + (backSlash ? \"\\\\\" : \"/\") + backupFolder + localPath.substr(dirPathPos);\n\tbackupPath = backupPath.substr(0,backupPath.lastIndexOf(\".\")) + \".\" + (new Date()).convertToYYYYMMDDHHMMSSMMM() + \".html\";\n\treturn backupPath;\n}\n\nfunction generateRss()\n{\n\tvar s = [];\n\tvar d = new Date();\n\tvar u = store.getTiddlerText(\"SiteUrl\");\n\t// Assemble the header\n\ts.push(\"<\" + \"?xml version=\\\"1.0\\\"?\" + \">\");\n\ts.push(\"<rss version=\\\"2.0\\\">\");\n\ts.push(\"<channel>\");\n\ts.push(\"<title\" + \">\" + wikifyPlain(\"SiteTitle\").htmlEncode() + \"</title\" + \">\");\n\tif(u)\n\t\ts.push(\"<link>\" + u.htmlEncode() + \"</link>\");\n\ts.push(\"<description>\" + wikifyPlain(\"SiteSubtitle\").htmlEncode() + \"</description>\");\n\ts.push(\"<language>en-us</language>\");\n\ts.push(\"<copyright>Copyright \" + d.getFullYear() + \" \" + config.options.txtUserName.htmlEncode() + \"</copyright>\");\n\ts.push(\"<pubDate>\" + d.toGMTString() + \"</pubDate>\");\n\ts.push(\"<lastBuildDate>\" + d.toGMTString() + \"</lastBuildDate>\");\n\ts.push(\"<docs>http://blogs.law.harvard.edu/tech/rss</docs>\");\n\ts.push(\"<generator>TiddlyWiki \" + version.major + \".\" + version.minor + \".\" + version.revision + \"</generator>\");\n\t// The body\n\tvar tiddlers = store.getTiddlers(\"modified\",\"excludeLists\");\n\tvar n = config.numRssItems > tiddlers.length ? 0 : tiddlers.length-config.numRssItems;\n\tfor (var t=tiddlers.length-1; t>=n; t--)\n\t\ts.push(tiddlers[t].saveToRss(u));\n\t// And footer\n\ts.push(\"</channel>\");\n\ts.push(\"</rss>\");\n\t// Save it all\n\treturn s.join(\"\\n\");\n}\n\n\n// UTF-8 encoding rules:\n// 0x0000 - 0x007F:\t0xxxxxxx\n// 0x0080 - 0x07FF:\t110xxxxx 10xxxxxx\n// 0x0800 - 0xFFFF:\t1110xxxx 10xxxxxx 10xxxxxx\n\nfunction convertUTF8ToUnicode(u)\n{\n\tif(window.netscape == undefined)\n\t\treturn manualConvertUTF8ToUnicode(u);\n\telse\n\t\treturn mozConvertUTF8ToUnicode(u);\n}\n\nfunction manualConvertUTF8ToUnicode(utf)\n{\n\tvar uni = utf;\n\tvar src = 0;\n\tvar dst = 0;\n\tvar b1, b2, b3;\n\tvar c;\n\twhile(src < utf.length)\n\t\t{\n\t\tb1 = utf.charCodeAt(src++);\n\t\tif(b1 < 0x80)\n\t\t\tdst++;\n\t\telse if(b1 < 0xE0)\n\t\t\t{\n\t\t\tb2 = utf.charCodeAt(src++);\n\t\t\tc = String.fromCharCode(((b1 & 0x1F) << 6) | (b2 & 0x3F));\n\t\t\tuni = uni.substring(0,dst++).concat(c,utf.substr(src));\n\t\t\t}\n\t\telse\n\t\t\t{\n\t\t\tb2 = utf.charCodeAt(src++);\n\t\t\tb3 = utf.charCodeAt(src++);\n\t\t\tc = String.fromCharCode(((b1 & 0xF) << 12) | ((b2 & 0x3F) << 6) | (b3 & 0x3F));\n\t\t\tuni = uni.substring(0,dst++).concat(c,utf.substr(src));\n\t\t\t}\n\t}\n\treturn(uni);\n}\n\nfunction mozConvertUTF8ToUnicode(u)\n{\n\ttry\n\t\t{\n\t\tnetscape.security.PrivilegeManager.enablePrivilege(\"UniversalXPConnect\");\n\t\tvar converter = Components.classes[\"@mozilla.org/intl/scriptableunicodeconverter\"].createInstance(Components.interfaces.nsIScriptableUnicodeConverter);\n\t\tconverter.charset = \"UTF-8\";\n\t\t}\n\tcatch(e)\n\t\t{\n\t\treturn manualConvertUTF8ToUnicode(u);\n\t\t} // fallback\n\tvar s = converter.ConvertToUnicode(u);\n\tvar fin = converter.Finish();\n\treturn (fin.length > 0) ? s+fin : s;\n}\n\nfunction convertUnicodeToUTF8(s)\n{\n\tif(window.netscape == undefined)\n\t\treturn manualConvertUnicodeToUTF8(s);\n\telse\n\t\treturn mozConvertUnicodeToUTF8(s);\n}\n\nfunction manualConvertUnicodeToUTF8(s)\n{\n\tvar re = /[^\\u0000-\\u007F]/g ;\n\treturn s.replace(re, function($0) {return(\"&#\" + $0.charCodeAt(0).toString() + \";\");})\n}\n\nfunction mozConvertUnicodeToUTF8(s)\n{\n\ttry\n\t\t{\n\t\tnetscape.security.PrivilegeManager.enablePrivilege(\"UniversalXPConnect\");\n\t\tvar converter = Components.classes[\"@mozilla.org/intl/scriptableunicodeconverter\"].createInstance(Components.interfaces.nsIScriptableUnicodeConverter);\n\t\tconverter.charset = \"UTF-8\";\n\t\t}\n\tcatch(e)\n\t\t{\n\t\treturn manualConvertUnicodeToUTF8(s);\n\t\t} // fallback\n\tvar u = converter.ConvertFromUnicode(s);\n\tvar fin = converter.Finish();\n\tif(fin.length > 0)\n\t\treturn u + fin;\n\telse\n\t\treturn u;\n}\n\nfunction saveFile(fileUrl, content)\n{\n\tvar r = null;\n\tif((r == null) || (r == false))\n\t\tr = mozillaSaveFile(fileUrl, content);\n\tif((r == null) || (r == false))\n\t\tr = ieSaveFile(fileUrl, content);\n\tif((r == null) || (r == false))\n\t\tr = javaSaveFile(fileUrl, content);\n\treturn(r);\n}\n\nfunction loadFile(fileUrl)\n{\n\tvar r = null;\n\tif((r == null) || (r == false))\n\t\tr = mozillaLoadFile(fileUrl);\n\tif((r == null) || (r == false))\n\t\tr = ieLoadFile(fileUrl);\n\tif((r == null) || (r == false))\n\t\tr = javaLoadFile(fileUrl);\n\treturn(r);\n}\n\n// Returns null if it can't do it, false if there's an error, true if it saved OK\nfunction ieSaveFile(filePath, content)\n{\n\ttry\n\t\t{\n\t\tvar fso = new ActiveXObject(\"Scripting.FileSystemObject\");\n\t\t}\n\tcatch(e)\n\t\t{\n\t\t//alert(\"Exception while attempting to save\\n\\n\" + e.toString());\n\t\treturn(null);\n\t\t}\n\tvar file = fso.OpenTextFile(filePath,2,-1,0);\n\tfile.Write(content);\n\tfile.Close();\n\treturn(true);\n}\n\n// Returns null if it can't do it, false if there's an error, or a string of the content if successful\nfunction ieLoadFile(filePath)\n{\n\ttry\n\t\t{\n\t\tvar fso = new ActiveXObject(\"Scripting.FileSystemObject\");\n\t\tvar file = fso.OpenTextFile(filePath,1);\n\t\tvar content = file.ReadAll();\n\t\tfile.Close();\n\t\t}\n\tcatch(e)\n\t\t{\n\t\t//alert(\"Exception while attempting to load\\n\\n\" + e.toString());\n\t\treturn(null);\n\t\t}\n\treturn(content);\n}\n\n// Returns null if it can't do it, false if there's an error, true if it saved OK\nfunction mozillaSaveFile(filePath, content)\n{\n\tif(window.Components)\n\t\ttry\n\t\t\t{\n\t\t\tnetscape.security.PrivilegeManager.enablePrivilege(\"UniversalXPConnect\");\n\t\t\tvar file = Components.classes[\"@mozilla.org/file/local;1\"].createInstance(Components.interfaces.nsILocalFile);\n\t\t\tfile.initWithPath(filePath);\n\t\t\tif (!file.exists())\n\t\t\t\tfile.create(0, 0664);\n\t\t\tvar out = Components.classes[\"@mozilla.org/network/file-output-stream;1\"].createInstance(Components.interfaces.nsIFileOutputStream);\n\t\t\tout.init(file, 0x20 | 0x02, 00004,null);\n\t\t\tout.write(content, content.length);\n\t\t\tout.flush();\n\t\t\tout.close();\n\t\t\treturn(true);\n\t\t\t}\n\t\tcatch(e)\n\t\t\t{\n\t\t\t//alert(\"Exception while attempting to save\\n\\n\" + e);\n\t\t\treturn(false);\n\t\t\t}\n\treturn(null);\n}\n\n// Returns null if it can't do it, false if there's an error, or a string of the content if successful\nfunction mozillaLoadFile(filePath)\n{\n\tif(window.Components)\n\t\ttry\n\t\t\t{\n\t\t\tnetscape.security.PrivilegeManager.enablePrivilege(\"UniversalXPConnect\");\n\t\t\tvar file = Components.classes[\"@mozilla.org/file/local;1\"].createInstance(Components.interfaces.nsILocalFile);\n\t\t\tfile.initWithPath(filePath);\n\t\t\tif (!file.exists())\n\t\t\t\treturn(null);\n\t\t\tvar inputStream = Components.classes[\"@mozilla.org/network/file-input-stream;1\"].createInstance(Components.interfaces.nsIFileInputStream);\n\t\t\tinputStream.init(file, 0x01, 00004, null);\n\t\t\tvar sInputStream = Components.classes[\"@mozilla.org/scriptableinputstream;1\"].createInstance(Components.interfaces.nsIScriptableInputStream);\n\t\t\tsInputStream.init(inputStream);\n\t\t\treturn(sInputStream.read(sInputStream.available()));\n\t\t\t}\n\t\tcatch(e)\n\t\t\t{\n\t\t\t//alert(\"Exception while attempting to load\\n\\n\" + e);\n\t\t\treturn(false);\n\t\t\t}\n\treturn(null);\n}\n\nfunction javaUrlToFilename(url)\n{\n\tvar f = \"//localhost\";\n\tif(url.indexOf(f) == 0)\n\t\treturn url.substring(f.length);\n\tvar i = url.indexOf(\":\");\n\tif(i > 0)\n\t\treturn url.substring(i-1);\n\treturn url;\n}\n\nfunction javaSaveFile(filePath, content)\n{\n\ttry\n\t\t{\n\t\tif(document.applets[\"TiddlySaver\"])\n\t\t\treturn document.applets[\"TiddlySaver\"].saveFile(javaUrlToFilename(filePath),\"UTF-8\",content);\n\t\t}\n\tcatch(e)\n\t\t{\n\t\t}\n\ttry\n\t\t{\n\t\tvar s = new java.io.PrintStream(new java.io.FileOutputStream(javaUrlToFilename(filePath)));\n\t\ts.print(content);\n\t\ts.close();\n\t\t}\n\tcatch(e)\n\t\t{\n\t\treturn null;\n\t\t}\n\treturn true;\n}\n\nfunction javaLoadFile(filePath)\n{\n\ttry\n\t\t{\n\tif(document.applets[\"TiddlySaver\"])\n\t\treturn String(document.applets[\"TiddlySaver\"].loadFile(javaUrlToFilename(filePath),\"UTF-8\"));\n\t\t}\n\tcatch(e)\n\t\t{\n\t\t}\n\tvar content = [];\n\ttry\n\t\t{\n\t\tvar r = new java.io.BufferedReader(new java.io.FileReader(javaUrlToFilename(filePath)));\n\t\tvar line;\n\t\twhile ((line = r.readLine()) != null)\n\t\t\tcontent.push(new String(line));\n\t\tr.close();\n\t\t}\n\tcatch(e)\n\t\t{\n\t\treturn null;\n\t\t}\n\treturn content.join(\"\\n\");\n}\n\n\n// ---------------------------------------------------------------------------------\n// Remote HTTP requests\n// ---------------------------------------------------------------------------------\n\n// Load a file over http\n//   url - the source url\n//   callback - function to call when there's a response\n//   params - parameter object that gets passed to the callback for storing it's state\n// Return value is the underlying XMLHttpRequest object, or 'null' if there was an error\n// Callback function is called like this:\n//   callback(status,params,responseText,xhr)\n//     status - true if OK, false if error\n//     params - the parameter object provided to loadRemoteFile()\n//     responseText - the text of the file\n//     xhr - the underlying XMLHttpRequest object\nfunction loadRemoteFile(url,callback,params)\n{\n\t// Get an xhr object\n\tvar x;\n\ttry\n\t\t{\n\t\tx = new XMLHttpRequest(); // Modern\n\t\t}\n\tcatch(e)\n\t\t{\n\t\ttry\n\t\t\t{\n\t\t\tx = new ActiveXObject(\"Msxml2.XMLHTTP\"); // IE 6\n\t\t\t}\n\t\tcatch (e)\n\t\t\t{\n\t\t\treturn null;\n\t\t\t}\n\t\t}\n\t// Install callback\n\tx.onreadystatechange = function()\n\t\t{\n\t\tif (x.readyState == 4)\n\t\t\t{\n\t\t\tif ((x.status == 0 || x.status == 200) && callback)\n\t\t\t\t{\n\t\t\t\tcallback(true,params,x.responseText,url,x);\n\t\t\t}\n\t\t\telse\n\t\t\t\tcallback(false,params,null,url,x);\n\t\t\t}\n\t\t}\n\t// Send request\n\tif(window.netscape && window.netscape.security && document.location.protocol.indexOf(\"http\") == -1)\n\t\twindow.netscape.security.PrivilegeManager.enablePrivilege(\"UniversalBrowserRead\");\n\ttry\n\t\t{\n\t\turl = url + (url.indexOf(\"?\") < 0 ? \"?\" : \"&\") + \"nocache=\" + Math.random();\n\t\tx.open(\"GET\",url,true);\n\t\tif (x.overrideMimeType)\n\t\t\tx.overrideMimeType(\"text/html\");\n\t\tx.send(null);\n\t\t}\n\tcatch (e)\n\t\t{\n\t\talert(\"Error in send \" + e);\n\t\treturn null;\n\t\t}\n\treturn x;\n}\n// ---------------------------------------------------------------------------------\n// TiddlyWiki-specific utility functions\n// ---------------------------------------------------------------------------------\n\nfunction createTiddlyButton(theParent,theText,theTooltip,theAction,theClass,theId,theAccessKey)\n{\n\tvar theButton = document.createElement(\"a\");\n\tif(theAction)\n\t\t{\n\t\ttheButton.onclick = theAction;\n\t\ttheButton.setAttribute(\"href\",\"javascript:;\");\n\t\t}\n\tif(theTooltip)\n\t\ttheButton.setAttribute(\"title\",theTooltip);\n\tif(theText)\n\t\ttheButton.appendChild(document.createTextNode(theText));\n\tif(theClass)\n\t\ttheButton.className = theClass;\n\telse\n\t\ttheButton.className = \"button\";\n\tif(theId)\n\t\ttheButton.id = theId;\n\tif(theParent)\n\t\ttheParent.appendChild(theButton);\n\tif(theAccessKey)\n\t\ttheButton.setAttribute(\"accessKey\",theAccessKey);\n\treturn(theButton);\n}\n\nfunction createTiddlyLink(place,title,includeText,theClass,isStatic)\n{\n\tvar text = includeText ? title : null;\n\tvar i = getTiddlyLinkInfo(title,theClass)\n\tvar btn;\n\tif(isStatic)\n\t\tbtn = createExternalLink(place,\"#\" + title);\n\telse\n\t\tbtn = createTiddlyButton(place,text,i.subTitle,onClickTiddlerLink,i.classes);\n\tbtn.setAttribute(\"refresh\",\"link\");\n\tbtn.setAttribute(\"tiddlyLink\",title);\n\treturn(btn);\n}\n\nfunction refreshTiddlyLink(e,title)\n{\n\tvar i = getTiddlyLinkInfo(title,e.className);\n\te.className = i.classes;\n\te.title = i.subTitle;\n}\n\nfunction getTiddlyLinkInfo(title,currClasses)\n{\n\tvar classes = currClasses ? currClasses.split(\" \") : [];\n\tclasses.pushUnique(\"tiddlyLink\");\n\tvar tiddler = store.fetchTiddler(title);\n\tvar subTitle;\n\tif(tiddler)\n\t\t{\n\t\tsubTitle = tiddler.getSubtitle();\n\t\tclasses.pushUnique(\"tiddlyLinkExisting\");\n\t\tclasses.remove(\"tiddlyLinkNonExisting\");\n\t\tclasses.remove(\"shadow\");\n\t\t}\n\telse\n\t\t{\n\t\tclasses.remove(\"tiddlyLinkExisting\");\n\t\tclasses.pushUnique(\"tiddlyLinkNonExisting\");\n\t\tif(store.isShadowTiddler(title))\n\t\t\t{\n\t\t\tsubTitle = config.messages.shadowedTiddlerToolTip.format([title]);\n\t\t\tclasses.pushUnique(\"shadow\");\n\t\t\t}\n\t\telse\n\t\t\t{\n\t\t\tsubTitle = config.messages.undefinedTiddlerToolTip.format([title]);\n\t\t\tclasses.remove(\"shadow\");\n\t\t\t}\n\t\t}\n\treturn {classes: classes.join(\" \"), subTitle: subTitle};\n}\n\nfunction createExternalLink(place,url)\n{\n\tvar theLink = document.createElement(\"a\");\n\ttheLink.className = \"externalLink\";\n\ttheLink.href = url;\n\ttheLink.title = config.messages.externalLinkTooltip.format([url]);\n\tif(config.options.chkOpenInNewWindow)\n\t\ttheLink.target = \"_blank\";\n\tplace.appendChild(theLink);\n\treturn(theLink);\n}\n\n// Event handler for clicking on a tiddly link\nfunction onClickTiddlerLink(e)\n{\n\tif (!e) var e = window.event;\n\tvar theTarget = resolveTarget(e);\n\tvar theLink = theTarget;\n\tvar title = null;\n\tdo {\n\t\ttitle = theLink.getAttribute(\"tiddlyLink\");\n\t\ttheLink = theLink.parentNode;\n\t} while(title == null && theLink != null);\n\tif(title)\n\t\t{\n\t\tvar toggling = e.metaKey || e.ctrlKey;\n\t\tif(config.options.chkToggleLinks)\n\t\t\ttoggling = !toggling;\n\t\tvar opening;\n\t\tif(toggling && document.getElementById(\"tiddler\" + title))\n\t\t\tstory.closeTiddler(title,true,e.shiftKey || e.altKey);\n\t\telse\n\t\t\tstory.displayTiddler(theTarget,title,null,true,e.shiftKey || e.altKey);\n\t\t}\n\tclearMessage();\n\treturn(false);\n}\n\n// Create a button for a tag with a popup listing all the tiddlers that it tags\nfunction createTagButton(place,tag,excludeTiddler)\n{\n\tvar theTag = createTiddlyButton(place,tag,config.views.wikified.tag.tooltip.format([tag]),onClickTag);\n\ttheTag.setAttribute(\"tag\",tag);\n\tif(excludeTiddler)\n\t\ttheTag.setAttribute(\"tiddler\",excludeTiddler);\n\treturn(theTag);\n}\n\n// Event handler for clicking on a tiddler tag\nfunction onClickTag(e)\n{\n\tif (!e) var e = window.event;\n\tvar theTarget = resolveTarget(e);\n\tvar popup = Popup.create(this);\n\tvar tag = this.getAttribute(\"tag\");\n\tvar title = this.getAttribute(\"tiddler\");\n\tif(popup && tag)\n\t\t{\n\t\tvar tagged = store.getTaggedTiddlers(tag);\n\t\tvar titles = [];\n\t\tvar li,r;\n\t\tfor(r=0;r<tagged.length;r++)\n\t\t\tif(tagged[r].title != title)\n\t\t\t\ttitles.push(tagged[r].title);\n\t\tvar lingo = config.views.wikified.tag;\n\t\tif(titles.length > 0)\n\t\t\t{\n\t\t\tvar openAll = createTiddlyButton(createTiddlyElement(popup,\"li\"),lingo.openAllText.format([tag]),lingo.openAllTooltip,onClickTagOpenAll);\n\t\t\topenAll.setAttribute(\"tag\",tag);\n\t\t\tcreateTiddlyElement(createTiddlyElement(popup,\"li\",null,\"listBreak\"),\"div\");\n\t\t\tfor(r=0; r<titles.length; r++)\n\t\t\t\t{\n\t\t\t\tcreateTiddlyLink(createTiddlyElement(popup,\"li\"),titles[r],true);\n\t\t\t\t}\n\t\t\t}\n\t\telse\n\t\t\tcreateTiddlyText(createTiddlyElement(popup,\"li\",null,\"disabled\"),lingo.popupNone.format([tag]));\n\t\tcreateTiddlyElement(createTiddlyElement(popup,\"li\",null,\"listBreak\"),\"div\");\n\t\tvar h = createTiddlyLink(createTiddlyElement(popup,\"li\"),tag,false);\n\t\tcreateTiddlyText(h,lingo.openTag.format([tag]));\n\t\t}\n\tPopup.show(popup,false);\n\te.cancelBubble = true;\n\tif (e.stopPropagation) e.stopPropagation();\n\treturn(false);\n}\n\n// Event handler for 'open all' on a tiddler popup\nfunction onClickTagOpenAll(e)\n{\n\tif (!e) var e = window.event;\n\tvar tag = this.getAttribute(\"tag\");\n\tvar tagged = store.getTaggedTiddlers(tag);\n\tvar titles = [];\n\tfor(var t=0; t<tagged.length; t++)\n\t\ttitles.push(tagged[t].title);\n\tstory.displayTiddlers(this,titles);\n\treturn(false);\n}\n\nfunction onClickError(e)\n{\n\tif (!e) var e = window.event;\n\tvar popup = Popup.create(this);\n\tvar lines = this.getAttribute(\"errorText\").split(\"\\n\");\n\tfor(var t=0; t<lines.length; t++)\n\t\tcreateTiddlyElement(popup,\"li\",null,null,lines[t]);\n\tPopup.show(popup,false);\n\te.cancelBubble = true;\n\tif (e.stopPropagation) e.stopPropagation();\n\treturn false;\n}\n\nfunction createTiddlyDropDown(place,onchange,options)\n{\n\tvar sel = createTiddlyElement(place,\"select\");\n\tsel.onchange = onchange;\n\tfor(var t=0; t<options.length; t++)\n\t\t{\n\t\tvar e = createTiddlyElement(sel,\"option\",null,null,options[t].caption);\n\t\te.value = options[t].name;\n\t\t}\n}\n\nfunction createTiddlyError(place,title,text)\n{\n\tvar btn = createTiddlyButton(place,title,null,onClickError,\"errorButton\");\n\tif (text) btn.setAttribute(\"errorText\",text);\n}\n\nfunction merge(dst,src,preserveExisting)\n{\n\tfor (p in src)\n\t\tif (!preserveExisting || dst[p] === undefined)\n\t\t\tdst[p] = src[p];\n\treturn dst;\n}\n\n// Returns a string containing the description of an exception, optionally prepended by a message\nfunction exceptionText(e, message)\n{\n\tvar s = e.description ? e.description : e.toString();\n\treturn message ? \"%0:\\n%1\".format([message, s]) : s;\n}\n\n// Displays an alert of an exception description with optional message\nfunction showException(e, message)\n{\n\talert(exceptionText(e, message));\n}\n\n// ---------------------------------------------------------------------------------\n// Animation engine\n// ---------------------------------------------------------------------------------\n\nfunction Animator()\n{\n\tthis.running = 0; // Incremented at start of each animation, decremented afterwards. If zero, the interval timer is disabled\n\tthis.timerID = 0; // ID of the timer used for animating\n\tthis.animations = []; // List of animations in progress\n\treturn this;\n}\n\n// Start animation engine\nAnimator.prototype.startAnimating = function() // Variable number of arguments\n{\n\tfor(var t=0; t<arguments.length; t++)\n\t\tthis.animations.push(arguments[t]);\n\tif(this.running == 0)\n\t\t{\n\t\tvar me = this;\n\t\tthis.timerID = window.setInterval(function() {me.doAnimate(me);},5);\n\t\t}\n\tthis.running += arguments.length;\n}\n\n// Perform an animation engine tick, calling each of the known animation modules\nAnimator.prototype.doAnimate = function(me)\n{\n\tvar a = 0;\n\twhile(a < me.animations.length)\n\t\t{\n\t\tvar animation = me.animations[a];\n\t\tif(animation.tick())\n\t\t\ta++;\n\t\telse\n\t\t\t{\n\t\t\tme.animations.splice(a,1);\n\t\t\tif(--me.running == 0)\n\t\t\t\twindow.clearInterval(me.timerID);\n\t\t\t}\n\t\t}\n}\n\n// Map a 0..1 value to 0..1, but slow down at the start and end\nAnimator.slowInSlowOut = function(progress)\n{\n\treturn(1-((Math.cos(progress * Math.PI)+1)/2));\n}\n\n// ---------------------------------------------------------------------------------\n// Cascade animation\n// ---------------------------------------------------------------------------------\n\nfunction Cascade(text,startElement,targetElement,slowly)\n{\n\tvar winWidth = findWindowWidth();\n\tvar winHeight = findWindowHeight();\n\tthis.elements = [];\n\tthis.startElement = startElement;\n\tthis.startLeft = findPosX(this.startElement);\n\tthis.startTop = findPosY(this.startElement);\n\tthis.startWidth = Math.min(this.startElement.offsetWidth,winWidth);\n\tthis.startHeight = Math.min(this.startElement.offsetHeight,winHeight);\n\tthis.targetElement = targetElement;\n\ttargetElement.style.position = \"relative\";\n\ttargetElement.style.zIndex = 2;\n\tthis.targetLeft = findPosX(this.targetElement);\n\tthis.targetTop = findPosY(this.targetElement);\n\tthis.targetWidth = Math.min(this.targetElement.offsetWidth,winWidth);\n\tthis.targetHeight = Math.min(this.targetElement.offsetHeight,winHeight);\n\tthis.progress = -1;\n\tthis.steps = slowly ? config.cascadeSlow : config.cascadeFast;\n\tthis.text = text;\n\tthis.tick();\n\treturn this;\n}\n\nCascade.prototype.tick = function()\n{\n\tthis.progress++;\n\tif(this.progress >= this.steps)\n\t\t{\n\t\twhile(this.elements.length > 0)\n\t\t\tthis.removeTail();\n\t\tthis.targetElement.style.position = \"static\";\n\t\tthis.targetElement.style.zIndex = \"\";\n\t\treturn false;\n\t\t}\n\telse\n\t\t{\n\t\tif(this.elements.length > 0 && this.progress > config.cascadeDepth)\n\t\t\tthis.removeTail();\n\t\tif(this.progress < (this.steps - config.cascadeDepth))\n\t\t\t{\n\t\t\tvar f = Animator.slowInSlowOut(this.progress/(this.steps - config.cascadeDepth - 1));\n\t\t\tvar e = createTiddlyElement(document.body,\"div\",null,\"cascade\",this.text);\n\t\t\te.style.zIndex = 1;\n\t\t\te.style.left = this.startLeft + (this.targetLeft-this.startLeft) * f + \"px\";\n\t\t\te.style.top = this.startTop + (this.targetTop-this.startTop) * f + \"px\";\n\t\t\te.style.width = this.startWidth + (this.targetWidth-this.startWidth) * f + \"px\";\n\t\t\te.style.height = this.startHeight + (this.targetHeight-this.startHeight) * f + \"px\";\n\t\t\te.style.display = \"block\";\n\t\t\tthis.elements.push(e);\n\t\t\t}\n\t\treturn true;\n\t\t}\n}\n\nCascade.prototype.removeTail = function()\n{\n\tvar e = this.elements[0];\n\te.parentNode.removeChild(e);\n\tthis.elements.shift();\n}\n\n// ---------------------------------------------------------------------------------\n// Scroller animation\n// ---------------------------------------------------------------------------------\n\nfunction Scroller(targetElement,slowly)\n{\n\tthis.targetElement = targetElement;\n\tthis.startScroll = findScrollY();\n\tthis.targetScroll = ensureVisible(targetElement);\n\tthis.progress = 0;\n\tthis.step = slowly ? config.animSlow : config.animFast;\n\treturn this;\n}\n\nScroller.prototype.tick = function()\n{\n\tthis.progress += this.step;\n\tif(this.progress > 1)\n\t\t{\n\t\twindow.scrollTo(0,this.targetScroll);\n\t\treturn false;\n\t\t}\n\telse\n\t\t{\n\t\tvar f = Animator.slowInSlowOut(this.progress);\n\t\twindow.scrollTo(0,this.startScroll + (this.targetScroll-this.startScroll) * f);\n\t\treturn true;\n\t\t}\n}\n\n// ---------------------------------------------------------------------------------\n// Slider animation\n// ---------------------------------------------------------------------------------\n\n// deleteMode - \"none\", \"all\" [delete target element and it's children], [only] \"children\" [but not the target element]\nfunction Slider(element,opening,slowly,deleteMode)\n{\n\tthis.element = element;\n\telement.style.display = \"block\";\n\tthis.deleteMode = deleteMode;\n\tthis.element.style.height = \"auto\";\n\tthis.realHeight = element.offsetHeight;\n\tthis.opening = opening;\n\tthis.step = slowly ? config.animSlow : config.animFast;\n\tif(opening)\n\t\t{\n\t\tthis.progress = 0;\n\t\telement.style.height = \"0px\";\n\t\telement.style.display = \"block\";\n\t\t}\n\telse\n\t\t{\n\t\tthis.progress = 1;\n\t\tthis.step = -this.step;\n\t\t}\n\telement.style.overflow = \"hidden\";\n\treturn this;\n}\n\nSlider.prototype.stop = function()\n{\n\tif(this.opening)\n\t\t{\n\t\tthis.element.style.height = \"auto\";\n\t\tthis.element.style.opacity = 1;\n\t\tthis.element.style.filter = \"alpha(opacity:100)\";\n\t\t}\n\telse\n\t\t{\n\t\tswitch(this.deleteMode)\n\t\t\t{\n\t\t\tcase \"none\":\n\t\t\t\tthis.element.style.display = \"none\";\n\t\t\t\tbreak;\n\t\t\tcase \"all\":\n\t\t\t\tthis.element.parentNode.removeChild(this.element);\n\t\t\t\tbreak;\n\t\t\tcase \"children\":\n\t\t\t\tremoveChildren(this.element);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n}\n\nSlider.prototype.tick = function()\n{\n\tthis.progress += this.step;\n\tif(this.progress < 0 || this.progress > 1)\n\t\t{\n\t\tthis.stop();\n\t\treturn false;\n\t\t}\n\telse\n\t\t{\n\t\tvar f = Animator.slowInSlowOut(this.progress);\n\t\tvar h = this.realHeight * f;\n\t\tthis.element.style.height = h + \"px\";\n\t\tthis.element.style.opacity = f;\n\t\tthis.element.style.filter = \"alpha(opacity:\" + f * 100 +\")\";\n\t\treturn true;\n\t\t}\n}\n\n// ---------------------------------------------------------------------------------\n// Popup menu\n// ---------------------------------------------------------------------------------\n\nvar Popup = {\n\tstack: [] // Array of objects with members root: and popup:\n\t};\n\nPopup.create = function(root)\n{\n\tPopup.remove();\n\tvar popup = createTiddlyElement(document.body,\"ol\",\"popup\",\"popup\");\n\tPopup.stack.push({root: root, popup: popup});\n\treturn popup;\n}\n\nPopup.onDocumentClick = function(e)\n{\n\tif (!e) var e = window.event;\n\tvar target = resolveTarget(e);\n\tif(e.eventPhase == undefined)\n\t\tPopup.remove();\n\telse if(e.eventPhase == Event.BUBBLING_PHASE || e.eventPhase == Event.AT_TARGET)\n\t\tPopup.remove();\n\treturn true;\n}\n\nPopup.show = function(unused,slowly)\n{\n\tvar curr = Popup.stack[Popup.stack.length-1];\n\tvar rootLeft = findPosX(curr.root);\n\tvar rootTop = findPosY(curr.root);\n\tvar rootHeight = curr.root.offsetHeight;\n\tvar popupLeft = rootLeft;\n\tvar popupTop = rootTop + rootHeight;\n\tvar popupWidth = curr.popup.offsetWidth;\n\tvar winWidth = findWindowWidth();\n\tif(popupLeft + popupWidth > winWidth)\n\t\tpopupLeft = winWidth - popupWidth;\n\tcurr.popup.style.left = popupLeft + \"px\";\n\tcurr.popup.style.top = popupTop + \"px\";\n\tcurr.popup.style.display = \"block\";\n\taddClass(curr.root,\"highlight\");\n\tif(anim && config.options.chkAnimate)\n\t\tanim.startAnimating(new Scroller(curr.popup,slowly));\n\telse\n\t\twindow.scrollTo(0,ensureVisible(curr.popup));\n}\n\nPopup.remove = function()\n{\n\tif(Popup.stack.length > 0)\n\t\t{\n\t\tPopup.removeFrom(0);\n\t\t}\n}\n\nPopup.removeFrom = function(from)\n{\n\tfor(var t=Popup.stack.length-1; t>=from; t--)\n\t\t{\n\t\tvar p = Popup.stack[t];\n\t\tremoveClass(p.root,\"highlight\");\n\t\tp.popup.parentNode.removeChild(p.popup);\n\t\t}\n\tPopup.stack = Popup.stack.slice(0,from);\n}\n\n// ---------------------------------------------------------------------------------\n// ListView gadget\n// ---------------------------------------------------------------------------------\n\nvar ListView = {};\n\n// Create a listview\n//   place - where in the DOM tree to insert the listview\n//   listObject - array of objects to be included in the listview\n//   listTemplate - template for the listview\n//   callback - callback for a command being selected\n//   className - optional classname for the <table> element\nListView.create = function(place,listObject,listTemplate,callback,className)\n{\n\tvar table = createTiddlyElement(place,\"table\",null,className ? className : \"listView\");\n\tvar thead = createTiddlyElement(table,\"thead\");\n\tvar r = createTiddlyElement(thead,\"tr\");\n\tfor(var t=0; t<listTemplate.columns.length; t++)\n\t\t{\n\t\tvar columnTemplate = listTemplate.columns[t];\n\t\tvar c = createTiddlyElement(r,\"th\");\n\t\tvar colType = ListView.columnTypes[columnTemplate.type];\n\t\tif(colType && colType.createHeader)\n\t\t\tcolType.createHeader(c,columnTemplate,t);\n\t\t}\n\tvar tbody = createTiddlyElement(table,\"tbody\");\n\tfor(var rc=0; rc<listObject.length; rc++)\n\t\t{\n\t\trowObject = listObject[rc];\n\t\tr = createTiddlyElement(tbody,\"tr\");\n\t\tfor(var c=0; c<listTemplate.rowClasses.length; c++)\n\t\t\t{\n\t\t\tif(rowObject[listTemplate.rowClasses[c].field])\n\t\t\t\taddClass(r,listTemplate.rowClasses[c].className);\n\t\t\t}\n\t\trowObject.rowElement = rowObject;\n\t\trowObject.colElements = {};\n\t\tfor(var cc=0; cc<listTemplate.columns.length; cc++)\n\t\t\t{\n\t\t\tvar c = createTiddlyElement(r,\"td\");\n\t\t\tvar columnTemplate = listTemplate.columns[cc];\n\t\t\tvar field = columnTemplate.field;\n\t\t\tvar colType = ListView.columnTypes[columnTemplate.type];\n\t\t\tif(colType && colType.createItem)\n\t\t\t\tcolType.createItem(c,rowObject,field,columnTemplate,cc,rc);\n\t\t\trowObject.colElements[field] = c;\n\t\t\t}\n\t\t}\n\tif(callback && listTemplate.actions)\n\t\tcreateTiddlyDropDown(place,ListView.getCommandHandler(callback),listTemplate.actions);\n\tif(callback && listTemplate.buttons)\n\t\t{\n\t\tfor(t=0; t<listTemplate.buttons.length; t++)\n\t\t\t{\n\t\t\tvar a = listTemplate.buttons[t];\n\t\t\tif(a && a.name != \"\")\n\t\t\t\tcreateTiddlyButton(place,a.caption,null,ListView.getCommandHandler(callback,a.name,a.allowEmptySelection));\n\t\t\t}\n\t\t}\n\treturn table;\n}\n\nListView.getCommandHandler = function(callback,name,allowEmptySelection)\n{\n\treturn function(e)\n\t\t{\n\t\tvar view = findRelated(this,\"TABLE\",null,\"previousSibling\");\n\t\tvar tiddlers = [];\n\t\tListView.forEachSelector(view,function(e,rowName) {\n\t\t\t\t\tif(e.checked)\n\t\t\t\t\t\ttiddlers.push(rowName);\n\t\t\t\t\t});\n\t\tif(tiddlers.length == 0 && !allowEmptySelection)\n\t\t\talert(config.messages.nothingSelected);\n\t\telse\n\t\t\t{\n\t\t\tif(this.nodeName.toLowerCase() == \"select\")\n\t\t\t\t{\n\t\t\t\tcallback(view,this.value,tiddlers);\n\t\t\t\tthis.selectedIndex = 0;\n\t\t\t\t}\n\t\t\telse\n\t\t\t\tcallback(view,name,tiddlers);\n\t\t\t}\n\t\t};\n}\n\n// Invoke a callback for each selector checkbox in the listview\n//   view - <table> element of listView\n//   callback(checkboxElement,rowName)\n//     where\n//       checkboxElement - DOM element of checkbox\n//       rowName - name of this row as assigned by the column template\n//   result: true if at least one selector was checked\nListView.forEachSelector = function(view,callback)\n{\n\tvar checkboxes = view.getElementsByTagName(\"input\");\n\tvar hadOne = false;\n\tfor(var t=0; t<checkboxes.length; t++)\n\t\t{\n\t\tvar cb = checkboxes[t];\n\t\tif(cb.getAttribute(\"type\") == \"checkbox\")\n\t\t\t{\n\t\t\tvar rn = cb.getAttribute(\"rowName\");\n\t\t\tif(rn)\n\t\t\t\t{\n\t\t\t\tcallback(cb,rn);\n\t\t\t\thadOne = true;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\treturn hadOne;\n}\n\nListView.columnTypes = {};\n\nListView.columnTypes.String = {\n\tcreateHeader: function(place,columnTemplate,col)\n\t\t{\n\t\t\tcreateTiddlyText(place,columnTemplate.title);\n\t\t},\n\tcreateItem: function(place,listObject,field,columnTemplate,col,row)\n\t\t{\n\t\t\tvar v = listObject[field];\n\t\t\tif(v != undefined)\n\t\t\t\tcreateTiddlyText(place,v);\n\t\t}\n};\n\nListView.columnTypes.Date = {\n\tcreateHeader: ListView.columnTypes.String.createHeader,\n\tcreateItem: function(place,listObject,field,columnTemplate,col,row)\n\t\t{\n\t\t\tvar v = listObject[field];\n\t\t\tif(v != undefined)\n\t\t\t\tcreateTiddlyText(place,v.formatString(columnTemplate.dateFormat));\n\t\t}\n};\n\nListView.columnTypes.StringList = {\n\tcreateHeader: ListView.columnTypes.String.createHeader,\n\tcreateItem: function(place,listObject,field,columnTemplate,col,row)\n\t\t{\n\t\t\tvar v = listObject[field];\n\t\t\tif(v != undefined)\n\t\t\t\t{\n\t\t\t\tfor(var t=0; t<v.length; t++)\n\t\t\t\t\t{\n\t\t\t\t\tcreateTiddlyText(place,v[t]);\n\t\t\t\t\tcreateTiddlyElement(place,\"br\");\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t}\n};\n\nListView.columnTypes.Selector = {\n\tcreateHeader: function(place,columnTemplate,col)\n\t\t{\n\t\t\tcreateTiddlyCheckbox(place,null,false,this.onHeaderChange);\n\t\t},\n\tcreateItem: function(place,listObject,field,columnTemplate,col,row)\n\t\t{\n\t\t\tvar e = createTiddlyCheckbox(place,null,listObject[field],null);\n\t\t\te.setAttribute(\"rowName\",listObject[columnTemplate.rowName]);\n\t\t},\n\tonHeaderChange: function(e)\n\t\t{\n\t\t\tvar state = this.checked;\n\t\t\tvar view = findRelated(this,\"TABLE\");\n\t\t\tif(!view)\n\t\t\t\treturn;\n\t\t\tListView.forEachSelector(view,function(e,rowName) {\n\t\t\t\t\t\t\t\te.checked = state;\n\t\t\t\t\t\t\t});\n\t\t}\n};\n\nListView.columnTypes.Tags = {\n\tcreateHeader: ListView.columnTypes.String.createHeader,\n\tcreateItem: function(place,listObject,field,columnTemplate,col,row)\n\t\t{\n\t\t\tvar tags = listObject[field];\n\t\t\tcreateTiddlyText(place,String.encodeTiddlyLinkList(tags));\n\t\t}\n};\n\nListView.columnTypes.Boolean = {\n\tcreateHeader: ListView.columnTypes.String.createHeader,\n\tcreateItem: function(place,listObject,field,columnTemplate,col,row)\n\t\t{\n\t\t\tif(listObject[field] == true)\n\t\t\t\tcreateTiddlyText(place,columnTemplate.trueText);\n\t\t\tif(listObject[field] == false)\n\t\t\t\tcreateTiddlyText(place,columnTemplate.falseText);\n\t\t}\n};\n\nListView.columnTypes.TagCheckbox = {\n\tcreateHeader: ListView.columnTypes.String.createHeader,\n\tcreateItem: function(place,listObject,field,columnTemplate,col,row)\n\t\t{\n\t\t\tvar e = createTiddlyCheckbox(place,null,listObject[field],this.onChange);\n\t\t\te.setAttribute(\"tiddler\",listObject.title);\n\t\t\te.setAttribute(\"tag\",columnTemplate.tag);\n\t\t},\n\tonChange : function(e)\n\t\t{\n\t\t\tvar tag = this.getAttribute(\"tag\");\n\t\t\tvar tiddler = this.getAttribute(\"tiddler\");\n\t\t\tstore.setTiddlerTag(tiddler,this.checked,tag);\n\t\t}\n};\n\nListView.columnTypes.TiddlerLink = {\n\tcreateHeader: ListView.columnTypes.String.createHeader,\n\tcreateItem: function(place,listObject,field,columnTemplate,col,row)\n\t\t{\n\t\t\tvar v = listObject[field];\n\t\t\tif(v != undefined)\n\t\t\t\t{\n\t\t\t\tvar link = createTiddlyLink(place,listObject[columnTemplate.tiddlerLink],false,null);\n\t\t\t\tcreateTiddlyText(link,listObject[field]);\n\t\t\t\t}\n\t\t}\n};\n// ---------------------------------------------------------------------------------\n// Augmented methods for the JavaScript Number(), Array(), String() and Date() objects\n// ---------------------------------------------------------------------------------\n\n// Clamp a number to a range\nNumber.prototype.clamp = function(min,max)\n{\n\tvar c = this;\n\tif(c < min)\n\t\tc = min;\n\tif(c > max)\n\t\tc = max;\n\treturn c;\n}\n\n// Add indexOf function if browser does not support it\nif(!Array.indexOf) {\nArray.prototype.indexOf = function(item,from)\n{\n\tif(!from)\n\t\tfrom = 0;\n\tfor(var i=from; i<this.length; i++)\n\t\tif(this[i] === item)\n\t\t\treturn i;\n\treturn -1;\n}}\n\n// Find an entry in a given field of the members of an array\nArray.prototype.findByField = function(field,value)\n{\n\tfor(var t=0; t<this.length; t++)\n\t\tif(this[t][field] == value)\n\t\t\treturn t;\n\treturn null;\n}\n\n// Return whether an entry exists in an array\nArray.prototype.contains = function(item)\n{\n\treturn this.indexOf(item) != -1;\n};\n\n// Adds, removes or toggles a particular value within an array\n//  value - value to add\n//  mode - +1 to add value, -1 to remove value, 0 to toggle it\nArray.prototype.setItem = function(value,mode)\n{\n\tvar p = this.indexOf(value);\n\tif(mode == 0)\n\t\tmode = (p == -1) ? +1 : -1;\n\tif(mode == +1)\n\t\t{\n\t\tif(p == -1)\n\t\t\tthis.push(value);\n\t\t}\n\telse if(mode == -1)\n\t\t{\n\t\tif(p != -1)\n\t\t\tthis.splice(p,1);\n\t\t}\n}\n\n// Return whether one of a list of values exists in an array\nArray.prototype.containsAny = function(items)\n{\n\tfor(var i=0; i<items.length; i++)\n\t\tif (this.indexOf(items[i]) != -1)\n\t\t\treturn true;\n\treturn false;\n};\n\n// Return whether all of a list of values exists in an array\nArray.prototype.containsAll = function(items)\n{\n\tfor (var i = 0; i<items.length; i++)\n\t\tif (this.indexOf(items[i]) == -1)\n\t\t\treturn false;\n\treturn true;\n};\n\n// Push a new value into an array only if it is not already present in the array. If the optional unique parameter is false, it reverts to a normal push\nArray.prototype.pushUnique = function(item,unique)\n{\n\tif(unique != undefined && unique == false)\n\t\tthis.push(item);\n\telse\n\t\t{\n\t\tif(this.indexOf(item) == -1)\n\t\t\tthis.push(item);\n\t\t}\n}\n\nArray.prototype.remove = function(item)\n{\n\tvar p = this.indexOf(item);\n\tif(p != -1)\n\t\tthis.splice(p,1);\n}\n\n// Get characters from the right end of a string\nString.prototype.right = function(n)\n{\n\tif(n < this.length)\n\t\treturn this.slice(this.length-n);\n\telse\n\t\treturn this;\n}\n\n// Trim whitespace from both ends of a string\nString.prototype.trim = function()\n{\n\treturn this.replace(/^\\s*|\\s*$/g,\"\");\n}\n\n// Convert a string from a CSS style property name to a JavaScript style name (\"background-color\" -> \"backgroundColor\")\nString.prototype.unDash = function()\n{\n\tvar s = this.split(\"-\");\n\tif(s.length > 1)\n\t\tfor(var t=1; t<s.length; t++)\n\t\t\ts[t] = s[t].substr(0,1).toUpperCase() + s[t].substr(1);\n\treturn s.join(\"\");\n}\n\n// Substitute substrings from an array into a format string that includes '%1'-type specifiers\nString.prototype.format = function(substrings)\n{\n\tvar subRegExp = /(?:%(\\d+))/mg;\n\tvar currPos = 0;\n\tvar r = [];\n\tdo {\n\t\tvar match = subRegExp.exec(this);\n\t\tif(match && match[1])\n\t\t\t{\n\t\t\tif(match.index > currPos)\n\t\t\t\tr.push(this.substring(currPos,match.index));\n\t\t\tr.push(substrings[parseInt(match[1])]);\n\t\t\tcurrPos = subRegExp.lastIndex;\n\t\t\t}\n\t} while(match);\n\tif(currPos < this.length)\n\t\tr.push(this.substring(currPos,this.length));\n\treturn r.join(\"\");\n}\n\n// Escape any special RegExp characters with that character preceded by a backslash\nString.prototype.escapeRegExp = function()\n{\n\tvar s = \"\\\\^$*+?()=!|,{}[].\";\n\tvar c = this;\n\tfor(var t=0; t<s.length; t++)\n\t\tc = c.replace(new RegExp(\"\\\\\" + s.substr(t,1),\"g\"),\"\\\\\" + s.substr(t,1));\n\treturn c;\n}\n\n// Convert \"\\\" to \"\\s\", newlines to \"\\n\" (and remove carriage returns)\nString.prototype.escapeLineBreaks = function()\n{\n\treturn this.replace(/\\\\/mg,\"\\\\s\").replace(/\\n/mg,\"\\\\n\").replace(/\\r/mg,\"\");\n}\n\n// Convert \"\\n\" to newlines, \"\\b\" to \" \", \"\\s\" to \"\\\" (and remove carriage returns)\nString.prototype.unescapeLineBreaks = function()\n{\n\treturn this.replace(/\\\\n/mg,\"\\n\").replace(/\\\\b/mg,\" \").replace(/\\\\s/mg,\"\\\\\").replace(/\\r/mg,\"\");\n}\n\n// Convert & to \"&amp;\", < to \"&lt;\", > to \"&gt;\" and \" to \"&quot;\"\nString.prototype.htmlEncode = function()\n{\n\treturn(this.replace(/&/mg,\"&amp;\").replace(/</mg,\"&lt;\").replace(/>/mg,\"&gt;\").replace(/\\\"/mg,\"&quot;\"));\n}\n\n// Convert \"&amp;\" to &, \"&lt;\" to <, \"&gt;\" to > and \"&quot;\" to \"\nString.prototype.htmlDecode = function()\n{\n\treturn(this.replace(/&amp;/mg,\"&\").replace(/&lt;/mg,\"<\").replace(/&gt;/mg,\">\").replace(/&quot;/mg,\"\\\"\"));\n}\n\n// Parse a space-separated string of name:value parameters where:\n//   - the name or the value can be optional (in which case separate defaults are used instead)\n//     - in case of ambiguity, a lone word is taken to be a value\n//     - if 'cascadeDefaults' is set to true, then the defaults are modified by updated by each specified name or value\n//     - name prefixes are not allowed if the 'noNames' parameter is true\n//   - if both the name and value are present they must be separated by a colon\n//   - the name and the value may both be quoted with single- or double-quotes, double-square brackets\n//   - names or values quoted with {{double-curly braces}} are evaluated as a JavaScript expression\n//     - as long as the 'allowEval' parameter is true\n// The result is an array of objects:\n//   result[0] = object with a member for each parameter name, value of that member being an array of values\n//   result[1..n] = one object for each parameter, with 'name' and 'value' members\nString.prototype.parseParams = function(defaultName,defaultValue,allowEval,noNames,cascadeDefaults)\n{\n\tvar parseToken = function(match,p)\n\t\t{\n\t\tvar n;\n\t\tif(match[p]) // Double quoted\n\t\t\tn = match[p];\n\t\telse if(match[p+1]) // Single quoted\n\t\t\tn = match[p+1];\n\t\telse if(match[p+2]) // Double-square-bracket quoted\n\t\t\tn = match[p+2];\n\t\telse if(match[p+3]) // Double-brace quoted\n\t\t\ttry\n\t\t\t\t{\n\t\t\t\tn = match[p+3];\n\t\t\t\tif(allowEval)\n\t\t\t\t\tn = window.eval(n);\n\t\t\t\t}\n\t\t\tcatch(e)\n\t\t\t\t{\n\t\t\t\tthrow \"Unable to evaluate {{\" + match[p+3] + \"}}: \" + exceptionText(e);\n\t\t\t\t}\n\t\telse if(match[p+4]) // Unquoted\n\t\t\tn = match[p+4];\n\t\telse if(match[p+5]) // empty quote\n\t\t\tn = \"\";\n\t\treturn n;\n\t\t};\n\tvar r = [{}];\n\tvar dblQuote = \"(?:\\\"((?:(?:\\\\\\\\\\\")|[^\\\"])+)\\\")\";\n\tvar sngQuote = \"(?:'((?:(?:\\\\\\\\\\')|[^'])+)')\";\n\tvar dblSquare = \"(?:\\\\[\\\\[((?:\\\\s|\\\\S)*?)\\\\]\\\\])\";\n\tvar dblBrace = \"(?:\\\\{\\\\{((?:\\\\s|\\\\S)*?)\\\\}\\\\})\";\n\tvar unQuoted = noNames ? \"([^\\\"'\\\\s]\\\\S*)\" : \"([^\\\"':\\\\s][^\\\\s:]*)\";\n\tvar emptyQuote = \"((?:\\\"\\\")|(?:''))\";\n\tvar skipSpace = \"(?:\\\\s*)\";\n\tvar token = \"(?:\" + dblQuote + \"|\" + sngQuote + \"|\" + dblSquare + \"|\" + dblBrace + \"|\" + unQuoted + \"|\" + emptyQuote + \")\";\n\tvar re = noNames\n\t\t? new RegExp(token,\"mg\")\n\t\t: new RegExp(skipSpace + token + skipSpace + \"(?:(\\\\:)\" + skipSpace + token + \")?\",\"mg\");\n\tvar params = [];\n\tdo {\n\t\tvar match = re.exec(this);\n\t\tif(match)\n\t\t\t{\n\t\t\tvar n = parseToken(match,1);\n\t\t\tif(noNames)\n\t\t\t\tr.push({name: \"\", value: n});\n\t\t\telse\n\t\t\t\t{\n\t\t\t\tvar v = parseToken(match,8);\n\t\t\t\tif(v == null && defaultName)\n\t\t\t\t\t{\n\t\t\t\t\tv = n;\n\t\t\t\t\tn = defaultName;\n\t\t\t\t\t}\n\t\t\t\telse if(v == null && defaultValue)\n\t\t\t\t\tv = defaultValue;\n\t\t\t\tr.push({name: n, value: v});\n\t\t\t\tif(cascadeDefaults)\n\t\t\t\t\t{\n\t\t\t\t\tdefaultName = n;\n\t\t\t\t\tdefaultValue = v;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t} while(match);\n\t// Summarise parameters into first element\n\tfor(var t=1; t<r.length; t++)\n\t\t{\n\t\tif(r[0][r[t].name])\n\t\t\tr[0][r[t].name].push(r[t].value);\n\t\telse\n\t\t\tr[0][r[t].name] = [r[t].value];\n\t\t}\n\treturn r;\n}\n\n// Process a string list of macro parameters into an array. Parameters can be quoted with \"\", '',\n// [[]], {{ }} or left unquoted (and therefore space-separated). Double-braces {{}} results in\n// an *evaluated* parameter: e.g. {{config.options.txtUserName}} results in the current user's name.\nString.prototype.readMacroParams = function()\n{\n\tvar p = this.parseParams(\"list\",null,true,true);\n\tvar n = [];\n\tfor(var t=1; t<p.length; t++)\n\t\tn.push(p[t].value);\n\treturn n;\n}\n\n// Process a string list of unique tiddler names into an array. Tiddler names that have spaces in them must be [[bracketed]]\nString.prototype.readBracketedList = function(unique)\n{\n\tvar p = this.parseParams(\"list\",null,false,true);\n\tvar n = [];\n\tfor(var t=1; t<p.length; t++)\n\t\tn.pushUnique(p[t].value,unique);\n\treturn n;\n}\n\n// Returns array with start and end index of chunk between given start and end marker, or undefined.\nString.prototype.getChunkRange = function(start,end)\n{\n\tvar s = this.indexOf(start);\n\tif(s != -1)\n\t\t{\n\t\ts += start.length;\n\t\tvar e = this.indexOf(end,s);\n\t\tif(e != -1)\n\t\t\treturn [s, e];\n\t\t}\n}\n\n// Replace a chunk of a string given start and end markers\nString.prototype.replaceChunk = function(start,end,sub)\n{\n\tvar r = this.getChunkRange(start,end);\n\treturn r\n\t\t? this.substring(0,r[0]) + sub + this.substring(r[1])\n\t\t: this;\n}\n\n// Returns a chunk of a string between start and end markers, or undefined\nString.prototype.getChunk = function(start,end)\n{\n\tvar r = this.getChunkRange(start,end);\n\tif (r)\n\t\treturn this.substring(r[0],r[1]);\n}\n\n\n// Static method to bracket a string with double square brackets if it contains a space\nString.encodeTiddlyLink = function(title)\n{\n\tif(title.indexOf(\" \") == -1)\n\t\treturn(title);\n\telse\n\t\treturn(\"[[\" + title + \"]]\");\n}\n\n// Static method to encodeTiddlyLink for every item in an array and join them with spaces\nString.encodeTiddlyLinkList = function(list)\n{\n\tif(list)\n\t\t{\n\t\tvar results = [];\n\t\tfor(var t=0; t<list.length; t++)\n\t\t\tresults.push(String.encodeTiddlyLink(list[t]));\n\t\treturn results.join(\" \");\n\t\t}\n\telse\n\t\treturn \"\";\n}\n\n// Static method to left-pad a string with 0s to a certain width\nString.zeroPad = function(n,d)\n{\n\tvar s = n.toString();\n\tif(s.length < d)\n\t\ts = \"000000000000000000000000000\".substr(0,d-s.length) + s;\n\treturn(s);\n}\n\nString.prototype.startsWith = function(prefix)\n{\n\treturn !prefix || this.substring(0,prefix.length) == prefix;\n}\n\n// Returns the first value of the given named parameter.\n//#\n//# @param params\n//#         as returned by parseParams or null/undefined\n//# @return [may be null/undefined]\n//#\nfunction getParam(params, name, defaultValue) {\n\tif (!params)\n\t\treturn defaultValue;\n\tvar p = params[0][name];\n\treturn p ? p[0] : defaultValue;\n}\n\n// Returns the first value of the given boolean named parameter.\n//#\n//# @param params\n//#         as returned by parseParams or null/undefined\n//#\nfunction getFlag(params, name, defaultValue) {\n\treturn !!getParam(params, name, defaultValue);\n}\n\n// Substitute date components into a string\nDate.prototype.formatString = function(template)\n{\n\tvar t = template.replace(/0hh12/g,String.zeroPad(this.getHours12(),2));\n\tt = t.replace(/hh12/g,this.getHours12());\n\tt = t.replace(/0hh/g,String.zeroPad(this.getHours(),2));\n\tt = t.replace(/hh/g,this.getHours());\n\tt = t.replace(/0mm/g,String.zeroPad(this.getMinutes(),2));\n\tt = t.replace(/mm/g,this.getMinutes());\n\tt = t.replace(/0ss/g,String.zeroPad(this.getSeconds(),2));\n\tt = t.replace(/ss/g,this.getSeconds());\n\tt = t.replace(/[ap]m/g,this.getAmPm().toLowerCase());\n\tt = t.replace(/[AP]M/g,this.getAmPm().toUpperCase());\n\tt = t.replace(/wYYYY/g,this.getYearForWeekNo());\n\tt = t.replace(/wYY/g,String.zeroPad(this.getYearForWeekNo()-2000,2));\n\tt = t.replace(/YYYY/g,this.getFullYear());\n\tt = t.replace(/YY/g,String.zeroPad(this.getFullYear()-2000,2));\n\tt = t.replace(/MMM/g,config.messages.dates.months[this.getMonth()]);\n\tt = t.replace(/mmm/g,config.messages.dates.shortMonths[this.getMonth()]);\n\tt = t.replace(/0MM/g,String.zeroPad(this.getMonth()+1,2));\n\tt = t.replace(/MM/g,this.getMonth()+1);\n\tt = t.replace(/0WW/g,String.zeroPad(this.getWeek(),2));\n\tt = t.replace(/WW/g,this.getWeek());\n\tt = t.replace(/DDD/g,config.messages.dates.days[this.getDay()]);\n\tt = t.replace(/ddd/g,config.messages.dates.shortDays[this.getDay()]);\n\tt = t.replace(/0DD/g,String.zeroPad(this.getDate(),2));\n\tt = t.replace(/DDth/g,this.getDate()+this.daySuffix());\n\tt = t.replace(/DD/g,this.getDate());\n\treturn t;\n}\n\nDate.prototype.getWeek = function()\n{\n\tvar dt = new Date(this.getTime());\n\tvar d = dt.getDay();\n\tif (d==0) d=7;// JavaScript Sun=0, ISO Sun=7\n\tdt.setTime(dt.getTime()+(4-d)*86400000);// shift day to Thurs of same week to calculate weekNo\n\tvar n = Math.floor((dt.getTime()-new Date(dt.getFullYear(),0,1)+3600000)/86400000);\n\treturn Math.floor(n/7)+1;\n}\n\nDate.prototype.getYearForWeekNo = function()\n{\n\tvar dt = new Date(this.getTime());\n\tvar d = dt.getDay();\n\tif (d==0) d=7;// JavaScript Sun=0, ISO Sun=7\n\tdt.setTime(dt.getTime()+(4-d)*86400000);// shift day to Thurs of same week\n\treturn dt.getFullYear();\n}\n\nDate.prototype.getHours12 = function()\n{\n\tvar h = this.getHours();\n\treturn h > 12 ? h-12 : ( h > 0 ? h : 12 );\n}\n\nDate.prototype.getAmPm = function()\n{\n\treturn this.getHours() >= 12 ? \"pm\" : \"am\";\n}\n\nDate.prototype.daySuffix = function()\n{\n\tvar num = this.getDate();\n\tif (num >= 11 && num <= 13) return \"th\";\n\telse if (num.toString().substr(-1)==\"1\") return \"st\";\n\telse if (num.toString().substr(-1)==\"2\") return \"nd\";\n\telse if (num.toString().substr(-1)==\"3\") return \"rd\";\n\treturn \"th\";\n}\n\n// Convert a date to local YYYYMMDDHHMM string format\nDate.prototype.convertToLocalYYYYMMDDHHMM = function()\n{\n\treturn(String.zeroPad(this.getFullYear(),4) + String.zeroPad(this.getMonth()+1,2) + String.zeroPad(this.getDate(),2) + String.zeroPad(this.getHours(),2) + String.zeroPad(this.getMinutes(),2));\n}\n\n// Convert a date to UTC YYYYMMDDHHMM string format\nDate.prototype.convertToYYYYMMDDHHMM = function()\n{\n\treturn(String.zeroPad(this.getUTCFullYear(),4) + String.zeroPad(this.getUTCMonth()+1,2) + String.zeroPad(this.getUTCDate(),2) + String.zeroPad(this.getUTCHours(),2) + String.zeroPad(this.getUTCMinutes(),2));\n}\n\n// Convert a date to UTC YYYYMMDD.HHMMSSMMM string format\nDate.prototype.convertToYYYYMMDDHHMMSSMMM = function()\n{\n\treturn(String.zeroPad(this.getUTCFullYear(),4) + String.zeroPad(this.getUTCMonth()+1,2) + String.zeroPad(this.getUTCDate(),2) + \".\" + String.zeroPad(this.getUTCHours(),2) + String.zeroPad(this.getUTCMinutes(),2) + String.zeroPad(this.getUTCSeconds(),2) + String.zeroPad(this.getUTCMilliseconds(),4));\n}\n\n// Static method to create a date from a UTC YYYYMMDDHHMM format string\nDate.convertFromYYYYMMDDHHMM = function(d)\n{\n\tvar theDate = new Date(Date.UTC(parseInt(d.substr(0,4),10),\n\t\t\t\t\t\t\tparseInt(d.substr(4,2),10)-1,\n\t\t\t\t\t\t\tparseInt(d.substr(6,2),10),\n\t\t\t\t\t\t\tparseInt(d.substr(8,2),10),\n\t\t\t\t\t\t\tparseInt(d.substr(10,2),10),0,0));\n\treturn(theDate);\n}\n\n// ---------------------------------------------------------------------------------\n// Crypto functions and associated conversion routines\n// ---------------------------------------------------------------------------------\n\n// Crypto \"namespace\"\nfunction Crypto() {}\n\n// Convert a string to an array of big-endian 32-bit words\nCrypto.strToBe32s = function(str)\n{\n\tvar be = Array();\n\tvar len = Math.floor(str.length/4);\n\tvar i, j;\n\tfor(i=0, j=0; i<len; i++, j+=4)\n\t\t{\n\t\tbe[i] = ((str.charCodeAt(j)&0xff) << 24)|((str.charCodeAt(j+1)&0xff) << 16)|((str.charCodeAt(j+2)&0xff) << 8)|(str.charCodeAt(j+3)&0xff);\n\t\t}\n\twhile (j<str.length)\n\t\t{\n\t\tbe[j>>2] |= (str.charCodeAt(j)&0xff)<<(24-(j*8)%32);\n\t\tj++;\n\t\t}\n\treturn be;\n}\n\n// Convert an array of big-endian 32-bit words to a string\nCrypto.be32sToStr = function(be)\n{\n\tvar str = \"\";\n\tfor(var i=0;i<be.length*32;i+=8)\n\t\tstr += String.fromCharCode((be[i>>5]>>>(24-i%32)) & 0xff);\n\treturn str;\n}\n\n// Convert an array of big-endian 32-bit words to a hex string\nCrypto.be32sToHex = function(be)\n{\n\tvar hex = \"0123456789ABCDEF\";\n\tvar str = \"\";\n\tfor(var i=0;i<be.length*4;i++)\n\t\tstr += hex.charAt((be[i>>2]>>((3-i%4)*8+4))&0xF) + hex.charAt((be[i>>2]>>((3-i%4)*8))&0xF);\n\treturn str;\n}\n\n// Return, in hex, the SHA-1 hash of a string\nCrypto.hexSha1Str = function(str)\n{\n\treturn Crypto.be32sToHex(Crypto.sha1Str(str));\n}\n\n// Return the SHA-1 hash of a string\nCrypto.sha1Str = function(str)\n{\n\treturn Crypto.sha1(Crypto.strToBe32s(str),str.length);\n}\n\n// Calculate the SHA-1 hash of an array of blen bytes of big-endian 32-bit words\nCrypto.sha1 = function(x,blen)\n{\n\t// Add 32-bit integers, wrapping at 32 bits\n\t//# Uses 16-bit operations internally to work around bugs in some JavaScript interpreters.\n\tadd32 = function(a,b)\n\t{\n\t\tvar lsw = (a&0xFFFF)+(b&0xFFFF);\n\t\tvar msw = (a>>16)+(b>>16)+(lsw>>16);\n\t\treturn (msw<<16)|(lsw&0xFFFF);\n\t};\n\t// Add five 32-bit integers, wrapping at 32 bits\n\t//# Uses 16-bit operations internally to work around bugs in some JavaScript interpreters.\n\tadd32x5 = function(a,b,c,d,e)\n\t{\n\t\tvar lsw = (a&0xFFFF)+(b&0xFFFF)+(c&0xFFFF)+(d&0xFFFF)+(e&0xFFFF);\n\t\tvar msw = (a>>16)+(b>>16)+(c>>16)+(d>>16)+(e>>16)+(lsw>>16);\n\t\treturn (msw<<16)|(lsw&0xFFFF);\n\t};\n\t// Bitwise rotate left a 32-bit integer by 1 bit\n\trol32 = function(n)\n\t{\n\t\treturn (n>>>31)|(n<<1);\n\t};\n\n\tvar len = blen*8;\n\t// Append padding so length in bits is 448 mod 512\n\tx[len>>5] |= 0x80 << (24-len%32);\n\t// Append length\n\tx[((len+64>>9)<<4)+15] = len;\n\tvar w = Array(80);\n\n\tvar k1 = 0x5A827999;\n\tvar k2 = 0x6ED9EBA1;\n\tvar k3 = 0x8F1BBCDC;\n\tvar k4 = 0xCA62C1D6;\n\n\tvar h0 = 0x67452301;\n\tvar h1 = 0xEFCDAB89;\n\tvar h2 = 0x98BADCFE;\n\tvar h3 = 0x10325476;\n\tvar h4 = 0xC3D2E1F0;\n\n\tfor(var i=0;i<x.length;i+=16)\n\t\t{\n\t\tvar j,t;\n\t\tvar a = h0;\n\t\tvar b = h1;\n\t\tvar c = h2;\n\t\tvar d = h3;\n\t\tvar e = h4;\n\t\tfor(j = 0;j<16;j++)\n\t\t\t{\n\t\t\tw[j] = x[i+j];\n\t\t\tt = add32x5(e,(a>>>27)|(a<<5),d^(b&(c^d)),w[j],k1);\n\t\t\te=d; d=c; c=(b>>>2)|(b<<30); b=a; a = t;\n\t\t\t}\n\t\tfor(j=16;j<20;j++)\n\t\t\t{\n\t\t\tw[j] = rol32(w[j-3]^w[j-8]^w[j-14]^w[j-16]);\n\t\t\tt = add32x5(e,(a>>>27)|(a<<5),d^(b&(c^d)),w[j],k1);\n\t\t\te=d; d=c; c=(b>>>2)|(b<<30); b=a; a = t;\n\t\t\t}\n\t\tfor(j=20;j<40;j++)\n\t\t\t{\n\t\t\tw[j] = rol32(w[j-3]^w[j-8]^w[j-14]^w[j-16]);\n\t\t\tt = add32x5(e,(a>>>27)|(a<<5),b^c^d,w[j],k2);\n\t\t\te=d; d=c; c=(b>>>2)|(b<<30); b=a; a = t;\n\t\t\t}\n\t\tfor(j=40;j<60;j++)\n\t\t\t{\n\t\t\tw[j] = rol32(w[j-3]^w[j-8]^w[j-14]^w[j-16]);\n\t\t\tt = add32x5(e,(a>>>27)|(a<<5),(b&c)|(d&(b|c)),w[j],k3);\n\t\t\te=d; d=c; c=(b>>>2)|(b<<30); b=a; a = t;\n\t\t\t}\n\t\tfor(j=60;j<80;j++)\n\t\t\t{\n\t\t\tw[j] = rol32(w[j-3]^w[j-8]^w[j-14]^w[j-16]);\n\t\t\tt = add32x5(e,(a>>>27)|(a<<5),b^c^d,w[j],k4);\n\t\t\te=d; d=c; c=(b>>>2)|(b<<30); b=a; a = t;\n\t\t\t}\n\n\t\th0 = add32(h0,a);\n\t\th1 = add32(h1,b);\n\t\th2 = add32(h2,c);\n\t\th3 = add32(h3,d);\n\t\th4 = add32(h4,e);\n\t\t}\n\treturn Array(h0,h1,h2,h3,h4);\n}\n\n// ---------------------------------------------------------------------------------\n// RGB colour object\n// ---------------------------------------------------------------------------------\n\n// Construct an RGB colour object from a '#rrggbb', '#rgb' or 'rgb(n,n,n)' string or from separate r,g,b values\nfunction RGB(r,g,b)\n{\n\tthis.r = 0;\n\tthis.g = 0;\n\tthis.b = 0;\n\tif(typeof r == \"string\")\n\t\t{\n\t\tif(r.substr(0,1) == \"#\")\n\t\t\t{\n\t\t\tif(r.length == 7)\n\t\t\t\t{\n\t\t\t\tthis.r = parseInt(r.substr(1,2),16)/255;\n\t\t\t\tthis.g = parseInt(r.substr(3,2),16)/255;\n\t\t\t\tthis.b = parseInt(r.substr(5,2),16)/255;\n\t\t\t\t}\n\t\t\telse\n\t\t\t\t{\n\t\t\t\tthis.r = parseInt(r.substr(1,1),16)/15;\n\t\t\t\tthis.g = parseInt(r.substr(2,1),16)/15;\n\t\t\t\tthis.b = parseInt(r.substr(3,1),16)/15;\n\t\t\t\t}\n\t\t\t}\n\t\telse\n\t\t\t{\n\t\t\tvar rgbPattern = /rgb\\s*\\(\\s*(\\d{1,3})\\s*,\\s*(\\d{1,3})\\s*,\\s*(\\d{1,3})\\s*\\)/ ;\n\t\t\tvar c = r.match(rgbPattern);\n\t\t\tif (c)\n\t\t\t\t{\n\t\t\t\tthis.r = parseInt(c[1],10)/255;\n\t\t\t\tthis.g = parseInt(c[2],10)/255;\n\t\t\t\tthis.b = parseInt(c[3],10)/255;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\telse\n\t\t{\n\t\tthis.r = r;\n\t\tthis.g = g;\n\t\tthis.b = b;\n\t\t}\n\treturn this;\n}\n\n// Mixes this colour with another in a specified proportion\n// c = other colour to mix\n// f = 0..1 where 0 is this colour and 1 is the new colour\n// Returns an RGB object\nRGB.prototype.mix = function(c,f)\n{\n\treturn new RGB(this.r + (c.r-this.r) * f,this.g + (c.g-this.g) * f,this.b + (c.b-this.b) * f);\n}\n\n// Return an rgb colour as a #rrggbb format hex string\nRGB.prototype.toString = function()\n{\n\tvar r = this.r.clamp(0,1);\n\tvar g = this.g.clamp(0,1);\n\tvar b = this.b.clamp(0,1);\n\treturn(\"#\" + (\"0\" + Math.floor(r * 255).toString(16)).right(2) +\n\t\t\t\t (\"0\" + Math.floor(g * 255).toString(16)).right(2) +\n\t\t\t\t (\"0\" + Math.floor(b * 255).toString(16)).right(2));\n}\n\n// ---------------------------------------------------------------------------------\n// DOM utilities - many derived from www.quirksmode.org\n// ---------------------------------------------------------------------------------\n\nfunction drawGradient(place,horiz,colours)\n{\n\tfor(var t=0; t<= 100; t+=2)\n\t\t{\n\t\tvar bar = document.createElement(\"div\");\n\t\tplace.appendChild(bar);\n\t\tbar.style.position = \"absolute\";\n\t\tbar.style.left = horiz ? t + \"%\" : 0;\n\t\tbar.style.top = horiz ? 0 : t + \"%\";\n\t\tbar.style.width = horiz ? (101-t) + \"%\" : \"100%\";\n\t\tbar.style.height = horiz ? \"100%\" : (101-t) + \"%\";\n\t\tbar.style.zIndex = -1;\n\t\tvar f = t/100;\n\t\tvar p = f*(colours.length-1);\n\t\tbar.style.backgroundColor = colours[Math.floor(p)].mix(colours[Math.ceil(p)],p-Math.floor(p)).toString();\n\t\t}\n}\n\nfunction createTiddlyText(theParent,theText)\n{\n\treturn theParent.appendChild(document.createTextNode(theText));\n}\n\nfunction createTiddlyCheckbox(theParent,caption,checked,onChange)\n{\n\tvar cb = document.createElement(\"input\");\n\tcb.setAttribute(\"type\",\"checkbox\");\n\tcb.onclick = onChange;\n\ttheParent.appendChild(cb);\n\tcb.checked = checked;\n\tcb.className = \"chkOptionInput\";\n\tif(caption)\n\t\twikify(caption,theParent);\n\treturn cb;\n}\n\nfunction createTiddlyElement(theParent,theElement,theID,theClass,theText)\n{\n\tvar e = document.createElement(theElement);\n\tif(theClass != null)\n\t\te.className = theClass;\n\tif(theID != null)\n\t\te.setAttribute(\"id\",theID);\n\tif(theText != null)\n\t\te.appendChild(document.createTextNode(theText));\n\tif(theParent != null)\n\t\ttheParent.appendChild(e);\n\treturn(e);\n}\n\n// Add an event handler\n// Thanks to John Resig, via QuirksMode\nfunction addEvent(obj,type,fn)\n{\n\tif(obj.attachEvent)\n\t\t{\n\t\tobj['e'+type+fn] = fn;\n\t\tobj[type+fn] = function(){obj['e'+type+fn](window.event);}\n\t\tobj.attachEvent('on'+type,obj[type+fn]);\n\t\t}\n\telse\n\t\tobj.addEventListener(type,fn,false);\n}\n\n// Remove  an event handler\n// Thanks to John Resig, via QuirksMode\nfunction removeEvent(obj,type,fn)\n{\n\tif(obj.detachEvent)\n\t\t{\n\t\tobj.detachEvent('on'+type,obj[type+fn]);\n\t\tobj[type+fn] = null;\n\t\t}\n\telse\n\t\tobj.removeEventListener(type,fn,false);\n}\n\nfunction addClass(e,theClass)\n{\n\tvar currClass = e.className.split(\" \");\n\tif(currClass.indexOf(theClass) == -1)\n\t\te.className += \" \" + theClass;\n}\n\nfunction removeClass(e,theClass)\n{\n\tvar currClass = e.className.split(\" \");\n\tvar i = currClass.indexOf(theClass);\n\twhile(i != -1)\n\t\t{\n\t\tcurrClass.splice(i,1);\n\t\ti = currClass.indexOf(theClass);\n\t\t}\n\te.className = currClass.join(\" \");\n}\n\nfunction hasClass(e,theClass)\n{\n\tif(e.className)\n\t\t{\n\t\tif(e.className.split(\" \").indexOf(theClass) != -1)\n\t\t\treturn true;\n\t\t}\n\treturn false;\n}\n\n// Find the closest relative with a given property value (property defaults to tagName, relative defaults to parentNode)\nfunction findRelated(e,value,name,relative)\n{\n\tname = name ? name : \"tagName\";\n\trelative = relative ? relative : \"parentNode\";\n\tif(name == \"className\")\n\t\t{\n\t\twhile(e && !hasClass(e,value))\n\t\t\t{\n\t\t\te = e[relative];\n\t\t\t}\n\t\t}\n\telse\n\t\t{\n\t\twhile(e && e[name] != value)\n\t\t\t{\n\t\t\te = e[relative];\n\t\t\t}\n\t\t}\n\treturn e;\n}\n\n// Resolve the target object of an event\nfunction resolveTarget(e)\n{\n\tvar obj;\n\tif (e.target)\n\t\tobj = e.target;\n\telse if (e.srcElement)\n\t\tobj = e.srcElement;\n\tif (obj.nodeType == 3) // defeat Safari bug\n\t\tobj = obj.parentNode;\n\treturn(obj);\n}\n\n// Return the content of an element as plain text with no formatting\nfunction getPlainText(e)\n{\n\tvar text = \"\";\n\tif(e.innerText)\n\t\ttext = e.innerText;\n\telse if(e.textContent)\n\t\ttext = e.textContent;\n\treturn text;\n}\n\n// Get the scroll position for window.scrollTo necessary to scroll a given element into view\nfunction ensureVisible(e)\n{\n\tvar posTop = findPosY(e);\n\tvar posBot = posTop + e.offsetHeight;\n\tvar winTop = findScrollY();\n\tvar winHeight = findWindowHeight();\n\tvar winBot = winTop + winHeight;\n\tif(posTop < winTop)\n\t\treturn(posTop);\n\telse if(posBot > winBot)\n\t\t{\n\t\tif(e.offsetHeight < winHeight)\n\t\t\treturn(posTop - (winHeight - e.offsetHeight));\n\t\telse\n\t\t\treturn(posTop);\n\t\t}\n\telse\n\t\treturn(winTop);\n}\n\n// Get the current width of the display window\nfunction findWindowWidth()\n{\n\treturn(window.innerWidth ? window.innerWidth : document.documentElement.clientWidth);\n}\n\n// Get the current height of the display window\nfunction findWindowHeight()\n{\n\treturn(window.innerHeight ? window.innerHeight : document.documentElement.clientHeight);\n}\n\n// Get the current horizontal page scroll position\nfunction findScrollX()\n{\n\treturn(window.scrollX ? window.scrollX : document.documentElement.scrollLeft);\n}\n\n// Get the current vertical page scroll position\nfunction findScrollY()\n{\n\treturn(window.scrollY ? window.scrollY : document.documentElement.scrollTop);\n}\n\nfunction findPosX(obj)\n{\n\tvar curleft = 0;\n\twhile (obj.offsetParent)\n\t\t{\n\t\tcurleft += obj.offsetLeft;\n\t\tobj = obj.offsetParent;\n\t\t}\n\treturn curleft;\n}\n\nfunction findPosY(obj)\n{\n\tvar curtop = 0;\n\twhile (obj.offsetParent)\n\t\t{\n\t\tcurtop += obj.offsetTop;\n\t\tobj = obj.offsetParent;\n\t\t}\n\treturn curtop;\n}\n\n// Blur a particular element\nfunction blurElement(e)\n{\n\tif(e != null && e.focus && e.blur)\n\t\t{\n\t\te.focus();\n\t\te.blur();\n\t\t}\n}\n\n// Create a non-breaking space\nfunction insertSpacer(place)\n{\n\tvar e = document.createTextNode(String.fromCharCode(160));\n\tif(place)\n\t\tplace.appendChild(e);\n\treturn e;\n}\n\n// Remove all children of a node\nfunction removeChildren(e)\n{\n\twhile(e.hasChildNodes())\n\t\te.removeChild(e.firstChild);\n}\n\n// Add a stylesheet, replacing any previous custom stylesheet\nfunction setStylesheet(s,id)\n{\n\tif(!id)\n\t\tid = \"customStyleSheet\";\n\tvar n = document.getElementById(id);\n\tif(document.createStyleSheet) // Test for IE's non-standard createStyleSheet method\n\t\t{\n\t\tif(n)\n\t\t\tn.parentNode.removeChild(n);\n\t\t// This failed without the &nbsp;\n\t\tdocument.getElementsByTagName(\"head\")[0].insertAdjacentHTML(\"beforeEnd\",\"&nbsp;<style id='\" + id + \"'>\" + s + \"</style>\");\n\t\t}\n\telse\n\t\t{\n\t\tif(n)\n\t\t\tn.replaceChild(document.createTextNode(s),n.firstChild);\n\t\telse\n\t\t\t{\n\t\t\tvar n = document.createElement(\"style\");\n\t\t\tn.type = \"text/css\";\n\t\t\tn.id = id;\n\t\t\tn.appendChild(document.createTextNode(s));\n\t\t\tdocument.getElementsByTagName(\"head\")[0].appendChild(n);\n\t\t\t}\n\t\t}\n}\n\n// Replace the current selection of a textarea or text input and scroll it into view\n\nfunction replaceSelection(e,text)\n{\n\tif (e.setSelectionRange)\n\t\t{\n\t\tvar oldpos = e.selectionStart + 1;\n\t\te.value = e.value.substr(0,e.selectionStart) + text + e.value.substr(e.selectionStart);\n\t\te.setSelectionRange( oldpos, oldpos);\n\t\tvar linecount = e.value.split('\\n').length;\n\t\tvar thisline = e.value.substr(0,e.selectionStart).split('\\n').length-1;\n\t\te.scrollTop = Math.floor((thisline-e.rows/2)*e.scrollHeight/linecount);\n\t\t}\n\telse if (document.selection)\n\t\t{\n\t\tvar range = document.selection.createRange();\n\t\tif (range.parentElement() == e)\n\t\t\t{\n\t\t\tvar isCollapsed = range.text == \"\";\n\t\t\trange.text = text;\n\t\t\t if (!isCollapsed)\n\t\t\t\t{\n\t\t\t\trange.moveStart('character', -text.length);\n\t\t\t\trange.select();\n\t\t\t\t}\n\t\t\t}\n\t\t}\n}\n\n// Returns the text of the given (text) node, possibly merging subsequent text nodes\nfunction getNodeText(e)\n{\n\tvar t = \"\";\n\twhile (e && e.nodeName == \"#text\")\n\t\t{\n\t\tt += e.nodeValue;\n\t\te = e.nextSibling;\n\t\t}\n\treturn t;\n}\n//# -------------------------\n//# LoaderBase: A (abstract) storage loader that loads the tiddlers from a list of HTML elements.\n//# The format of the elements is defined by subclasses of this loader through the internalizeTiddler implementation.\n//# Subclasses must implement:\n//# \t\t\tfunction getTitle(store, e)\n//#\n//# store must implement:\n//# \t\t\tfunction createTiddler(title).\n//#\n\nfunction LoaderBase()\n{\n}\n\nLoaderBase.prototype.loadTiddler = function(store,e,tiddlers)\n{\n\tvar title = this.getTitle(store, e);\n\tif (title)\n\t\t{\n\t\tvar tiddler = store.createTiddler(title);\n\t\tthis.internalizeTiddler(store, tiddler, title, e);\n\t\ttiddlers.push(tiddler);\n\t\t}\n}\n\nLoaderBase.prototype.loadTiddlers = function(store,nodes)\n{\n\tvar tiddlers = [];\n\tfor (var t = 0; t < nodes.length; t++)\n\t\t{\n\t\ttry\n\t\t\t{\n\t\t\tthis.loadTiddler(store, nodes[t], tiddlers);\n\t\t\t}\n\t\tcatch(e)\n\t\t\t{\n\t\t\tshowException(e, config.messages.tiddlerLoadError.format([this.getTitle(store, nodes[t])]));\n\t\t\t}\n\t\t}\n\treturn tiddlers;\n}\n\n//# -------------------------\n//# SaverBase: a (abstract) storage saver that externalizes all tiddlers into a string,\n//# with every tiddler individually externalized (using this.externalizeTiddler) and joined with newlines\n//# Subclasses must implement:\n//# \t\t\tfunction externalizeTiddler(store, tiddler)\n//#\n//# store must implement:\n//# \t\t\tfunction getTiddlers(sortByFieldName)\n//#\n\nfunction SaverBase()\n{\n}\n\nSaverBase.prototype.externalize = function(store)\n{\n\tvar results = [];\n\tvar tiddlers = store.getTiddlers(\"title\");\n\tfor (var t = 0; t < tiddlers.length; t++)\n\t\tresults.push(this.externalizeTiddler(store, tiddlers[t]));\n\treturn results.join(\"\\n\");\n}\n//--------------------------------\n// TW21Loader (inherits from LoaderBase)\n\nfunction TW21Loader() {};\n\nTW21Loader.prototype = new LoaderBase();\n\nTW21Loader.prototype.getTitle = function(store, e) {\n\tvar title = null;\n\tif(e.getAttribute)\n\t\ttitle = e.getAttribute(\"tiddler\");\n\tif(!title && e.id) {\n\t\tvar lenPrefix = store.idPrefix.length;\n\t\tif (e.id.substr(0,lenPrefix) == store.idPrefix)\n\t\t\ttitle = e.id.substr(lenPrefix);\n\t}\n\treturn title;\n}\n\nTW21Loader.prototype.internalizeTiddler = function(store, tiddler, title, data) {\n\tvar text = getNodeText(data.firstChild).unescapeLineBreaks();\n\tvar modifier = data.getAttribute(\"modifier\");\n\tvar modified = Date.convertFromYYYYMMDDHHMM(data.getAttribute(\"modified\"));\n\tvar c = data.getAttribute(\"created\");\n\tvar created = c ? Date.convertFromYYYYMMDDHHMM(c) : modified;\n\tvar tags = data.getAttribute(\"tags\");\n\tvar fields = {};\n\tvar attrs = data.attributes;\n\tfor(var i = attrs.length-1; i >= 0; i--) {\n\t\tvar name = attrs[i].name;\n\t\tif (attrs[i].specified && !TiddlyWiki.isStandardField(name)) {\n\t\t\tfields[name] = attrs[i].value.unescapeLineBreaks();\n\t\t}\n\t}\n\ttiddler.assign(title,text,modifier,modified,tags,created, fields);\n\treturn tiddler;\n};\n\n//--------------------------------\n// TW21Saver (inherits from SaverBase)\n\nfunction TW21Saver() {};\n\nTW21Saver.prototype = new SaverBase();\n\nTW21Saver.prototype.externalizeTiddler = function(store, tiddler)\n{\n\ttry {\n\t\tvar extendedFieldAttributes = \"\";\n\t\tstore.forEachField(tiddler,\n\t\t\tfunction(tiddler, fieldName, value) {\n\t\t\t\t// don't store stuff from the temp namespace\n\t\t\t\tif (!fieldName.match(/^temp\\./))\n\t\t\t\t\textendedFieldAttributes += ' %0=\"%1\"'.format([fieldName, value.escapeLineBreaks().htmlEncode()]);\n\t\t\t}, true);\n\t\treturn '<div tiddler=\"%0\" modifier=\"%1\" modified=\"%2\" created=\"%3\" tags=\"%4\"%6>%5</div>'.format([\n\t\t\t\ttiddler.title.htmlEncode(),\n\t\t\t\ttiddler.modifier.htmlEncode(),\n\t\t\t\ttiddler.modified.convertToYYYYMMDDHHMM(),\n\t\t\t\ttiddler.created.convertToYYYYMMDDHHMM(),\n\t\t\t\ttiddler.getTags().htmlEncode(),\n\t\t\t\ttiddler.escapeLineBreaks().htmlEncode(),\n\t\t\t\textendedFieldAttributes\n\t\t\t]);\n\t} catch (e) {\n\t\tthrow exceptionText(e, config.messages.tiddlerSaveError.format([tiddler.title]));\n\t}\n}\n\n// ---------------------------------------------------------------------------------\n// Deprecated code\n// ---------------------------------------------------------------------------------\n\n// @Deprecated: Use createElementAndWikify and this.termRegExp instead\nconfig.formatterHelpers.charFormatHelper = function(w)\n{\n\tw.subWikify(createTiddlyElement(w.output,this.element),this.terminator);\n}\n\n// @Deprecated: Use enclosedTextHelper and this.lookaheadRegExp instead\nconfig.formatterHelpers.monospacedByLineHelper = function(w)\n{\n\tvar lookaheadRegExp = new RegExp(this.lookahead,\"mg\");\n\tlookaheadRegExp.lastIndex = w.matchStart;\n\tvar lookaheadMatch = lookaheadRegExp.exec(w.source);\n\tif(lookaheadMatch && lookaheadMatch.index == w.matchStart)\n\t\t{\n\t\tvar text = lookaheadMatch[1];\n\t\tif(config.browser.isIE)\n\t\t\ttext = text.replace(/\\n/g,\"\\r\");\n\t\tcreateTiddlyElement(w.output,\"pre\",null,null,text);\n\t\tw.nextMatch = lookaheadRegExp.lastIndex;\n\t\t}\n}\n\n// @Deprecated: Use <br> or <br /> instead of <<br>>\nconfig.macros.br.handler = function(place)\n{\n\tcreateTiddlyElement(place,\"br\");\n}\n\n// Find an entry in an array. Returns the array index or null\n// @Deprecated: Use indexOf instead\nArray.prototype.find = function(item)\n{\n\tvar i = this.indexOf(item);\n\treturn i == -1 ? null : i;\n}\n\n// Load a tiddler from an HTML DIV. The caller should make sure to later call Tiddler.changed()\n// @Deprecated: Use store.getLoader().internalizeTiddler instead\nTiddler.prototype.loadFromDiv = function(divRef,title)\n{\n\treturn store.getLoader().internalizeTiddler(store,this,title,divRef);\n}\n\n// Format the text for storage in an HTML DIV\n// @Deprecated Use store.getSaver().externalizeTiddler instead.\nTiddler.prototype.saveToDiv = function()\n{\n\treturn store.getSaver().externalizeTiddler(store,this);\n}\n\n// @Deprecated: Use store.allTiddlersAsHtml() instead\nfunction allTiddlersAsHtml()\n{\n\treturn store.allTiddlersAsHtml();\n}\n\n// @Deprecated: Use refreshPageTemplate instead\nfunction applyPageTemplate(title)\n{\n\trefreshPageTemplate(title);\n}\n\n// @Deprecated: Use story.displayTiddlers instead\nfunction displayTiddlers(srcElement,titles,template,unused1,unused2,animate,slowly)\n{\n\tstory.displayTiddlers(srcElement,titles,template,animate,slowly);\n}\n\n// @Deprecated: Use story.displayTiddler instead\nfunction displayTiddler(srcElement,title,template,unused1,unused2,animate,slowly)\n{\n\tstory.displayTiddler(srcElement,title,template,animate,slowly);\n}\n\n// @Deprecated: Use functions on right hand side directly instead\nvar createTiddlerPopup = Popup.create;\nvar scrollToTiddlerPopup = Popup.show;\nvar hideTiddlerPopup = Popup.remove;\n\n// @Deprecated: Use right hand side directly instead\nvar regexpBackSlashEn = new RegExp(\"\\\\\\\\n\",\"mg\");\nvar regexpBackSlash = new RegExp(\"\\\\\\\\\",\"mg\");\nvar regexpBackSlashEss = new RegExp(\"\\\\\\\\s\",\"mg\");\nvar regexpNewLine = new RegExp(\"\\n\",\"mg\");\nvar regexpCarriageReturn = new RegExp(\"\\r\",\"mg\");\n// ---------------------------------------------------------------------------------\n// End of scripts\n// ---------------------------------------------------------------------------------\n//]]>\n</script>\n<style type=\"text/css\">\n\n#saveTest {\n\tdisplay: none;\n}\n\n.zoomer {\n\tdisplay: none;\n}\n\n#messageArea {\n\tdisplay: none;\n}\n\n#copyright {\n\tdisplay: none;\n}\n\n.popup {\n\tposition: absolute;\n}\n\n#storeArea {\n\tdisplay: none;\n\tmargin: 4em 10em 3em;\n}\n\n#storeArea div {\n padding: 0.5em;\n margin: 1em 0em 0em 0em;\n border-color: #f0f0f0 #606060 #404040 #d0d0d0;\n border-style: solid;\n border-width: 2px;\n overflow: auto;\n}\n\n#javascriptWarning {\n\twidth: 100%;\n\ttext-align: center;\n\tfont-weight: bold;\n\tbackground-color: #dd1100;\n\tcolor: #fff;\n\tpadding:1em 0em;\n}\n\n</style>\n<!--POST-HEAD-START-->\n\n<!--POST-HEAD-END-->\n</head>\n<body onload=\"main();\" onunload=\"if(window.checkUnsavedChanges) checkUnsavedChanges();\">\n<!--PRE-BODY-START-->\n\n<!--PRE-BODY-END-->\n\t<script type=\"text/javascript\">\n//<![CDATA[\nif (useJavaSaver)\n\tdocument.write(\"<applet style='position:absolute;left:-1px' name='TiddlySaver' code='TiddlySaver.class' archive='TiddlySaver.jar' width='1' height='1'></applet>\");\n//]]>\n\t</script>\n\t<div id=\"copyright\">\n\tWelcome to TiddlyWiki by Jeremy Ruston, Copyright &copy; 2006 Osmosoft Limited\n\t</div>\n\t<noscript>\n\t\t<div id=\"javascriptWarning\">This page requires JavaScript to function properly</div>\n\t</noscript>\n\t<div id=\"saveTest\"></div>\n\t<div id=\"contentWrapper\"></div>\n\t<div id=\"contentStash\"></div>\n\t<div id=\"storeArea\">\n<div tiddler=\"Adversary\" modifier=\"YourName\" modified=\"200901120839\" created=\"200804081715\" tags=\"\">!Mobility\\nEnvisioned adversary is ''mobile''. It can compromise a subset of sensor within a particular time interval. \\nWhile it occupies a given node, it can read, and possibly write to, the compromised node's storage and any of its communication interfaces. \\nIn the next interval, it is capable of migrating to a different subset of sensor. Given enough time intervals, the adversary can compromise the whole network.\\n\\n!Goals:\\nA UWSN adversary can have different goal. We list a few of them:\\n\\n!!!!Curious\\nIts goal is to learn as much sensed data as possible, compromising sensor and reading their storage.\\n!!!!Polluter\\nIts goal is to mislead or confuse the sink by introducing fraudulent data into the network. \\n!!!!Eraser\\nThis adversary aims to indiscriminately erase as much sensed data as possible.\\n!!!!~Search-and-Read\\nThis adversary is focused on learning certain selected sensor measurements that represent critical or high-value data.\\n!!!!~Search-and-Erase\\nIts goal is to prevent certain target data from reaching the sink. \\n!!!!~Search-and-Replace\\nThis adversary aims at replacing certain target data with a concocted value before the sink approaches the network to collect sensed data \\n\\n!Visibility\\nThe adversary could choose as a secondary goal, whether to be visible to the sink or not. An Eraser adversary deleting data from sensor storage will be easily spotted by the sink; on the other side, the sink might not learn if a Search-and-Replace adversary has ever attacked the network.\\n\\n!Reactivity\\nWe distinguish between a proactive adversary and a reactive one. The former starts node compromise as soon as the sink leaves the network; the latter waits for a trigger event.\\n\\n</div>\n<div tiddler=\"DefaultTiddlers\" modifier=\"YourName\" modified=\"200812151628\" created=\"200701312156\" tags=\"\">[[UWSNs]]\\n[[Publications]]\\n\\n</div>\n<div tiddler=\"MainMenu\" modifier=\"YourName\" modified=\"200812151628\" created=\"200701312154\" tags=\"\">''Main Menu''\\n----\\n[[UWSNs|UWSNs]]\\n[[Adversary|Adversary]]\\n[[Publications|Publications]]\\n[[Presentations|Presentations]]\\n\\n</div>\n<div tiddler=\"PageTemplate\" modifier=\"YourName\" modified=\"200804081848\" created=\"200804081848\" tags=\"\">&lt;!--{{{--&gt;\\n&lt;div class='header' macro='gradient vert [[ColorPalette::PrimaryLight]] [[ColorPalette::PrimaryMid]]'&gt;\\n&lt;div class='headerShadow'&gt;\\n&lt;span class='siteTitle' refresh='content' tiddler='SiteTitle'&gt;&lt;/span&gt;&amp;nbsp;\\n&lt;span class='siteSubtitle' refresh='content' tiddler='SiteSubtitle'&gt;&lt;/span&gt;\\n&lt;/div&gt;\\n&lt;div class='headerForeground'&gt;\\n&lt;span class='siteTitle' refresh='content' tiddler='SiteTitle'&gt;&lt;/span&gt;&amp;nbsp;\\n&lt;span class='siteSubtitle' refresh='content' tiddler='SiteSubtitle'&gt;&lt;/span&gt;\\n&lt;/div&gt;\\n&lt;/div&gt;\\n&lt;div id='mainMenu' refresh='content' tiddler='MainMenu'&gt;&lt;/div&gt;\\n&lt;div id='sidebar'&gt;\\n&lt;div id='sidebarOptions' refresh='content' tiddler='SideBarOptions'&gt;&lt;/div&gt;\\n&lt;div id='sidebarTabs' refresh='content' force='true' tiddler='SideBarTabs'&gt;&lt;/div&gt;\\n&lt;/div&gt;\\n&lt;div id='displayArea'&gt;\\n&lt;div id='messageArea'&gt;&lt;/div&gt;\\n&lt;div id='tiddlerDisplay'&gt;&lt;/div&gt;\\n&lt;/div&gt;\\n&lt;!--}}}--&gt;</div>\n<div tiddler=\"Presentations\" modifier=\"YourName\" modified=\"200901111818\" created=\"200812151600\" tags=\"\">[[Self-Defense in Unattended Wireless Sensor Networks (UWSNs)|./presentations/sss_poster.pdf]] @ SSS 2008\\n\\n[[DISH|./presentations/sss_slides.pdf]] @ SSS 2008\\n\\n[[POSH|./presentations/srds08.pdf]] @ IEEE SRDS 2008\\n\\n[[Practical Forward Secure Aggregate Signatures|./presentations/asiaccs08_slides.pdf]] @ ACM ~AsiaCCS 2008\\n\\n[[Security in UWSNs|./presentations/asiaccs08.pdf]] @ ACM ~AsiaCCS 2008\\n\\n[[Catch Me (If You Can)|./presentations/percom08.pdf]] @ IEEE ~PerCom 2008\\n\\n[[FSS-AGG|./presentations/sp07_slides.pdf]] @ IEEE S&amp;P 2007\\n</div>\n<div tiddler=\"Publications\" modifier=\"YourName\" modified=\"201007021403\" created=\"200701312158\" tags=\"i\">[[Securing Mobile Unattended WSNs against a mobile adversary|]]\\nThe 29th IEEE International Symposium on Reliable Distributed Systems, SRDS 2010, New Delhi, India, November 1-3, 2010. To appear.\\n\\n[[Security and Privacy in Emerging Wireless Networks|./publications/ewgwn-final.pdf]]\\nIEEE Wireless Communications, Special Issue on Security and Privacy in Emerging Wireless Networks\\n\\n[[IRRES: Intrusion Resilient Remote Email Storage|./publications/irres-final.pdf]]\\nFirst ICDCS Workshop on Security and Privacy in Cloud Computing.\\n\\n[[Intrusion-Resilience in Mobile Unattended WSNs|./publications/infocom10.pdf]]\\nThe 29th IEEE Conference on Computer Communications, INFOCOM 2010, San Diego, California, March 15-19, 2010.\\n\\n[[Data Security in Unattended Sensor Networks|./publications/toc09.PDF]]\\nIEEE Transactions on Computers, Volume 50, Issue 11, November 2009, Pages 1500-1511.\\n\\n[[New Adversary and New Threats: Security in Unattended Sensor Networks|./publications/network09.PDF]]\\nIEEE Network, Volume 23, Issue 2,  March 2009, Pages 43-48.\\n\\n[[Playing Hide-and-Seek with a Focused Mobile Adversary in Unattended Sensor Networks|./publications/adhoc09.PDF]] \\nAd Hoc Networks, Volume 7, Issue 8, November 2009, Pages 1463-1475.\\n\\n[[Collaborative Authentication in Unattended Sensor Networks|./publications/wisec09.PDF]]\\nThe Second ACM Conference on Wireless Network Security, WISEC 2009, Zurich, Switzerland, March 16-19, 2009, Pages 237-244.\\n\\n[[DISH: Distributed Self-Healing in Unattended Wireless Sensor Networks|./publications/sss08.PDF]]\\nThe Tenth International Symposium on Stabilization, Safety, and Security of Distributed Systems, SSS 2008, Detroit, MI, USA, November 21-23, 2008, Pages 47-72. [[Full version|./publications/sss08-full.pdf]].\\n\\n[[Self-Defense in Unattended Wireless Sensor Networks|./publications/sss08-poster.pdf]] (poster)\\nThe Tenth International Symposium on Stabilization, Safety, and Security of Distributed Systems, SSS 2008, Detroit, MI, USA, November 21-23, 2008.\\n\\n[[POSH: Proactive co-Operative Self-Healing in Unattended Wireless Sensor Networks|./publications/srds08.PDF]]\\nThe Twenty-seventh IEEE Symposium on Reliable Distributed Systems, SRDS 2008, Napoli, Italy, October 6-8, 2008, Pages 185-194.\\n\\n[[Catch Me (If You Can): Data Survival in Unattended Sensor Networks|./publications/percom08.PDF]]\\nThe Sixth Annual IEEE International Conference on Pervasive Computing and Communications, PerCom 2008, Hong Kong, March 17-21 , 2008, Pages 185-194.\\n\\n[[Practical Forward Secure Aggregate Signatures|./publications/asiaccs08.PDF]] \\nThe 2008 ACM Symposium on Information, Computer and Communications Security, ASIACCS 2008, Tokyo, Japan, March 18-20, 2008, Pages 341-352.\\n\\n[[Confronting a mobile adversary in unattended sensor networks|./publications/asiaccs08gts.PDF]]\\nThe 2008 ACM Symposium on Information, Computer and Communications Security, ASIACCS 2008, Tokyo, Japan, March 18-20, 2008, Pages 1.\\n \\n[[Forward-secure Sequential Aggregate Authentication|./publications/sp07.PDF]]\\nThe 2007 IEEE Symposium on Security and Privacy, S&amp;P 2007, Oakland, CA, USA, May 20-23, 2007, Pages 86-91.\\n\\n</div>\n<div tiddler=\"SideBarOptions\" modifier=\"YourName\" modified=\"200912081751\" created=\"200703072222\" tags=\"\">/%&lt;&lt;search&gt;&gt;&lt;&lt;closeAll&gt;&gt;&lt;&lt;permaview&gt;&gt;&lt;&lt;newTiddler&gt;&gt;&lt;&lt;newJournal 'DD MMM YYYY'&gt;&gt;&lt;&lt;saveChanges&gt;&gt;&lt;&lt;slider chkSliderOptionsPanel OptionsPanel 'options \u00bb' 'Change TiddlyWiki advanced options'&gt;&gt;%/\\n''People''\\n----\\n@@font-size:8pt;\\n[[Roberto Di Pietro|http://www.dsi.uniroma1.it/~dipietro/]]\\n[[Di Ma|http://www-personal.engin.umd.umich.edu/~dmadma/]]\\n[[Luigi V. Mancini|http://www.di.uniroma1.it/mancini]]\\n[[Gabriele Oligeri|http://wnlab.isti.cnr.it/gabriele/]]\\n[[Claudio Soriente|http://www.ics.uci.edu/~csorient/]]\\n[[Angelo Spognardi|http://icsecurity.di.uniroma1.it/dokuwiki/doku.php?id=people:aspognardi]]\\n[[Gene Tsudik|http://www.ics.uci.edu/~gts/]]\\n@@\\n\\n</div>\n<div tiddler=\"SideBarTabs\" modifier=\"YourName\" modified=\"200704281735\" created=\"200703072223\" tags=\"\">/%&lt;&lt;tabs txtMainTab Timeline Timeline TabTimeline All 'All tiddlers' TabAll Tags 'All tags' TabTags More 'More lists' TabMore&gt;&gt;%/</div>\n<div tiddler=\"SiteSubtitle\" modifier=\"Karim\" modified=\"200701312153\" created=\"200701312153\" tags=\"\"></div>\n<div tiddler=\"SiteTitle\" modifier=\"Claudio\" modified=\"200804112033\" created=\"200701312153\" tags=\"\">Security in Unattended Wireless Sensor Netoworks</div>\n<div tiddler=\"StyleSheetLayout\" modifier=\"YourName\" modified=\"200812141100\" created=\"200707241602\" tags=\"\">/*{{{*/\\n* html .tiddler {\\n height: 1%;\\n}\\n\\nbody {\\n font-size: .75em;\\n font-family: arial,helvetica;\\n margin: 0;\\n padding: 0;\\n}\\n\\nh1,h2,h3,h4,h5 {\\n font-weight: bold;\\n text-decoration: none;\\n padding-left: 0.4em;\\n}\\n\\nh1 {font-size: 1.35em;}\\nh2 {font-size: 1.25em;}\\nh3 {font-size: 1.1em;}\\nh4 {font-size: 1em;}\\nh5 {font-size: .9em;}\\n\\nhr {\\n height: 1px;\\n}\\n\\na{\\n text-decoration: none;\\n}\\n\\ndt {font-weight: bold;}\\n\\nol { list-style-type: decimal }\\nol ol { list-style-type: lower-alpha }\\nol ol ol { list-style-type: lower-roman }\\nol ol ol ol { list-style-type: decimal }\\nol ol ol ol ol { list-style-type: lower-alpha }\\nol ol ol ol ol ol { list-style-type: lower-roman }\\nol ol ol ol ol ol ol { list-style-type: decimal }\\n\\n.txtOptionInput {\\n width: 11em;\\n}\\n\\n#contentWrapper .chkOptionInput {\\n border: 0;\\n}\\n\\n.externalLink {\\n text-decoration: underline;\\n}\\n\\n.indent {margin-left:3em;}\\n.outdent {margin-left:3em; text-indent:-3em;}\\ncode.escaped {white-space:nowrap;}\\n\\n.tiddlyLinkExisting {\\n font-weight: bold;\\n}\\n\\n.tiddlyLinkNonExisting {\\n font-style: italic;\\n}\\n\\n/* the 'a' is required for IE, otherwise it renders the whole tiddler a bold */\\na.tiddlyLinkNonExisting.shadow {\\n font-weight: bold;\\n}\\n\\n#mainMenu .tiddlyLinkExisting, \\n#mainMenu .tiddlyLinkNonExisting,\\n#sidebarTabs .tiddlyLinkNonExisting{\\n font-weight: normal;\\n font-style: normal;\\n}\\n\\n#sidebarTabs .tiddlyLinkExisting {\\n font-weight: bold;\\n font-style: normal;\\n}\\n\\n.header {\\n position: relative;\\nbackground: red;\\n\\n}\\n\\n.header a:hover {\\n background: transparent;\\n}\\n\\n.headerShadow {\\n position: relative;\\n padding: 4.5em 0em 1em 1em;\\n left: -1px;\\n top: -1px;\\n}\\n\\n.headerForeground {\\n position: absolute;\\n padding: 4.5em 0em 1em 1em;\\n left: 0px;\\n top: 0px;\\n}\\n\\n.siteTitle {\\n font-size: 3em;\\n}\\n\\n.siteSubtitle {\\n font-size: 1.2em;\\n}\\n\\n#mainMenu {\\n position: absolute;\\n left: 0;\\n width: 10em;\\n text-align: right;\\n line-height: 1.6em;\\n padding: 1.5em 0.5em 0.5em 0.5em;\\n font-size: 1.1em;\\n}\\n\\n#sidebar {\\n position: absolute;\\n right: 20px;\\n width: 16em;\\n font-size: 1.1em;\\n}\\n\\n#sidebarOptions {\\n padding-top: 0.3em;\\n}\\n\\n#sidebarOptions a {\\n margin: 0em 0.2em;\\n padding: 0.2em 0.3em;\\n display: block;\\n}\\n\\n#sidebarOptions input {\\n margin: 0.4em 0.5em;\\n}\\n\\n#sidebarOptions .sliderPanel {\\n margin-left: 1em;\\n padding: 0.5em;\\n font-size: .85em;\\n}\\n\\n#sidebarOptions .sliderPanel a {\\n font-weight: bold;\\n display: inline;\\n padding: 0;\\n}\\n\\n#sidebarOptions .sliderPanel input {\\n margin: 0 0 .3em 0;\\n}\\n\\n#sidebarTabs .tabContents {\\n width: 15em;\\n overflow: hidden;\\n}\\n\\n.wizard {\\n padding: 0.1em 0em 0em 2em;\\n}\\n\\n.wizard h1 {\\n font-size: 2em;\\n font-weight: bold;\\n background: none;\\n padding: 0em 0em 0em 0em;\\n margin: 0.4em 0em 0.2em 0em;\\n}\\n\\n.wizard h2 {\\n font-size: 1.2em;\\n font-weight: bold;\\n background: none;\\n padding: 0em 0em 0em 0em;\\n margin: 0.2em 0em 0.2em 0em;\\n}\\n\\n.wizardStep {\\n padding: 1em 1em 1em 1em;\\n}\\n\\n.wizard .button {\\n margin: 0.5em 0em 0em 0em;\\n font-size: 1.2em;\\n}\\n\\n#messageArea {\\nposition:absolute; top:0; right:0; margin: 0.5em; padding: 0.5em;\\n}\\n\\n*[id='messageArea'] {\\nposition:fixed !important; z-index:99;}\\n\\n.messageToolbar {\\ndisplay: block;\\ntext-align: right;\\n}\\n\\n#messageArea a{\\n text-decoration: underline;\\n}\\n\\n.popup {\\n font-size: .9em;\\n padding: 0.2em;\\n list-style: none;\\n margin: 0;\\n}\\n\\n.popup hr {\\n display: block;\\n height: 1px;\\n width: auto;\\n padding: 0;\\n margin: 0.2em 0em;\\n}\\n\\n.listBreak {\\n font-size: 1px;\\n line-height: 1px;\\n}\\n\\n.listBreak div {\\n margin: 2px 0;\\n}\\n\\n.popup li.disabled {\\n padding: 0.2em;\\n}\\n\\n.popup li a{\\n display: block;\\n padding: 0.2em;\\n}\\n\\n.tabset {\\n padding: 1em 0em 0em 0.5em;\\n}\\n\\n.tab {\\n margin: 0em 0em 0em 0.25em;\\n padding: 2px;\\n}\\n\\n.tabContents {\\n padding: 0.5em;\\n}\\n\\n.tabContents ul, .tabContents ol {\\n margin: 0;\\n padding: 0;\\n}\\n\\n.txtMainTab .tabContents li {\\n list-style: none;\\n}\\n\\n.tabContents li.listLink {\\n margin-left: .75em;\\n}\\n\\n#displayArea {\\n margin: 1em 20em 0em 14em;\\n}\\n\\n\\n.toolbar {\\n text-align: right;\\n font-size: .9em;\\n visibility: hidden;\\n}\\n\\n.selected .toolbar {\\n visibility: visible;\\n}\\n\\n.tiddler {\\n padding: 1em 1em 0em 1em;\\n}\\n\\n.missing .viewer,.missing .title {\\n font-style: italic;\\n}\\n\\n.title {\\n font-size: 1.6em;\\n font-weight: bold;\\n background: LightCyan;\\n foreground:Bakc;\\n}\\n\\n.missing .subtitle {\\n display: none;\\n}\\n\\n.subtitle {\\n font-size: 1.1em;\\n}\\n\\n.tiddler .button {\\n padding: 0.2em 0.4em;\\n}\\n\\n.tagging {\\nmargin: 0.5em 0.5em 0.5em 0;\\nfloat: left;\\ndisplay: none;\\n}\\n\\n.isTag .tagging {\\ndisplay: block;\\n}\\n\\n.tagged {\\nmargin: 0.5em;\\nfloat: right;\\n}\\n\\n.tagging, .tagged {\\nfont-size: 0.9em;\\npadding: 0.25em;\\n}\\n\\n.tagging ul, .tagged ul {\\nlist-style: none;margin: 0.25em;\\npadding: 0;\\n}\\n\\n.tagClear {\\nclear: both;\\n}\\n\\n.footer {\\n font-size: .9em;\\n}\\n\\n.footer li {\\ndisplay: inline;\\n}\\n\\n* html .viewer pre {\\n width: 99%;\\n padding: 0 0 1em 0;\\n}\\n\\n.viewer {\\n line-height: 1.4em;\\n padding-top: 0.5em;\\n}\\n\\n.viewer .button {\\n margin: 0em 0.25em;\\n padding: 0em 0.25em;\\n}\\n\\n.viewer blockquote {\\n line-height: 1.5em;\\n padding-left: 0.8em;\\n margin-left: 2.5em;\\n}\\n\\n.viewer ul, .viewer ol{\\n margin-left: 0.5em;\\n padding-left: 1.5em;\\n}\\n\\n.viewer table {\\n border-collapse: collapse;\\n margin: 0.8em 1.0em;\\n}\\n\\n.viewer th, .viewer td, .viewer tr,.viewer caption{\\n padding: 3px;\\n}\\n\\n.viewer table.listView {\\n font-size: 0.85em;\\n margin: 0.8em 1.0em;\\n}\\n\\n.viewer table.listView th, .viewer table.listView td, .viewer table.listView tr {\\n padding: 0px 3px 0px 3px;\\n}\\n\\n.viewer pre {\\n padding: 0.5em;\\n margin-left: 0.5em;\\n font-size: 1.2em;\\n line-height: 1.4em;\\n overflow: auto;\\n}\\n\\n.viewer code {\\n font-size: 1.2em;\\n line-height: 1.4em;\\n}\\n\\n.editor {\\nfont-size: 1.1em;\\n}\\n\\n.editor input, .editor textarea {\\n display: block;\\n width: 100%;\\n font: inherit;\\n}\\n\\n.editorFooter {\\n padding: 0.25em 0em;\\n font-size: .9em;\\n}\\n\\n.editorFooter .button {\\npadding-top: 0px; padding-bottom: 0px;}\\n\\n.fieldsetFix {border: 0;\\npadding: 0;\\nmargin: 1px 0px 1px 0px;\\n}\\n\\n.sparkline {\\n line-height: 1em;\\n}\\n\\n.sparktick {\\n outline: 0;\\n}\\n\\n.zoomer {\\n font-size: 1.1em;\\n position: absolute;\\n padding: 1em;\\n}\\n\\n.cascade {\\n font-size: 1.1em;\\n position: absolute;\\n overflow: hidden;\\n}\\n/*}}}*/</div>\n<div tiddler=\"UWSNs\" modifier=\"YourName\" modified=\"200901111832\" created=\"200804081714\" tags=\"\">''//Unattended Wireless Sensor Networks//'' (UWSNs) refer to the category of wireless sensor networks that operate without an on-line data collection entity. \\n\\nIn a UWSN the sink visits the network with irregular and even unpredictable frequency. Consequently, each sensor must retain its data (measurements) for a considerable time. \\n\\nIntervals between successive sink visits represent periods of vulnerability and incentive attacks. This web page provides an overview of UWSNs, a model for a new [[Adversary]] and proposes solutions to address its security issues.\\n\\n\\n&lt;html&gt;\\n&lt;div align=center&gt;\\n&lt;img src=&quot;UWSNs.jpg&quot; width=600 height=362 alt=&quot;UWSN splash&quot;&gt; \\n&lt;/div&gt;\\n&lt;/html&gt;\\n</div>\n<div tiddler=\"ViewTemplate\" modifier=\"cla\" modified=\"200703071910\" created=\"200703071909\" tags=\"\">&lt;!--{{{--&gt;\\n&lt;div class='toolbar' macro='toolbar closeTiddler closeOthers +editTiddler permalink references jump'&gt;&lt;/div&gt;\\n&lt;div class='title' macro='view title'&gt;&lt;/div&gt;\\n&lt;div class='tagging' macro='tagging'&gt;&lt;/div&gt;\\n&lt;div class='viewer' macro='view text wikified'&gt;&lt;/div&gt;\\n&lt;div class='tagClear'&gt;&lt;/div&gt;\\n&lt;!--}}}--&gt;</div>\n</div>\n<!--POST-BODY-START-->\n\n<!--POST-BODY-END-->\n\t</body>\n</html>\n", "encoding": "utf-8"}