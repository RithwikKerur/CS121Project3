{"url": "http://sprout.ics.uci.edu/projects/usec/usec.html", "content": "<!-- saved from url=(0022)http://internet.e-mail -->\n<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Strict//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd\">\n<html xmlns=\"http://www.w3.org/1999/xhtml\" xml:lang=\"en\" lang=\"en\">\n<head>\n<script type=\"text/javascript\">\n//<![CDATA[\nvar version = {title: \"TiddlyWiki\", major: 2, minor: 2, revision: 4, date: new Date(\"Jun 19, 2007\"), extensions: {}};\n//]]>\n</script>\n<!--\nTiddlyWiki created by Jeremy Ruston, (jeremy [at] osmosoft [dot] com)\n\nCopyright (c) UnaMesa Association 2004-2007\n\nRedistribution and use in source and binary forms, with or without modification,\nare permitted provided that the following conditions are met:\n\nRedistributions of source code must retain the above copyright notice, this\nlist of conditions and the following disclaimer.\n\nRedistributions in binary form must reproduce the above copyright notice, this\nlist of conditions and the following disclaimer in the documentation and/or other\nmaterials provided with the distribution.\n\nNeither the name of the UnaMesa Association nor the names of its contributors may be\nused to endorse or promote products derived from this software without specific\nprior written permission.\n\nTHIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS \"AS IS\" AND ANY\nEXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES\nOF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT\nSHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,\nINCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED\nTO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR\nBUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN\nCONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN\nANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH\nDAMAGE.\n-->\n<meta http-equiv=\"Content-Type\" content=\"text/html;charset=utf-8\"/>\n<!--PRE-HEAD-START-->\n<!--{{{-->\n<link rel='alternate' type='application/rss+xml' title='RSS' href='index.xml'/>\n<!--}}}-->\n<!--PRE-HEAD-END-->\n<title>Usable Security Group - improving usability for better security </title>\n<style type=\"text/css\">\n#saveTest {display:none;}\n#messageArea {display:none;}\n#copyright {display:none;}\n#storeArea {display:none;}\n#storeArea div {padding:0.5em; margin:1em 0em 0em 0em; border-color:#fff #666 #444 #ddd; border-style:solid; border-width:2px; overflow:auto;}\n#shadowArea {display:none;}\n#javascriptWarning {width:100%; text-align:center; font-weight:bold; background-color:#dd1100; color:#fff; padding:1em 0em;}\n</style>\n<!--POST-HEAD-START-->\n\n<!--POST-HEAD-END-->\n</head>\n<body onload=\"main();\" onunload=\"if(window.checkUnsavedChanges) checkUnsavedChanges(); if(window.scrubNodes) scrubNodes(document.body);\">\n<!--PRE-BODY-START-->\n\n<!--PRE-BODY-END-->\n<div id=\"copyright\">\nWelcome to TiddlyWiki created by Jeremy Ruston, Copyright &copy; 2007 UnaMesa Association\n</div>\n<noscript>\n\t<div id=\"javascriptWarning\">This page requires JavaScript to function properly.<br /><br />If you are using Microsoft Internet Explorer you may need to click on the yellow bar above and select 'Allow Blocked Content'. You must then click 'Yes' on the following security warning.</div>\n</noscript>\n<div id=\"saveTest\"></div>\n<div id=\"backstageCloak\"></div>\n<div id=\"backstageButton\"></div>\n<div id=\"backstageArea\"><div id=\"backstageToolbar\"></div></div>\n<div id=\"backstage\">\n\t<div id=\"backstagePanel\"></div>\n</div>\n<div id=\"contentWrapper\"></div>\n<div id=\"contentStash\"></div>\n<div id=\"shadowArea\">\n<div title=\"ColorPalette\">\n<pre>Background: #fff\nForeground: #000\nPrimaryPale: #8cf\nPrimaryLight: #18f\nPrimaryMid: #04b\nPrimaryDark: #014\nSecondaryPale: #ffc\nSecondaryLight: #fe8\nSecondaryMid: #db4\nSecondaryDark: #841\nTertiaryPale: #eee\nTertiaryLight: #ccc\nTertiaryMid: #999\nTertiaryDark: #666\nError: #f88</pre>\n</div>\n<div title=\"StyleSheetColors\">\n<pre>/*{{{*/\nbody {background:[[ColorPalette::Background]]; color:[[ColorPalette::Foreground]];}\n\na {color:[[ColorPalette::PrimaryMid]];}\na:hover {background-color:[[ColorPalette::PrimaryMid]]; color:[[ColorPalette::Background]];}\na img {border:0;}\n\nh1,h2,h3,h4,h5,h6 {color:[[ColorPalette::SecondaryDark]]; background:transparent;}\nh1 {border-bottom:2px solid [[ColorPalette::TertiaryLight]];}\nh2,h3 {border-bottom:1px solid [[ColorPalette::TertiaryLight]];}\n\n.button {color:[[ColorPalette::PrimaryDark]]; border:1px solid [[ColorPalette::Background]];}\n.button:hover {color:[[ColorPalette::PrimaryDark]]; background:[[ColorPalette::SecondaryLight]]; border-color:[[ColorPalette::SecondaryMid]];}\n.button:active {color:[[ColorPalette::Background]]; background:[[ColorPalette::SecondaryMid]]; border:1px solid [[ColorPalette::SecondaryDark]];}\n\n.header {background:[[ColorPalette::PrimaryMid]];}\n.headerShadow {color:[[ColorPalette::Foreground]];}\n.headerShadow a {font-weight:normal; color:[[ColorPalette::Foreground]];}\n.headerForeground {color:[[ColorPalette::Background]];}\n.headerForeground a {font-weight:normal; color:[[ColorPalette::PrimaryPale]];}\n\n.tabSelected{color:[[ColorPalette::PrimaryDark]];\n\tbackground:[[ColorPalette::TertiaryPale]];\n\tborder-left:1px solid [[ColorPalette::TertiaryLight]];\n\tborder-top:1px solid [[ColorPalette::TertiaryLight]];\n\tborder-right:1px solid [[ColorPalette::TertiaryLight]];\n}\n.tabUnselected {color:[[ColorPalette::Background]]; background:[[ColorPalette::TertiaryMid]];}\n.tabContents {color:[[ColorPalette::PrimaryDark]]; background:[[ColorPalette::TertiaryPale]]; border:1px solid [[ColorPalette::TertiaryLight]];}\n.tabContents .button {border:0;}\n\n#sidebar {}\n#sidebarOptions input {border:1px solid [[ColorPalette::PrimaryMid]];}\n#sidebarOptions .sliderPanel {background:[[ColorPalette::PrimaryPale]];}\n#sidebarOptions .sliderPanel a {border:none;color:[[ColorPalette::PrimaryMid]];}\n#sidebarOptions .sliderPanel a:hover {color:[[ColorPalette::Background]]; background:[[ColorPalette::PrimaryMid]];}\n#sidebarOptions .sliderPanel a:active {color:[[ColorPalette::PrimaryMid]]; background:[[ColorPalette::Background]];}\n\n.wizard {background:[[ColorPalette::PrimaryPale]]; border:1px solid [[ColorPalette::PrimaryMid]];}\n.wizard h1 {color:[[ColorPalette::PrimaryDark]]; border:none;}\n.wizard h2 {color:[[ColorPalette::Foreground]]; border:none;}\n.wizardStep {background:[[ColorPalette::Background]]; color:[[ColorPalette::Foreground]];\n\tborder:1px solid [[ColorPalette::PrimaryMid]];}\n.wizardStep.wizardStepDone {background::[[ColorPalette::TertiaryLight]];}\n.wizardFooter {background:[[ColorPalette::PrimaryPale]];}\n.wizardFooter .status {background:[[ColorPalette::PrimaryDark]]; color:[[ColorPalette::Background]];}\n.wizard .button {color:[[ColorPalette::Foreground]]; background:[[ColorPalette::SecondaryLight]]; border: 1px solid;\n\tborder-color:[[ColorPalette::SecondaryPale]] [[ColorPalette::SecondaryDark]] [[ColorPalette::SecondaryDark]] [[ColorPalette::SecondaryPale]];}\n.wizard .button:hover {color:[[ColorPalette::Foreground]]; background:[[ColorPalette::Background]];}\n.wizard .button:active {color:[[ColorPalette::Background]]; background:[[ColorPalette::Foreground]]; border: 1px solid;\n\tborder-color:[[ColorPalette::PrimaryDark]] [[ColorPalette::PrimaryPale]] [[ColorPalette::PrimaryPale]] [[ColorPalette::PrimaryDark]];}\n\n#messageArea {border:1px solid [[ColorPalette::SecondaryMid]]; background:[[ColorPalette::SecondaryLight]]; color:[[ColorPalette::Foreground]];}\n#messageArea .button {color:[[ColorPalette::PrimaryMid]]; background:[[ColorPalette::SecondaryPale]]; border:none;}\n\n.popupTiddler {background:[[ColorPalette::TertiaryPale]]; border:2px solid [[ColorPalette::TertiaryMid]];}\n\n.popup {background:[[ColorPalette::TertiaryPale]]; color:[[ColorPalette::TertiaryDark]]; border-left:1px solid [[ColorPalette::TertiaryMid]]; border-top:1px solid [[ColorPalette::TertiaryMid]]; border-right:2px solid [[ColorPalette::TertiaryDark]]; border-bottom:2px solid [[ColorPalette::TertiaryDark]];}\n.popup hr {color:[[ColorPalette::PrimaryDark]]; background:[[ColorPalette::PrimaryDark]]; border-bottom:1px;}\n.popup li.disabled {color:[[ColorPalette::TertiaryMid]];}\n.popup li a, .popup li a:visited {color:[[ColorPalette::Foreground]]; border: none;}\n.popup li a:hover {background:[[ColorPalette::SecondaryLight]]; color:[[ColorPalette::Foreground]]; border: none;}\n.popup li a:active {background:[[ColorPalette::SecondaryPale]]; color:[[ColorPalette::Foreground]]; border: none;}\n.popupHighlight {background:[[ColorPalette::Background]]; color:[[ColorPalette::Foreground]];}\n.listBreak div {border-bottom:1px solid [[ColorPalette::TertiaryDark]];}\n\n.tiddler .defaultCommand {font-weight:bold;}\n\n.shadow .title {color:[[ColorPalette::TertiaryDark]];}\n\n.title {color:[[ColorPalette::SecondaryDark]];}\n.subtitle {color:[[ColorPalette::TertiaryDark]];}\n\n.toolbar {color:[[ColorPalette::PrimaryMid]];}\n.toolbar a {color:[[ColorPalette::TertiaryLight]];}\n.selected .toolbar a {color:[[ColorPalette::TertiaryMid]];}\n.selected .toolbar a:hover {color:[[ColorPalette::Foreground]];}\n\n.tagging, .tagged {border:1px solid [[ColorPalette::TertiaryPale]]; background-color:[[ColorPalette::TertiaryPale]];}\n.selected .tagging, .selected .tagged {background-color:[[ColorPalette::TertiaryLight]]; border:1px solid [[ColorPalette::TertiaryMid]];}\n.tagging .listTitle, .tagged .listTitle {color:[[ColorPalette::PrimaryDark]];}\n.tagging .button, .tagged .button {border:none;}\n\n.footer {color:[[ColorPalette::TertiaryLight]];}\n.selected .footer {color:[[ColorPalette::TertiaryMid]];}\n\n.sparkline {background:[[ColorPalette::PrimaryPale]]; border:0;}\n.sparktick {background:[[ColorPalette::PrimaryDark]];}\n\n.error, .errorButton {color:[[ColorPalette::Foreground]]; background:[[ColorPalette::Error]];}\n.warning {color:[[ColorPalette::Foreground]]; background:[[ColorPalette::SecondaryPale]];}\n.lowlight {background:[[ColorPalette::TertiaryLight]];}\n\n.zoomer {background:none; color:[[ColorPalette::TertiaryMid]]; border:3px solid [[ColorPalette::TertiaryMid]];}\n\n.imageLink, #displayArea .imageLink {background:transparent;}\n\n.annotation {background:[[ColorPalette::SecondaryLight]]; color:[[ColorPalette::Foreground]]; border:2px solid [[ColorPalette::SecondaryMid]];}\n\n.viewer .listTitle {list-style-type:none; margin-left:-2em;}\n.viewer .button {border:1px solid [[ColorPalette::SecondaryMid]];}\n.viewer blockquote {border-left:3px solid [[ColorPalette::TertiaryDark]];}\n\n.viewer table, table.twtable {border:2px solid [[ColorPalette::TertiaryDark]];}\n.viewer th, .viewer thead td, .twtable th, .twtable thead td {background:[[ColorPalette::SecondaryMid]]; border:1px solid [[ColorPalette::TertiaryDark]]; color:[[ColorPalette::Background]];}\n.viewer td, .viewer tr, .twtable td, .twtable tr {border:1px solid [[ColorPalette::TertiaryDark]];}\n\n.viewer pre {border:1px solid [[ColorPalette::SecondaryLight]]; background:[[ColorPalette::SecondaryPale]];}\n.viewer code {color:[[ColorPalette::SecondaryDark]];}\n.viewer hr {border:0; border-top:dashed 1px [[ColorPalette::TertiaryDark]]; color:[[ColorPalette::TertiaryDark]];}\n\n.highlight, .marked {background:[[ColorPalette::SecondaryLight]];}\n\n.editor input {border:1px solid [[ColorPalette::PrimaryMid]];}\n.editor textarea {border:1px solid [[ColorPalette::PrimaryMid]]; width:100%;}\n.editorFooter {color:[[ColorPalette::TertiaryMid]];}\n\n#backstageArea {background:[[ColorPalette::Foreground]]; color:[[ColorPalette::TertiaryMid]];}\n#backstageArea a {background:[[ColorPalette::Foreground]]; color:[[ColorPalette::Background]]; border:none;}\n#backstageArea a:hover {background:[[ColorPalette::SecondaryLight]]; color:[[ColorPalette::Foreground]]; }\n#backstageArea a.backstageSelTab {background:[[ColorPalette::Background]]; color:[[ColorPalette::Foreground]];}\n#backstageButton a {background:none; color:[[ColorPalette::Background]]; border:none;}\n#backstageButton a:hover {background:[[ColorPalette::Foreground]]; color:[[ColorPalette::Background]]; border:none;}\n#backstagePanel {background:[[ColorPalette::Background]]; border-color: [[ColorPalette::Background]] [[ColorPalette::TertiaryDark]] [[ColorPalette::TertiaryDark]] [[ColorPalette::TertiaryDark]];}\n.backstagePanelFooter .button {border:none; color:[[ColorPalette::Background]];}\n.backstagePanelFooter .button:hover {color:[[ColorPalette::Foreground]];}\n#backstageCloak {background:[[ColorPalette::Foreground]]; opacity:0.6; filter:'alpha(opacity:60)';}\n/*}}}*/</pre>\n</div>\n<div title=\"StyleSheetLayout\">\n<pre>/*{{{*/\n* html .tiddler {height:1%;}\n\nbody {font-size:.75em; font-family:arial,helvetica; margin:0; padding:0;}\n\nh1,h2,h3,h4,h5,h6 {font-weight:bold; text-decoration:none;}\nh1,h2,h3 {padding-bottom:1px; margin-top:1.2em;margin-bottom:0.3em;}\nh4,h5,h6 {margin-top:1em;}\nh1 {font-size:1.35em;}\nh2 {font-size:1.25em;}\nh3 {font-size:1.1em;}\nh4 {font-size:1em;}\nh5 {font-size:.9em;}\n\nhr {height:1px;}\n\na {text-decoration:none;}\n\ndt {font-weight:bold;}\n\nol {list-style-type:decimal;}\nol ol {list-style-type:lower-alpha;}\nol ol ol {list-style-type:lower-roman;}\nol ol ol ol {list-style-type:decimal;}\nol ol ol ol ol {list-style-type:lower-alpha;}\nol ol ol ol ol ol {list-style-type:lower-roman;}\nol ol ol ol ol ol ol {list-style-type:decimal;}\n\n.txtOptionInput {width:11em;}\n\n#contentWrapper .chkOptionInput {border:0;}\n\n.externalLink {text-decoration:underline;}\n\n.indent {margin-left:3em;}\n.outdent {margin-left:3em; text-indent:-3em;}\ncode.escaped {white-space:nowrap;}\n\n.tiddlyLinkExisting {font-weight:bold;}\n.tiddlyLinkNonExisting {font-style:italic;}\n\n/* the 'a' is required for IE, otherwise it renders the whole tiddler in bold */\na.tiddlyLinkNonExisting.shadow {font-weight:bold;}\n\n#mainMenu .tiddlyLinkExisting,\n\t#mainMenu .tiddlyLinkNonExisting,\n\t#sidebarTabs .tiddlyLinkNonExisting {font-weight:normal; font-style:normal;}\n#sidebarTabs .tiddlyLinkExisting {font-weight:bold; font-style:normal;}\n\n.header {position:relative;}\n.header a:hover {background:transparent;}\n.headerShadow {position:relative; padding:4.5em 0em 1em 1em; left:-1px; top:-1px;}\n.headerForeground {position:absolute; padding:4.5em 0em 1em 1em; left:0px; top:0px;}\n\n.siteTitle {font-size:3em;}\n.siteSubtitle {font-size:1.2em;}\n\n#mainMenu {position:absolute; left:0; width:10em; text-align:right; line-height:1.6em; padding:1.5em 0.5em 0.5em 0.5em; font-size:1.1em;}\n\n#sidebar {position:absolute; right:3px; width:16em; font-size:.9em;}\n#sidebarOptions {padding-top:0.3em;}\n#sidebarOptions a {margin:0em 0.2em; padding:0.2em 0.3em; display:block;}\n#sidebarOptions input {margin:0.4em 0.5em;}\n#sidebarOptions .sliderPanel {margin-left:1em; padding:0.5em; font-size:.85em;}\n#sidebarOptions .sliderPanel a {font-weight:bold; display:inline; padding:0;}\n#sidebarOptions .sliderPanel input {margin:0 0 .3em 0;}\n#sidebarTabs .tabContents {width:15em; overflow:hidden;}\n\n.wizard {padding:0.1em 1em 0em 2em;}\n.wizard h1 {font-size:2em; font-weight:bold; background:none; padding:0em 0em 0em 0em; margin:0.4em 0em 0.2em 0em;}\n.wizard h2 {font-size:1.2em; font-weight:bold; background:none; padding:0em 0em 0em 0em; margin:0.4em 0em 0.2em 0em;}\n.wizardStep {padding:1em 1em 1em 1em;}\n.wizard .button {margin:0.5em 0em 0em 0em; font-size:1.2em;}\n.wizardFooter {padding:0.8em 0.4em 0.8em 0em;}\n.wizardFooter .status {padding:0em 0.4em 0em 0.4em; margin-left:1em;}\n.wizard .button {padding:0.1em 0.2em 0.1em 0.2em;}\n\n#messageArea {position:fixed; top:2em; right:0em; margin:0.5em; padding:0.5em; z-index:2000; _position:absolute;}\n.messageToolbar {display:block; text-align:right; padding:0.2em 0.2em 0.2em 0.2em;}\n#messageArea a {text-decoration:underline;}\n\n.tiddlerPopupButton {padding:0.2em 0.2em 0.2em 0.2em;}\n.popupTiddler {position: absolute; z-index:300; padding:1em 1em 1em 1em; margin:0;}\n\n.popup {position:absolute; z-index:300; font-size:.9em; padding:0; list-style:none; margin:0;}\n.popup .popupMessage {padding:0.4em;}\n.popup hr {display:block; height:1px; width:auto; padding:0; margin:0.2em 0em;}\n.popup li.disabled {padding:0.4em;}\n.popup li a {display:block; padding:0.4em; font-weight:normal; cursor:pointer;}\n.listBreak {font-size:1px; line-height:1px;}\n.listBreak div {margin:2px 0;}\n\n.tabset {padding:1em 0em 0em 0.5em;}\n.tab {margin:0em 0em 0em 0.25em; padding:2px;}\n.tabContents {padding:0.5em;}\n.tabContents ul, .tabContents ol {margin:0; padding:0;}\n.txtMainTab .tabContents li {list-style:none;}\n.tabContents li.listLink { margin-left:.75em;}\n\n#contentWrapper {display:block;}\n#splashScreen {display:none;}\n\n#displayArea {margin:1em 17em 0em 14em;}\n\n.toolbar {text-align:right; font-size:.9em;}\n\n.tiddler {padding:1em 1em 0em 1em;}\n\n.missing .viewer,.missing .title {font-style:italic;}\n\n.title {font-size:1.6em; font-weight:bold;}\n\n.missing .subtitle {display:none;}\n.subtitle {font-size:1.1em;}\n\n.tiddler .button {padding:0.2em 0.4em;}\n\n.tagging {margin:0.5em 0.5em 0.5em 0; float:left; display:none;}\n.isTag .tagging {display:block;}\n.tagged {margin:0.5em; float:right;}\n.tagging, .tagged {font-size:0.9em; padding:0.25em;}\n.tagging ul, .tagged ul {list-style:none; margin:0.25em; padding:0;}\n.tagClear {clear:both;}\n\n.footer {font-size:.9em;}\n.footer li {display:inline;}\n\n.annotation {padding:0.5em; margin:0.5em;}\n\n* html .viewer pre {width:99%; padding:0 0 1em 0;}\n.viewer {line-height:1.4em; padding-top:0.5em;}\n.viewer .button {margin:0em 0.25em; padding:0em 0.25em;}\n.viewer blockquote {line-height:1.5em; padding-left:0.8em;margin-left:2.5em;}\n.viewer ul, .viewer ol {margin-left:0.5em; padding-left:1.5em;}\n\n.viewer table, table.twtable {border-collapse:collapse; margin:0.8em 1.0em;}\n.viewer th, .viewer td, .viewer tr,.viewer caption,.twtable th, .twtable td, .twtable tr,.twtable caption {padding:3px;}\ntable.listView {font-size:0.85em; margin:0.8em 1.0em;}\ntable.listView th, table.listView td, table.listView tr {padding:0px 3px 0px 3px;}\n\n.viewer pre {padding:0.5em; margin-left:0.5em; font-size:1.2em; line-height:1.4em; overflow:auto;}\n.viewer code {font-size:1.2em; line-height:1.4em;}\n\n.editor {font-size:1.1em;}\n.editor input, .editor textarea {display:block; width:100%; font:inherit;}\n.editorFooter {padding:0.25em 0em; font-size:.9em;}\n.editorFooter .button {padding-top:0px; padding-bottom:0px;}\n\n.fieldsetFix {border:0; padding:0; margin:1px 0px 1px 0px;}\n\n.sparkline {line-height:1em;}\n.sparktick {outline:0;}\n\n.zoomer {font-size:1.1em; position:absolute; overflow:hidden;}\n.zoomer div {padding:1em;}\n\n* html #backstage {width:99%;}\n* html #backstageArea {width:99%;}\n#backstageArea {display:none; position:relative; overflow: hidden; z-index:150; padding:0.3em 0.5em 0.3em 0.5em;}\n#backstageToolbar {position:relative;}\n#backstageArea a {font-weight:bold; margin-left:0.5em; padding:0.3em 0.5em 0.3em 0.5em;}\n#backstageButton {display:none; position:absolute; z-index:175; top:0em; right:0em;}\n#backstageButton a {padding:0.1em 0.4em 0.1em 0.4em; margin:0.1em 0.1em 0.1em 0.1em;}\n#backstage {position:relative; width:100%; z-index:50;}\n#backstagePanel {display:none; z-index:100; position:absolute; margin:0em 3em 0em 3em; padding:1em 1em 1em 1em;}\n.backstagePanelFooter {padding-top:0.2em; float:right;}\n.backstagePanelFooter a {padding:0.2em 0.4em 0.2em 0.4em;}\n#backstageCloak {display:none; z-index:20; position:absolute; width:100%; height:100px;}\n\n.whenBackstage {display:none;}\n.backstageVisible .whenBackstage {display:block;}\n/*}}}*/</pre>\n</div>\n<div title=\"StyleSheetLocale\">\n<pre>/***\nStyleSheet for use when a translation requires any css style changes.\nThis StyleSheet can be used directly by languages such as Chinese, Japanese and Korean which use a logographic writing system and need larger font sizes.\n***/\n\n/*{{{*/\nbody {font-size:0.8em;}\n\n#sidebarOptions {font-size:1.05em;}\n#sidebarOptions a {font-style:normal;}\n#sidebarOptions .sliderPanel {font-size:0.95em;}\n\n.subtitle {font-size:0.8em;}\n\n.viewer table.listView {font-size:0.95em;}\n\n.htmlarea .toolbarHA table {border:1px solid ButtonFace; margin:0em 0em;}\n/*}}}*/</pre>\n</div>\n<div title=\"StyleSheetPrint\">\n<pre>/*{{{*/\n@media print {\n#mainMenu, #sidebar, #messageArea, .toolbar, #backstageButton {display: none ! important;}\n#displayArea {margin: 1em 1em 0em 1em;}\n/* Fixes a feature in Firefox 1.5.0.2 where print preview displays the noscript content */\nnoscript {display:none;}\n}\n/*}}}*/</pre>\n</div>\n<div title=\"PageTemplate\">\n<pre>&lt;!--{{{--&gt;\n&lt;div class='header' macro='gradient vert [[ColorPalette::PrimaryLight]] [[ColorPalette::PrimaryMid]]'&gt;\n&lt;div class='headerShadow'&gt;\n&lt;span class='siteTitle' refresh='content' tiddler='SiteTitle'&gt;&lt;/span&gt;&amp;nbsp;\n&lt;span class='siteSubtitle' refresh='content' tiddler='SiteSubtitle'&gt;&lt;/span&gt;\n&lt;/div&gt;\n&lt;div class='headerForeground'&gt;\n&lt;span class='siteTitle' refresh='content' tiddler='SiteTitle'&gt;&lt;/span&gt;&amp;nbsp;\n&lt;span class='siteSubtitle' refresh='content' tiddler='SiteSubtitle'&gt;&lt;/span&gt;\n&lt;/div&gt;\n&lt;/div&gt;\n&lt;div id='mainMenu' refresh='content' tiddler='MainMenu'&gt;&lt;/div&gt;\n&lt;div id='sidebar'&gt;\n&lt;div id='sidebarOptions' refresh='content' tiddler='SideBarOptions'&gt;&lt;/div&gt;\n&lt;div id='sidebarTabs' refresh='content' force='true' tiddler='SideBarTabs'&gt;&lt;/div&gt;\n&lt;/div&gt;\n&lt;div id='displayArea'&gt;\n&lt;div id='messageArea'&gt;&lt;/div&gt;\n&lt;div id='tiddlerDisplay'&gt;&lt;/div&gt;\n&lt;/div&gt;\n&lt;!--}}}--&gt;</pre>\n</div>\n<div title=\"ViewTemplate\">\n<pre>&lt;!--{{{--&gt;\n&lt;div class='toolbar' macro='toolbar closeTiddler closeOthers +editTiddler &gt; fields syncing permalink references jump'&gt;&lt;/div&gt;\n&lt;div class='title' macro='view title'&gt;&lt;/div&gt;\n&lt;div class='tagging' macro='tagging'&gt;&lt;/div&gt;\n&lt;div class='tagged' macro='tags'&gt;&lt;/div&gt;\n&lt;div class='viewer' macro='view text wikified'&gt;&lt;/div&gt;\n&lt;div class='tagClear'&gt;&lt;/div&gt;\n&lt;!--}}}--&gt;</pre>\n</div>\n<div title=\"EditTemplate\">\n<pre>&lt;!--{{{--&gt;\n&lt;div class='toolbar' macro='toolbar +saveTiddler -cancelTiddler deleteTiddler'&gt;&lt;/div&gt;\n&lt;div class='title' macro='view title'&gt;&lt;/div&gt;\n&lt;div class='editor' macro='edit title'&gt;&lt;/div&gt;\n&lt;div macro='annotations'&gt;&lt;/div&gt;\n&lt;div class='editor' macro='edit text'&gt;&lt;/div&gt;\n&lt;div class='editor' macro='edit tags'&gt;&lt;/div&gt;&lt;div class='editorFooter'&gt;&lt;span macro='message views.editor.tagPrompt'&gt;&lt;/span&gt;&lt;span macro='tagChooser'&gt;&lt;/span&gt;&lt;/div&gt;\n&lt;!--}}}--&gt;</pre>\n</div>\n<div title=\"GettingStarted\">\n<pre>To get started with this blank TiddlyWiki, you'll need to modify the following tiddlers:\n* SiteTitle &amp; SiteSubtitle: The title and subtitle of the site, as shown above (after saving, they will also appear in the browser title bar)\n* MainMenu: The menu (usually on the left)\n* DefaultTiddlers: Contains the names of the tiddlers that you want to appear when the TiddlyWiki is opened\nYou'll also need to enter your username for signing your edits: &lt;&lt;option txtUserName&gt;&gt;</pre>\n</div>\n<div title=\"OptionsPanel\">\n<pre>These InterfaceOptions for customising TiddlyWiki are saved in your browser\n\nYour username for signing your edits. Write it as a WikiWord (eg JoeBloggs)\n\n&lt;&lt;option txtUserName&gt;&gt;\n&lt;&lt;option chkSaveBackups&gt;&gt; SaveBackups\n&lt;&lt;option chkAutoSave&gt;&gt; AutoSave\n&lt;&lt;option chkRegExpSearch&gt;&gt; RegExpSearch\n&lt;&lt;option chkCaseSensitiveSearch&gt;&gt; CaseSensitiveSearch\n&lt;&lt;option chkAnimate&gt;&gt; EnableAnimations\n\n----\nAlso see AdvancedOptions</pre>\n</div>\n</div>\n<!--POST-SHADOWAREA-->\n<div id=\"storeArea\">\n<div title=\"BEDA\" modifier=\"Rishab\" modified=\"201006092158\" created=\"200708231142\" changecount=\"8\">\n<pre>Secure initial pairing of electronic gadgets is a challenging problem, especially considering lack of any common security infrastructure. The main security issue is the threat of so-called ~Man-in-the-Middle (~MiTM) attacks, whereby an attacker inserts itself into the pairing protocol by impersonating one of the legitimate parties. A number of interesting techniques have been proposed, all of which involve the user in the pairing process. However, they are inapplicable to many common scenarios where devices to-be-paired do not possess required interfaces, such as displays, speakers, cameras or microphones. \n\nIn this project, we introduce BEDA (~Button-Enabled Device Association), a protocol suite for secure pairing devices with minimal user interfaces. The most common and minimal interface available on wide variety of devices is a single button. BEDA protocols can accommodate pairing scenarios where one (or even both) devices only have a single button as their user interface&quot;. Our usability study demonstrates that BEDA protocols involve very little human burden and are quite suitable for ordinary users.\n!!!Related Publications\n\n*Claudio Soriente, Gene Tsudik, Ersin Uzun. \u201c[[BEDA: Button Enabled Device Pairing|http://www.ersinuzun.com/pub/BEDA.pdf]]\u201d, International Workshop on Security for Spontaneous Interaction (IWSSI 2007) and UBICOMP 2007 workshop proceedings.\n*Claudio Soriente, Gene Tsudik, Ersin Uzun, \u201c[[Secure Pairing of Interface constrained Devices|http://www.ersinuzun.com/pub/IJSN-Soriente.pdf]]\u201d, in International Journal on Security and Networks, Vol.4 No.1, 2009.</pre>\n</div>\n<div title=\"DefaultTiddlers\" modifier=\"Ersin\" modified=\"200708210949\" created=\"200708210819\" changecount=\"7\">\n<pre>Introduction\nProjects\nPeople\n</pre>\n</div>\n<div title=\"Framework For Comparative Usability Testing of Distributed Applications\" modifier=\"Rishab\" modified=\"201006092148\" created=\"200708231151\" changecount=\"3\">\n<pre>Comparative usability tests are useful when the optimal user interface needs to be selected from several alternatives. However, performing comparative\nusability tests is laborious, especially for distributed applications. In this extended abstract we present a usability test framework for one distributed application type: pairing methods. Using this framework developing new user interfaces for pairing methods and testing them for usability is easy and fast. Our framework also supports automated test sessions, event logging and error condition simulation.\n\n!!!Related Publications\n\n*Kari Kostiainen, Ersin Uzun, N. Asokan, Philip Ginzboorg, &quot;[[Framework For Comparative Usability Testing of Distributed Applications|http://www.ersinuzun.com/pub/NRC-TR-2007-005.pdf]]&quot;, Technical Report, Nokia Research Center 2007. [[Extended abstract|http://sconce.ics.uci.edu/CUF/ex_abs.pdf]] appeared in Security User Studies: Methodologies and Best Practices Workshop in CHI'07. </pre>\n</div>\n<div title=\"HAPADEP\" modifier=\"Rishab\" modified=\"201006092158\" created=\"200708231115\" changecount=\"12\">\n<pre>The number and diversity of electronic gadgets has been steadily increasing and they are becoming indispensable to more and more professionals and non-professionals alike. At the same time, there has been fairly little progress in secure pairing of such devices. The pairing challenge revolves\naround establishing on-the-fly secure communication without any trusted (on- or off-line) third parties between devices that have no prior association. The main security issue is the danger of so-called ~Man-in-the-Middle (~MiTM) attacks, whereby an adversary impersonates one of the devices by inserting itself into the pairing protocol. One basic approach to countering these ~MiTM attacks is to involve the user in the pairing process. Therein lies the usability challenge since it is natural to minimize user burden. Previous research yielded some interesting secure pairing techniques, some of which ask too much of the human user, while others assume availability of specialized equipment (e.g., wires, photo or video cameras) on  devices. Furthermore, all prior methods assumed the existence of a common digital (human-imperceptible) communication medium, such as infrared, 802.11 or Bluetooth. \n\nIn this project we introduce a very simple technique called HAPADEP (~Human-Assisted Pure Audio Device Pairing). It places very little burden on the human user and requires no common means of electronic communication. Instead, HAPADEP uses the audio channel to exchange both data\nand verification information among devices. It makes secure pairing possible even if devices are equipped only with a microphone and a speaker. Despite its simplicity, HAPADEP offers better user experience by eliminating the need to set-up a wireless communication (such as bluetooth or ~Wi-Fi) first and provides end-users easy to verify security controls.\n!!!Related Publications\n\n*Claudio Soriente, Gene Tsudik, Ersin Uzun. \u201c[[HAPADEP: Human-Assisted Pure Audio (Secure) Device Pairing|http://portal.acm.org/citation.cfm?id=1432478.1432514&amp;coll=ACM&amp;dl=ACM]]\u201d, in proceedings of the 11th international conference on Information Security (ISC\u201908).\n*M.T. Goodrich, M. Sirivianos, J. Solis, C. Soriente, G. Tsudik, E. Uzun, \u201c[[Using Audio in Secure Device Pairing|http://www.ersinuzun.com/pub/IJSN-Goodrich.pdf]]\u201d, in International Journal on Security and Networks, Vol.4 No.1, 2009.\n</pre>\n</div>\n<div title=\"Introduction\" modifier=\"Rishab\" modified=\"201006160223\" created=\"200708210937\" changecount=\"32\">\n<pre>The SPROUT Usable Security Project began in Spring 2006 to increase the usability in security software. The security research community has become increasingly aware that the better usability is a key element to achieve better security. Thanks to recent advances in cryptography research, the tools and protocols available today are the least concern for security. What really determines the security of a software system today is the correct implementation and usage of those cryptographic tools and compliance of the end-user to the expected behavior. \n\nSecurity software often depends on the end-user for critical tasks and decisions to function properly. However, usability problems in such software may result in severe vulnerabilities. As identified by the Computing Research Association in 2003; &quot;Giving end-users security controls they can understand and privacy they can control for the dynamic, pervasive computing environments of the future.&quot; is one of the four grand challenges in computer science and we, as SPROUT Usable Security Group, address this grand challenge in different application domains. Our mission is analyzing current solutions in different application domains for usability problems and inventing better solutions or developing new cryptographic tools and/or user interfaces that would improve the usability and security of them.\n\n!!!This research is supported by:\n*NSF Grant &quot;~CNS-1544373: The Effect of Sensory Stimuli on the Performance of ~Security-Critical Tasks&quot;.\n*NSF Grant, &quot;~CT-ISG-0831526: ~User-Aided Secure Association of Wireless Devices&quot;.\n*Google Research Award, &quot;Secure and Usable Group Association of Personal Wireless Devices&quot;.\nWe would like to also thank Nokia and NXP Semiconductors for providing us the various devices used in our user studies.</pre>\n</div>\n<div title=\"Loud and Clear\" modifier=\"Rishab\" modified=\"201006092158\" created=\"200708231113\" changecount=\"14\">\n<pre>Secure pairing of electronic devices that lack any previous association is a challenging problem which has been considered in many contexts and in various flavors. In this project, we investigate the use of the audio channel for ~human-assisted authentication of previously ~un-associated devices. We develop and evaluate a system we call ~Loud-and-Clear (L&amp;C) which places very little demand on the human user. L&amp;C involves the use of a text-to-speech (TTS) engine to for vocalizing a robust-sounding and syntactically-correct (English-like) sentence derived from the hash of a device\u2019s public key. By coupling vocalization on one device with the display of the same information on another device, we demonstrate that L&amp;C is suitable for secure device pairing (e.g., key exchange) and similar tasks. We also describe several common use cases, provide some performance data for our prototype implementation and discuss the security properties of L&amp;C.\n!!!Related Publications\n\n*Michael T. Goodrich, Michael Sirivianos, John Solis, Gene Tsudik, and Ersin Uzun, &quot;[[Loud And Clear Human-Verifiable Authentication Based on Audio|http://www.ersinuzun.com/pub/icdcs.pdf]]&quot;, Proceedings of IEEE ICDCS'06.\n*M.T. Goodrich, M. Sirivianos, J. Solis, C. Soriente, G. Tsudik, E. Uzun, \u201c[[Using Audio in Secure Device Pairing|http://www.ersinuzun.com/pub/IJSN-Goodrich.pdf]]\u201d, in International Journal on Security and Networks, Vol.4 No.1, 2009.</pre>\n</div>\n<div title=\"MainMenu\" modifier=\"Ersin\" modified=\"200708210942\" created=\"200708210817\" changecount=\"2\">\n<pre>[[Introduction]]\n[[Projects]]\n[[Publications]]\n[[People]]\n\n</pre>\n</div>\n<div title=\"News\" modifier=\"Rishab\" modified=\"201002180852\" created=\"200708211102\" changecount=\"23\">\n<pre>!News\n!!!!Magazine Article Published\n!!!December 2017\n&quot;An Exploration of the Effects of Sensory Stimuli on the Completion of Security Tasks&quot; authored by Bruce Berg, Tyler Kaczmarek, Alfred Kobsa and Gene Tsudik is accepted to appear in November/December Issue of IEEE Security & Privacy\n!!!!Conference Paper Accepted\n!!!April 2017\n&quot;Lights, Camera, Action! Exploring Effects of Visual Distractions on Completion of Security Tasks&quot; authored by Bruce Berg, Tyler Kaczmarek, Alfred Kobsa and Gene Tsudik is accepted to appear in The 15th International Conference on Applied Cryptography and Network Security (ACNS 2017) \n!!!!Workshop Paper Accepted\n!!!January 2015\n&quot;An Unattended Study of Users Performing Security Critical Tasks Under Adversarial Noise&quot; authored by Tyler Kaczmarek, Alfred Kobsa, Robert Sy, and Gene Tsudik is accepted to appear in the NDSS Workshop on Usable Security, 2015 (USEC 2015)\n!!!June 2010 \n!!!!Conference Paper Accepted\n&quot;Readers Behaving Badly: Reader Revocation in PKI Based RFID Systems&quot; authored by Rishab Nithyanand, Gene Tsudik, and Ersin Uzun, is accepted to appear at the 15th European Symposium on Research in Computer Security (ESORICS 2010).\n!!!May 2010 \n!!!!Conference Paper Accepted\n&quot;~GroupThink: On the Usability of Secure Group Association of Wireless Devices&quot; authored by Rishab Nithyanand, Nitesh Saxena, Gene Tsudik, and Ersin Uzun is accepted to appear at the 12th ACM International Conference on Ubiquitous Computing (~UbiComp 2010).\n\n!!!!Poster Accepted\nA poster &quot;Check the Date: Reader Revocation in PKI Based RFID Systems&quot; will be presented at the 31st IEEE Symposium of Security and Privacy.\n\n!!!December 2009\n!!!!Google Research Award\nGene Tsudik and Ersin Uzun have been awarded a Google Research Award for $50,000 for a research effort entitled &quot;Secure and Usable Group Association of Personal Wireless Devices.&quot;\n\n!!!August 2009 \n!!!!Journal Paper Accepted\n&quot;A Comparative Study of Secure Device Pairing Methods&quot; authored by Arun Kumar, Nitesh Saxena, Gene Tsudik, and Ersin Uzun is accepted to appear in Pervasive and Mobile Computing Journal (PMC).\n\n!!!!Conference Paper Accepted\n&quot;On the Usability of Secure Association of Wireless Devices Based On Distance Bounding&quot; authored by Mario Cagalj, Nitesh Saxena, and Ersin Uzun, is accepted to appear in The 8th International Conference on Cryptology And Network Security (CANS'09).\n\n!!!NSF Cybertrust Award\nGene Tsudik and Alfred Kobsa, in conjunction with Nitesh Saxena (Assistant Professor of Computer Science at NYU/Polytechnic and a SCONCE alumnus), have been awarded a $460,000 grant from the NSF Cybertrust program for a collaborative project titled: &quot;~User-Aided Secure Association of Wireless Devices&quot;.\nThe grant will be used to research and design: (1) pairing methods suitable for common devices and the general user population, (2) secure pairing techniques for personal RFID tags, and (3) user-friendly, scalable and secure methods for sensor initialization. \n</pre>\n</div>\n<div title=\"Options\" modifier=\"Ersin\" created=\"200902032249\" changecount=\"1\">\n<pre>SideBarOptions\nOptionsPanel\nAdvancedOptions\nSideBarTabs\n[[News]]</pre>\n</div>\n<div title=\"PageTemplate\" modifier=\"Ersin\" created=\"200708211105\" changecount=\"3\">\n<pre>&lt;!--{{{--&gt;\n&lt;div class='header' macro='gradient vert [[ColorPalette::PrimaryLight]] [[ColorPalette::PrimaryMid]]'&gt;\n&lt;div class='headerShadow'&gt;\n&lt;span class='siteTitle' refresh='content' tiddler='SiteTitle'&gt;&lt;/span&gt;&amp;nbsp;\n&lt;span class='siteSubtitle' refresh='content' tiddler='SiteSubtitle'&gt;&lt;/span&gt;\n&lt;/div&gt;\n&lt;div class='headerForeground'&gt;\n&lt;span class='siteTitle' refresh='content' tiddler='SiteTitle'&gt;&lt;/span&gt;&amp;nbsp;\n&lt;span class='siteSubtitle' refresh='content' tiddler='SiteSubtitle'&gt;&lt;/span&gt;\n&lt;/div&gt;\n&lt;/div&gt;\n&lt;div id='mainMenu' refresh='content' tiddler='MainMenu'&gt;&lt;/div&gt;\n&lt;div id='sidebar'&gt;\n&lt;div id='sidebarOptions' refresh='content' tiddler='News'&gt;&lt;/div&gt;\n&lt;div id='sidebarTabs' refresh='content' force='true' tiddler=''&gt;&lt;/div&gt;\n&lt;/div&gt;\n&lt;div id='displayArea'&gt;\n&lt;div id='messageArea'&gt;&lt;/div&gt;\n&lt;div id='tiddlerDisplay'&gt;&lt;/div&gt;\n&lt;/div&gt;\n&lt;!--}}}--&gt;</pre>\n</div>\n<div title=\"People\" modifier=\"Rishab\" modified=\"201006160216\" created=\"200708231126\" changecount=\"15\">\n<pre>!!Current Members\n[[Tyler Kaczmarek | http://sprout.ics.uci.edu/people/tkaczmar/index.html]]\n[[Gene Tsudik|http://www.ics.uci.edu/~gts/]] \n[[Alfred Kobsa|http://www.ics.uci.edu/~kobsa/]]\n[[Bruce Berg|http://www.faculty.uci.edu/profile.cfm?faculty_id=2558]]\n!!Alumni\n[[Nitesh Saxena|http://saxena.cis.uab.edu/]]\n[[Ersin Uzun|http://www.ersinuzun.com]] \n[[Rishab Nithyanand|http://www.ics.uci.edu/~rishabn]]\n[[Yang Wang|http://www.ics.uci.edu/~yangwang/]]</pre>\n</div>\n<div title=\"Projects\" modifier=\"Rishab\" modified=\"201006160220\" created=\"200708210942\" changecount=\"27\">\n<pre>!!Current Project\n* [[Effect of Adversarial Noise on Completion of Security Critical Tasks]]\n!!Past Projects\n* [[Usability Analysis of Device Pairing Methods]]\n* [[Securing Personal RFID Tags and Infrastructures]]\n* [[Framework For Comparative Usability Testing of Distributed Applications]]\n* [[Loud and Clear]]\n* [[HAPADEP]]\n* [[BEDA]]\n</pre>\n</div>\n<div title=\"Publications\" modifier=\"Rishab\" modified=\"201006101137\" created=\"200708231157\" changecount=\"36\">\n<pre>Related publications are also listed under each project.\n!!!2017\n*Bruce Berg, Tyler Kaczmarek, Alfred Kobsa, Gene Tsudik, &quot;[[An Exploration of the Effects of Sensory Stimuli on the Completion of Security Tasks|http://ieeexplore.ieee.org/document/8123485/?part=1]]&quot; in IEEE Security 7 Privacy Magazine, volume 15, issue 6\n*Bruce Berg, Tyler Kaczmarek, Alfred Kobsa, Gene Tsudik, &quot;[[Lights, Camera, Action! Exploring Effects of Visual Distractions on Completion of Security Tasks|http://sprout.ics.uci.edu/pubs/Vision-Sec.pdf]]&quot; in proceedings of The 15th International Conference on Applied Cryptography and Network Security (ACNS 2017) \n!!!2015\n*Tyler Kaczmarek, Alfred Kobsa, Gene Tsudik, &quot;[[An Unattended Study of Users Performing Security Critical Tasks Under Adversarial Noise|http://www.ics.uci.edu/~gts/paps/noise-USEC15.pdf]]&quot; in proceedings of the NDSS Workshop on Usable Security, 2015 (USEC 2015)\n!!!2010\n*Rishab Nithyanand, Gene Tsudik, Ersin Uzun, &quot;[[Readers Behaving Badly: Reader Revocation in PKI-Based RFID Systems|http://eprint.iacr.org/2009/465.pdf]]&quot;, in proceedings of the 15th European Symposium on Research in Computer Security (ESORICS 2010), Sept 2010. \n*Rishab Nithyanand, Nitesh Saxena, Gene Tsudik, Ersin Uzun. &quot;[[ GroupThink: On the Usability of Secure Group Association of Wireless Devices&quot;|http://www.ics.uci.edu/~euzun/pub/group.pdf]]&quot;, in proceedings of the 12th ACM International Conference on Ubiquitous Computing (~UbiComp 2010), Sept 2010.\n*Rishab Nithyanand, Gene Tsudik, Ersin Uzun, &quot;[[Check The Date: Reader Revocation in PKI-Based RFID Systems|http://www.ics.uci.edu/~euzun/pub/SP_poster_abs.pdf]]&quot;, poster at the 31st IEEE Symposium on Security and Privacy, May 2010. \n!!!2009\n*Arun Kumar, Nitesh Saxena, Gene Tsudik, Ersin Uzun. &quot;[[A Comparative Study of Secure Device Pairing Methods|http://www.ersinuzun.com/pub/pmc.pdf]]&quot;, Pervasive and Mobile Computing Journal (PMC), Dec. 2009.\n*Alfred Kobsa, Rahim Sonawalla, Gene Tsudik, Ersin Uzun, Yang Wang. \u201c[[Serial Hook-Ups: A Comparative Usability Study of Secure Device Pairing Methods|http://www.ersinuzun.com/pub/soups09.pdf]]\u201d,  in proceedings of the 5th Symposium on Usable Privacy and Security (SOUPS\u201909)\n*Arun Kumar, Nitesh Saxena, Gene Tsudik, Ersin Uzun. \u201c[[Caveat Emptor: A Comparative Study of Secure Device Pairing Methods|http://www.ersinuzun.com/pub/caveat.pdf]]\u201d, in the proceedings of the 7th Annual IEEE International Conference on Pervasive Computing and Communications (IEEE ~PerCom\u201909).\n*Mario Cagalj, Nitesh Saxena, Ersin Uzun. &quot;On the Usability of Secure Association of Wireless Devices Based On Distance Bounding&quot;, in the proceedings of the 8th International Conference on Cryptology And Network Security (CANS'09).\n*M.T. Goodrich, M. Sirivianos, J. Solis, C. Soriente, G. Tsudik, E. Uzun, \u201c[[Using Audio in Secure Device Pairing|http://www.ersinuzun.com/pub/IJSN-Goodrich.pdf]]\u201d, in International Journal on Security and Networks, Vol.4 No.1, 2009.\n*Claudio Soriente, Gene Tsudik, Ersin Uzun, \u201c[[Secure Pairing of Interface constrained Devices|http://www.ersinuzun.com/pub/IJSN-Soriente.pdf]]\u201d, in International Journal on Security and Networks, Vol.4 No.1, 2009.\n!!!2008\n*Claudio Soriente, Gene Tsudik, Ersin Uzun. \u201c[[HAPADEP: Human-Assisted Pure Audio (Secure) Device Pairing|http://portal.acm.org/citation.cfm?id=1432478.1432514&amp;coll=ACM&amp;dl=ACM]]\u201d, in proceedings of the 11th international conference on Information Security (ISC\u201908).\n!!!2007\n*Claudio Soriente, Gene Tsudik, Ersin Uzun. \u201c[[BEDA: Button Enabled Device Pairing|http://www.ersinuzun.com/pub/BEDA.pdf]]\u201d, in the proceedings of the International Workshop on Security for Spontaneous Interaction (IWSSI 2007) and UBICOMP 2007 workshops.\n*Ersin Uzun, Kristiina Karvonen, N. Asokan, &quot;[[Usability Analysis of Secure Pairing Methods|http://www.ersinuzun.com/pub/EU-USEC07.pdf]]&quot;, in USEC'07. ([[Technical Report|http://www.ics.uci.edu/~euzun/pub/NRC-TR-2007-002.pdf]], Nokia Research 2007) ([[Presentation Slides|http://www.ersinuzun.com/presentations/Usability-of-pairing.pdf]])\n*Kari Kostiainen, Ersin Uzun, N. Asokan, Philip Ginzboorg, &quot;[[Framework For Comparative Usability Testing of Distributed Applications|http://www.ersinuzun.com/pub/NRC-TR-2007-005.pdf]]&quot;, Technical Report, Nokia Research Center 2007. [[Extended abstract|http://sconce.ics.uci.edu/CUF/ex_abs.pdf]] appeared in Security User Studies: Methodologies and Best Practices Workshop in CHI'07. \n!!!2006\n*Michael T. Goodrich, Michael Sirivianos, John Solis, Gene Tsudik, and Ersin Uzun, &quot;[[Loud And Clear Human-Verifiable Authentication Based on Audio|http://www.ersinuzun.com/pub/icdcs.pdf]]&quot;, in the proceedings of IEEE ICDCS 2006.\n</pre>\n</div>\n<div title=\"Securing Personal RFID Tags and Infrastructures\" modifier=\"Rishab\" modified=\"201006101135\" created=\"201002180416\" changecount=\"10\">\n<pre>The recent emergence of RFID tags that are capable of performing high level cryptographic operations (including public key operations) motivates new RFID applications, including electronic travel documents, identification cards, and payment instruments. This has introduced a new class of RFID tags which store sensitive owner specific data (e.g., biometrics) -- i.e., personal RFID tags. \n\nThe primary task of these tags is to identify and authenticate their authorized holders to authorized RFID readers . In such settings, we observe an important feature that distinguishes these tags from the more traditional RFID tags used in supply chain and inventory management is the involvement of a human user and the sensitive nature of data contained in the tags. \n\nWe take advantage of the user's awareness and presence to construct simple, efficient, secure, feasible, and (most importantly) usable solutions for important, yet largely ignored problems in such RFID systems. These include RFID reader revocation status checking in RFID public key infrastructures, secure user-to-tag authentication, and transaction verification in RFID enabled payment instruments.\n\nWe also evaluate the usability and practical security of each of our solutions via usability studies which include online surveys and actual tests using prototypes. Our approach to solving the above mentioned problems takes advantage of new low-power technologies such as OLED, ePaper, and other more recent advances in hardware integration on RFID tags. We use these technologies to improve security by applying them to establish secure I/O channels for communication between the tag owner, the personal tag, and the reader.\n\n!!!Related Publications\n*Rishab Nithyanand, Gene Tsudik, Ersin Uzun, &quot;[[Readers Behaving Badly: Reader Revocation in PKI-Based RFID Systems|http://eprint.iacr.org/2009/465.pdf]]&quot;, in proceedings of the 15th European Symposium on Research in Computer Security (ESORICS 2010), Sept 2010. \n*Rishab Nithyanand, Gene Tsudik, Ersin Uzun, &quot;[[Check The Date: Reader Revocation in PKI-Based RFID Systems|http://www.ersinuzun.com/pub/SP_poster_abs.pdf]]&quot;, poster at the 31st IEEE Symposium on Security and Privacy, May 2010. </pre>\n</div>\n<div title=\"SiteSubtitle\" modifier=\"Ersin\" created=\"200708210813\" changecount=\"1\">\n<pre>improving usability for better security</pre>\n</div>\n<div title=\"SiteTitle\" modifier=\"Ersin\" created=\"200708210747\" changecount=\"2\">\n<pre>SPROUT Usable Security Group</pre>\n</div>\n<div title=\"SiteUrl\" modifier=\"Rishab\" modified=\"200902032148\" created=\"200708211050\" changecount=\"3\">\n<pre>http://sprout.ics.uci.edu/projects/usec/usec.html</pre>\n</div>\n<div title=\"Effect of Adversarial Noise on Completion of Security Critical Tasks\" modifier=\"Tyler\" modified=\"201507101228\" changecount=\"1\">\n<pre>\tUser errors while performing security-critical tasks can lead to undesirable or even disastrous consequences. One major factor influencing mistakes and failures is complexity of such tasks, which has been studied extensively in prior research. Another important issue which hardly received any attention is the impact of both  accidental and intended distractions on users performing security-critical tasks.  In particular, it is unclear whether, and to what extent, unexpected sensory cues  (e.g., auditory or visual) can influence user behavior and/or trigger mistakes. Better understanding of the effects of intended distractions will help clarify their role in adversarial models. In this project, we seek to define the impacts that the inclusion of adversarial noise has on user performance in the completion of these security critical tasks. \n!!!Related Publications\n*Bruce Berg, Tyler Kaczmarek, Alfred Kobsa, Gene Tsudik, &quot;[[An Exploration of the Effects of Sensory Stimuli on the Completion of Security Tasks|http://ieeexplore.ieee.org/document/8123485/?part=1]]&quot; in IEEE Security 7 Privacy Magazine, volume 15, issue 6\n*Bruce Berg, Tyler Kaczmarek, Alfred Kobsa and Gene Tsudik. &quot;[[Lights, Camera, Action! Exploring Effects of Visual Distractions on Completion of Security Tasks&quot;|http://sprout.ics.uci.edu/pubs/Vision-Sec.pdf]]&quot;, in proceedings of The 15th International Conference on Applied Cryptography and Network Security, July 2017.\n*Tyler Kaczmarek, Alfed Kobsa, Robert Sy, Gene Tsudik. &quot;[[An Unattended Study of Users Performing Security Critical Tasks Under Adversarial Noise&quot;|http://www.ics.uci.edu/~kobsa/papers/2015-NDSS-USEC-Kobsa.pdf]]&quot;, in proceedings of NDSS Workshop on Usable Security 2015 (USEC 2015), Feb 2015.\n</pre>\n</div>\n<div title=\"Usability Analysis of Device Pairing Methods\" modifier=\"Rishab\" modified=\"201006101136\" created=\"200708231145\" changecount=\"10\">\n<pre>Setting up security associations between end-user devices is a challenging task when it needs to be done by ordinary users. The increasing popularity of powerful personal electronics with wireless communication abilities has made the problem more urgent than ever before. During the last few years, several solutions have appeared in the research literature. Several standardization bodies have also been working on improved setup procedures. All these protocols provide certain level of security, but several new questions arise, such as \u201chow to implement this protocol so that it is easy to use?\u201d and \u201cis it still secure when used by a non-technical person?\u201d In this project, we attempt to answer these questions by carrying out a comparative usability evaluation of selected methods to derive some insights into the usability and security of these methods as well as strategies for implementing them.\n!!!Related Publications\n*Rishab Nithyanand, Nitesh Saxena, Gene Tsudik, Ersin Uzun. &quot;[[ GroupThink: On the Usability of Secure Group Association of Wireless Devices&quot;|http://www.ics.uci.edu/~euzun/pub/group.pdf]]&quot;, in proceedings of the 12th ACM International Conference on Ubiquitous Computing (~UbiComp 2010), Sept 2010.\n*Arun Kumar, Nitesh Saxena, Gene Tsudik, Ersin Uzun. &quot;[[A Comparative Study of Secure Device Pairing Methods|http://www.ersinuzun.com/pub/pmc.pdf]]&quot;, Pervasive and Mobile Computing Journal (PMC), Dec. 2009.\n*Alfred Kobsa, Rahim Sonawalla, Gene Tsudik, Ersin Uzun, Yang Wang. \u201c[[Serial Hook-Ups: A Comparative Usability Study of Secure Device Pairing Methods|http://www.ersinuzun.com/pub/soups09.pdf]]\u201d, in proceedings of The Fifth Symposium on Usable Privacy and Security (SOUPS\u201909).\n*Arun Kumar, Nitesh Saxena, Gene Tsudik, Ersin Uzun. \u201c[[Caveat Emptor: A Comparative Study of Secure Device Pairing Methods|http://www.ersinuzun.com/pub/caveat.pdf]]\u201d, in proceedings of the 7th Annual IEEE International Conference on Pervasive Computing and Communications (IEEE ~PerCom\u201909).\n*Mario Cagalj, Nitesh Saxena, Ersin Uzun. &quot;On the Usability of Secure Association of Wireless Devices Based On Distance Bounding&quot;.in proceedings of the 8th International Conference on Cryptology And Network Security (CANS'09).\n*Ersin Uzun, Kristiina Karvonen, N. Asokan, &quot;[[Usability Analysis of Secure Pairing Methods|http://www.ersinuzun.com/pub/EU-USEC07.pdf]]&quot;, in USEC'07. ([[Technical Report|http://www.ersinuzun.com/pub/NRC-TR-2007-002.pdf]], Nokia Research 2007) ([[Presentation Slides|http://www.ersinuzun.com/presentations/Usability-of-pairing.pdf]])\n</pre>\n</div>\n<div title=\"ViewTemplate\" modifier=\"Ersin\" created=\"200708231211\" changecount=\"7\">\n<pre>&lt;!--{{{--&gt;\n&lt;div class='toolbar' macro='toolbar closeTiddler closeOthers +editTiddler' &gt;&lt;/div&gt;\n&lt;div class='title' macro='view title'&gt;&lt;/div&gt;\n&lt;div class='viewer' macro='view text wikified'&gt;&lt;/div&gt;\n&lt;!--}}}--&gt;</pre>\n</div>\n</div>\n<!--POST-STOREAREA-->\n<!--POST-BODY-START-->\n<!--POST-BODY-END-->\n<script type=\"text/javascript\">\n//<![CDATA[\n//\n// Please note:\n// \n// * This code is designed to be readable but for compactness it only includes brief comments. You can see fuller comments\n//   in the project Subversion repository at http://svn.tiddlywiki.org/Trunk/core/\n//\n// * You should never need to modify this source code directly. TiddlyWiki is carefully designed to allow deep customisation\n//   without changing the core code. Please consult the development group at http://groups.google.com/group/TiddlyWikiDev\n// \n\n//--\n//-- Configuration repository\n//--\n\n// Miscellaneous options\nvar config = {\n\tnumRssItems: 20, // Number of items in the RSS feed\n\tanimDuration: 400, // Duration of UI animations in milliseconds\n\tcascadeFast: 20, // Speed for cascade animations (higher == slower)\n\tcascadeSlow: 60, // Speed for EasterEgg cascade animations\n\tcascadeDepth: 5 // Depth of cascade animation\n};\n\n// Adaptors\nconfig.adaptors = {};\n\n// Backstage tasks\nconfig.tasks = {};\n\n// Annotations\nconfig.annotations = {};\n\n// Custom fields to be automatically added to new tiddlers\nconfig.defaultCustomFields = {};\n\n// Messages\nconfig.messages = {\n\tmessageClose: {},\n\tdates: {},\n\ttiddlerPopup: {}\n};\n\n// Options that can be set in the options panel and/or cookies\nconfig.options = {\n\tchkRegExpSearch: false,\n\tchkCaseSensitiveSearch: false,\n\tchkAnimate: true,\n\tchkSaveBackups: true,\n\tchkAutoSave: false,\n\tchkGenerateAnRssFeed: false,\n\tchkSaveEmptyTemplate: false,\n\tchkOpenInNewWindow: true,\n\tchkToggleLinks: false,\n\tchkHttpReadOnly: true,\n\tchkForceMinorUpdate: false,\n\tchkConfirmDelete: true,\n\tchkInsertTabs: false,\n\tchkUsePreForStorage: true, // Whether to use <pre> format for storage\n\tchkDisplayStartupTime: false,\n\ttxtBackupFolder: \"\",\n\ttxtMainTab: \"tabTimeline\",\n\ttxtMoreTab: \"moreTabAll\",\n\ttxtMaxEditRows: \"30\",\n\ttxtFileSystemCharSet: \"UTF-8\"\n\t};\nconfig.optionsDesc = {};\n\t\n// List of notification functions to be called when certain tiddlers are changed or deleted\nconfig.notifyTiddlers = [\n\t{name: \"StyleSheetLayout\", notify: refreshStyles},\n\t{name: \"StyleSheetColors\", notify: refreshStyles},\n\t{name: \"StyleSheet\", notify: refreshStyles},\n\t{name: \"StyleSheetPrint\", notify: refreshStyles},\n\t{name: \"PageTemplate\", notify: refreshPageTemplate},\n\t{name: \"SiteTitle\", notify: refreshPageTitle},\n\t{name: \"SiteSubtitle\", notify: refreshPageTitle},\n\t{name: \"ColorPalette\", notify: refreshColorPalette},\n\t{name: null, notify: refreshDisplay}\n];\n\n// Default tiddler templates\nvar DEFAULT_VIEW_TEMPLATE = 1;\nvar DEFAULT_EDIT_TEMPLATE = 2;\nconfig.tiddlerTemplates = {\n\t1: \"ViewTemplate\",\n\t2: \"EditTemplate\"\n};\n\n// More messages (rather a legacy layout that shouldn't really be like this)\nconfig.views = {\n\twikified: {\n\t\ttag: {}\n\t},\n\teditor: {\n\t\ttagChooser: {}\n\t}\n};\n\n// Backstage tasks\nconfig.backstageTasks = [\"save\",\"sync\",\"importTask\",\"tweak\",\"plugins\"];\n\n// Macros; each has a 'handler' member that is inserted later\nconfig.macros = {\n\ttoday: {},\n\tversion: {},\n\tsearch: {sizeTextbox: 15},\n\ttiddler: {},\n\ttag: {},\n\ttags: {},\n\ttagging: {},\n\ttimeline: {},\n\tallTags: {},\n\tlist: {\n\t\tall: {},\n\t\tmissing: {},\n\t\torphans: {},\n\t\tshadowed: {},\n\t\ttouched: {}\n\t},\n\tcloseAll: {},\n\tpermaview: {},\n\tsaveChanges: {},\n\tslider: {},\n\toption: {},\n\toptions: {},\n\tnewTiddler: {},\n\tnewJournal: {},\n\tsparkline: {},\n\ttabs: {},\n\tgradient: {},\n\tmessage: {},\n\tview: {},\n\tedit: {},\n\ttagChooser: {},\n\ttoolbar: {},\n\tbr: {},\n\tplugins: {},\n\trefreshDisplay: {},\n\timportTiddlers: {},\n\tsync: {},\n\tannotations: {}\n};\n\n// Commands supported by the toolbar macro\nconfig.commands = {\n\tcloseTiddler: {},\n\tcloseOthers: {},\n\teditTiddler: {hideReadOnly: true},\n\tsaveTiddler: {hideReadOnly: true},\n\tcancelTiddler: {},\n\tdeleteTiddler: {hideReadOnly: true},\n\tpermalink: {},\n\treferences: {type: \"popup\"},\n\tjump: {type: \"popup\"},\n\tsyncing: {type: \"popup\"},\n\tfields: {type: \"popup\"}\n};\n\n// Browser detection... In a very few places, there's nothing else for it but to know what browser we're using.\nconfig.userAgent = navigator.userAgent.toLowerCase();\nconfig.browser = {\n\tisIE: config.userAgent.indexOf(\"msie\") != -1 && config.userAgent.indexOf(\"opera\") == -1,\n\tisGecko: config.userAgent.indexOf(\"gecko\") != -1,\n\tieVersion: /MSIE (\\d.\\d)/i.exec(config.userAgent), // config.browser.ieVersion[1], if it exists, will be the IE version string, eg \"6.0\"\n\tisSafari: config.userAgent.indexOf(\"applewebkit\") != -1,\n\tisBadSafari: !((new RegExp(\"[\\u0150\\u0170]\",\"g\")).test(\"\\u0150\")),\n\tfirefoxDate: /gecko\\/(\\d{8})/i.exec(config.userAgent), // config.browser.firefoxDate[1], if it exists, will be Firefox release date as \"YYYYMMDD\"\n\tisOpera: config.userAgent.indexOf(\"opera\") != -1,\n\tisLinux: config.userAgent.indexOf(\"linux\") != -1,\n\tisUnix: config.userAgent.indexOf(\"x11\") != -1,\n\tisMac: config.userAgent.indexOf(\"mac\") != -1,\n\tisWindows: config.userAgent.indexOf(\"win\") != -1\n};\n\n// Basic regular expressions\nconfig.textPrimitives = {\n\tupperLetter: \"[A-Z\\u00c0-\\u00de\\u0150\\u0170]\",\n\tlowerLetter: \"[a-z0-9_\\\\-\\u00df-\\u00ff\\u0151\\u0171]\",\n\tanyLetter:   \"[A-Za-z0-9_\\\\-\\u00c0-\\u00de\\u00df-\\u00ff\\u0150\\u0170\\u0151\\u0171]\",\n\tanyLetterStrict: \"[A-Za-z0-9\\u00c0-\\u00de\\u00df-\\u00ff\\u0150\\u0170\\u0151\\u0171]\"\n};\nif(config.browser.isBadSafari) {\n\tconfig.textPrimitives = {\n\t\tupperLetter: \"[A-Z\\u00c0-\\u00de]\",\n\t\tlowerLetter: \"[a-z0-9_\\\\-\\u00df-\\u00ff]\",\n\t\tanyLetter:   \"[A-Za-z0-9_\\\\-\\u00c0-\\u00de\\u00df-\\u00ff]\",\n\t\tanyLetterStrict: \"[A-Za-z0-9\\u00c0-\\u00de\\u00df-\\u00ff]\"\n\t};\n}\nconfig.textPrimitives.sliceSeparator = \"::\";\nconfig.textPrimitives.urlPattern = \"[a-z]{3,8}:[^\\\\s:'\\\"][^\\\\s'\\\"]*(?:/|\\\\b)\";\nconfig.textPrimitives.unWikiLink = \"~\";\nconfig.textPrimitives.wikiLink = \"(?:(?:\" + config.textPrimitives.upperLetter + \"+\" +\n\tconfig.textPrimitives.lowerLetter + \"+\" +\n\tconfig.textPrimitives.upperLetter +\n\tconfig.textPrimitives.anyLetter + \"*)|(?:\" +\n\tconfig.textPrimitives.upperLetter + \"{2,}\" +\n\tconfig.textPrimitives.lowerLetter + \"+))\";\n\nconfig.textPrimitives.cssLookahead = \"(?:(\" + config.textPrimitives.anyLetter + \"+)\\\\(([^\\\\)\\\\|\\\\n]+)(?:\\\\):))|(?:(\" + config.textPrimitives.anyLetter + \"+):([^;\\\\|\\\\n]+);)\";\nconfig.textPrimitives.cssLookaheadRegExp = new RegExp(config.textPrimitives.cssLookahead,\"mg\");\n\nconfig.textPrimitives.brackettedLink = \"\\\\[\\\\[([^\\\\]]+)\\\\]\\\\]\";\nconfig.textPrimitives.titledBrackettedLink = \"\\\\[\\\\[([^\\\\[\\\\]\\\\|]+)\\\\|([^\\\\[\\\\]\\\\|]+)\\\\]\\\\]\";\nconfig.textPrimitives.tiddlerForcedLinkRegExp = new RegExp(\"(?:\" + config.textPrimitives.titledBrackettedLink + \")|(?:\" +\n\tconfig.textPrimitives.brackettedLink + \")|(?:\" + \n\tconfig.textPrimitives.urlPattern + \")\",\"mg\");\nconfig.textPrimitives.tiddlerAnyLinkRegExp = new RegExp(\"(\"+ config.textPrimitives.wikiLink + \")|(?:\" +\n\tconfig.textPrimitives.titledBrackettedLink + \")|(?:\" +\n\tconfig.textPrimitives.brackettedLink + \")|(?:\" +\n\tconfig.textPrimitives.urlPattern + \")\",\"mg\");\n\nconfig.glyphs = {\n\tbrowsers: [\n\t\tfunction() {return config.browser.isIE;},\n\t\tfunction() {return true}\n\t],\n\tcurrBrowser: null,\n\tcodes: {\n\t\tdownTriangle: [\"\\u25BC\",\"\\u25BE\"],\n\t\tdownArrow: [\"\\u2193\",\"\\u2193\"],\n\t\tbentArrowLeft: [\"\\u2190\",\"\\u21A9\"],\n\t\tbentArrowRight: [\"\\u2192\",\"\\u21AA\"]\n\t}\n};\n\n//--\n//-- Shadow tiddlers\n//--\n\nconfig.shadowTiddlers = {\n\tStyleSheet: \"\",\n\tMarkupPreHead: \"<!--{{{-->\\n<link rel='alternate' type='application/rss+xml' title='RSS' href='index.xml'/>\\n<!--}}}-->\",\n\tMarkupPostHead: \"\",\n\tMarkupPreBody: \"\",\n\tMarkupPostBody: \"\",\n\tTabTimeline: '<<timeline>>',\n\tTabAll: '<<list all>>',\n\tTabTags: '<<allTags excludeLists>>',\n\tTabMoreMissing: '<<list missing>>',\n\tTabMoreOrphans: '<<list orphans>>',\n\tTabMoreShadowed: '<<list shadowed>>',\n\tAdvancedOptions: '<<options>>',\n\tPluginManager: '<<plugins>>',\n\tImportTiddlers: '<<importTiddlers>>'\n};\n\n//--\n//-- Translateable strings\n//--\n\n// Strings in \"double quotes\" should be translated; strings in 'single quotes' should be left alone\n\nmerge(config.options,{\n\ttxtUserName: \"Rishab\"});\n\nmerge(config.tasks,{\n\tsave: {text: \"save\", tooltip: \"Save your changes to this TiddlyWiki\", action: saveChanges},\n\tsync: {text: \"sync\", tooltip: \"Synchronise changes with other TiddlyWiki files and servers\", content: '<<sync>>'},\n\timportTask: {text: \"import\", tooltip: \"Import tiddlers and plugins from other TiddlyWiki files and servers\", content: '<<importTiddlers>>'},\n\ttweak: {text: \"tweak\", tooltip: \"Tweak the appearance and behaviour of TiddlyWiki\", content: '<<options>>'},\n\tplugins: {text: \"plugins\", tooltip: \"Manage installed plugins\", content: '<<plugins>>'}\n});\n\n// Options that can be set in the options panel and/or cookies\nmerge(config.optionsDesc,{\n\ttxtUserName: \"Username for signing your edits\",\n\tchkRegExpSearch: \"Enable regular expressions for searches\",\n\tchkCaseSensitiveSearch: \"Case-sensitive searching\",\n\tchkAnimate: \"Enable animations\",\n\tchkSaveBackups: \"Keep backup file when saving changes\",\n\tchkAutoSave: \"Automatically save changes\",\n\tchkGenerateAnRssFeed: \"Generate an RSS feed when saving changes\",\n\tchkSaveEmptyTemplate: \"Generate an empty template when saving changes\",\n\tchkOpenInNewWindow: \"Open external links in a new window\",\n\tchkToggleLinks: \"Clicking on links to open tiddlers causes them to close\",\n\tchkHttpReadOnly: \"Hide editing features when viewed over HTTP\",\n\tchkForceMinorUpdate: \"Don't update modifier username and date when editing tiddlers\",\n\tchkConfirmDelete: \"Require confirmation before deleting tiddlers\",\n\tchkInsertTabs: \"Use the tab key to insert tab characters instead of moving between fields\",\n\ttxtBackupFolder: \"Name of folder to use for backups\",\n\ttxtMaxEditRows: \"Maximum number of rows in edit boxes\",\n\ttxtFileSystemCharSet: \"Default character set for saving changes (Firefox/Mozilla only)\"});\n\nmerge(config.messages,{\n\tcustomConfigError: \"Problems were encountered loading plugins. See PluginManager for details\",\n\tpluginError: \"Error: %0\",\n\tpluginDisabled: \"Not executed because disabled via 'systemConfigDisable' tag\",\n\tpluginForced: \"Executed because forced via 'systemConfigForce' tag\",\n\tpluginVersionError: \"Not executed because this plugin needs a newer version of TiddlyWiki\",\n\tnothingSelected: \"Nothing is selected. You must select one or more items first\",\n\tsavedSnapshotError: \"It appears that this TiddlyWiki has been incorrectly saved. Please see http://www.tiddlywiki.com/#DownloadSoftware for details\",\n\tsubtitleUnknown: \"(unknown)\",\n\tundefinedTiddlerToolTip: \"The tiddler '%0' doesn't yet exist\",\n\tshadowedTiddlerToolTip: \"The tiddler '%0' doesn't yet exist, but has a pre-defined shadow value\",\n\ttiddlerLinkTooltip: \"%0 - %1, %2\",\n\texternalLinkTooltip: \"External link to %0\",\n\tnoTags: \"There are no tagged tiddlers\",\n\tnotFileUrlError: \"You need to save this TiddlyWiki to a file before you can save changes\",\n\tcantSaveError: \"It's not possible to save changes. Possible reasons include:\\n- your browser doesn't support saving (Firefox, Internet Explorer, Safari and Opera all work if properly configured)\\n- the pathname to your TiddlyWiki file contains illegal characters\\n- the TiddlyWiki HTML file has been moved or renamed\",\n\tinvalidFileError: \"The original file '%0' does not appear to be a valid TiddlyWiki\",\n\tbackupSaved: \"Backup saved\",\n\tbackupFailed: \"Failed to save backup file\",\n\trssSaved: \"RSS feed saved\",\n\trssFailed: \"Failed to save RSS feed file\",\n\temptySaved: \"Empty template saved\",\n\temptyFailed: \"Failed to save empty template file\",\n\tmainSaved: \"Main TiddlyWiki file saved\",\n\tmainFailed: \"Failed to save main TiddlyWiki file. Your changes have not been saved\",\n\tmacroError: \"Error in macro <<\\%0>>\",\n\tmacroErrorDetails: \"Error while executing macro <<\\%0>>:\\n%1\",\n\tmissingMacro: \"No such macro\",\n\toverwriteWarning: \"A tiddler named '%0' already exists. Choose OK to overwrite it\",\n\tunsavedChangesWarning: \"WARNING! There are unsaved changes in TiddlyWiki\\n\\nChoose OK to save\\nChoose CANCEL to discard\",\n\tconfirmExit: \"--------------------------------\\n\\nThere are unsaved changes in TiddlyWiki. If you continue you will lose those changes\\n\\n--------------------------------\",\n\tsaveInstructions: \"SaveChanges\",\n\tunsupportedTWFormat: \"Unsupported TiddlyWiki format '%0'\",\n\ttiddlerSaveError: \"Error when saving tiddler '%0'\",\n\ttiddlerLoadError: \"Error when loading tiddler '%0'\",\n\twrongSaveFormat: \"Cannot save with storage format '%0'. Using standard format for save.\",\n\tinvalidFieldName: \"Invalid field name %0\",\n\tfieldCannotBeChanged: \"Field '%0' cannot be changed\",\n\tloadingMissingTiddler: \"Attempting to retrieve the tiddler '%0' from the '%1' server at:\\n\\n'%2' in the workspace '%3'\"});\n\nmerge(config.messages.messageClose,{\n\ttext: \"close\",\n\ttooltip: \"close this message area\"});\n\nconfig.messages.backstage = {\n\topen: {text: \"backstage\", tooltip: \"Open the backstage area to perform authoring and editing tasks\"},\n\tclose: {text: \"close\", tooltip: \"Close the backstage area\"},\n\tprompt: \"backstage: \",\n\tdecal: {\n\t\tedit: {text: \"edit\", tooltip: \"Edit the tiddler '%0'\"}\n\t}\n};\n\nconfig.messages.listView = {\n\ttiddlerTooltip: \"Click for the full text of this tiddler\",\n\tpreviewUnavailable: \"(preview not available)\"\n};\n\nconfig.messages.dates.months = [\"January\", \"February\", \"March\", \"April\", \"May\", \"June\", \"July\", \"August\", \"September\", \"October\", \"November\",\"December\"];\nconfig.messages.dates.days = [\"Sunday\", \"Monday\", \"Tuesday\", \"Wednesday\", \"Thursday\", \"Friday\", \"Saturday\"];\nconfig.messages.dates.shortMonths = [\"Jan\", \"Feb\", \"Mar\", \"Apr\", \"May\", \"Jun\", \"Jul\", \"Aug\", \"Sep\", \"Oct\", \"Nov\", \"Dec\"];\nconfig.messages.dates.shortDays = [\"Sun\", \"Mon\", \"Tue\", \"Wed\", \"Thu\", \"Fri\", \"Sat\"];\n// suffixes for dates, eg \"1st\",\"2nd\",\"3rd\"...\"30th\",\"31st\"\nconfig.messages.dates.daySuffixes = [\"st\",\"nd\",\"rd\",\"th\",\"th\",\"th\",\"th\",\"th\",\"th\",\"th\",\n\t\t\"th\",\"th\",\"th\",\"th\",\"th\",\"th\",\"th\",\"th\",\"th\",\"th\",\n\t\t\"st\",\"nd\",\"rd\",\"th\",\"th\",\"th\",\"th\",\"th\",\"th\",\"th\",\n\t\t\"st\"];\nconfig.messages.dates.am = \"am\";\nconfig.messages.dates.pm = \"pm\";\n\nmerge(config.messages.tiddlerPopup,{\n\t});\n\nmerge(config.views.wikified.tag,{\n\tlabelNoTags: \"no tags\",\n\tlabelTags: \"tags: \",\n\topenTag: \"Open tag '%0'\",\n\ttooltip: \"Show tiddlers tagged with '%0'\",\n\topenAllText: \"Open all\",\n\topenAllTooltip: \"Open all of these tiddlers\",\n\tpopupNone: \"No other tiddlers tagged with '%0'\"});\n\nmerge(config.views.wikified,{\n\tdefaultText: \"The tiddler '%0' doesn't yet exist. Double-click to create it\",\n\tdefaultModifier: \"(missing)\",\n\tshadowModifier: \"(built-in shadow tiddler)\",\n\tdateFormat: \"DD MMM YYYY\",\n\tcreatedPrompt: \"created\"});\n\nmerge(config.views.editor,{\n\ttagPrompt: \"Type tags separated with spaces, [[use double square brackets]] if necessary, or add existing\",\n\tdefaultText: \"Type the text for '%0'\"});\n\nmerge(config.views.editor.tagChooser,{\n\ttext: \"tags\",\n\ttooltip: \"Choose existing tags to add to this tiddler\",\n\tpopupNone: \"There are no tags defined\",\n\ttagTooltip: \"Add the tag '%0'\"});\n\nmerge(config.messages,{\n\tsizeTemplates:\n\t\t[\n\t\t{unit: 1024*1024*1024, template: \"%0\\u00a0GB\"},\n\t\t{unit: 1024*1024, template: \"%0\\u00a0MB\"},\n\t\t{unit: 1024, template: \"%0\\u00a0KB\"},\n\t\t{unit: 1, template: \"%0\\u00a0B\"}\n\t\t]});\n\nmerge(config.macros.search,{\n\tlabel: \"search\",\n\tprompt: \"Search this TiddlyWiki\",\n\taccessKey: \"F\",\n\tsuccessMsg: \"%0 tiddlers found matching %1\",\n\tfailureMsg: \"No tiddlers found matching %0\"});\n\nmerge(config.macros.tagging,{\n\tlabel: \"tagging: \",\n\tlabelNotTag: \"not tagging\",\n\ttooltip: \"List of tiddlers tagged with '%0'\"});\n\nmerge(config.macros.timeline,{\n\tdateFormat: \"DD MMM YYYY\"});\n\nmerge(config.macros.allTags,{\n\ttooltip: \"Show tiddlers tagged with '%0'\",\n\tnoTags: \"There are no tagged tiddlers\"});\n\nconfig.macros.list.all.prompt = \"All tiddlers in alphabetical order\";\nconfig.macros.list.missing.prompt = \"Tiddlers that have links to them but are not defined\";\nconfig.macros.list.orphans.prompt = \"Tiddlers that are not linked to from any other tiddlers\";\nconfig.macros.list.shadowed.prompt = \"Tiddlers shadowed with default contents\";\nconfig.macros.list.touched.prompt = \"Tiddlers that have been modified locally\";\n\nmerge(config.macros.closeAll,{\n\tlabel: \"close all\",\n\tprompt: \"Close all displayed tiddlers (except any that are being edited)\"});\n\nmerge(config.macros.permaview,{\n\tlabel: \"permaview\",\n\tprompt: \"Link to an URL that retrieves all the currently displayed tiddlers\"});\n\nmerge(config.macros.saveChanges,{\n\tlabel: \"save changes\",\n\tprompt: \"Save all tiddlers to create a new TiddlyWiki\",\n\taccessKey: \"S\"});\n\nmerge(config.macros.newTiddler,{\n\tlabel: \"new tiddler\",\n\tprompt: \"Create a new tiddler\",\n\ttitle: \"New Tiddler\",\n\taccessKey: \"N\"});\n\nmerge(config.macros.newJournal,{\n\tlabel: \"new journal\",\n\tprompt: \"Create a new tiddler from the current date and time\",\n\taccessKey: \"J\"});\n\nmerge(config.macros.options,{\n\twizardTitle: \"Tweak advanced options\",\n\tstep1Title: \"These options are saved in cookies in your browser\",\n\tstep1Html: \"<input type='hidden' name='markList'></input><br><input type='checkbox' checked='false' name='chkUnknown'>Show unknown options</input>\",\n\tunknownDescription: \"//(unknown)//\",\n\tlistViewTemplate: {\n\t\tcolumns: [\n\t\t\t{name: 'Option', field: 'option', title: \"Option\", type: 'String'},\n\t\t\t{name: 'Description', field: 'description', title: \"Description\", type: 'WikiText'},\n\t\t\t{name: 'Name', field: 'name', title: \"Name\", type: 'String'}\n\t\t\t],\n\t\trowClasses: [\n\t\t\t{className: 'lowlight', field: 'lowlight'} \n\t\t\t]}\n\t});\n\nmerge(config.macros.plugins,{\n\twizardTitle: \"Manage plugins\",\n\tstep1Title: \"Currently loaded plugins\",\n\tstep1Html: \"<input type='hidden' name='markList'></input>\", // DO NOT TRANSLATE\n\tskippedText: \"(This plugin has not been executed because it was added since startup)\",\n\tnoPluginText: \"There are no plugins installed\",\n\tconfirmDeleteText: \"Are you sure you want to delete these plugins:\\n\\n%0\",\n\tremoveLabel: \"remove systemConfig tag\",\n\tremovePrompt: \"Remove systemConfig tag\",\n\tdeleteLabel: \"delete\",\n\tdeletePrompt: \"Delete these tiddlers forever\",\n\tlistViewTemplate: {\n\t\tcolumns: [\n\t\t\t{name: 'Selected', field: 'Selected', rowName: 'title', type: 'Selector'},\n\t\t\t{name: 'Tiddler', field: 'tiddler', title: \"Tiddler\", type: 'Tiddler'},\n\t\t\t{name: 'Size', field: 'size', tiddlerLink: 'size', title: \"Size\", type: 'Size'},\n\t\t\t{name: 'Forced', field: 'forced', title: \"Forced\", tag: 'systemConfigForce', type: 'TagCheckbox'},\n\t\t\t{name: 'Disabled', field: 'disabled', title: \"Disabled\", tag: 'systemConfigDisable', type: 'TagCheckbox'},\n\t\t\t{name: 'Executed', field: 'executed', title: \"Loaded\", type: 'Boolean', trueText: \"Yes\", falseText: \"No\"},\n\t\t\t{name: 'Startup Time', field: 'startupTime', title: \"Startup Time\", type: 'String'},\n\t\t\t{name: 'Error', field: 'error', title: \"Status\", type: 'Boolean', trueText: \"Error\", falseText: \"OK\"},\n\t\t\t{name: 'Log', field: 'log', title: \"Log\", type: 'StringList'}\n\t\t\t],\n\t\trowClasses: [\n\t\t\t{className: 'error', field: 'error'},\n\t\t\t{className: 'warning', field: 'warning'}\n\t\t\t]}\n\t});\n\nmerge(config.macros.toolbar,{\n\tmoreLabel: \"more\",\n\tmorePrompt: \"Reveal further commands\"\n\t});\n\nmerge(config.macros.refreshDisplay,{\n\tlabel: \"refresh\",\n\tprompt: \"Redraw the entire TiddlyWiki display\"\n\t});\n\nmerge(config.macros.importTiddlers,{\n\treadOnlyWarning: \"You cannot import into a read-only TiddlyWiki file. Try opening it from a file:// URL\",\n\twizardTitle: \"Import tiddlers from another file or server\",\n\tstep1Title: \"Step 1: Locate the server or TiddlyWiki file\",\n\tstep1Html: \"Specify the type of the server: <select name='selTypes'><option value=''>Choose...</option></select><br>Enter the URL or pathname here: <input type='text' size=50 name='txtPath'><br>...or browse for a file: <input type='file' size=50 name='txtBrowse'><br><hr>...or select a pre-defined feed: <select name='selFeeds'><option value=''>Choose...</option></select>\",\n\topenLabel: \"open\",\n\topenPrompt: \"Open the connection to this file or server\",\n\topenError: \"There were problems fetching the tiddlywiki file\",\n\tstatusOpenHost: \"Opening the host\",\n\tstatusGetWorkspaceList: \"Getting the list of available workspaces\",\n\tstep2Title: \"Step 2: Choose the workspace\",\n\tstep2Html: \"Enter a workspace name: <input type='text' size=50 name='txtWorkspace'><br>...or select a workspace: <select name='selWorkspace'><option value=''>Choose...</option></select>\",\n\tcancelLabel: \"cancel\",\n\tcancelPrompt: \"Cancel this import\",\n\tstatusOpenWorkspace: \"Opening the workspace\",\n\tstatusGetTiddlerList: \"Getting the list of available tiddlers\",\n\tstep3Title: \"Step 3: Choose the tiddlers to import\",\n\tstep3Html: \"<input type='hidden' name='markList'></input><br><input type='checkbox' checked='true' name='chkSync'>Keep these tiddlers linked to this server so that you can synchronise subsequent changes</input><br><input type='checkbox' name='chkSave'>Save the details of this server in a 'systemServer' tiddler called:</input> <input type='text' size=25 name='txtSaveTiddler'>\",\n\timportLabel: \"import\",\n\timportPrompt: \"Import these tiddlers\",\n\tconfirmOverwriteText: \"Are you sure you want to overwrite these tiddlers:\\n\\n%0\",\n\tstep4Title: \"Step 4: Importing %0 tiddler(s)\",\n\tstep4Html: \"<input type='hidden' name='markReport'></input>\", // DO NOT TRANSLATE\n\tdoneLabel: \"done\",\n\tdonePrompt: \"Close this wizard\",\n\tstatusDoingImport: \"Importing tiddlers\",\n\tstatusDoneImport: \"All tiddlers imported\",\n\tsystemServerNamePattern: \"%2 on %1\",\n\tsystemServerNamePatternNoWorkspace: \"%1\",\n\tconfirmOverwriteSaveTiddler: \"The tiddler '%0' already exists. Click 'OK' to overwrite it with the details of this server, or 'Cancel' to leave it unchanged\",\n\tserverSaveTemplate: \"|''Type:''|%0|\\n|''URL:''|%1|\\n|''Workspace:''|%2|\\n\\nThis tiddler was automatically created to record the details of this server\",\n\tserverSaveModifier: \"(System)\",\n\tlistViewTemplate: {\n\t\tcolumns: [\n\t\t\t{name: 'Selected', field: 'Selected', rowName: 'title', type: 'Selector'},\n\t\t\t{name: 'Tiddler', field: 'tiddler', title: \"Tiddler\", type: 'Tiddler'},\n\t\t\t{name: 'Size', field: 'size', tiddlerLink: 'size', title: \"Size\", type: 'Size'},\n\t\t\t{name: 'Tags', field: 'tags', title: \"Tags\", type: 'Tags'}\n\t\t\t],\n\t\trowClasses: [\n\t\t\t]}\n\t});\n\nmerge(config.macros.sync,{\n\tlistViewTemplate: {\n\t\tcolumns: [\n\t\t\t{name: 'Selected', field: 'selected', rowName: 'title', type: 'Selector'},\n\t\t\t{name: 'Tiddler', field: 'tiddler', title: \"Tiddler\", type: 'Tiddler'},\n\t\t\t{name: 'Server Type', field: 'serverType', title: \"Server type\", type: 'String'},\n\t\t\t{name: 'Server Host', field: 'serverHost', title: \"Server host\", type: 'String'},\n\t\t\t{name: 'Server Workspace', field: 'serverWorkspace', title: \"Server workspace\", type: 'String'},\n\t\t\t{name: 'Status', field: 'status', title: \"Synchronisation status\", type: 'String'},\n\t\t\t{name: 'Server URL', field: 'serverUrl', title: \"Server URL\", text: \"View\", type: 'Link'}\n\t\t\t],\n\t\trowClasses: [\n\t\t\t],\n\t\tbuttons: [\n\t\t\t{caption: \"Sync these tiddlers\", name: 'sync'}\n\t\t\t]},\n\twizardTitle: \"Synchronize with external servers and files\",\n\tstep1Title: \"Choose the tiddlers you want to synchronize\",\n\tstep1Html: \"<input type='hidden' name='markList'></input>\", // DO NOT TRANSLATE\n\tsyncLabel: \"sync\",\n\tsyncPrompt: \"Sync these tiddlers\",\n\thasChanged: \"Changed while unplugged\",\n\thasNotChanged: \"Unchanged while unplugged\",\n\tsyncStatusList: {\n\t\tnone: {text: \"...\", color: \"none\"},\n\t\tchangedServer: {text: \"Changed on server\", color: '#80ff80'},\n\t\tchangedLocally: {text: \"Changed while unplugged\", color: '#80ff80'},\n\t\tchangedBoth: {text: \"Changed while unplugged and on server\", color: '#ff8080'},\n\t\tnotFound: {text: \"Not found on server\", color: '#ffff80'},\n\t\tputToServer: {text: \"Saved update on server\", color: '#ff80ff'},\n\t\tgotFromServer: {text: \"Retrieved update from server\", color: '#80ffff'}\n\t\t}\n\t});\n\nmerge(config.macros.annotations,{\n\t});\n\nmerge(config.commands.closeTiddler,{\n\ttext: \"close\",\n\ttooltip: \"Close this tiddler\"});\n\nmerge(config.commands.closeOthers,{\n\ttext: \"close others\",\n\ttooltip: \"Close all other tiddlers\"});\n\nmerge(config.commands.editTiddler,{\n\ttext: \"edit\",\n\ttooltip: \"Edit this tiddler\",\n\treadOnlyText: \"view\",\n\treadOnlyTooltip: \"View the source of this tiddler\"});\n\nmerge(config.commands.saveTiddler,{\n\ttext: \"done\",\n\ttooltip: \"Save changes to this tiddler\"});\n\nmerge(config.commands.cancelTiddler,{\n\ttext: \"cancel\",\n\ttooltip: \"Undo changes to this tiddler\",\n\twarning: \"Are you sure you want to abandon your changes to '%0'?\",\n\treadOnlyText: \"done\",\n\treadOnlyTooltip: \"View this tiddler normally\"});\n\nmerge(config.commands.deleteTiddler,{\n\ttext: \"delete\",\n\ttooltip: \"Delete this tiddler\",\n\twarning: \"Are you sure you want to delete '%0'?\"});\n\nmerge(config.commands.permalink,{\n\ttext: \"permalink\",\n\ttooltip: \"Permalink for this tiddler\"});\n\nmerge(config.commands.references,{\n\ttext: \"references\",\n\ttooltip: \"Show tiddlers that link to this one\",\n\tpopupNone: \"No references\"});\n\nmerge(config.commands.jump,{\n\ttext: \"jump\",\n\ttooltip: \"Jump to another open tiddler\"});\n\nmerge(config.commands.syncing,{\n\ttext: \"syncing\",\n\ttooltip: \"Control synchronisation of this tiddler with a server or external file\",\n\tcurrentlySyncing: \"<div>Currently syncing via <span class='popupHighlight'>'%0'</span> to:</\"+\"div><div>host: <span class='popupHighlight'>%1</span></\"+\"div><div>workspace: <span class='popupHighlight'>%2</span></\"+\"div>\", // Note escaping of closing <div> tag\n\tnotCurrentlySyncing: \"Not currently syncing\",\n\tcaptionUnSync: \"Stop synchronising this tiddler\",\n\tchooseServer: \"Synchronise this tiddler with another server:\",\n\tcurrServerMarker: \"\\u25cf \",\n\tnotCurrServerMarker: \"  \"});\n\nmerge(config.commands.fields,{\n\ttext: \"fields\",\n\ttooltip: \"Show the extended fields of this tiddler\",\n\temptyText: \"There are no extended fields for this tiddler\",\n\tlistViewTemplate: {\n\t\tcolumns: [\n\t\t\t{name: 'Field', field: 'field', title: \"Field\", type: 'String'},\n\t\t\t{name: 'Value', field: 'value', title: \"Value\", type: 'String'}\n\t\t\t],\n\t\trowClasses: [\n\t\t\t],\n\t\tbuttons: [\n\t\t\t]}});\n\nmerge(config.shadowTiddlers,{\n\tDefaultTiddlers: \"GettingStarted\",\n\tMainMenu: \"GettingStarted\",\n\tSiteTitle: \"My TiddlyWiki\",\n\tSiteSubtitle: \"a reusable non-linear personal web notebook\",\n\tSiteUrl: \"http://sconce.ics.uci.edu/usec/usec.html\",\n\tSideBarOptions: '<<search>><<closeAll>><<permaview>><<newTiddler>><<newJournal \"DD MMM YYYY\">><<saveChanges>><<slider chkSliderOptionsPanel OptionsPanel \"options \u00bb\" \"Change TiddlyWiki advanced options\">>',\n\tSideBarTabs: '<<tabs txtMainTab \"Timeline\" \"Timeline\" TabTimeline \"All\" \"All tiddlers\" TabAll \"Tags\" \"All tags\" TabTags \"More\" \"More lists\" TabMore>>',\n\tTabMore: '<<tabs txtMoreTab \"Missing\" \"Missing tiddlers\" TabMoreMissing \"Orphans\" \"Orphaned tiddlers\" TabMoreOrphans \"Shadowed\" \"Shadowed tiddlers\" TabMoreShadowed>>'});\n\nmerge(config.annotations,{\n\tAdvancedOptions: \"This shadow tiddler provides access to several advanced options\",\n\tColorPalette: \"These values in this shadow tiddler determine the colour scheme of the ~TiddlyWiki user interface\",\n\tDefaultTiddlers: \"The tiddlers listed in this shadow tiddler will be automatically displayed when ~TiddlyWiki starts up\",\n\tEditTemplate: \"The HTML template in this shadow tiddler determines how tiddlers look while they are being edited\",\n\tGettingStarted: \"This shadow tiddler provides basic usage instructions\",\n\tImportTiddlers: \"This shadow tiddler provides access to importing tiddlers\",\n\tMainMenu: \"This shadow tiddler is used as the contents of the main menu in the left-hand column of the screen\",\n\tMarkupPreHead: \"This tiddler is inserted at the top of the <head> section of the TiddlyWiki HTML file\",\n\tMarkupPostHead: \"This tiddler is inserted at the bottom of the <head> section of the TiddlyWiki HTML file\",\n\tMarkupPreBody: \"This tiddler is inserted at the top of the <body> section of the TiddlyWiki HTML file\",\n\tMarkupPostBody: \"This tiddler is inserted at the end of the <body> section of the TiddlyWiki HTML file immediately before the script block\",\n\tOptionsPanel: \"This shadow tiddler is used as the contents of the options panel slider in the right-hand sidebar\",\n\tPageTemplate: \"The HTML template in this shadow tiddler determines the overall ~TiddlyWiki layout\",\n\tPluginManager: \"This shadow tiddler provides access to the plugin manager\",\n\tSideBarOptions: \"This shadow tiddler is used as the contents of the option panel in the right-hand sidebar\",\n\tSideBarTabs: \"This shadow tiddler is used as the contents of the tabs panel in the right-hand sidebar\",\n\tSiteSubtitle: \"This shadow tiddler is used as the second part of the page title\",\n\tSiteTitle: \"This shadow tiddler is used as the first part of the page title\",\n\tSiteUrl: \"This shadow tiddler should be set to the full target URL for publication\",\n\tStyleSheetColours: \"This shadow tiddler contains CSS definitions related to the color of page elements\",\n\tStyleSheet: \"This tiddler can contain custom CSS definitions\",\n\tStyleSheetLayout: \"This shadow tiddler contains CSS definitions related to the layout of page elements\",\n\tStyleSheetLocale: \"This shadow tiddler contains CSS definitions related to the translation locale\",\n\tStyleSheetPrint: \"This shadow tiddler contains CSS definitions for printing\",\n\tTabAll: \"This shadow tiddler contains the contents of the 'All' tab in the right-hand sidebar\",\n\tTabMore: \"This shadow tiddler contains the contents of the 'More' tab in the right-hand sidebar\",\n\tTabMoreMissing: \"This shadow tiddler contains the contents of the 'Missing' tab in the right-hand sidebar\",\n\tTabMoreOrphans: \"This shadow tiddler contains the contents of the 'Orphans' tab in the right-hand sidebar\",\n\tTabMoreShadowed: \"This shadow tiddler contains the contents of the 'Shadowed' tab in the right-hand sidebar\",\n\tTabTags: \"This shadow tiddler contains the contents of the 'Tags' tab in the right-hand sidebar\",\n\tTabTimeline: \"This shadow tiddler contains the contents of the 'Timeline' tab in the right-hand sidebar\",\n\tViewTemplate: \"The HTML template in this shadow tiddler determines how tiddlers look\"\n\t});\n\n//--\n//-- Main\n//--\n\nvar params = null; // Command line parameters\nvar store = null; // TiddlyWiki storage\nvar story = null; // Main story\nvar formatter = null; // Default formatters for the wikifier\nconfig.parsers = {}; // Hashmap of alternative parsers for the wikifier\nvar anim = new Animator(); // Animation engine\nvar readOnly = false; // Whether we're in readonly mode\nvar highlightHack = null; // Embarrassing hack department...\nvar hadConfirmExit = false; // Don't warn more than once\nvar safeMode = false; // Disable all plugins and cookies\nvar installedPlugins = []; // Information filled in when plugins are executed\nvar startingUp = false; // Whether we're in the process of starting up\nvar pluginInfo,tiddler; // Used to pass information to plugins in loadPlugins()\n\n// Whether to use the JavaSaver applet\nvar useJavaSaver = config.browser.isSafari || config.browser.isOpera;\n\n// Starting up\nfunction main()\n{\n\tvar t9,t8,t7,t6,t5,t4,t3,t2,t1,t0 = new Date();\n\tstartingUp = true;\n\twindow.onbeforeunload = function(e) {if(window.confirmExit) return confirmExit();};\n\tparams = getParameters();\n\tif(params)\n\t\tparams = params.parseParams(\"open\",null,false);\n\tstore = new TiddlyWiki();\n\tinvokeParamifier(params,\"oninit\");\n\tstory = new Story(\"tiddlerDisplay\",\"tiddler\");\n\taddEvent(document,\"click\",Popup.onDocumentClick);\n\tsaveTest();\n\tloadOptionsCookie();\n\tfor(var s=0; s<config.notifyTiddlers.length; s++)\n\t\tstore.addNotification(config.notifyTiddlers[s].name,config.notifyTiddlers[s].notify);\n\tt1 = new Date();\n\tstore.loadFromDiv(\"storeArea\",\"store\",true);\n\tt2 = new Date();\n\tloadShadowTiddlers();\n\tt3 = new Date();\n\tinvokeParamifier(params,\"onload\");\n\tt4 = new Date();\n\treadOnly = (window.location.protocol == \"file:\") ? false : config.options.chkHttpReadOnly;\n\tvar pluginProblem = loadPlugins();\n\tt5 = new Date();\n\tformatter = new Formatter(config.formatters);\n\tinvokeParamifier(params,\"onconfig\");\n\tt6 = new Date();\n\tstore.notifyAll();\n\tt7 = new Date();\n\trestart();\n\tt8 = new Date();\n\tif(pluginProblem) {\n\t\tstory.displayTiddler(null,\"PluginManager\");\n\t\tdisplayMessage(config.messages.customConfigError);\n\t}\n\tfor(var m in config.macros) {\n\t\tif(config.macros[m].init)\n\t\t\tconfig.macros[m].init();\n\t}\n\tif(!readOnly)\n\t\tbackstage.init();\n\tt9 = new Date();\n\tif(config.options.chkDisplayStartupTime) {\n\t\tdisplayMessage(\"Load in \" + (t2-t1) + \" ms\");\n\t\tdisplayMessage(\"Loadshadows in \" + (t3-t2) + \" ms\");\n\t\tdisplayMessage(\"Loadplugins in \" + (t5-t4) + \" ms\");\n\t\tdisplayMessage(\"Notify in \" + (t7-t6) + \" ms\");\n\t\tdisplayMessage(\"Restart in \" + (t8-t7) + \" ms\");\n\t\tdisplayMessage(\"Total startup in \" + (t9-t0) + \" ms\");\n\t}\n\tstartingUp = false;\n}\n\n// Restarting\nfunction restart()\n{\n\tinvokeParamifier(params,\"onstart\");\n\tif(story.isEmpty()) {\n\t\tvar defaultParams = store.getTiddlerText(\"DefaultTiddlers\").parseParams(\"open\",null,false);\n\t\tinvokeParamifier(defaultParams,\"onstart\");\n\t}\n\twindow.scrollTo(0,0);\n}\n\nfunction saveTest()\n{\n\tvar s = document.getElementById(\"saveTest\");\n\tif(s.hasChildNodes())\n\t\talert(config.messages.savedSnapshotError);\n\ts.appendChild(document.createTextNode(\"savetest\"));\n}\n\nfunction loadShadowTiddlers()\n{\n\tvar shadows = new TiddlyWiki();\n\tshadows.loadFromDiv(\"shadowArea\",\"shadows\",true);\n\tshadows.forEachTiddler(function(title,tiddler){config.shadowTiddlers[title] = tiddler.text;});\n\tdelete shadows;\n}\n\nfunction loadPlugins()\n{\n\tif(safeMode)\n\t\treturn false;\n\tvar tiddlers = store.getTaggedTiddlers(\"systemConfig\");\n\tvar toLoad = [];\n\tvar nLoaded = 0;\n\tvar map = {};\n\tvar nPlugins = tiddlers.length;\n\tinstalledPlugins = [];\n\tfor(var i=0; i<nPlugins; i++) {\n\t\tvar p = getPluginInfo(tiddlers[i]);\n\t\tinstalledPlugins[i] = p;\n\t\tvar n = p.Name;\n\t\tif(n) \n\t\t\tmap[n] = p;\n\t\tif(n = p.Source) \n\t\t\tmap[n] = p;\n\t}\n\tvar visit = function(p) {\n\t\tif(!p || p.done)\n\t\t\treturn;\n\t\tp.done = 1;\n\t\tvar reqs = p.Requires;\n\t\tif(reqs) {\n\t\t\treqs = reqs.readBracketedList();\n\t\t\tfor(var i=0; i<reqs.length; i++)\n\t\t\t\tvisit(map[reqs[i]]);\n\t\t}\n\t\ttoLoad.push(p);\n\t};\n\tfor(i=0; i<nPlugins; i++) \n\t\tvisit(installedPlugins[i]);\t\n\tfor(i=0; i<toLoad.length; i++) {\n\t\tp = toLoad[i];\n\t\tpluginInfo = p;\n\t\ttiddler = p.tiddler;\n\t\tif(isPluginExecutable(p)) {\n\t\t\tif(isPluginEnabled(p)) {\n\t\t\t\tp.executed = true;\n\t\t\t\tvar startTime = new Date();\n\t\t\t\ttry {\n\t\t\t\t\tif(tiddler.text)\n\t\t\t\t\t\twindow.eval(tiddler.text);\n\t\t\t\t\tnLoaded++;\n\t\t\t\t} catch(ex) {\n\t\t\t\t\tp.log.push(config.messages.pluginError.format([exceptionText(ex)]));\n\t\t\t\t\tp.error = true;\n\t\t\t\t}\n\t\t\t\tpluginInfo.startupTime = String((new Date()) - startTime) + \"ms\"; \n\t\t\t} else {\n\t\t\t\tnPlugins--;\n\t\t\t}\n\t\t} else {\n\t\t\tp.warning = true;\n\t\t}\n\t}\n\treturn nLoaded != nPlugins;\n}\n\nfunction getPluginInfo(tiddler)\n{\n\tvar p = store.getTiddlerSlices(tiddler.title,[\"Name\",\"Description\",\"Version\",\"Requires\",\"CoreVersion\",\"Date\",\"Source\",\"Author\",\"License\",\"Browsers\"]);\n\tp.tiddler = tiddler;\n\tp.title = tiddler.title;\n\tp.log = [];\n\treturn p;\n}\n\n// Check that a particular plugin is valid for execution\nfunction isPluginExecutable(plugin)\n{\n\tif(plugin.tiddler.isTagged(\"systemConfigForce\"))\n\t\treturn verifyTail(plugin,true,config.messages.pluginForced);\n\tif(plugin[\"CoreVersion\"]) {\n\t\tvar coreVersion = plugin[\"CoreVersion\"].split(\".\");\n\t\tvar w = parseInt(coreVersion[0]) - version.major;\n\t\tif(w == 0 && coreVersion[1])\n\t\t\tw = parseInt(coreVersion[1]) - version.minor;\n\t\tif(w == 0 && coreVersion[2])\n\t\t \tw = parseInt(coreVersion[2]) - version.revision;\n\t\tif(w > 0)\n\t\t\treturn verifyTail(plugin,false,config.messages.pluginVersionError);\n\t\t}\n\treturn true;\n}\n\nfunction isPluginEnabled(plugin)\n{\n\tif(plugin.tiddler.isTagged(\"systemConfigDisable\"))\n\t\treturn verifyTail(plugin,false,config.messages.pluginDisabled);\n\treturn true;\n}\n\nfunction verifyTail(plugin,result,message)\n{\n\tplugin.log.push(message);\n\treturn result;\n}\n\nfunction invokeMacro(place,macro,params,wikifier,tiddler)\n{\n\ttry {\n\t\tvar m = config.macros[macro];\n\t\tif(m && m.handler)\n\t\t\tm.handler(place,macro,params.readMacroParams(),wikifier,params,tiddler);\n\t\telse\n\t\t\tcreateTiddlyError(place,config.messages.macroError.format([macro]),config.messages.macroErrorDetails.format([macro,config.messages.missingMacro]));\n\t} catch(ex) {\n\t\tcreateTiddlyError(place,config.messages.macroError.format([macro]),config.messages.macroErrorDetails.format([macro,ex.toString()]));\n\t}\n}\n\n//--\n//-- Paramifiers\n//--\n\nfunction getParameters()\n{\n\tvar p = null;\n\tif(window.location.hash) {\n\t\tp = decodeURI(window.location.hash.substr(1));\n\t\tif(config.browser.firefoxDate != null && config.browser.firefoxDate[1] < \"20051111\")\n\t\t\tp = convertUTF8ToUnicode(p);\n\t}\n\treturn p;\n}\n\nfunction invokeParamifier(params,handler)\n{\n\tif(!params || params.length == undefined || params.length <= 1)\n\t\treturn;\n\tfor(var t=1; t<params.length; t++) {\n\t\tvar p = config.paramifiers[params[t].name];\n\t\tif(p && p[handler] instanceof Function)\n\t\t\tp[handler](params[t].value);\n\t}\n}\n\nconfig.paramifiers = {};\n\nconfig.paramifiers.start = {\n\toninit: function(v) {\n\t\tsafeMode = v.toLowerCase() == \"safe\";\n\t}\n};\n\nconfig.paramifiers.open = {\n\tonstart: function(v) {\n\t\tstory.displayTiddler(\"bottom\",v,null,false,null);\n\t}\n};\n\nconfig.paramifiers.story = {\n\tonstart: function(v) {\n\t\tvar list = store.getTiddlerText(v,\"\").parseParams(\"open\",null,false);\n\t\tinvokeParamifier(list,\"onstart\");\n\t}\n};\n\nconfig.paramifiers.search = {\n\tonstart: function(v) {\n\t\tstory.search(v,false,false);\n\t}\n};\n\nconfig.paramifiers.searchRegExp = {\n\tonstart: function(v) {\n\t\tstory.prototype.search(v,false,true);\n\t}\n};\n\nconfig.paramifiers.tag = {\n\tonstart: function(v) {\n\t\tvar tagged = store.getTaggedTiddlers(v,\"title\");\n\t\tfor(var t=0; t<tagged.length; t++)\n\t\t\tstory.displayTiddler(\"bottom\",tagged[t].title,null,false,null);\n\t}\n};\n\nconfig.paramifiers.newTiddler = {\n\tonstart: function(v) {\n\t\tif(!readOnly) {\n\t\t\tstory.displayTiddler(null,v,DEFAULT_EDIT_TEMPLATE);\n\t\t\tstory.focusTiddler(v,\"text\");\n\t\t}\n\t}\n};\n\nconfig.paramifiers.newJournal = {\n\tonstart: function(v) {\n\t\tif(!readOnly) {\n\t\t\tvar now = new Date();\n\t\t\tvar title = now.formatString(v.trim());\n\t\t\tstory.displayTiddler(null,title,DEFAULT_EDIT_TEMPLATE);\n\t\t\tstory.focusTiddler(title,\"text\");\n\t\t}\n\t}\n};\n\nconfig.paramifiers.readOnly = {\n\tonconfig: function(v) {\n\t\tvar p = v.toLowerCase();\n\t\treadOnly = p == \"yes\" ? true : (p == \"no\" ? false : readOnly);\n\t}\n};\n\n//--\n//-- Formatter helpers\n//--\n\nfunction Formatter(formatters)\n{\n\tthis.formatters = [];\n\tvar pattern = [];\n\tfor(var n=0; n<formatters.length; n++) {\n\t\tpattern.push(\"(\" + formatters[n].match + \")\");\n\t\tthis.formatters.push(formatters[n]);\n\t}\n\tthis.formatterRegExp = new RegExp(pattern.join(\"|\"),\"mg\");\n}\n\nconfig.formatterHelpers = {\n\n\tcreateElementAndWikify: function(w)\n\t{\n\t\tw.subWikifyTerm(createTiddlyElement(w.output,this.element),this.termRegExp);\n\t},\n\t\n\tinlineCssHelper: function(w)\n\t{\n\t\tvar styles = [];\n\t\tconfig.textPrimitives.cssLookaheadRegExp.lastIndex = w.nextMatch;\n\t\tvar lookaheadMatch = config.textPrimitives.cssLookaheadRegExp.exec(w.source);\n\t\twhile(lookaheadMatch && lookaheadMatch.index == w.nextMatch) {\n\t\t\tvar s,v;\n\t\t\tif(lookaheadMatch[1]) {\n\t\t\t\ts = lookaheadMatch[1].unDash();\n\t\t\t\tv = lookaheadMatch[2];\n\t\t\t} else {\n\t\t\t\ts = lookaheadMatch[3].unDash();\n\t\t\t\tv = lookaheadMatch[4];\n\t\t\t}\n\t\t\tif (s==\"bgcolor\")\n\t\t\t\ts = \"backgroundColor\";\n\t\t\tstyles.push({style: s, value: v});\n\t\t\tw.nextMatch = lookaheadMatch.index + lookaheadMatch[0].length;\n\t\t\tconfig.textPrimitives.cssLookaheadRegExp.lastIndex = w.nextMatch;\n\t\t\tlookaheadMatch = config.textPrimitives.cssLookaheadRegExp.exec(w.source);\n\t\t}\n\t\treturn styles;\n\t},\n\n\tapplyCssHelper: function(e,styles)\n\t{\n\t\tfor(var t=0; t< styles.length; t++) {\n\t\t\ttry {\n\t\t\t\te.style[styles[t].style] = styles[t].value;\n\t\t\t} catch (ex) {\n\t\t\t}\n\t\t}\n\t},\n\n\tenclosedTextHelper: function(w)\n\t{\n\t\tthis.lookaheadRegExp.lastIndex = w.matchStart;\n\t\tvar lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n\t\tif(lookaheadMatch && lookaheadMatch.index == w.matchStart) {\n\t\t\tvar text = lookaheadMatch[1];\n\t\t\tif(config.browser.isIE)\n\t\t\t\ttext = text.replace(/\\n/g,\"\\r\");\n\t\t\tcreateTiddlyElement(w.output,this.element,null,null,text);\n\t\t\tw.nextMatch = lookaheadMatch.index + lookaheadMatch[0].length;\n\t\t}\n\t},\n\n\tisExternalLink: function(link)\n\t{\n\t\tif(store.tiddlerExists(link) || store.isShadowTiddler(link)) {\n\t\t\treturn false;\n\t\t}\n\t\tvar urlRegExp = new RegExp(config.textPrimitives.urlPattern,\"mg\");\n\t\tif(urlRegExp.exec(link)) {\n\t\t\treturn true;\n\t\t}\n\t\tif (link.indexOf(\".\")!=-1 || link.indexOf(\"\\\\\")!=-1 || link.indexOf(\"/\")!=-1){\n\t\t\treturn true;\n\t\t}\n\t\treturn false;\n\t}\n\n};\n\n//--\n//-- Standard formatters\n//--\n\nconfig.formatters = [\n{\n\tname: \"table\",\n\tmatch: \"^\\\\|(?:[^\\\\n]*)\\\\|(?:[fhck]?)$\",\n\tlookaheadRegExp: /^\\|([^\\n]*)\\|([fhck]?)$/mg,\n\trowTermRegExp: /(\\|(?:[fhck]?)$\\n?)/mg,\n\tcellRegExp: /(?:\\|([^\\n\\|]*)\\|)|(\\|[fhck]?$\\n?)/mg,\n\tcellTermRegExp: /((?:\\x20*)\\|)/mg,\n\trowTypes: {\"c\":\"caption\", \"h\":\"thead\", \"\":\"tbody\", \"f\":\"tfoot\"},\n\n\thandler: function(w)\n\t{\n\t\tvar table = createTiddlyElement(w.output,\"table\",null,\"twtable\");\n\t\tvar prevColumns = [];\n\t\tvar currRowType = null;\n\t\tvar rowContainer;\n\t\tvar rowCount = 0;\n\t\tw.nextMatch = w.matchStart;\n\t\tthis.lookaheadRegExp.lastIndex = w.nextMatch;\n\t\tvar lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n\t\twhile(lookaheadMatch && lookaheadMatch.index == w.nextMatch) {\n\t\t\tvar nextRowType = lookaheadMatch[2];\n\t\t\tif(nextRowType == \"k\") {\n\t\t\t\ttable.className = lookaheadMatch[1];\n\t\t\t\tw.nextMatch += lookaheadMatch[0].length+1;\n\t\t\t} else {\n\t\t\t\tif(nextRowType != currRowType) {\n\t\t\t\t\trowContainer = createTiddlyElement(table,this.rowTypes[nextRowType]);\n\t\t\t\t\tcurrRowType = nextRowType;\n\t\t\t\t}\n\t\t\t\tif(currRowType == \"c\") {\n\t\t\t\t\t// Caption\n\t\t\t\t\tw.nextMatch++;\n\t\t\t\t\tif(rowContainer != table.firstChild)\n\t\t\t\t\t\ttable.insertBefore(rowContainer,table.firstChild);\n\t\t\t\t\trowContainer.setAttribute(\"align\",rowCount == 0?\"top\":\"bottom\");\n\t\t\t\t\tw.subWikifyTerm(rowContainer,this.rowTermRegExp);\n\t\t\t\t} else {\n\t\t\t\t\tthis.rowHandler(w,createTiddlyElement(rowContainer,\"tr\",null,(rowCount&1)?\"oddRow\":\"evenRow\"),prevColumns);\n\t\t\t\t\trowCount++;\n\t\t\t\t}\n\t\t\t}\n\t\t\tthis.lookaheadRegExp.lastIndex = w.nextMatch;\n\t\t\tlookaheadMatch = this.lookaheadRegExp.exec(w.source);\n\t\t}\n\t},\n\trowHandler: function(w,e,prevColumns)\n\t{\n\t\tvar col = 0;\n\t\tvar colSpanCount = 1;\n\t\tvar prevCell = null;\n\t\tthis.cellRegExp.lastIndex = w.nextMatch;\n\t\tvar cellMatch = this.cellRegExp.exec(w.source);\n\t\twhile(cellMatch && cellMatch.index == w.nextMatch) {\n\t\t\tif(cellMatch[1] == \"~\") {\n\t\t\t\t// Rowspan\n\t\t\t\tvar last = prevColumns[col];\n\t\t\t\tif(last) {\n\t\t\t\t\tlast.rowSpanCount++;\n\t\t\t\t\tlast.element.setAttribute(\"rowspan\",last.rowSpanCount);\n\t\t\t\t\tlast.element.setAttribute(\"rowSpan\",last.rowSpanCount); // Needed for IE\n\t\t\t\t\tlast.element.valign = \"center\";\n\t\t\t\t}\n\t\t\t\tw.nextMatch = this.cellRegExp.lastIndex-1;\n\t\t\t} else if(cellMatch[1] == \">\") {\n\t\t\t\t// Colspan\n\t\t\t\tcolSpanCount++;\n\t\t\t\tw.nextMatch = this.cellRegExp.lastIndex-1;\n\t\t\t} else if(cellMatch[2]) {\n\t\t\t\t// End of row\n\t\t\t\tif(prevCell && colSpanCount > 1) {\n\t\t\t\t\tprevCell.setAttribute(\"colspan\",colSpanCount);\n\t\t\t\t\tprevCell.setAttribute(\"colSpan\",colSpanCount); // Needed for IE\n\t\t\t\t}\n\t\t\t\tw.nextMatch = this.cellRegExp.lastIndex;\n\t\t\t\tbreak;\n\t\t\t} else {\n\t\t\t\t// Cell\n\t\t\t\tw.nextMatch++;\n\t\t\t\tvar styles = config.formatterHelpers.inlineCssHelper(w);\n\t\t\t\tvar spaceLeft = false;\n\t\t\t\tvar chr = w.source.substr(w.nextMatch,1);\n\t\t\t\twhile(chr == \" \") {\n\t\t\t\t\tspaceLeft = true;\n\t\t\t\t\tw.nextMatch++;\n\t\t\t\t\tchr = w.source.substr(w.nextMatch,1);\n\t\t\t\t}\n\t\t\t\tvar cell;\n\t\t\t\tif(chr == \"!\") {\n\t\t\t\t\tcell = createTiddlyElement(e,\"th\");\n\t\t\t\t\tw.nextMatch++;\n\t\t\t\t} else {\n\t\t\t\t\tcell = createTiddlyElement(e,\"td\");\n\t\t\t\t}\n\t\t\t\tprevCell = cell;\n\t\t\t\tprevColumns[col] = {rowSpanCount:1,element:cell};\n\t\t\t\tif(colSpanCount > 1) {\n\t\t\t\t\tcell.setAttribute(\"colspan\",colSpanCount);\n\t\t\t\t\tcell.setAttribute(\"colSpan\",colSpanCount); // Needed for IE\n\t\t\t\t\tcolSpanCount = 1;\n\t\t\t\t}\n\t\t\t\tconfig.formatterHelpers.applyCssHelper(cell,styles);\n\t\t\t\tw.subWikifyTerm(cell,this.cellTermRegExp);\n\t\t\t\tif(w.matchText.substr(w.matchText.length-2,1) == \" \") // spaceRight\n\t\t\t\t\tcell.align = spaceLeft ? \"center\" : \"left\";\n\t\t\t\telse if(spaceLeft)\n\t\t\t\t\tcell.align = \"right\";\n\t\t\t\tw.nextMatch--;\n\t\t\t}\n\t\t\tcol++;\n\t\t\tthis.cellRegExp.lastIndex = w.nextMatch;\n\t\t\tcellMatch = this.cellRegExp.exec(w.source);\n\t\t}\n\t}\n},\n\n{\n\tname: \"heading\",\n\tmatch: \"^!{1,6}\",\n\ttermRegExp: /(\\n)/mg,\n\thandler: function(w)\n\t{\n\t\tw.subWikifyTerm(createTiddlyElement(w.output,\"h\" + w.matchLength),this.termRegExp);\n\t}\n},\n\n{\n\tname: \"list\",\n\tmatch: \"^(?:[\\\\*#;:]+)\",\n\tlookaheadRegExp: /^(?:(?:(\\*)|(#)|(;)|(:))+)/mg,\n\ttermRegExp: /(\\n)/mg,\n\thandler: function(w)\n\t{\n\t\tvar stack = [w.output];\n\t\tvar currLevel = 0, currType = null;\n\t\tvar listLevel, listType, itemType;\n\t\tw.nextMatch = w.matchStart;\n\t\tthis.lookaheadRegExp.lastIndex = w.nextMatch;\n\t\tvar lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n\t\twhile(lookaheadMatch && lookaheadMatch.index == w.nextMatch) {\n\t\t\tif(lookaheadMatch[1]) {\n\t\t\t\tlistType = \"ul\";\n\t\t\t\titemType = \"li\";\n\t\t\t} else if(lookaheadMatch[2]) {\n\t\t\t\tlistType = \"ol\";\n\t\t\t\titemType = \"li\";\n\t\t\t} else if(lookaheadMatch[3]) {\n\t\t\t\tlistType = \"dl\";\n\t\t\t\titemType = \"dt\";\n\t\t\t} else if(lookaheadMatch[4]) {\n\t\t\t\tlistType = \"dl\";\n\t\t\t\titemType = \"dd\";\n\t\t\t}\n\t\t\tlistLevel = lookaheadMatch[0].length;\n\t\t\tw.nextMatch += lookaheadMatch[0].length;\n\t\t\tvar t;\n\t\t\tif(listLevel > currLevel) {\n\t\t\t\tfor(t=currLevel; t<listLevel; t++) {\n\t\t\t\t\tvar target = (currLevel == 0) ? stack[stack.length-1] : stack[stack.length-1].lastChild;\n\t\t\t\t\tstack.push(createTiddlyElement(target,listType));\n\t\t\t\t}\n\t\t\t} else if(listLevel < currLevel) {\n\t\t\t\tfor(t=currLevel; t>listLevel; t--)\n\t\t\t\t\tstack.pop();\n\t\t\t} else if(listLevel == currLevel && listType != currType) {\n\t\t\t\tstack.pop();\n\t\t\t\tstack.push(createTiddlyElement(stack[stack.length-1].lastChild,listType));\n\t\t\t}\n\t\t\tcurrLevel = listLevel;\n\t\t\tcurrType = listType;\n\t\t\tvar e = createTiddlyElement(stack[stack.length-1],itemType);\n\t\t\tw.subWikifyTerm(e,this.termRegExp);\n\t\t\tthis.lookaheadRegExp.lastIndex = w.nextMatch;\n\t\t\tlookaheadMatch = this.lookaheadRegExp.exec(w.source);\n\t\t}\n\t}\n},\n\n{\n\tname: \"quoteByBlock\",\n\tmatch: \"^<<<\\\\n\",\n\ttermRegExp: /(^<<<(\\n|$))/mg,\n\telement: \"blockquote\",\n\thandler: config.formatterHelpers.createElementAndWikify\n},\n\n{\n\tname: \"quoteByLine\",\n\tmatch: \"^>+\",\n\tlookaheadRegExp: /^>+/mg,\n\ttermRegExp: /(\\n)/mg,\n\telement: \"blockquote\",\n\thandler: function(w)\n\t{\n\t\tvar stack = [w.output];\n\t\tvar currLevel = 0;\n\t\tvar newLevel = w.matchLength;\n\t\tvar t;\n\t\tdo {\n\t\t\tif(newLevel > currLevel) {\n\t\t\t\tfor(t=currLevel; t<newLevel; t++)\n\t\t\t\t\tstack.push(createTiddlyElement(stack[stack.length-1],this.element));\n\t\t\t} else if(newLevel < currLevel) {\n\t\t\t\tfor(t=currLevel; t>newLevel; t--)\n\t\t\t\t\tstack.pop();\n\t\t\t}\n\t\t\tcurrLevel = newLevel;\n\t\t\tw.subWikifyTerm(stack[stack.length-1],this.termRegExp);\n\t\t\tcreateTiddlyElement(stack[stack.length-1],\"br\");\n\t\t\tthis.lookaheadRegExp.lastIndex = w.nextMatch;\n\t\t\tvar lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n\t\t\tvar matched = lookaheadMatch && lookaheadMatch.index == w.nextMatch;\n\t\t\tif(matched) {\n\t\t\t\tnewLevel = lookaheadMatch[0].length;\n\t\t\t\tw.nextMatch += lookaheadMatch[0].length;\n\t\t\t}\n\t\t} while(matched);\n\t}\n},\n\n{\n\tname: \"rule\",\n\tmatch: \"^----+$\\\\n?\",\n\thandler: function(w)\n\t{\n\t\tcreateTiddlyElement(w.output,\"hr\");\n\t}\n},\n\n{\n\tname: \"monospacedByLine\",\n\tmatch: \"^\\\\{\\\\{\\\\{\\\\n\",\n\tlookaheadRegExp: /^\\{\\{\\{\\n((?:^[^\\n]*\\n)+?)(^\\}\\}\\}$\\n?)/mg,\n\telement: \"pre\",\n\thandler: config.formatterHelpers.enclosedTextHelper\n},\n\n{\n\tname: \"monospacedByLineForCSS\",\n\tmatch: \"^/\\\\*\\\\{\\\\{\\\\{\\\\*/\\\\n\",\n\tlookaheadRegExp: /\\/\\*\\{\\{\\{\\*\\/\\n*((?:^[^\\n]*\\n)+?)(\\n*^\\/\\*\\}\\}\\}\\*\\/$\\n?)/mg,\n\telement: \"pre\",\n\thandler: config.formatterHelpers.enclosedTextHelper\n},\n\n{\n\tname: \"monospacedByLineForPlugin\",\n\tmatch: \"^//\\\\{\\\\{\\\\{\\\\n\",\n\tlookaheadRegExp: /^\\/\\/\\{\\{\\{\\n\\n*((?:^[^\\n]*\\n)+?)(\\n*^\\/\\/\\}\\}\\}$\\n?)/mg,\n\telement: \"pre\",\n\thandler: config.formatterHelpers.enclosedTextHelper\n},\n\n{\n\tname: \"monospacedByLineForTemplate\",\n\tmatch: \"^<!--\\\\{\\\\{\\\\{-->\\\\n\",\n\tlookaheadRegExp: /<!--\\{\\{\\{-->\\n*((?:^[^\\n]*\\n)+?)(\\n*^<!--\\}\\}\\}-->$\\n?)/mg,\n\telement: \"pre\",\n\thandler: config.formatterHelpers.enclosedTextHelper\n},\n\n{\n\tname: \"wikifyCommentForPlugin\",\n\tmatch: \"^/\\\\*\\\\*\\\\*\\\\n\",\n\ttermRegExp: /(^\\*\\*\\*\\/\\n)/mg,\n\thandler: function(w)\n\t{\n\t\tw.subWikifyTerm(w.output,this.termRegExp);\n\t}\n},\n\n{\n\tname: \"wikifyCommentForTemplate\",\n\tmatch: \"^<!---\\\\n\",\n\ttermRegExp: /(^--->\\n)/mg,\n\thandler: function(w) \n\t{\n\t\tw.subWikifyTerm(w.output,this.termRegExp);\n\t}\n},\n\n{\n\tname: \"macro\",\n\tmatch: \"<<\",\n\tlookaheadRegExp: /<<([^>\\s]+)(?:\\s*)((?:[^>]|(?:>(?!>)))*)>>/mg,\n\thandler: function(w)\n\t{\n\t\tthis.lookaheadRegExp.lastIndex = w.matchStart;\n\t\tvar lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n\t\tif(lookaheadMatch && lookaheadMatch.index == w.matchStart && lookaheadMatch[1]) {\n\t\t\tw.nextMatch = this.lookaheadRegExp.lastIndex;\n\t\t\tinvokeMacro(w.output,lookaheadMatch[1],lookaheadMatch[2],w,w.tiddler);\n\t\t}\n\t}\n},\n\n{\n\tname: \"prettyLink\",\n\tmatch: \"\\\\[\\\\[\",\n\tlookaheadRegExp: /\\[\\[(.*?)(?:\\|(~)?(.*?))?\\]\\]/mg,\n\thandler: function(w)\n\t{\n\t\tthis.lookaheadRegExp.lastIndex = w.matchStart;\n\t\tvar lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n\t\tif(lookaheadMatch && lookaheadMatch.index == w.matchStart) {\n\t\t\tvar e;\n\t\t\tvar text = lookaheadMatch[1];\n\t\t\tif(lookaheadMatch[3]) {\n\t\t\t\t// Pretty bracketted link\n\t\t\t\tvar link = lookaheadMatch[3];\n\t\t\t\te = (!lookaheadMatch[2] && config.formatterHelpers.isExternalLink(link)) ?\n\t\t\t\t\t\tcreateExternalLink(w.output,link) : createTiddlyLink(w.output,link,false,null,w.isStatic,w.tiddler);\n\t\t\t} else {\n\t\t\t\t// Simple bracketted link\n\t\t\t\te = createTiddlyLink(w.output,text,false,null,w.isStatic,w.tiddler);\n\t\t\t}\n\t\t\tcreateTiddlyText(e,text);\n\t\t\tw.nextMatch = this.lookaheadRegExp.lastIndex;\n\t\t}\n\t}\n},\n\n{\n\tname: \"unWikiLink\",\n\tmatch: config.textPrimitives.unWikiLink+config.textPrimitives.wikiLink,\n\thandler: function(w)\n\t{\n\t\tw.outputText(w.output,w.matchStart+1,w.nextMatch);\n\t}\n},\n\n{\n\tname: \"wikiLink\",\n\tmatch: config.textPrimitives.wikiLink,\n\thandler: function(w)\n\t{\n\t\tif(w.matchStart > 0) {\n\t\t\tvar preRegExp = new RegExp(config.textPrimitives.anyLetterStrict,\"mg\");\n\t\t\tpreRegExp.lastIndex = w.matchStart-1;\n\t\t\tvar preMatch = preRegExp.exec(w.source);\n\t\t\tif(preMatch.index == w.matchStart-1) {\n\t\t\t\tw.outputText(w.output,w.matchStart,w.nextMatch);\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\t\tif(w.autoLinkWikiWords == true || store.isShadowTiddler(w.matchText)) {\n\t\t\tvar link = createTiddlyLink(w.output,w.matchText,false,null,w.isStatic,w.tiddler);\n\t\t\tw.outputText(link,w.matchStart,w.nextMatch);\n\t\t} else {\n\t\t\tw.outputText(w.output,w.matchStart,w.nextMatch);\n\t\t}\n\t}\n},\n\n{\n\tname: \"urlLink\",\n\tmatch: config.textPrimitives.urlPattern,\n\thandler: function(w)\n\t{\n\t\tw.outputText(createExternalLink(w.output,w.matchText),w.matchStart,w.nextMatch);\n\t}\n},\n\n{\n\tname: \"image\",\n\tmatch: \"\\\\[[<>]?[Ii][Mm][Gg]\\\\[\",\n\tlookaheadRegExp: /\\[([<]?)(>?)[Ii][Mm][Gg]\\[(?:([^\\|\\]]+)\\|)?([^\\[\\]\\|]+)\\](?:\\[([^\\]]*)\\])?\\]/mg,\n\thandler: function(w)\n\t{\n\t\tthis.lookaheadRegExp.lastIndex = w.matchStart;\n\t\tvar lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n\t\tif(lookaheadMatch && lookaheadMatch.index == w.matchStart) {\n\t\t\tvar e = w.output;\n\t\t\tif(lookaheadMatch[5]) {\n\t\t\t\tvar link = lookaheadMatch[5];\n\t\t\t\te = config.formatterHelpers.isExternalLink(link) ? createExternalLink(w.output,link) : createTiddlyLink(w.output,link,false,null,w.isStatic,w.tiddler);\n\t\t\t\taddClass(e,\"imageLink\");\n\t\t\t}\n\t\t\tvar img = createTiddlyElement(e,\"img\");\n\t\t\tif(lookaheadMatch[1])\n\t\t\t\timg.align = \"left\";\n\t\t\telse if(lookaheadMatch[2])\n\t\t\t\timg.align = \"right\";\n\t\t\tif(lookaheadMatch[3])\n\t\t\t\timg.title = lookaheadMatch[3];\n\t\t\timg.src = lookaheadMatch[4];\n\t\t\tw.nextMatch = this.lookaheadRegExp.lastIndex;\n\t\t}\n\t}\n},\n\n{\n\tname: \"html\",\n\tmatch: \"<[Hh][Tt][Mm][Ll]>\",\n\tlookaheadRegExp: /<[Hh][Tt][Mm][Ll]>((?:.|\\n)*?)<\\/[Hh][Tt][Mm][Ll]>/mg,\n\thandler: function(w)\n\t{\n\t\tthis.lookaheadRegExp.lastIndex = w.matchStart;\n\t\tvar lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n\t\tif(lookaheadMatch && lookaheadMatch.index == w.matchStart) {\n\t\t\tcreateTiddlyElement(w.output,\"span\").innerHTML = lookaheadMatch[1];\n\t\t\tw.nextMatch = this.lookaheadRegExp.lastIndex;\n\t\t}\n\t}\n},\n\n{\n\tname: \"commentByBlock\",\n\tmatch: \"/%\",\n\tlookaheadRegExp: /\\/%((?:.|\\n)*?)%\\//mg,\n\thandler: function(w)\n\t{\n\t\tthis.lookaheadRegExp.lastIndex = w.matchStart;\n\t\tvar lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n\t\tif(lookaheadMatch && lookaheadMatch.index == w.matchStart)\n\t\t\tw.nextMatch = this.lookaheadRegExp.lastIndex;\n\t}\n},\n\n{\n\tname: \"boldByChar\",\n\tmatch: \"''\",\n\ttermRegExp: /('')/mg,\n\telement: \"strong\",\n\thandler: config.formatterHelpers.createElementAndWikify\n},\n\n{\n\tname: \"italicByChar\",\n\tmatch: \"//\",\n\ttermRegExp: /(\\/\\/)/mg,\n\telement: \"em\",\n\thandler: config.formatterHelpers.createElementAndWikify\n},\n\n{\n\tname: \"underlineByChar\",\n\tmatch: \"__\",\n\ttermRegExp: /(__)/mg,\n\telement: \"u\",\n\thandler: config.formatterHelpers.createElementAndWikify\n},\n\n{\n\tname: \"strikeByChar\",\n\tmatch: \"--(?!\\\\s|$)\",\n\ttermRegExp: /((?!\\s)--|(?=\\n\\n))/mg,\n\telement: \"strike\",\n\thandler: config.formatterHelpers.createElementAndWikify\n},\n\n{\n\tname: \"superscriptByChar\",\n\tmatch: \"\\\\^\\\\^\",\n\ttermRegExp: /(\\^\\^)/mg,\n\telement: \"sup\",\n\thandler: config.formatterHelpers.createElementAndWikify\n},\n\n{\n\tname: \"subscriptByChar\",\n\tmatch: \"~~\",\n\ttermRegExp: /(~~)/mg,\n\telement: \"sub\",\n\thandler: config.formatterHelpers.createElementAndWikify\n},\n\n{\n\tname: \"monospacedByChar\",\n\tmatch: \"\\\\{\\\\{\\\\{\",\n\tlookaheadRegExp: /\\{\\{\\{((?:.|\\n)*?)\\}\\}\\}/mg,\n\thandler: function(w)\n\t{\n\t\tthis.lookaheadRegExp.lastIndex = w.matchStart;\n\t\tvar lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n\t\tif(lookaheadMatch && lookaheadMatch.index == w.matchStart) {\n\t\t\tcreateTiddlyElement(w.output,\"code\",null,null,lookaheadMatch[1]);\n\t\t\tw.nextMatch = this.lookaheadRegExp.lastIndex;\n\t\t}\n\t}\n},\n\n{\n\tname: \"styleByChar\",\n\tmatch: \"@@\",\n\ttermRegExp: /(@@)/mg,\n\thandler: function(w)\n\t{\n\t\tvar e = createTiddlyElement(w.output,\"span\");\n\t\tvar styles = config.formatterHelpers.inlineCssHelper(w);\n\t\tif(styles.length == 0)\n\t\t\te.className = \"marked\";\n\t\telse\n\t\t\tconfig.formatterHelpers.applyCssHelper(e,styles);\n\t\tw.subWikifyTerm(e,this.termRegExp);\n\t}\n},\n\n{\n\tname: \"lineBreak\",\n\tmatch: \"\\\\n|<br ?/?>\",\n\thandler: function(w)\n\t{\n\t\tcreateTiddlyElement(w.output,\"br\");\n\t}\n},\n\n{\n\tname: \"rawText\",\n\tmatch: \"\\\\\\\"{3}|<nowiki>\",\n\tlookaheadRegExp: /(?:\\\"{3}|<nowiki>)((?:.|\\n)*?)(?:\\\"{3}|<\\/nowiki>)/mg,\n\thandler: function(w)\n\t{\n\t\tthis.lookaheadRegExp.lastIndex = w.matchStart;\n\t\tvar lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n\t\tif(lookaheadMatch && lookaheadMatch.index == w.matchStart) {\n\t\t\tcreateTiddlyElement(w.output,\"span\",null,null,lookaheadMatch[1]);\n\t\t\tw.nextMatch = this.lookaheadRegExp.lastIndex;\n\t\t}\n\t}\n},\n\n{\n\tname: \"mdash\",\n\tmatch: \"--\",\n\thandler: function(w)\n\t{\n\t\tcreateTiddlyElement(w.output,\"span\").innerHTML = \"&mdash;\";\n\t}\n},\n\n{\n\tname: \"htmlEntitiesEncoding\",\n\tmatch: \"(?:(?:&#?[a-zA-Z0-9]{2,8};|.)(?:&#?(?:x0*(?:3[0-6][0-9a-fA-F]|1D[c-fC-F][0-9a-fA-F]|20[d-fD-F][0-9a-fA-F]|FE2[0-9a-fA-F])|0*(?:76[89]|7[7-9][0-9]|8[0-7][0-9]|761[6-9]|76[2-7][0-9]|84[0-3][0-9]|844[0-7]|6505[6-9]|6506[0-9]|6507[0-1]));)+|&#?[a-zA-Z0-9]{2,8};)\",\n\thandler: function(w)\n\t{\n\t\tcreateTiddlyElement(w.output,\"span\").innerHTML = w.matchText;\n\t}\n},\n\n{\n\tname: \"customClasses\",\n\tmatch: \"\\\\{\\\\{\",\n\ttermRegExp: /(\\}\\}\\})/mg,\n\tlookaheadRegExp: /\\{\\{[\\s]*([\\w]+[\\s\\w]*)[\\s]*\\{(\\n?)/mg,\n\thandler: function(w)\n\t{\n\t\tthis.lookaheadRegExp.lastIndex = w.matchStart;\n\t\tvar lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n\t\tif(lookaheadMatch) {\n\t\t\tvar e = createTiddlyElement(w.output,lookaheadMatch[2] == \"\\n\" ? \"div\" : \"span\",null,lookaheadMatch[1]);\n\t\t\tw.nextMatch = this.lookaheadRegExp.lastIndex;\n\t\t\tw.subWikifyTerm(e,this.termRegExp);\n\t\t}\n\t}\n}\n\n];\n\n//--\n//-- Wikifier\n//--\n\nfunction getParser(tiddler,format)\n{\n\tif(tiddler) {\n\t\tif(!format)\n\t\t\tformat = tiddler.fields[\"wikiformat\"];\n\t\tif(format) {\n\t\t\tfor(var i in config.parsers) {\n\t\t\t\tif(format == config.parsers[i].format)\n\t\t\t\t\treturn config.parsers[i];\n\t\t\t}\n\t\t} else {\n\t\t\tfor(var i in config.parsers) {\n\t\t\t\tif(tiddler.isTagged(config.parsers[i].formatTag))\n\t\t\t\t\treturn config.parsers[i];\n\t\t\t}\n\t\t}\n\t}\n\treturn formatter;\n}\n\nfunction wikify(source,output,highlightRegExp,tiddler)\n{\n\tif(source && source != \"\") {\n\t\tvar wikifier = new Wikifier(source,getParser(tiddler),highlightRegExp,tiddler);\n\t\twikifier.subWikifyUnterm(output);\n\t}\n}\n\nfunction wikifyStatic(source,highlightRegExp,tiddler,format)\n{\n\tvar e = createTiddlyElement(document.body,\"div\");\n\te.style.display = \"none\";\n\tvar html = \"\";\n\tif(source && source != \"\") {\n\t\tvar wikifier = new Wikifier(source,getParser(tiddler,format),highlightRegExp,tiddler);\n\t\twikifier.isStatic = true;\n\t\twikifier.subWikifyUnterm(e);\n\t\thtml = e.innerHTML;\n\t\tremoveNode(e);\n\t}\n\treturn html;\n}\n\nfunction wikifyPlain(title,theStore,limit)\n{\n\tif(!theStore)\n\t\ttheStore = store;\n\tif(theStore.tiddlerExists(title) || theStore.isShadowTiddler(title)) {\n\t\treturn wikifyPlainText(theStore.getTiddlerText(title),limit,tiddler);\n\t} else {\n\t\treturn \"\";\n\t}\n}\n\nfunction wikifyPlainText(text,limit,tiddler)\n{\n\tif(limit > 0)\n\t\ttext = text.substr(0,limit);\n\tvar wikifier = new Wikifier(text,formatter,null,tiddler);\n\treturn wikifier.wikifyPlain();\n}\n\nfunction highlightify(source,output,highlightRegExp,tiddler)\n{\n\tif(source && source != \"\") {\n\t\tvar wikifier = new Wikifier(source,formatter,highlightRegExp,tiddler);\n\t\twikifier.outputText(output,0,source.length);\n\t}\n}\n\nfunction Wikifier(source,formatter,highlightRegExp,tiddler)\n{\n\tthis.source = source;\n\tthis.output = null;\n\tthis.formatter = formatter;\n\tthis.nextMatch = 0;\n\tthis.autoLinkWikiWords = tiddler && tiddler.autoLinkWikiWords() == false ? false : true;\n\tthis.highlightRegExp = highlightRegExp;\n\tthis.highlightMatch = null;\n\tthis.isStatic = false;\n\tif(highlightRegExp) {\n\t\thighlightRegExp.lastIndex = 0;\n\t\tthis.highlightMatch = highlightRegExp.exec(source);\n\t}\n\tthis.tiddler = tiddler;\n}\n\nWikifier.prototype.wikifyPlain = function()\n{\n\tvar e = createTiddlyElement(document.body,\"div\");\n\tthis.subWikify(e);\n\tvar text = getPlainText(e);\n\tremoveNode(e);\n\treturn text;\n};\n\nWikifier.prototype.subWikify = function(output,terminator)\n{\n\tif(terminator)\n\t\tthis.subWikifyTerm(output,new RegExp(\"(\" + terminator + \")\",\"mg\"));\n\telse\n\t\tthis.subWikifyUnterm(output);\n};\n\nWikifier.prototype.subWikifyUnterm = function(output)\n{\n\t// subWikify() can be indirectly recursive, so we need to save the old output pointer\n\tvar oldOutput = this.output;\n\tthis.output = output;\n\tthis.formatter.formatterRegExp.lastIndex = this.nextMatch;\n\tvar formatterMatch = this.formatter.formatterRegExp.exec(this.source);\n\twhile(formatterMatch) {\n\t\t// Output any text before the match\n\t\tif(formatterMatch.index > this.nextMatch)\n\t\t\tthis.outputText(this.output,this.nextMatch,formatterMatch.index);\n\t\t// Set the match parameters for the handler\n\t\tthis.matchStart = formatterMatch.index;\n\t\tthis.matchLength = formatterMatch[0].length;\n\t\tthis.matchText = formatterMatch[0];\n\t\tthis.nextMatch = this.formatter.formatterRegExp.lastIndex;\n\t\tfor(var t=1; t<formatterMatch.length; t++) {\n\t\t\tif(formatterMatch[t]) {\n\t\t\t\tthis.formatter.formatters[t-1].handler(this);\n\t\t\t\tthis.formatter.formatterRegExp.lastIndex = this.nextMatch;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\tformatterMatch = this.formatter.formatterRegExp.exec(this.source);\n\t}\n\tif(this.nextMatch < this.source.length) {\n\t\tthis.outputText(this.output,this.nextMatch,this.source.length);\n\t\tthis.nextMatch = this.source.length;\n\t}\n\tthis.output = oldOutput;\n};\n\nWikifier.prototype.subWikifyTerm = function(output,terminatorRegExp)\n{\n\t// subWikify() can be indirectly recursive, so we need to save the old output pointer\n\tvar oldOutput = this.output;\n\tthis.output = output;\n\t// Get the first matches for the formatter and terminator RegExps\n\tterminatorRegExp.lastIndex = this.nextMatch;\n\tvar terminatorMatch = terminatorRegExp.exec(this.source);\n\tthis.formatter.formatterRegExp.lastIndex = this.nextMatch;\n\tvar formatterMatch = this.formatter.formatterRegExp.exec(terminatorMatch ? this.source.substr(0,terminatorMatch.index) : this.source);\n\twhile(terminatorMatch || formatterMatch) {\n\t\tif(terminatorMatch && (!formatterMatch || terminatorMatch.index <= formatterMatch.index)) {\n\t\t\tif(terminatorMatch.index > this.nextMatch)\n\t\t\t\tthis.outputText(this.output,this.nextMatch,terminatorMatch.index);\n\t\t\tthis.matchText = terminatorMatch[1];\n\t\t\tthis.matchLength = terminatorMatch[1].length;\n\t\t\tthis.matchStart = terminatorMatch.index;\n\t\t\tthis.nextMatch = this.matchStart + this.matchLength;\n\t\t\tthis.output = oldOutput;\n\t\t\treturn;\n\t\t}\n\t\tif(formatterMatch.index > this.nextMatch)\n\t\t\tthis.outputText(this.output,this.nextMatch,formatterMatch.index);\n\t\tthis.matchStart = formatterMatch.index;\n\t\tthis.matchLength = formatterMatch[0].length;\n\t\tthis.matchText = formatterMatch[0];\n\t\tthis.nextMatch = this.formatter.formatterRegExp.lastIndex;\n\t\tfor(var t=1; t<formatterMatch.length; t++) {\n\t\t\tif(formatterMatch[t]) {\n\t\t\t\tthis.formatter.formatters[t-1].handler(this);\n\t\t\t\tthis.formatter.formatterRegExp.lastIndex = this.nextMatch;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\tterminatorRegExp.lastIndex = this.nextMatch;\n\t\tterminatorMatch = terminatorRegExp.exec(this.source);\n\t\tformatterMatch = this.formatter.formatterRegExp.exec(terminatorMatch ? this.source.substr(0,terminatorMatch.index) : this.source);\n\t}\n\tif(this.nextMatch < this.source.length) {\n\t\tthis.outputText(this.output,this.nextMatch,this.source.length);\n\t\tthis.nextMatch = this.source.length;\n\t}\n\tthis.output = oldOutput;\n};\n\nWikifier.prototype.outputText = function(place,startPos,endPos)\n{\n\twhile(this.highlightMatch && (this.highlightRegExp.lastIndex > startPos) && (this.highlightMatch.index < endPos) && (startPos < endPos)) {\n\t\tif(this.highlightMatch.index > startPos) {\n\t\t\tcreateTiddlyText(place,this.source.substring(startPos,this.highlightMatch.index));\n\t\t\tstartPos = this.highlightMatch.index;\n\t\t}\n\t\tvar highlightEnd = Math.min(this.highlightRegExp.lastIndex,endPos);\n\t\tvar theHighlight = createTiddlyElement(place,\"span\",null,\"highlight\",this.source.substring(startPos,highlightEnd));\n\t\tstartPos = highlightEnd;\n\t\tif(startPos >= this.highlightRegExp.lastIndex)\n\t\t\tthis.highlightMatch = this.highlightRegExp.exec(this.source);\n\t}\n\tif(startPos < endPos) {\n\t\tcreateTiddlyText(place,this.source.substring(startPos,endPos));\n\t}\n};\n\n//--\n//-- Macro definitions\n//--\n\nconfig.macros.today.handler = function(place,macroName,params)\n{\n\tvar now = new Date();\n\tvar text;\n\tif(params[0])\n\t\ttext = now.formatString(params[0].trim());\n\telse\n\t\ttext = now.toLocaleString();\n\tcreateTiddlyElement(place,\"span\",null,null,text);\n};\n\nconfig.macros.version.handler = function(place)\n{\n\tcreateTiddlyElement(place,\"span\",null,null,version.major + \".\" + version.minor + \".\" + version.revision + (version.beta ? \" (beta \" + version.beta + \")\" : \"\"));\n};\n\nconfig.macros.list.handler = function(place,macroName,params)\n{\n\tvar type = params[0] ? params[0] : \"all\";\n\tvar list = document.createElement(\"ul\");\n\tplace.appendChild(list);\n\tif(this[type].prompt)\n\t\tcreateTiddlyElement(list,\"li\",null,\"listTitle\",this[type].prompt);\n\tvar results;\n\tif(this[type].handler)\n\t\tresults = this[type].handler(params);\n\tfor(var t = 0; t < results.length; t++) {\n\t\tvar li = document.createElement(\"li\");\n\t\tlist.appendChild(li);\n\t\tcreateTiddlyLink(li,typeof results[t] == \"string\" ? results[t] : results[t].title,true);\n\t}\n};\n\nconfig.macros.list.all.handler = function(params)\n{\n\treturn store.reverseLookup(\"tags\",\"excludeLists\",false,\"title\");\n};\n\nconfig.macros.list.missing.handler = function(params)\n{\n\treturn store.getMissingLinks();\n};\n\nconfig.macros.list.orphans.handler = function(params)\n{\n\treturn store.getOrphans();\n};\n\nconfig.macros.list.shadowed.handler = function(params)\n{\n\treturn store.getShadowed();\n};\n\nconfig.macros.list.touched.handler = function(params)\n{\n\treturn store.getTouched();\n};\n\nconfig.macros.allTags.handler = function(place,macroName,params)\n{\n\tvar tags = store.getTags(params[0]);\n\tvar ul = createTiddlyElement(place,\"ul\");\n\tif(tags.length == 0)\n\t\tcreateTiddlyElement(ul,\"li\",null,\"listTitle\",this.noTags);\n\tfor(var t=0; t<tags.length; t++) {\n\t\tvar title = tags[t][0];\n\t\tvar info = getTiddlyLinkInfo(title);\n\t\tvar li =createTiddlyElement(ul,\"li\");\n\t\tvar btn = createTiddlyButton(li,title + \" (\" + tags[t][1] + \")\",this.tooltip.format([title]),onClickTag,info.classes);\n\t\tbtn.setAttribute(\"tag\",title);\n\t\tbtn.setAttribute(\"refresh\",\"link\");\n\t\tbtn.setAttribute(\"tiddlyLink\",title);\n\t}\n};\n\nconfig.macros.timeline.handler = function(place,macroName,params)\n{\n\tvar field = params[0] ? params[0] : \"modified\";\n\tvar tiddlers = store.reverseLookup(\"tags\",\"excludeLists\",false,field);\n\tvar lastDay = \"\";\n\tvar last = params[1] ? tiddlers.length-Math.min(tiddlers.length,parseInt(params[1])) : 0;\n\tfor(var t=tiddlers.length-1; t>=last; t--) {\n\t\tvar tiddler = tiddlers[t];\n\t\tvar theDay = tiddler[field].convertToLocalYYYYMMDDHHMM().substr(0,8);\n\t\tif(theDay != lastDay) {\n\t\t\tvar theDateList = document.createElement(\"ul\");\n\t\t\tplace.appendChild(theDateList);\n\t\t\tcreateTiddlyElement(theDateList,\"li\",null,\"listTitle\",tiddler[field].formatString(this.dateFormat));\n\t\t\tlastDay = theDay;\n\t\t}\n\t\tvar theDateListItem = createTiddlyElement(theDateList,\"li\",null,\"listLink\");\n\t\ttheDateListItem.appendChild(createTiddlyLink(place,tiddler.title,true));\n\t}\n};\n\nconfig.macros.search.handler = function(place,macroName,params)\n{\n\tvar searchTimeout = null;\n\tvar btn = createTiddlyButton(place,this.label,this.prompt,this.onClick);\n\tvar txt = createTiddlyElement(place,\"input\",null,\"txtOptionInput\");\n\tif(params[0])\n\t\ttxt.value = params[0];\n\ttxt.onkeyup = this.onKeyPress;\n\ttxt.onfocus = this.onFocus;\n\ttxt.setAttribute(\"size\",this.sizeTextbox);\n\ttxt.setAttribute(\"accessKey\",this.accessKey);\n\ttxt.setAttribute(\"autocomplete\",\"off\");\n\ttxt.setAttribute(\"lastSearchText\",\"\");\n\tif(config.browser.isSafari) {\n\t\ttxt.setAttribute(\"type\",\"search\");\n\t\ttxt.setAttribute(\"results\",\"5\");\n\t} else {\n\t\ttxt.setAttribute(\"type\",\"text\");\n\t}\n};\n\n// Global because there's only ever one outstanding incremental search timer\nconfig.macros.search.timeout = null;\n\nconfig.macros.search.doSearch = function(txt)\n{\n\tif(txt.value.length > 0) {\n\t\tstory.search(txt.value,config.options.chkCaseSensitiveSearch,config.options.chkRegExpSearch);\n\t\ttxt.setAttribute(\"lastSearchText\",txt.value);\n\t}\n};\n\nconfig.macros.search.onClick = function(e)\n{\n\tconfig.macros.search.doSearch(this.nextSibling);\n\treturn false;\n};\n\nconfig.macros.search.onKeyPress = function(e)\n{\n\tif(!e) var e = window.event;\n\tswitch(e.keyCode) {\n\t\tcase 13: // Ctrl-Enter\n\t\tcase 10: // Ctrl-Enter on IE PC\n\t\t\tconfig.macros.search.doSearch(this);\n\t\t\tbreak;\n\t\tcase 27: // Escape\n\t\t\tthis.value = \"\";\n\t\t\tclearMessage();\n\t\t\tbreak;\n\t}\n\tif(this.value.length > 2) {\n\t\tif(this.value != this.getAttribute(\"lastSearchText\")) {\n\t\t\tif(config.macros.search.timeout)\n\t\t\t\tclearTimeout(config.macros.search.timeout);\n\t\t\tvar txt = this;\n\t\t\tconfig.macros.search.timeout = setTimeout(function() {config.macros.search.doSearch(txt);},500);\n\t\t}\n\t} else {\n\t\tif(config.macros.search.timeout)\n\t\t\tclearTimeout(config.macros.search.timeout);\n\t}\n};\n\nconfig.macros.search.onFocus = function(e)\n{\n\tthis.select();\n};\n\nconfig.macros.tiddler.handler = function(place,macroName,params,wikifier,paramString,tiddler)\n{\n\tparams = paramString.parseParams(\"name\",null,true,false,true);\n\tvar names = params[0][\"name\"];\n\tvar tiddlerName = names[0];\n\tvar className = names[1] ? names[1] : null;\n\tvar args = params[0][\"with\"];\n\tvar wrapper = createTiddlyElement(place,\"span\",null,className);\n\tif(!args) {\n\t\twrapper.setAttribute(\"refresh\",\"content\");\n\t\twrapper.setAttribute(\"tiddler\",tiddlerName);\n\t}\n\tvar text = store.getTiddlerText(tiddlerName);\n\tif(text) {\n\t\tvar stack = config.macros.tiddler.tiddlerStack;\n\t\tif(stack.indexOf(tiddlerName) !== -1)\n\t\t\treturn;\n\t\tstack.push(tiddlerName);\n\t\ttry {\n\t\t\tvar n = args ? Math.min(args.length,9) : 0;\n\t\t\tfor(var i=0; i<n; i++) {\n\t\t\t\tvar placeholderRE = new RegExp(\"\\\\$\" + (i + 1),\"mg\");\n\t\t\t\ttext = text.replace(placeholderRE,args[i]);\n\t\t\t}\n\t\t\tconfig.macros.tiddler.renderText(wrapper,text,tiddlerName,params);\n\t\t} finally {\n\t\t\tstack.pop();\n\t\t}\n\t}\n};\n\nconfig.macros.tiddler.renderText = function(place,text,tiddlerName,params) \n{\n\twikify(text,place,null,store.getTiddler(tiddlerName));\n};\n\nconfig.macros.tiddler.tiddlerStack = [];\n\nconfig.macros.tag.handler = function(place,macroName,params)\n{\n\tcreateTagButton(place,params[0]);\n};\n\nconfig.macros.tags.handler = function(place,macroName,params,wikifier,paramString,tiddler)\n{\n\tparams = paramString.parseParams(\"anon\",null,true,false,false);\n\tvar theList = createTiddlyElement(place,\"ul\");\n\tvar title = getParam(params,\"anon\",\"\");\n\tif(title && store.tiddlerExists(title))\n\t\ttiddler = store.getTiddler(title);\n\tvar sep = getParam(params,\"sep\",\" \");\n\tvar lingo = config.views.wikified.tag;\n\tvar prompt = tiddler.tags.length == 0 ? lingo.labelNoTags : lingo.labelTags;\n\tcreateTiddlyElement(theList,\"li\",null,\"listTitle\",prompt.format([tiddler.title]));\n\tfor(var t=0; t<tiddler.tags.length; t++) {\n\t\tcreateTagButton(createTiddlyElement(theList,\"li\"),tiddler.tags[t],tiddler.title);\n\t\tif(t<tiddler.tags.length-1)\n\t\t\tcreateTiddlyText(theList,sep);\n\t}\n};\n\nconfig.macros.tagging.handler = function(place,macroName,params,wikifier,paramString,tiddler)\n{\n\tparams = paramString.parseParams(\"anon\",null,true,false,false);\n\tvar theList = createTiddlyElement(place,\"ul\");\n\tvar title = getParam(params,\"anon\",\"\");\n\tif(title == \"\" && tiddler instanceof Tiddler)\n\t\ttitle = tiddler.title;\n\tvar sep = getParam(params,\"sep\",\" \");\n\ttheList.setAttribute(\"title\",this.tooltip.format([title]));\n\tvar tagged = store.getTaggedTiddlers(title);\n\tvar prompt = tagged.length == 0 ? this.labelNotTag : this.label;\n\tcreateTiddlyElement(theList,\"li\",null,\"listTitle\",prompt.format([title,tagged.length]));\n\tfor(var t=0; t<tagged.length; t++) {\n\t\tcreateTiddlyLink(createTiddlyElement(theList,\"li\"),tagged[t].title,true);\n\t\tif(t<tagged.length-1)\n\t\t\tcreateTiddlyText(theList,sep);\n\t}\n};\n\nconfig.macros.closeAll.handler = function(place)\n{\n\tcreateTiddlyButton(place,this.label,this.prompt,this.onClick);\n};\n\nconfig.macros.closeAll.onClick = function(e)\n{\n\tstory.closeAllTiddlers();\n\treturn false;\n};\n\nconfig.macros.permaview.handler = function(place)\n{\n\tcreateTiddlyButton(place,this.label,this.prompt,this.onClick);\n};\n\nconfig.macros.permaview.onClick = function(e)\n{\n\tstory.permaView();\n\treturn false;\n};\n\nconfig.macros.saveChanges.handler = function(place)\n{\n\tif(!readOnly)\n\t\tcreateTiddlyButton(place,this.label,this.prompt,this.onClick,null,null,this.accessKey);\n};\n\nconfig.macros.saveChanges.onClick = function(e)\n{\n\tsaveChanges();\n\treturn false;\n};\n\nconfig.macros.slider.onClickSlider = function(e)\n{\n\tif(!e) var e = window.event;\n\tvar n = this.nextSibling;\n\tvar cookie = n.getAttribute(\"cookie\");\n\tvar isOpen = n.style.display != \"none\";\n\tif(config.options.chkAnimate && anim && typeof Slider == \"function\")\n\t\tanim.startAnimating(new Slider(n,!isOpen,null,\"none\"));\n\telse\n\t\tn.style.display = isOpen ? \"none\" : \"block\";\n\tconfig.options[cookie] = !isOpen;\n\tsaveOptionCookie(cookie);\n\treturn false;\n};\n\nconfig.macros.slider.createSlider = function(place,cookie,title,tooltip)\n{\n\tvar cookie = cookie ? cookie : \"\";\n\tvar btn = createTiddlyButton(place,title,tooltip,this.onClickSlider);\n\tvar panel = createTiddlyElement(null,\"div\",null,\"sliderPanel\");\n\tpanel.setAttribute(\"cookie\",cookie);\n\tpanel.style.display = config.options[cookie] ? \"block\" : \"none\";\n\tplace.appendChild(panel);\n\treturn panel;\n};\n\nconfig.macros.slider.handler = function(place,macroName,params)\n{\n\tvar panel = this.createSlider(place,params[0],params[2],params[3]);\n\tvar text = store.getTiddlerText(params[1]);\n\tpanel.setAttribute(\"refresh\",\"content\");\n\tpanel.setAttribute(\"tiddler\",params[1]);\n\tif(text)\n\t\twikify(text,panel,null,store.getTiddler(params[1]));\n};\n\nconfig.macros.option.genericCreate = function(place,type,opt,className,desc)\n{\n\tvar typeInfo = config.macros.option.types[type];\n\tvar c = document.createElement(typeInfo.elementType);\n\tif(typeInfo.typeValue)\n\t\tc.setAttribute(\"type\",typeInfo.typeValue);\n\tc[typeInfo.eventName] = typeInfo.onChange;\n\tc.setAttribute(\"option\",opt);\n\tif(className)\n\t\tc.className = className;\n\telse\n\t\tc.className = typeInfo.className;\n\tif(config.optionsDesc[opt])\n\t\tc.setAttribute(\"title\",config.optionsDesc[opt]);\n\tplace.appendChild(c);\n\tif(desc != \"no\")\n\t\tcreateTiddlyText(place,config.optionsDesc[opt] ? config.optionsDesc[opt] : opt);\n\tc[typeInfo.valueField] = config.options[opt];\n\treturn c;\n};\n\nconfig.macros.option.genericOnChange = function(e)\n{\n\tvar opt = this.getAttribute(\"option\");\n\tif(opt) {\n\t\tvar optType = opt.substr(0,3);\n\t\tvar handler = config.macros.option.types[optType];\n\t\tif (handler.elementType && handler.valueField)\n\t\t\tconfig.macros.option.propagateOption(opt,handler.valueField,this[handler.valueField],handler.elementType);\n\t\t}\n\treturn true;\n};\n\nconfig.macros.option.types = {\n\t'txt': {\n\t\telementType: \"input\",\n\t\tvalueField: \"value\",\n\t\teventName: \"onkeyup\",\n\t\tclassName: \"txtOptionInput\",\n\t\tcreate: config.macros.option.genericCreate,\n\t\tonChange: config.macros.option.genericOnChange\n\t},\n\t'chk': {\n\t\telementType: \"input\",\n\t\tvalueField: \"checked\",\n\t\teventName: \"onclick\",\n\t\tclassName: \"chkOptionInput\",\n\t\ttypeValue: \"checkbox\",\n\t\tcreate: config.macros.option.genericCreate,\n\t\tonChange: config.macros.option.genericOnChange\n\t}\n};\n\nconfig.macros.option.propagateOption = function(opt,valueField,value,elementType)\n{\n\tconfig.options[opt] = value;\n\tsaveOptionCookie(opt);\n\tvar nodes = document.getElementsByTagName(elementType);\n\tfor(var t=0; t<nodes.length; t++) {\n\t\tvar optNode = nodes[t].getAttribute(\"option\");\n\t\tif(opt == optNode)\n\t\t\tnodes[t][valueField] = value;\n\t\t}\n};\n\nconfig.macros.option.handler = function(place,macroName,params,wikifier,paramString,tiddler)\n{\n\tparams = paramString.parseParams(\"anon\",null,true,false,false);\n\tvar opt = (params[1] && params[1].name == \"anon\") ? params[1].value : getParam(params,\"name\",null);\n\tvar className = (params[2] && params[2].name == \"anon\") ? params[2].value : getParam(params,\"class\",null);\n\tvar desc = getParam(params,\"desc\",\"no\");\n\tvar type = opt.substr(0,3);\n\tvar h = config.macros.option.types[type];\n\tif (h && h.create)\n\t\th.create(place,type,opt,className,desc);\n};\n\nconfig.macros.options.handler = function(place,macroName,params,wikifier,paramString,tiddler)\n{\n\tparams = paramString.parseParams(\"anon\",null,true,false,false);\n\tvar showUnknown = getParam(params,\"showUnknown\",\"no\");\n\tvar wizard = new Wizard();\n\twizard.createWizard(place,this.wizardTitle);\n\twizard.addStep(this.step1Title,this.step1Html);\n\tvar markList = wizard.getElement(\"markList\");\n\tvar chkUnknown = wizard.getElement(\"chkUnknown\");\n\tchkUnknown.checked = showUnknown == \"yes\";\n\tchkUnknown.onchange = this.onChangeUnknown;\n\tvar listWrapper = document.createElement(\"div\");\n\tmarkList.parentNode.insertBefore(listWrapper,markList);\n\twizard.setValue(\"listWrapper\",listWrapper);\n\tthis.refreshOptions(listWrapper,showUnknown == \"yes\");\n};\n\nconfig.macros.options.refreshOptions = function(listWrapper,showUnknown)\n{\t\n\tvar opts = [];\n\tfor(var n in config.options) {\n\t\tvar opt = {};\n\t\topt.option = \"\";\n\t\topt.name = n;\n\t\topt.lowlight = !config.optionsDesc[n];\n\t\topt.description = opt.lowlight ? this.unknownDescription : config.optionsDesc[n];\n\t\tif(!opt.lowlight || showUnknown)\n\t\t\topts.push(opt);\n\t}\n\topts.sort(function(a,b) {return a.name.substr(3) < b.name.substr(3) ? -1 : (a.name.substr(3) == b.name.substr(3) ? 0 : +1);});\n\tvar listview = ListView.create(listWrapper,opts,this.listViewTemplate);\n\tfor(n=0; n<opts.length; n++) {\n\t\tvar type = opts[n].name.substr(0,3);\n\t\tvar h = config.macros.option.types[type];\n\t\tif (h && h.create) {\n\t\t\th.create(opts[n].colElements['option'],type,opts[n].name,null,\"no\");\n\t\t}\n\t}\n};\n\nconfig.macros.options.onChangeUnknown = function(e)\n{\n\tvar wizard = new Wizard(this);\n\tvar listWrapper = wizard.getValue(\"listWrapper\");\n\tremoveChildren(listWrapper);\n\tconfig.macros.options.refreshOptions(listWrapper,this.checked);\n\treturn false;\n};\n\nconfig.macros.newTiddler.createNewTiddlerButton = function(place,title,params,label,prompt,accessKey,newFocus,isJournal)\n{\n\tvar tags = [];\n\tfor(var t=1; t<params.length; t++) {\n\t\tif((params[t].name == \"anon\" && t != 1) || (params[t].name == \"tag\"))\n\t\t\ttags.push(params[t].value);\n\t}\n\tlabel = getParam(params,\"label\",label);\n\tprompt = getParam(params,\"prompt\",prompt);\n\taccessKey = getParam(params,\"accessKey\",accessKey);\n\tnewFocus = getParam(params,\"focus\",newFocus);\n\tvar customFields = getParam(params,\"fields\",\"\");\n\tif(!customFields && !store.isShadowTiddler(title))\n\t\tcustomFields = String.encodeHashMap(config.defaultCustomFields);\n\tvar btn = createTiddlyButton(place,label,prompt,this.onClickNewTiddler,null,null,accessKey);\n\tbtn.setAttribute(\"newTitle\",title);\n\tbtn.setAttribute(\"isJournal\",isJournal ? \"true\" : \"false\");\n\tif(tags.length > 0)\n\t\tbtn.setAttribute(\"params\",tags.join(\"|\"));\n\tbtn.setAttribute(\"newFocus\",newFocus);\n\tbtn.setAttribute(\"newTemplate\",getParam(params,\"template\",DEFAULT_EDIT_TEMPLATE));\n\tif(customFields !== \"\")\n\t\tbtn.setAttribute(\"customFields\",customFields);\n\tvar text = getParam(params,\"text\");\n\tif(text !== undefined) \n\t\tbtn.setAttribute(\"newText\",text);\n\treturn btn;\n};\n\nconfig.macros.newTiddler.onClickNewTiddler = function()\n{\n\tvar title = this.getAttribute(\"newTitle\");\n\tif(this.getAttribute(\"isJournal\") == \"true\") {\n\t\tvar now = new Date();\n\t\ttitle = now.formatString(title.trim());\n\t}\n\tvar params = this.getAttribute(\"params\");\n\tvar tags = params ? params.split(\"|\") : [];\n\tvar focus = this.getAttribute(\"newFocus\");\n\tvar template = this.getAttribute(\"newTemplate\");\n\tvar customFields = this.getAttribute(\"customFields\");\n\tstory.displayTiddler(null,title,template,false,null,null);\n\tvar tiddlerElem = document.getElementById(story.idPrefix + title);\n\tif(customFields)\n\t\tstory.addCustomFields(tiddlerElem,customFields);\n\tvar text = this.getAttribute(\"newText\");\n\tif(typeof text == \"string\")\n\t\tstory.getTiddlerField(title,\"text\").value = text.format([title]);\n\tfor(var t=0;t<tags.length;t++)\n\t\tstory.setTiddlerTag(title,tags[t],+1);\n\tstory.focusTiddler(title,focus);\n\treturn false;\n};\n\nconfig.macros.newTiddler.handler = function(place,macroName,params,wikifier,paramString,tiddler)\n{\n\tif(!readOnly) {\n\t\tparams = paramString.parseParams(\"anon\",null,true,false,false);\n\t\tvar title = params[1] && params[1].name == \"anon\" ? params[1].value : this.title;\n\t\ttitle = getParam(params,\"title\",title);\n\t\tthis.createNewTiddlerButton(place,title,params,this.label,this.prompt,this.accessKey,\"title\",false);\n\t}\n};\n\nconfig.macros.newJournal.handler = function(place,macroName,params,wikifier,paramString,tiddler)\n{\n\tif(!readOnly) {\n\t\tparams = paramString.parseParams(\"anon\",null,true,false,false);\n\t\tvar title = params[1] && params[1].name == \"anon\" ? params[1].value : \"\";\n\t\ttitle = getParam(params,\"title\",title);\n\t\tconfig.macros.newTiddler.createNewTiddlerButton(place,title,params,this.label,this.prompt,this.accessKey,\"text\",true);\n\t}\n};\n\nconfig.macros.sparkline.handler = function(place,macroName,params)\n{\n\tvar data = [];\n\tvar min = 0;\n\tvar max = 0;\n\tfor(var t=0; t<params.length; t++) {\n\t\tvar v = parseInt(params[t]);\n\t\tif(v < min)\n\t\t\tmin = v;\n\t\tif(v > max)\n\t\t\tmax = v;\n\t\tdata.push(v);\n\t}\n\tif(data.length < 1)\n\t\treturn;\n\tvar box = createTiddlyElement(place,\"span\",null,\"sparkline\",String.fromCharCode(160));\n\tbox.title = data.join(\",\");\n\tvar w = box.offsetWidth;\n\tvar h = box.offsetHeight;\n\tbox.style.paddingRight = (data.length * 2 - w) + \"px\";\n\tbox.style.position = \"relative\";\n\tfor(var d=0; d<data.length; d++) {\n\t\tvar tick = document.createElement(\"img\");\n\t\ttick.border = 0;\n\t\ttick.className = \"sparktick\";\n\t\ttick.style.position = \"absolute\";\n\t\ttick.src = \"data:image/gif,GIF89a%01%00%01%00%91%FF%00%FF%FF%FF%00%00%00%C0%C0%C0%00%00%00!%F9%04%01%00%00%02%00%2C%00%00%00%00%01%00%01%00%40%02%02T%01%00%3B\";\n\t\ttick.style.left = d*2 + \"px\";\n\t\ttick.style.width = \"2px\";\n\t\tvar v = Math.floor(((data[d] - min)/(max-min)) * h);\n\t\ttick.style.top = (h-v) + \"px\";\n\t\ttick.style.height = v + \"px\";\n\t\tbox.appendChild(tick);\n\t}\n};\n\nconfig.macros.tabs.handler = function(place,macroName,params)\n{\n\tvar cookie = params[0];\n\tvar numTabs = (params.length-1)/3;\n\tvar wrapper = createTiddlyElement(null,\"div\",null,cookie);\n\tvar tabset = createTiddlyElement(wrapper,\"div\",null,\"tabset\");\n\ttabset.setAttribute(\"cookie\",cookie);\n\tvar validTab = false;\n\tfor(var t=0; t<numTabs; t++) {\n\t\tvar label = params[t*3+1];\n\t\tvar prompt = params[t*3+2];\n\t\tvar content = params[t*3+3];\n\t\tvar tab = createTiddlyButton(tabset,label,prompt,this.onClickTab,\"tab tabUnselected\");\n\t\ttab.setAttribute(\"tab\",label);\n\t\ttab.setAttribute(\"content\",content);\n\t\ttab.title = prompt;\n\t\tif(config.options[cookie] == label)\n\t\t\tvalidTab = true;\n\t}\n\tif(!validTab)\n\t\tconfig.options[cookie] = params[1];\n\tplace.appendChild(wrapper);\n\tthis.switchTab(tabset,config.options[cookie]);\n};\n\nconfig.macros.tabs.onClickTab = function(e)\n{\n\tconfig.macros.tabs.switchTab(this.parentNode,this.getAttribute(\"tab\"));\n\treturn false;\n};\n\nconfig.macros.tabs.switchTab = function(tabset,tab)\n{\n\tvar cookie = tabset.getAttribute(\"cookie\");\n\tvar theTab = null;\n\tvar nodes = tabset.childNodes;\n\tfor(var t=0; t<nodes.length; t++) {\n\t\tif(nodes[t].getAttribute && nodes[t].getAttribute(\"tab\") == tab) {\n\t\t\ttheTab = nodes[t];\n\t\t\ttheTab.className = \"tab tabSelected\";\n\t\t} else {\n\t\t\tnodes[t].className = \"tab tabUnselected\";\n\t\t}\n\t}\n\tif(theTab) {\n\t\tif(tabset.nextSibling && tabset.nextSibling.className == \"tabContents\")\n\t\t\tremoveNode(tabset.nextSibling);\n\t\tvar tabContent = createTiddlyElement(null,\"div\",null,\"tabContents\");\n\t\ttabset.parentNode.insertBefore(tabContent,tabset.nextSibling);\n\t\tvar contentTitle = theTab.getAttribute(\"content\");\n\t\twikify(store.getTiddlerText(contentTitle),tabContent,null,store.getTiddler(contentTitle));\n\t\tif(cookie) {\n\t\t\tconfig.options[cookie] = tab;\n\t\t\tsaveOptionCookie(cookie);\n\t\t}\n\t}\n};\n\n// <<gradient [[tiddler name]] vert|horiz rgb rgb rgb rgb... >>\nconfig.macros.gradient.handler = function(place,macroName,params,wikifier)\n{\n\tvar terminator = \">>\";\n\tvar panel;\n\tif(wikifier)\n\t\tpanel = createTiddlyElement(place,\"div\",null,\"gradient\");\n\telse\n\t\tpanel = place;\n\tpanel.style.position = \"relative\";\n\tpanel.style.overflow = \"hidden\";\n\tpanel.style.zIndex = \"0\";\n\tvar t;\n\tif(wikifier) {\n\t\tvar styles = config.formatterHelpers.inlineCssHelper(wikifier);\n\t\tconfig.formatterHelpers.applyCssHelper(panel,styles);\n\t}\n\tvar colours = [];\n\tfor(t=1; t<params.length; t++) {\n\t\tvar c = new RGB(params[t]);\n\t\tif(c)\n\t\t\tcolours.push(c);\n\t}\n\tdrawGradient(panel,params[0] != \"vert\",colours);\n\tif(wikifier)\n\t\twikifier.subWikify(panel,terminator);\n\tif(document.all) {\n\t\tpanel.style.height = \"100%\";\n\t\tpanel.style.width = \"100%\";\n\t}\n};\n\nconfig.macros.message.handler = function(place,macroName,params)\n{\n\tif(params[0]) {\n\t\tvar m = config;\n\t\tvar p = params[0].split(\".\");\n\t\tfor(var t=0; t<p.length; t++) {\n\t\t\tif(p[t] in m)\n\t\t\t\tm = m[p[t]];\n\t\t\telse\n\t\t\t\tbreak;\n\t\t}\n\t\tcreateTiddlyText(place,m.toString().format(params.splice(1)));\n\t}\n};\n\nconfig.macros.view.handler = function(place,macroName,params,wikifier,paramString,tiddler)\n{\n\tif((tiddler instanceof Tiddler) && params[0]) {\n\t\tvar value = store.getValue(tiddler,params[0]);\n\t\tif(value != undefined) {\n\t\t\tswitch(params[1]) {\n\t\t\t\tcase undefined:\n\t\t\t\t\thighlightify(value,place,highlightHack,tiddler);\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"link\":\n\t\t\t\t\tcreateTiddlyLink(place,value,true);\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"wikified\":\n\t\t\t\t\twikify(value,place,highlightHack,tiddler);\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"date\":\n\t\t\t\t\tvalue = Date.convertFromYYYYMMDDHHMM(value);\n\t\t\t\t\tcreateTiddlyText(place,value.formatString(params[2] ? params[2] : config.views.wikified.dateFormat));\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n};\n\nconfig.macros.edit.handler = function(place,macroName,params,wikifier,paramString,tiddler)\n{\n\tvar field = params[0];\n\tvar rows = params[1];\n\tif((tiddler instanceof Tiddler) && field) {\n\t\tstory.setDirty(tiddler.title,true);\n\t\tif(field != \"text\" && !rows) {\n\t\t\tvar e = createTiddlyElement(null,\"input\");\n\t\t\tif(tiddler.isReadOnly())\n\t\t\t\te.setAttribute(\"readOnly\",\"readOnly\");\n\t\t\te.setAttribute(\"edit\",field);\n\t\t\te.setAttribute(\"type\",\"text\");\n\t\t\tvar v = store.getValue(tiddler,field);\n\t\t\tif(!v) \n\t\t\t\tv = \"\";\n\t\t\te.value = v;\n\t\t\te.setAttribute(\"size\",\"40\");\n\t\t\te.setAttribute(\"autocomplete\",\"off\");\n\t\t\tplace.appendChild(e);\n\t\t} else {\n\t\t\tvar wrapper1 = createTiddlyElement(null,\"fieldset\",null,\"fieldsetFix\");\n\t\t\tvar wrapper2 = createTiddlyElement(wrapper1,\"div\");\n\t\t\tvar e = createTiddlyElement(wrapper2,\"textarea\");\n\t\t\tif(tiddler.isReadOnly())\n\t\t\t\te.setAttribute(\"readOnly\",\"readOnly\");\n\t\t\tvar v = store.getValue(tiddler,field);\n\t\t\tif(!v) \n\t\t\t\tv = \"\";\n\t\t\te.value = v;\n\t\t\tvar rows = rows ? rows : 10;\n\t\t\tvar lines = v.match(/\\n/mg);\n\t\t\tvar maxLines = Math.max(parseInt(config.options.txtMaxEditRows),5);\n\t\t\tif(lines != null && lines.length > rows)\n\t\t\t\trows = lines.length + 5;\n\t\t\trows = Math.min(rows,maxLines);\n\t\t\te.setAttribute(\"rows\",rows);\n\t\t\te.setAttribute(\"edit\",field);\n\t\t\tplace.appendChild(wrapper1);\n\t\t}\n\t}\n};\n\nconfig.macros.tagChooser.onClick = function(e)\n{\n\tif(!e) var e = window.event;\n\tvar lingo = config.views.editor.tagChooser;\n\tvar popup = Popup.create(this);\n\tvar tags = store.getTags();\n\tif(tags.length == 0)\n\t\tcreateTiddlyText(createTiddlyElement(popup,\"li\"),lingo.popupNone);\n\tfor(var t=0; t<tags.length; t++) {\n\t\tvar theTag = createTiddlyButton(createTiddlyElement(popup,\"li\"),tags[t][0],lingo.tagTooltip.format([tags[t][0]]),config.macros.tagChooser.onTagClick);\n\t\ttheTag.setAttribute(\"tag\",tags[t][0]);\n\t\ttheTag.setAttribute(\"tiddler\",this.getAttribute(\"tiddler\"));\n\t}\n\tPopup.show();\n\te.cancelBubble = true;\n\tif(e.stopPropagation) e.stopPropagation();\n\treturn false;\n};\n\nconfig.macros.tagChooser.onTagClick = function(e)\n{\n\tif(!e) var e = window.event;\n\tvar tag = this.getAttribute(\"tag\");\n\tvar title = this.getAttribute(\"tiddler\");\n\tif(!readOnly)\n\t\tstory.setTiddlerTag(title,tag,0);\n\treturn false;\n};\n\nconfig.macros.tagChooser.handler = function(place,macroName,params,wikifier,paramString,tiddler)\n{\n\tif(tiddler instanceof Tiddler) {\n\t\tvar title = tiddler.title;\n\t\tvar lingo = config.views.editor.tagChooser;\n\t\tvar btn = createTiddlyButton(place,lingo.text,lingo.tooltip,this.onClick);\n\t\tbtn.setAttribute(\"tiddler\",title);\n\t}\n};\n\n// Create a toolbar command button\nconfig.macros.toolbar.createCommand = function(place,commandName,tiddler,theClass)\n{\n\tif(typeof commandName != \"string\") {\n\t\tvar c = null;\n\t\tfor(var t in config.commands) {\n\t\t\tif(config.commands[t] == commandName)\n\t\t\t\tc = t;\n\t\t}\n\t\tcommandName = c;\n\t}\n\tif((tiddler instanceof Tiddler) && (typeof commandName == \"string\")) {\n\t\tvar command = config.commands[commandName];\n\t\tif(command.isEnabled ? command.isEnabled(tiddler) : this.isCommandEnabled(command,tiddler)) {\n\t\t\tvar text = command.getText ? command.getText(tiddler) : this.getCommandText(command,tiddler);\n\t\t\tvar tooltip = command.getTooltip ? command.getTooltip(tiddler) : this.getCommandTooltip(command,tiddler);\n\t\t\tvar cmd;\n\t\t\tswitch(command.type) {\n\t\t\t\tcase \"popup\":\n\t\t\t\t\tcmd = this.onClickPopup;\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"command\":\n\t\t\t\tdefault:\n\t\t\t\t\tcmd = this.onClickCommand;\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t\tvar btn = createTiddlyButton(null,text,tooltip,cmd);\n\t\t\tbtn.setAttribute(\"commandName\",commandName);\n\t\t\tbtn.setAttribute(\"tiddler\",tiddler.title);\n\t\t\tif(theClass)\n\t\t\t\taddClass(btn,theClass);\n\t\t\tplace.appendChild(btn);\n\t\t}\n\t}\n};\n\nconfig.macros.toolbar.isCommandEnabled = function(command,tiddler)\n{\n\tvar title = tiddler.title;\n\tvar ro = tiddler.isReadOnly();\n\tvar shadow = store.isShadowTiddler(title) && !store.tiddlerExists(title);\n\treturn (!ro || (ro && !command.hideReadOnly)) && !(shadow && command.hideShadow);\n};\n\nconfig.macros.toolbar.getCommandText = function(command,tiddler)\n{\n\treturn tiddler.isReadOnly() && command.readOnlyText ? command.readOnlyText : command.text;\n};\n\nconfig.macros.toolbar.getCommandTooltip = function(command,tiddler)\n{\n\treturn tiddler.isReadOnly() && command.readOnlyTooltip ? command.readOnlyTooltip : command.tooltip;\n};\n\nconfig.macros.toolbar.onClickCommand = function(e)\n{\n\tif(!e) var e = window.event;\n\te.cancelBubble = true;\n\tif (e.stopPropagation) e.stopPropagation();\n\tvar command = config.commands[this.getAttribute(\"commandName\")];\n\treturn command.handler(e,this,this.getAttribute(\"tiddler\"));\n};\n\nconfig.macros.toolbar.onClickPopup = function(e)\n{\n\tif(!e) var e = window.event;\n\te.cancelBubble = true;\n\tif (e.stopPropagation) e.stopPropagation();\n\tvar popup = Popup.create(this);\n\tvar command = config.commands[this.getAttribute(\"commandName\")];\n\tvar title = this.getAttribute(\"tiddler\");\n\tvar tiddler = store.fetchTiddler(title);\n\tpopup.setAttribute(\"tiddler\",title);\n\tcommand.handlePopup(popup,title);\n\tPopup.show();\n\treturn false;\n};\n\n// Invoke the first command encountered from a given place that is tagged with a specified class\nconfig.macros.toolbar.invokeCommand = function(place,theClass,event)\n{\n\tvar children = place.getElementsByTagName(\"a\");\n\tfor(var t=0; t<children.length; t++) {\n\t\tvar c = children[t];\n\t\tif(hasClass(c,theClass) && c.getAttribute && c.getAttribute(\"commandName\")) {\n\t\t\tif(c.onclick instanceof Function)\n\t\t\t\tc.onclick.call(c,event);\n\t\t\tbreak;\n\t\t}\n\t}\n};\n\nconfig.macros.toolbar.onClickMore = function(e)\n{\n\tvar e = this.nextSibling;\n\te.style.display = \"inline\";\n\tremoveNode(this);\n\treturn false;\n};\n\nconfig.macros.toolbar.handler = function(place,macroName,params,wikifier,paramString,tiddler)\n{\n\tfor(var t=0; t<params.length; t++) {\n\t\tvar c = params[t];\n\t\tswitch(c) {\n\t\t\tcase '>':\n\t\t\t\tvar btn = createTiddlyButton(place,this.moreLabel,this.morePrompt,config.macros.toolbar.onClickMore);\n\t\t\t\taddClass(btn,\"moreCommand\");\n\t\t\t\tvar e = createTiddlyElement(place,\"span\",null,\"moreCommand\");\n\t\t\t\te.style.display = \"none\";\n\t\t\t\tplace = e;\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tvar theClass = \"\";\n\t\t\t\tswitch(c.substr(0,1)) {\n\t\t\t\t\tcase \"+\":\n\t\t\t\t\t\ttheClass = \"defaultCommand\";\n\t\t\t\t\t\tc = c.substr(1);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase \"-\":\n\t\t\t\t\t\ttheClass = \"cancelCommand\";\n\t\t\t\t\t\tc = c.substr(1);\n\t\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tif(c in config.commands)\n\t\t\t\t\tthis.createCommand(place,c,tiddler,theClass);\n\t\t\t\tbreak;\n\t\t}\n\t}\n};\n\nconfig.macros.refreshDisplay.handler = function(place)\n{\n\tcreateTiddlyButton(place,this.label,this.prompt,this.onClick);\n};\n\nconfig.macros.refreshDisplay.onClick = function(e)\n{\n\trefreshAll();\n\treturn false;\n};\n\nconfig.macros.annotations.handler = function(place,macroName,params,wikifier,paramString,tiddler)\n{\n\tvar title = tiddler ? tiddler.title : null;\n\tvar a = title ? config.annotations[title] : null;\n\tif(!tiddler || !title || !a)\n\t\treturn;\n\tvar text = a.format([title]);\n\twikify(text,createTiddlyElement(place,\"div\",null,\"annotation\"),null,tiddler);\n};\n\n//--\n//-- Menu and toolbar commands\n//--\n\nconfig.commands.closeTiddler.handler = function(event,src,title)\n{\n\tstory.closeTiddler(title,true);\n\treturn false;\n};\n\nconfig.commands.closeOthers.handler = function(event,src,title)\n{\n\tstory.closeAllTiddlers(title);\n\treturn false;\n};\n\nconfig.commands.editTiddler.handler = function(event,src,title)\n{\n\tclearMessage();\n\tvar tiddlerElem = document.getElementById(story.idPrefix + title);\n\tvar fields = tiddlerElem.getAttribute(\"tiddlyFields\");\n\tstory.displayTiddler(null,title,DEFAULT_EDIT_TEMPLATE,false,null,fields);\n\tstory.focusTiddler(title,\"text\");\n\treturn false;\n};\n\nconfig.commands.saveTiddler.handler = function(event,src,title)\n{\n\tvar newTitle = story.saveTiddler(title,event.shiftKey);\n\tif(newTitle)\n\t\tstory.displayTiddler(null,newTitle);\n\treturn false;\n};\n\nconfig.commands.cancelTiddler.handler = function(event,src,title)\n{\n\tif(story.hasChanges(title) && !readOnly) {\n\t\tif(!confirm(this.warning.format([title])))\n\t\t\treturn false;\n\t}\n\tstory.setDirty(title,false);\n\tstory.displayTiddler(null,title);\n\treturn false;\n};\n\nconfig.commands.deleteTiddler.handler = function(event,src,title)\n{\n\tvar deleteIt = true;\n\tif (config.options.chkConfirmDelete)\n\t\tdeleteIt = confirm(this.warning.format([title]));\n\tif (deleteIt) {\n\t\tstore.removeTiddler(title);\n\t\tstory.closeTiddler(title,true);\n\t\tautoSaveChanges();\n\t}\n\treturn false;\n};\n\nconfig.commands.permalink.handler = function(event,src,title)\n{\n\tvar t = encodeURIComponent(String.encodeTiddlyLink(title));\n\tif(window.location.hash != t)\n\t\twindow.location.hash = t;\n\treturn false;\n};\n\nconfig.commands.references.handlePopup = function(popup,title)\n{\n\tvar references = store.getReferringTiddlers(title);\n\tvar c = false;\n\tfor(var r=0; r<references.length; r++) {\n\t\tif(references[r].title != title && !references[r].isTagged(\"excludeLists\")) {\n\t\t\tcreateTiddlyLink(createTiddlyElement(popup,\"li\"),references[r].title,true);\n\t\t\tc = true;\n\t\t}\n\t}\n\tif(!c)\n\t\tcreateTiddlyText(createTiddlyElement(popup,\"li\",null,\"disabled\"),this.popupNone);\n};\n\nconfig.commands.jump.handlePopup = function(popup,title)\n{\n\tstory.forEachTiddler(function(title,element) {\n\t\tcreateTiddlyLink(createTiddlyElement(popup,\"li\"),title,true,null,false,null,true);\n\t\t});\n};\n\nconfig.commands.syncing.handlePopup = function(popup,title)\n{\n\tvar tiddler = store.fetchTiddler(title);\n\tif(!tiddler)\n\t\treturn;\n\tvar serverType = tiddler.getServerType();\n\tvar serverHost = tiddler.fields['server.host'];\n\tvar serverWorkspace = tiddler.fields['server.workspace'];\n\tif(!serverWorkspace)\n\t\tserverWorkspace = \"\";\n\tif(serverType) {\n\t\tvar e = createTiddlyElement(popup,\"li\",null,\"popupMessage\");\n\t\te.innerHTML = config.commands.syncing.currentlySyncing.format([serverType,serverHost,serverWorkspace]);\n\t} else {\n\t\tcreateTiddlyElement(popup,\"li\",null,\"popupMessage\",config.commands.syncing.notCurrentlySyncing);\n\t}\n\tif(serverType) {\n\t\tcreateTiddlyElement(createTiddlyElement(popup,\"li\",null,\"listBreak\"),\"div\");\n\t\tvar btn = createTiddlyButton(createTiddlyElement(popup,\"li\"),this.captionUnSync,null,config.commands.syncing.onChooseServer);\n\t\tbtn.setAttribute(\"tiddler\",title);\n\t\tbtn.setAttribute(\"server.type\",\"\");\n\t}\n\tcreateTiddlyElement(createTiddlyElement(popup,\"li\",null,\"listBreak\"),\"div\");\n\tcreateTiddlyElement(popup,\"li\",null,\"popupMessage\",config.commands.syncing.chooseServer);\n\tvar feeds = store.getTaggedTiddlers(\"systemServer\",\"title\");\n\tfor(var t=0; t<feeds.length; t++) {\n\t\tvar f = feeds[t];\n\t\tvar feedServerType = store.getTiddlerSlice(f.title,\"Type\");\n\t\tif(!feedServerType)\n\t\t\tfeedServerType = \"file\";\n\t\tvar feedServerHost = store.getTiddlerSlice(f.title,\"URL\");\n\t\tif(!feedServerHost)\n\t\t\tfeedServerHost = \"\";\n\t\tvar feedServerWorkspace = store.getTiddlerSlice(f.title,\"Workspace\");\n\t\tif(!feedServerWorkspace)\n\t\t\tfeedServerWorkspace = \"\";\n\t\tvar caption = f.title;\n\t\tif(serverType == feedServerType && serverHost == feedServerHost && serverWorkspace == feedServerWorkspace) {\n\t\t\tcaption = config.commands.syncing.currServerMarker + caption;\n\t\t} else {\n\t\t\tcaption = config.commands.syncing.notCurrServerMarker + caption;\n\t\t}\n\t\tbtn = createTiddlyButton(createTiddlyElement(popup,\"li\"),caption,null,config.commands.syncing.onChooseServer);\n\t\tbtn.setAttribute(\"tiddler\",title);\n\t\tbtn.setAttribute(\"server.type\",feedServerType);\n\t\tbtn.setAttribute(\"server.host\",feedServerHost);\n\t\tbtn.setAttribute(\"server.workspace\",feedServerWorkspace);\n\t}\n};\n\nconfig.commands.syncing.onChooseServer = function(e)\n{\n\tvar tiddler = this.getAttribute(\"tiddler\");\n\tvar serverType = this.getAttribute(\"server.type\");\n\tif(serverType) {\n\t\tstore.addTiddlerFields(tiddler,{\n\t\t\t'server.type': serverType,\n\t\t\t'server.host': this.getAttribute(\"server.host\"),\n\t\t\t'server.workspace': this.getAttribute(\"server.workspace\")\n\t\t\t});\n\t} else {\n\t\tstore.setValue(tiddler,'server',null);\n\t}\n\treturn false;\n};\n\nconfig.commands.fields.handlePopup = function(popup,title)\n{\n\tvar tiddler = store.fetchTiddler(title);\n\tif(!tiddler)\n\t\treturn;\n\tvar fields = {};\n\tstore.forEachField(tiddler,function(tiddler,fieldName,value) {fields[fieldName] = value;},true);\n\tvar items = [];\n\tfor(var t in fields) {\n\t\titems.push({field: t,value: fields[t]});\n\t}\n\titems.sort(function(a,b) {return a.field < b.field ? -1 : (a.field == b.field ? 0 : +1);});\n\tif(items.length > 0)\n\t\tListView.create(popup,items,this.listViewTemplate);\n\telse\n\t\tcreateTiddlyElement(popup,\"div\",null,null,this.emptyText);\n};\n\n//--\n//-- Tiddler() object\n//--\n\nfunction Tiddler(title)\n{\n\tthis.title = title;\n\tthis.text = null;\n\tthis.modifier = null;\n\tthis.modified = new Date();\n\tthis.created = new Date();\n\tthis.links = [];\n\tthis.linksUpdated = false;\n\tthis.tags = [];\n\tthis.fields = {};\n\treturn this;\n}\n\nTiddler.prototype.getLinks = function()\n{\n\tif(this.linksUpdated==false)\n\t\tthis.changed();\n\treturn this.links;\n};\n\n// Returns the fields that are inherited in string field:\"value\" field2:\"value2\" format\nTiddler.prototype.getInheritedFields = function()\n{\n\tvar f = {};\n\tfor(i in this.fields) {\n\t\tif(i==\"server.host\" || i==\"server.workspace\" || i==\"wikiformat\"|| i==\"server.type\") {\n\t\t\tf[i] = this.fields[i];\n\t\t}\n\t}\n\treturn String.encodeHashMap(f);\n};\n\n// Increment the changeCount of a tiddler\nTiddler.prototype.incChangeCount = function()\n{\n\tvar c = this.fields['changecount'];\n\tc = c ? parseInt(c) : 0;\n\tthis.fields['changecount'] = String(c+1);\n};\n\n// Clear the changeCount of a tiddler\nTiddler.prototype.clearChangeCount = function()\n{\n\tif(this.fields['changecount']) {\n\t\tdelete this.fields['changecount'];\n\t}\n};\n\n// Returns true if the tiddler has been updated since the tiddler was created or downloaded\nTiddler.prototype.isTouched = function()\n{\n\tvar changeCount = this.fields['changecount'];\n\tif(changeCount === undefined)\n\t\tchangeCount = 0;\n\treturn changeCount > 0;\n};\n\n// Format the text for storage in an RSS item\nTiddler.prototype.saveToRss = function(url)\n{\n\tvar s = [];\n\ts.push(\"<item>\");\n\ts.push(\"<title\" + \">\" + this.title.htmlEncode() + \"</title\" + \">\");\n\ts.push(\"<description>\" + wikifyStatic(this.text,null,this).htmlEncode() + \"</description>\");\n\tfor(var t=0; t<this.tags.length; t++)\n\t\ts.push(\"<category>\" + this.tags[t] + \"</category>\");\n\ts.push(\"<link>\" + url + \"#\" + encodeURIComponent(String.encodeTiddlyLink(this.title)) + \"</link>\");\n\ts.push(\"<pubDate>\" + this.modified.toGMTString() + \"</pubDate>\");\n\ts.push(\"</item>\");\n\treturn s.join(\"\\n\");\n};\n\n// Change the text and other attributes of a tiddler\nTiddler.prototype.set = function(title,text,modifier,modified,tags,created,fields)\n{\n\tthis.assign(title,text,modifier,modified,tags,created,fields);\n\tthis.changed();\n\treturn this;\n};\n\n// Change the text and other attributes of a tiddler without triggered a tiddler.changed() call\nTiddler.prototype.assign = function(title,text,modifier,modified,tags,created,fields)\n{\n\tif(title != undefined)\n\t\tthis.title = title;\n\tif(text != undefined)\n\t\tthis.text = text;\n\tif(modifier != undefined)\n\t\tthis.modifier = modifier;\n\tif(modified != undefined)\n\t\tthis.modified = modified;\n\tif(created != undefined)\n\t\tthis.created = created;\n\tif(fields != undefined)\n\t\tthis.fields = fields;\n\tif(tags != undefined)\n\t\tthis.tags = (typeof tags == \"string\") ? tags.readBracketedList() : tags;\n\telse if(this.tags == undefined)\n\t\tthis.tags = [];\n\treturn this;\n};\n\n// Get the tags for a tiddler as a string (space delimited, using [[brackets]] for tags containing spaces)\nTiddler.prototype.getTags = function()\n{\n\treturn String.encodeTiddlyLinkList(this.tags);\n};\n\n// Test if a tiddler carries a tag\nTiddler.prototype.isTagged = function(tag)\n{\n\treturn this.tags.indexOf(tag) != -1;\n};\n\n// Static method to convert \"\\n\" to newlines, \"\\s\" to \"\\\"\nTiddler.unescapeLineBreaks = function(text)\n{\n\treturn text ? text.unescapeLineBreaks() : \"\";\n};\n\n// Convert newlines to \"\\n\", \"\\\" to \"\\s\"\nTiddler.prototype.escapeLineBreaks = function()\n{\n\treturn this.text.escapeLineBreaks();\n};\n\n// Updates the secondary information (like links[] array) after a change to a tiddler\nTiddler.prototype.changed = function()\n{\n\tthis.links = [];\n\tvar t = this.autoLinkWikiWords() ? 0 : 1;\n\tvar tiddlerLinkRegExp = t==0 ? config.textPrimitives.tiddlerAnyLinkRegExp : config.textPrimitives.tiddlerForcedLinkRegExp;\n\ttiddlerLinkRegExp.lastIndex = 0;\n\tvar formatMatch = tiddlerLinkRegExp.exec(this.text);\n\twhile(formatMatch) {\n\t\tvar lastIndex = tiddlerLinkRegExp.lastIndex;\n\t\tif(t==0 && formatMatch[1] && formatMatch[1] != this.title) {\n\t\t\t// wikiWordLink\n\t\t\tif(formatMatch.index > 0) {\n\t\t\t\tvar preRegExp = new RegExp(config.textPrimitives.unWikiLink+\"|\"+config.textPrimitives.anyLetter,\"mg\");\n\t\t\t\tpreRegExp.lastIndex = formatMatch.index-1;\n\t\t\t\tvar preMatch = preRegExp.exec(this.text);\n\t\t\t\tif(preMatch.index != formatMatch.index-1)\n\t\t\t\t\tthis.links.pushUnique(formatMatch[1]);\n\t\t\t} else {\n\t\t\t\tthis.links.pushUnique(formatMatch[1]);\n\t\t\t}\n\t\t}\n\t\telse if(formatMatch[2-t] && !config.formatterHelpers.isExternalLink(formatMatch[3-t])) // titledBrackettedLink\n\t\t\tthis.links.pushUnique(formatMatch[3-t]);\n\t\telse if(formatMatch[4-t] && formatMatch[4-t] != this.title) // brackettedLink\n\t\t\tthis.links.pushUnique(formatMatch[4-t]);\n\t\ttiddlerLinkRegExp.lastIndex = lastIndex;\n\t\tformatMatch = tiddlerLinkRegExp.exec(this.text);\n\t}\n\tthis.linksUpdated = true;\n};\n\nTiddler.prototype.getSubtitle = function()\n{\n\tvar theModifier = this.modifier;\n\tif(!theModifier)\n\t\ttheModifier = config.messages.subtitleUnknown;\n\tvar theModified = this.modified;\n\tif(theModified)\n\t\ttheModified = theModified.toLocaleString();\n\telse\n\t\ttheModified = config.messages.subtitleUnknown;\n\treturn config.messages.tiddlerLinkTooltip.format([this.title,theModifier,theModified]);\n};\n\nTiddler.prototype.isReadOnly = function()\n{\n\treturn readOnly;\n};\n\nTiddler.prototype.autoLinkWikiWords = function()\n{\n\treturn !(this.isTagged(\"systemConfig\") || this.isTagged(\"excludeMissing\"));\n};\n\nTiddler.prototype.generateFingerprint = function()\n{\n\treturn \"0x\" + Crypto.hexSha1Str(this.text);\n};\n\nTiddler.prototype.getServerType = function()\n{\n\tvar serverType = null;\n\tif(this.fields && this.fields['server.type'])\n\t\tserverType = this.fields['server.type'];\n\tif(!serverType)\n\t\tserverType = this.fields['wikiformat'];\n\tif(serverType && !config.adaptors[serverType])\n\t\tserverType = null;\n\treturn serverType;\n};\n\nTiddler.prototype.getAdaptor = function()\n{\n\tvar serverType = this.getServerType();\n\tif(serverType)\n\t\treturn new config.adaptors[serverType];\n\telse\n\t\treturn null;\n};\n\n//--\n//-- TiddlyWiki() object contains Tiddler()s\n//--\n\nfunction TiddlyWiki()\n{\n\tvar tiddlers = {}; // Hashmap by name of tiddlers\n\tthis.tiddlersUpdated = false;\n\tthis.namedNotifications = []; // Array of {name:,notify:} of notification functions\n\tthis.notificationLevel = 0;\n\tthis.slices = {}; // map tiddlerName->(map sliceName->sliceValue). Lazy.\n\tthis.clear = function() {\n\t\ttiddlers = {};\n\t\tthis.setDirty(false);\n\t};\n\tthis.fetchTiddler = function(title) {\n\t\treturn tiddlers[title];\n\t};\n\tthis.deleteTiddler = function(title) {\n\t\tdelete this.slices[title];\n\t\tdelete tiddlers[title];\n\t};\n\tthis.addTiddler = function(tiddler) {\n\t\tdelete this.slices[tiddler.title];\n\t\ttiddlers[tiddler.title] = tiddler;\n\t};\n\tthis.forEachTiddler = function(callback) {\n\t\tfor(var t in tiddlers) {\n\t\t\tvar tiddler = tiddlers[t];\n\t\t\tif(tiddler instanceof Tiddler)\n\t\t\t\tcallback.call(this,t,tiddler);\n\t\t}\n\t};\n}\n\nTiddlyWiki.prototype.setDirty = function(dirty)\n{\n\tthis.dirty = dirty;\n};\n\nTiddlyWiki.prototype.isDirty = function()\n{\n\treturn this.dirty;\n};\n\nTiddlyWiki.prototype.suspendNotifications = function()\n{\n\tthis.notificationLevel--;\n};\n\nTiddlyWiki.prototype.resumeNotifications = function()\n{\n\tthis.notificationLevel++;\n};\n\n// Invoke the notification handlers for a particular tiddler\nTiddlyWiki.prototype.notify = function(title,doBlanket)\n{\n\tif(!this.notificationLevel) {\n\t\tfor(var t=0; t<this.namedNotifications.length; t++) {\n\t\t\tvar n = this.namedNotifications[t];\n\t\t\tif((n.name == null && doBlanket) || (n.name == title))\n\t\t\t\tn.notify(title);\n\t\t}\n\t}\n};\n\n// Invoke the notification handlers for all tiddlers\nTiddlyWiki.prototype.notifyAll = function()\n{\n\tif(!this.notificationLevel) {\n\t\tfor(var t=0; t<this.namedNotifications.length; t++) {\n\t\t\tvar n = this.namedNotifications[t];\n\t\t\tif(n.name)\n\t\t\t\tn.notify(n.name);\n\t\t}\n\t}\n};\n\n// Add a notification handler to a tiddler\nTiddlyWiki.prototype.addNotification = function(title,fn)\n{\n\tfor(var i=0; i<this.namedNotifications.length; i++) {\n\t\tif((this.namedNotifications[i].name == title) && (this.namedNotifications[i].notify == fn))\n\t\t\treturn this;\n\t}\n\tthis.namedNotifications.push({name: title, notify: fn});\n\treturn this;\n};\n\nTiddlyWiki.prototype.removeTiddler = function(title)\n{\n\tvar tiddler = this.fetchTiddler(title);\n\tif(tiddler) {\n\t\tthis.deleteTiddler(title);\n\t\tthis.notify(title,true);\n\t\tthis.setDirty(true);\n\t}\n};\n\nTiddlyWiki.prototype.tiddlerExists = function(title)\n{\n\tvar t = this.fetchTiddler(title);\n\treturn t != undefined;\n};\n\nTiddlyWiki.prototype.isShadowTiddler = function(title)\n{\n\treturn typeof config.shadowTiddlers[title] == \"string\";\n};\n\nTiddlyWiki.prototype.getTiddler = function(title)\n{\n\tvar t = this.fetchTiddler(title);\n\tif(t != undefined)\n\t\treturn t;\n\telse\n\t\treturn null;\n};\n\nTiddlyWiki.prototype.getTiddlerText = function(title,defaultText)\n{\n\tvar tiddler = this.fetchTiddler(title);\n\tif(tiddler)\n\t\treturn tiddler.text;\n\tif(!title)\n\t\treturn defaultText;\n\tvar pos = title.indexOf(config.textPrimitives.sliceSeparator);\n\tif(pos != -1) {\n\t\tvar slice = this.getTiddlerSlice(title.substr(0,pos),title.substr(pos + config.textPrimitives.sliceSeparator.length));\n\t\tif(slice)\n\t\t\treturn slice;\n\t}\n\tif(this.isShadowTiddler(title))\n\t\treturn config.shadowTiddlers[title];\n\tif(defaultText != undefined)\n\t\treturn defaultText;\n\treturn null;\n};\n\nTiddlyWiki.prototype.slicesRE = /(?:[\\'\\/]*~?([\\.\\w]+)[\\'\\/]*\\:[\\'\\/]*\\s*(.*?)\\s*$)|(?:\\|[\\'\\/]*~?([\\.\\w]+)\\:?[\\'\\/]*\\|\\s*(.*?)\\s*\\|)/gm;\n\n// @internal\nTiddlyWiki.prototype.calcAllSlices = function(title)\n{\n\tvar slices = {};\n\tvar text = this.getTiddlerText(title,\"\");\n\tthis.slicesRE.lastIndex = 0;\n\tdo {\n\t\tvar m = this.slicesRE.exec(text);\n\t\tif(m) {\n\t\t\tif(m[1])\n\t\t\t\tslices[m[1]] = m[2];\n\t\t\telse\n\t\t\t\tslices[m[3]] = m[4];\n\t\t}\n\t} while(m);\n\treturn slices;\n};\n\n// Returns the slice of text of the given name\nTiddlyWiki.prototype.getTiddlerSlice = function(title,sliceName)\n{\n\tvar slices = this.slices[title];\n\tif(!slices) {\n\t\tslices = this.calcAllSlices(title);\n\t\tthis.slices[title] = slices;\n\t}\n\treturn slices[sliceName];\n};\n\n// Build an hashmap of the specified named slices of a tiddler\nTiddlyWiki.prototype.getTiddlerSlices = function(title,sliceNames)\n{\n\tvar r = {};\n\tfor(var t=0; t<sliceNames.length; t++) {\n\t\tvar slice = this.getTiddlerSlice(title,sliceNames[t]);\n\t\tif(slice)\n\t\t\tr[sliceNames[t]] = slice;\n\t}\n\treturn r;\n};\n\nTiddlyWiki.prototype.getRecursiveTiddlerText = function(title,defaultText,depth)\n{\n\tvar bracketRegExp = new RegExp(\"(?:\\\\[\\\\[([^\\\\]]+)\\\\]\\\\])\",\"mg\");\n\tvar text = this.getTiddlerText(title,null);\n\tif(text == null)\n\t\treturn defaultText;\n\tvar textOut = [];\n\tvar lastPos = 0;\n\tdo {\n\t\tvar match = bracketRegExp.exec(text);\n\t\tif(match) {\n\t\t\ttextOut.push(text.substr(lastPos,match.index-lastPos));\n\t\t\tif(match[1]) {\n\t\t\t\tif(depth <= 0)\n\t\t\t\t\ttextOut.push(match[1]);\n\t\t\t\telse\n\t\t\t\t\ttextOut.push(this.getRecursiveTiddlerText(match[1],\"[[\" + match[1] + \"]]\",depth-1));\n\t\t\t}\n\t\t\tlastPos = match.index + match[0].length;\n\t\t} else {\n\t\t\ttextOut.push(text.substr(lastPos));\n\t\t}\n\t} while(match);\n\treturn textOut.join(\"\");\n};\n\nTiddlyWiki.prototype.setTiddlerTag = function(title,status,tag)\n{\n\tvar tiddler = this.fetchTiddler(title);\n\tif(tiddler) {\n\t\tvar t = tiddler.tags.indexOf(tag);\n\t\tif(t != -1)\n\t\t\ttiddler.tags.splice(t,1);\n\t\tif(status)\n\t\t\ttiddler.tags.push(tag);\n\t\ttiddler.changed();\n\t\tthis.incChangeCount(title);\n\t\tthis.notify(title,true);\n\t\tthis.setDirty(true);\n\t}\n};\n\nTiddlyWiki.prototype.addTiddlerFields = function(title,fields)\n{\n\tvar tiddler = this.fetchTiddler(title);\n\tif(!tiddler)\n\t\treturn;\n\tmerge(tiddler.fields,fields);\n\ttiddler.changed();\n\tthis.incChangeCount(title);\n\tthis.notify(title,true);\n\tthis.setDirty(true);\n};\n\nTiddlyWiki.prototype.saveTiddler = function(title,newTitle,newBody,modifier,modified,tags,fields,clearChangeCount,created)\n{\n\tvar tiddler = this.fetchTiddler(title);\n\tif(tiddler) {\n\t\tcreated = created ? created : tiddler.created; // Preserve created date\n\t\tthis.deleteTiddler(title);\n\t} else {\n\t\tcreated = created ? created : modified;\n\t\ttiddler = new Tiddler();\n\t}\n\ttiddler.set(newTitle,newBody,modifier,modified,tags,created,fields);\n\tthis.addTiddler(tiddler);\n\tif(clearChangeCount)\n\t\ttiddler.clearChangeCount();\n\telse\n\t\ttiddler.incChangeCount();\n\tif(title != newTitle)\n\t\tthis.notify(title,true);\n\tthis.notify(newTitle,true);\n\tthis.setDirty(true);\n\treturn tiddler;\n};\n\n// Reset the sync status of a freshly synced tiddler\nTiddlyWiki.prototype.resetTiddler = function(title)\n{\n\tvar tiddler = this.fetchTiddler(title);\n\tif(tiddler) {\n\t\ttiddler.clearChangeCount();\n\t\tthis.notify(title,true);\n\t\tthis.setDirty(true);\n\t}\n};\n\nTiddlyWiki.prototype.incChangeCount = function(title)\n{\n\tvar tiddler = this.fetchTiddler(title);\n\tif(tiddler)\n\t\ttiddler.incChangeCount();\n};\n\nTiddlyWiki.prototype.createTiddler = function(title)\n{\n\tvar tiddler = this.fetchTiddler(title);\n\tif(!tiddler) {\n\t\ttiddler = new Tiddler();\n\t\ttiddler.title = title;\n\t\tthis.addTiddler(tiddler);\n\t\tthis.setDirty(true);\n\t}\n\treturn tiddler;\n};\n\n// Load contents of a TiddlyWiki from an HTML DIV\nTiddlyWiki.prototype.loadFromDiv = function(src,idPrefix,noUpdate)\n{\n\tthis.idPrefix = idPrefix;\n\tvar storeElem = (typeof src == \"string\") ? document.getElementById(src) : src;\n\tif(!storeElem)\n\t\treturn;\n\tvar tiddlers = this.getLoader().loadTiddlers(this,storeElem.childNodes);\n\tthis.setDirty(false);\n\tif(!noUpdate) {\n\t\tfor(var i = 0;i<tiddlers.length; i++)\n\t\t\ttiddlers[i].changed();\n\t}\n};\n\n// Load contents of a TiddlyWiki from a string\n// Returns null if there's an error\nTiddlyWiki.prototype.importTiddlyWiki = function(text)\n{\n\tvar posDiv = locateStoreArea(text);\n\tif(!posDiv)\n\t\treturn null;\n\tvar content = \"<\" + \"html><\" + \"body>\" + text.substring(posDiv[0],posDiv[1] + endSaveArea.length) + \"<\" + \"/body><\" + \"/html>\";\n\t// Create the iframe\n\tvar iframe = document.createElement(\"iframe\");\n\tiframe.style.display = \"none\";\n\tdocument.body.appendChild(iframe);\n\tvar doc = iframe.document;\n\tif(iframe.contentDocument)\n\t\tdoc = iframe.contentDocument; // For NS6\n\telse if(iframe.contentWindow)\n\t\tdoc = iframe.contentWindow.document; // For IE5.5 and IE6\n\t// Put the content in the iframe\n\tdoc.open();\n\tdoc.writeln(content);\n\tdoc.close();\n\t// Load the content into a TiddlyWiki() object\n\tvar storeArea = doc.getElementById(\"storeArea\");\n\tthis.loadFromDiv(storeArea,\"store\");\n\t// Get rid of the iframe\n\tiframe.parentNode.removeChild(iframe);\n\treturn this;\n};\n\nTiddlyWiki.prototype.updateTiddlers = function()\n{\n\tthis.tiddlersUpdated = true;\n\tthis.forEachTiddler(function(title,tiddler) {\n\t\ttiddler.changed();\n\t});\n};\n\n// Return all tiddlers formatted as an HTML string\nTiddlyWiki.prototype.allTiddlersAsHtml = function()\n{\n\treturn store.getSaver().externalize(store);\n};\n\n// Return an array of tiddlers matching a search regular expression\nTiddlyWiki.prototype.search = function(searchRegExp,sortField,excludeTag)\n{\n\tvar candidates = this.reverseLookup(\"tags\",excludeTag,false);\n\tvar results = [];\n\tfor(var t=0; t<candidates.length; t++) {\n\t\tif((candidates[t].title.search(searchRegExp) != -1) || (candidates[t].text.search(searchRegExp) != -1))\n\t\t\tresults.push(candidates[t]);\n\t}\n\tif(!sortField)\n\t\tsortField = \"title\";\n\tresults.sort(function(a,b) {return a[sortField] < b[sortField] ? -1 : (a[sortField] == b[sortField] ? 0 : +1);});\n\treturn results;\n};\n\n// Return an array of all the tags in use. Each member of the array is another array where [0] is the name of the tag and [1] is the number of occurances\nTiddlyWiki.prototype.getTags = function(excludeTag)\n{\n\tvar results = [];\n\tthis.forEachTiddler(function(title,tiddler) {\n\t\tfor(var g=0; g<tiddler.tags.length; g++) {\n\t\t\tvar tag = tiddler.tags[g];\n\t\t\tif(excludeTag) {\n\t\t\t\tvar t = store.fetchTiddler(tag);\n\t\t\t\tif(t && t.isTagged(excludeTag))\n\t\t\t\t\treturn false;\n\t\t\t}\n\t\t\tvar f = false;\n\t\t\tfor(var c=0; c<results.length; c++) {\n\t\t\t\tif(results[c][0] == tag) {\n\t\t\t\t\tf = true;\n\t\t\t\t\tresults[c][1]++;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif(!f)\n\t\t\t\tresults.push([tag,1]);\n\t\t}\n\t});\n\tresults.sort(function(a,b) {return a[0].toLowerCase() < b[0].toLowerCase() ? -1 : (a[0].toLowerCase() == b[0].toLowerCase() ? 0 : +1);});\n\treturn results;\n};\n\n// Return an array of the tiddlers that are tagged with a given tag\nTiddlyWiki.prototype.getTaggedTiddlers = function(tag,sortField)\n{\n\treturn this.reverseLookup(\"tags\",tag,true,sortField);\n};\n\n// Return an array of the tiddlers that link to a given tiddler\nTiddlyWiki.prototype.getReferringTiddlers = function(title,unusedParameter,sortField)\n{\n\tif(!this.tiddlersUpdated)\n\t\tthis.updateTiddlers();\n\treturn this.reverseLookup(\"links\",title,true,sortField);\n};\n\n// Return an array of the tiddlers that do or do not have a specified entry in the specified storage array (ie, \"links\" or \"tags\")\n// lookupMatch == true to match tiddlers, false to exclude tiddlers\nTiddlyWiki.prototype.reverseLookup = function(lookupField,lookupValue,lookupMatch,sortField)\n{\n\tvar results = [];\n\tthis.forEachTiddler(function(title,tiddler) {\n\t\tvar f = !lookupMatch;\n\t\tfor(var lookup=0; lookup<tiddler[lookupField].length; lookup++) {\n\t\t\tif(tiddler[lookupField][lookup] == lookupValue)\n\t\t\t\tf = lookupMatch;\n\t\t}\n\t\tif(f)\n\t\t\tresults.push(tiddler);\n\t});\n\tif(!sortField)\n\t\tsortField = \"title\";\n\tresults.sort(function(a,b) {return a[sortField] < b[sortField] ? -1 : (a[sortField] == b[sortField] ? 0 : +1);});\n\treturn results;\n};\n\n// Return the tiddlers as a sorted array\nTiddlyWiki.prototype.getTiddlers = function(field,excludeTag)\n{\n\tvar results = [];\n\tthis.forEachTiddler(function(title,tiddler) {\n\t\tif(excludeTag == undefined || !tiddler.isTagged(excludeTag))\n\t\t\tresults.push(tiddler);\n\t});\n\tif(field)\n\t\tresults.sort(function(a,b) {return a[field] < b[field] ? -1 : (a[field] == b[field] ? 0 : +1);});\n\treturn results;\n};\n\n// Return array of names of tiddlers that are referred to but not defined\nTiddlyWiki.prototype.getMissingLinks = function(sortField)\n{\n\tif(!this.tiddlersUpdated)\n\t\tthis.updateTiddlers();\n\tvar results = [];\n\tthis.forEachTiddler(function (title,tiddler) {\n\t\tif(tiddler.isTagged(\"excludeMissing\") || tiddler.isTagged(\"systemConfig\"))\n\t\t\treturn;\n\t\tfor(var n=0; n<tiddler.links.length;n++) {\n\t\t\tvar link = tiddler.links[n];\n\t\t\tif(this.fetchTiddler(link) == null && !this.isShadowTiddler(link))\n\t\t\t\tresults.pushUnique(link);\n\t\t}\n\t});\n\tresults.sort();\n\treturn results;\n};\n\n// Return an array of names of tiddlers that are defined but not referred to\nTiddlyWiki.prototype.getOrphans = function()\n{\n\tvar results = [];\n\tthis.forEachTiddler(function (title,tiddler) {\n\t\tif(this.getReferringTiddlers(title).length == 0 && !tiddler.isTagged(\"excludeLists\"))\n\t\t\tresults.push(title);\n\t});\n\tresults.sort();\n\treturn results;\n};\n\n// Return an array of names of all the shadow tiddlers\nTiddlyWiki.prototype.getShadowed = function()\n{\n\tvar results = [];\n\tfor(var t in config.shadowTiddlers) {\n\t\tif(typeof config.shadowTiddlers[t] == \"string\")\n\t\t\tresults.push(t);\n\t}\n\tresults.sort();\n\treturn results;\n};\n\n// Return an array of tiddlers that have been touched since they were downloaded or created\nTiddlyWiki.prototype.getTouched = function()\n{\n\tvar results = [];\n\tthis.forEachTiddler(function(title,tiddler) {\n\t\tif(tiddler.isTouched())\n\t\t\tresults.push(tiddler);\n\t\t});\n\tresults.sort();\n\treturn results;\n};\n\n// Resolves a Tiddler reference or tiddler title into a Tiddler object, or null if it doesn't exist\nTiddlyWiki.prototype.resolveTiddler = function(tiddler)\n{\n\tvar t = (typeof tiddler == 'string') ? this.getTiddler(tiddler) : tiddler;\n\treturn t instanceof Tiddler ? t : null;\n};\n\nTiddlyWiki.prototype.getLoader = function()\n{\n\tif(!this.loader)\n\t\tthis.loader = new TW21Loader();\n\treturn this.loader;\n};\n\nTiddlyWiki.prototype.getSaver = function()\n{\n\tif(!this.saver)\n\t\tthis.saver = new TW21Saver();\n\treturn this.saver;\n};\n\n// Returns true if path is a valid field name (path),\n// i.e. a sequence of identifiers, separated by '.'\nTiddlyWiki.isValidFieldName = function(name)\n{\n\tvar match = /[a-zA-Z_]\\w*(\\.[a-zA-Z_]\\w*)*/.exec(name);\n\treturn match && (match[0] == name);\n};\n\n// Throws an exception when name is not a valid field name.\nTiddlyWiki.checkFieldName = function(name)\n{\n\tif(!TiddlyWiki.isValidFieldName(name))\n\t\tthrow config.messages.invalidFieldName.format([name]);\n};\n\nfunction StringFieldAccess(n,readOnly)\n{\n\tthis.set = readOnly ?\n\t\t\tfunction(t,v) {if(v != t[n]) throw config.messages.fieldCannotBeChanged.format([n]);} :\n\t\t\tfunction(t,v) {if(v != t[n]) {t[n] = v; return true;}};\n\tthis.get = function(t) {return t[n];};\n}\n\nfunction DateFieldAccess(n)\n{\n\tthis.set = function(t,v) {\n\t\tvar d = v instanceof Date ? v : Date.convertFromYYYYMMDDHHMM(v);\n\t\tif(d != t[n]) {\n\t\t\tt[n] = d; return true;\n\t\t}\n\t};\n\tthis.get = function(t) {return t[n].convertToYYYYMMDDHHMM();};\n}\n\nfunction LinksFieldAccess(n)\n{\n\tthis.set = function(t,v) {\n\t\tvar s = (typeof v == \"string\") ? v.readBracketedList() : v;\n\t\tif(s.toString() != t[n].toString()) {\n\t\t\tt[n] = s; return true;\n\t\t}\n\t};\n\tthis.get = function(t) {return String.encodeTiddlyLinkList(t[n]);};\n}\n\nTiddlyWiki.standardFieldAccess = {\n\t// The set functions return true when setting the data has changed the value.\n\t\"title\":    new StringFieldAccess(\"title\",true),\n\t// Handle the \"tiddler\" field name as the title\n\t\"tiddler\":  new StringFieldAccess(\"title\",true),\n\t\"text\":     new StringFieldAccess(\"text\"),\n\t\"modifier\": new StringFieldAccess(\"modifier\"),\n\t\"modified\": new DateFieldAccess(\"modified\"),\n\t\"created\":  new DateFieldAccess(\"created\"),\n\t\"tags\":     new LinksFieldAccess(\"tags\")\n};\n\nTiddlyWiki.isStandardField = function(name)\n{\n\treturn TiddlyWiki.standardFieldAccess[name] != undefined;\n};\n\n// Sets the value of the given field of the tiddler to the value.\n// Setting an ExtendedField's value to null or undefined removes the field.\n// Setting a namespace to undefined removes all fields of that namespace.\n// The fieldName is case-insensitive.\n// All values will be converted to a string value.\nTiddlyWiki.prototype.setValue = function(tiddler,fieldName,value)\n{\n\tTiddlyWiki.checkFieldName(fieldName);\n\tvar t = this.resolveTiddler(tiddler);\n\tif(!t)\n\t\treturn;\n\tfieldName = fieldName.toLowerCase();\n\tvar isRemove = (value === undefined) || (value === null);\n\tvar accessor = TiddlyWiki.standardFieldAccess[fieldName];\n\tif(accessor) {\n\t\tif(isRemove)\n\t\t\t// don't remove StandardFields\n\t\t\treturn;\n\t\tvar h = TiddlyWiki.standardFieldAccess[fieldName];\n\t\tif(!h.set(t,value))\n\t\t\treturn;\n\t} else {\n\t\tvar oldValue = t.fields[fieldName];\n\t\tif(isRemove) {\n\t\t\tif(oldValue !== undefined) {\n\t\t\t\t// deletes a single field\n\t\t\t\tdelete t.fields[fieldName];\n\t\t\t} else {\n\t\t\t\t// no concrete value is defined for the fieldName\n\t\t\t\t// so we guess this is a namespace path.\n\t\t\t\t// delete all fields in a namespace\n\t\t\t\tvar re = new RegExp('^'+fieldName+'\\\\.');\n\t\t\t\tvar dirty = false;\n\t\t\t\tfor(var n in t.fields) {\n\t\t\t\t\tif(n.match(re)) {\n\t\t\t\t\t\tdelete t.fields[n];\n\t\t\t\t\t\tdirty = true;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif(!dirty)\n\t\t\t\t\treturn;\n\t\t\t}\n\t\t} else {\n\t\t\t// the \"normal\" set case. value is defined (not null/undefined)\n\t\t\t// For convenience provide a nicer conversion Date->String\n\t\t\tvalue = value instanceof Date ? value.convertToYYYYMMDDHHMMSSMMM() : String(value);\n\t\t\tif(oldValue == value)\n\t\t\t\treturn;\n\t\t\tt.fields[fieldName] = value;\n\t\t}\n\t}\n\t// When we are here the tiddler/store really was changed.\n\tthis.notify(t.title,true);\n\tif(!fieldName.match(/^temp\\./))\n\t\tthis.setDirty(true);\n};\n\n// Returns the value of the given field of the tiddler.\n// The fieldName is case-insensitive.\n// Will only return String values (or undefined).\nTiddlyWiki.prototype.getValue = function(tiddler,fieldName)\n{\n\tvar t = this.resolveTiddler(tiddler);\n\tif(!t)\n\t\treturn undefined;\n\tfieldName = fieldName.toLowerCase();\n\tvar accessor = TiddlyWiki.standardFieldAccess[fieldName];\n\tif(accessor) {\n\t\treturn accessor.get(t);\n\t}\n\treturn t.fields[fieldName];\n};\n\n// Calls the callback function for every field in the tiddler.\n// When callback function returns a non-false value the iteration stops\n// and that value is returned.\n// The order of the fields is not defined.\n// @param callback a function(tiddler,fieldName,value).\nTiddlyWiki.prototype.forEachField = function(tiddler,callback,onlyExtendedFields)\n{\n\tvar t = this.resolveTiddler(tiddler);\n\tif(!t)\n\t\treturn undefined;\n\tfor(var n in t.fields) {\n\t\tvar result = callback(t,n,t.fields[n]);\n\t\tif(result)\n\t\t\treturn result;\n\t\t}\n\tif(onlyExtendedFields)\n\t\treturn undefined;\n\tfor(var n in TiddlyWiki.standardFieldAccess) {\n\t\tif(n == \"tiddler\")\n\t\t\t// even though the \"title\" field can also be referenced through the name \"tiddler\"\n\t\t\t// we only visit this field once.\n\t\t\tcontinue;\n\t\tvar result = callback(t,n,TiddlyWiki.standardFieldAccess[n].get(t));\n\t\tif(result)\n\t\t\treturn result;\n\t}\n\treturn undefined;\n};\n\n//--\n//-- Story functions\n//--\n\nfunction Story(container,idPrefix)\n{\n\tthis.container = container;\n\tthis.idPrefix = idPrefix;\n\tthis.highlightRegExp = null;\n}\n\nStory.prototype.forEachTiddler = function(fn)\n{\n\tvar place = document.getElementById(this.container);\n\tif(!place)\n\t\treturn;\n\tvar e = place.firstChild;\n\twhile(e) {\n\t\tvar n = e.nextSibling;\n\t\tvar title = e.getAttribute(\"tiddler\");\n\t\tfn.call(this,title,e);\n\t\te = n;\n\t}\n};\n\nStory.prototype.displayTiddlers = function(srcElement,titles,template,animate,unused,customFields,toggle)\n{\n\tfor(var t = titles.length-1;t>=0;t--)\n\t\tthis.displayTiddler(srcElement,titles[t],template,animate,unused,customFields);\n};\n\nStory.prototype.displayTiddler = function(srcElement,title,template,animate,unused,customFields,toggle)\n{\n\tvar place = document.getElementById(this.container);\n\tvar tiddlerElem = document.getElementById(this.idPrefix + title);\n\tif(tiddlerElem) {\n\t\tif(toggle)\n\t\t\tthis.closeTiddler(title,true);\n\t\telse\n\t\t\tthis.refreshTiddler(title,template,false,customFields);\n\t} else {\n\t\tvar before = this.positionTiddler(srcElement);\n\t\ttiddlerElem = this.createTiddler(place,before,title,template,customFields);\n\t}\n\tif(srcElement && typeof srcElement !== \"string\") {\n\t\tif(config.options.chkAnimate && (animate == undefined || animate == true) && anim && typeof Zoomer == \"function\" && typeof Scroller == \"function\")\n\t\t\tanim.startAnimating(new Zoomer(title,srcElement,tiddlerElem),new Scroller(tiddlerElem));\n\t\telse\n\t\t\twindow.scrollTo(0,ensureVisible(tiddlerElem));\n\t}\n};\n\nStory.prototype.positionTiddler = function(srcElement)\n{\n\tvar place = document.getElementById(this.container);\n\tvar before = null;\n\tif(typeof srcElement == \"string\") {\n\t\tswitch(srcElement) {\n\t\t\tcase \"top\":\n\t\t\t\tbefore = place.firstChild;\n\t\t\t\tbreak;\n\t\t\tcase \"bottom\":\n\t\t\t\tbefore = null;\n\t\t\t\tbreak;\n\t\t}\n\t} else {\n\t\tvar after = this.findContainingTiddler(srcElement);\n\t\tif(after == null) {\n\t\t\tbefore = place.firstChild;\n\t\t} else if(after.nextSibling) {\n\t\t\tbefore = after.nextSibling;\n\t\t\tif(before.nodeType != 1)\n\t\t\t\tbefore = null;\n\t\t}\n\t}\n\treturn before;\n};\n\nStory.prototype.createTiddler = function(place,before,title,template,customFields)\n{\n\tvar tiddlerElem = createTiddlyElement(null,\"div\",this.idPrefix + title,\"tiddler\");\n\ttiddlerElem.setAttribute(\"refresh\",\"tiddler\");\n\tif(customFields)\n\t\ttiddlerElem.setAttribute(\"tiddlyFields\",customFields);\n\tplace.insertBefore(tiddlerElem,before);\n\tvar defaultText = null;\n\tif(!store.tiddlerExists(title) && !store.isShadowTiddler(title))\n\t\tdefaultText = this.loadMissingTiddler(title,customFields,tiddlerElem);\n\tthis.refreshTiddler(title,template,false,customFields,defaultText);\n\treturn tiddlerElem;\n};\n\nStory.prototype.loadMissingTiddler = function(title,fields,tiddlerElem)\n{\n\tvar tiddler = new Tiddler(title);\n\ttiddler.fields = typeof fields == \"string\" ?  fields.decodeHashMap() : (fields ? fields : {});\n\tvar serverType = tiddler.getServerType();\n\tvar host = tiddler.fields['server.host'];\n\tvar workspace = tiddler.fields['server.workspace'];\n\tif(!serverType | !host)\n\t\treturn null;\n\tvar sm = new SyncMachine(serverType,{\n\t\t\tstart: function() {\n\t\t\t\treturn this.openHost(host,\"openWorkspace\");\n\t\t\t},\n\t\t\topenWorkspace: function() {\n\t\t\t\treturn this.openWorkspace(workspace,\"getTiddler\");\n\t\t\t},\n\t\t\tgetTiddler: function() {\n\t\t\t\treturn this.getTiddler(title,\"gotTiddler\");\n\t\t\t},\n\t\t\tgotTiddler: function(tiddler) {\n\t\t\t\tif(tiddler && tiddler.text) {\n\t\t\t\t\tvar downloaded = new Date();\n\t\t\t\t\tif(!tiddler.created)\n\t\t\t\t\t\ttiddler.created = downloaded;\n\t\t\t\t\tif(!tiddler.modified)\n\t\t\t\t\t\ttiddler.modified = tiddler.created;\n\t\t\t\t\tstore.saveTiddler(tiddler.title,tiddler.title,tiddler.text,tiddler.modifier,tiddler.modified,tiddler.tags,tiddler.fields,true,tiddler.created);\n\t\t\t\t\tautoSaveChanges();\n\t\t\t\t}\n\t\t\t\tdelete this;\n\t\t\t\treturn true;\n\t\t\t},\n\t\t\terror: function(message) {\n\t\t\t\tdisplayMessage(\"Error loading missing tiddler from %0: %1\".format([host,message]));\n\t\t\t}\n\t\t});\n\tsm.go();\n\treturn config.messages.loadingMissingTiddler.format([title,serverType,host,workspace]);\n};\n\nStory.prototype.chooseTemplateForTiddler = function(title,template)\n{\n\tif(!template)\n\t\ttemplate = DEFAULT_VIEW_TEMPLATE;\n\tif(template == DEFAULT_VIEW_TEMPLATE || template == DEFAULT_EDIT_TEMPLATE)\n\t\ttemplate = config.tiddlerTemplates[template];\n\treturn template;\n};\n\nStory.prototype.getTemplateForTiddler = function(title,template,tiddler)\n{\n\treturn store.getRecursiveTiddlerText(template,null,10);\n};\n\nStory.prototype.refreshTiddler = function(title,template,force,customFields,defaultText)\n{\n\tvar tiddlerElem = document.getElementById(this.idPrefix + title);\n\tif(tiddlerElem) {\n\t\tif(tiddlerElem.getAttribute(\"dirty\") == \"true\" && !force)\n\t\t\treturn tiddlerElem;\n\t\ttemplate = this.chooseTemplateForTiddler(title,template);\n\t\tvar currTemplate = tiddlerElem.getAttribute(\"template\");\n\t\tif((template != currTemplate) || force) {\n\t\t\tvar tiddler = store.getTiddler(title);\n\t\t\tif(!tiddler) {\n\t\t\t\ttiddler = new Tiddler();\n\t\t\t\tif(store.isShadowTiddler(title)) {\n\t\t\t\t\ttiddler.set(title,store.getTiddlerText(title),config.views.wikified.shadowModifier,version.date,[],version.date);\n\t\t\t\t} else {\n\t\t\t\t\tvar text = template==\"EditTemplate\" ?\n\t\t\t\t\t\t\t\tconfig.views.editor.defaultText.format([title]) :\n\t\t\t\t\t\t\t\tconfig.views.wikified.defaultText.format([title]);\n\t\t\t\t\ttext = defaultText ? defaultText : text;\n\t\t\t\t\tvar fields = customFields ? customFields.decodeHashMap() : null;\n\t\t\t\t\ttiddler.set(title,text,config.views.wikified.defaultModifier,version.date,[],version.date,fields);\n\t\t\t\t}\n\t\t\t}\n\t\t\ttiddlerElem.setAttribute(\"tags\",tiddler.tags.join(\" \"));\n\t\t\ttiddlerElem.setAttribute(\"tiddler\",title);\n\t\t\ttiddlerElem.setAttribute(\"template\",template);\n\t\t\tvar me = this;\n\t\t\ttiddlerElem.onmouseover = this.onTiddlerMouseOver;\n\t\t\ttiddlerElem.onmouseout = this.onTiddlerMouseOut;\n\t\t\ttiddlerElem.ondblclick = this.onTiddlerDblClick;\n\t\t\ttiddlerElem[window.event?\"onkeydown\":\"onkeypress\"] = this.onTiddlerKeyPress;\n\t\t\tvar html = this.getTemplateForTiddler(title,template,tiddler);\n\t\t\ttiddlerElem.innerHTML = html;\n\t\t\tapplyHtmlMacros(tiddlerElem,tiddler);\n\t\t\tif(store.getTaggedTiddlers(title).length > 0)\n\t\t\t\taddClass(tiddlerElem,\"isTag\");\n\t\t\telse\n\t\t\t\tremoveClass(tiddlerElem,\"isTag\");\n\t\t\tif(!store.tiddlerExists(title)) {\n\t\t\t\tif(store.isShadowTiddler(title))\n\t\t\t\t\taddClass(tiddlerElem,\"shadow\");\n\t\t\t\telse\n\t\t\t\t\taddClass(tiddlerElem,\"missing\");\n\t\t\t} else {\n\t\t\t\tremoveClass(tiddlerElem,\"shadow\");\n\t\t\t\tremoveClass(tiddlerElem,\"missing\");\n\t\t\t}\n\t\t\tif(customFields)\n\t\t\t\tthis.addCustomFields(tiddlerElem,customFields);\n\t\t\tforceReflow();\n\t\t}\n\t}\n\treturn tiddlerElem;\n};\n\nStory.prototype.addCustomFields = function(place,customFields)\n{\n\tvar fields = customFields.decodeHashMap();\n\tvar w = document.createElement(\"div\");\n\tw.style.display = \"none\";\n\tplace.appendChild(w);\n\tfor(var t in fields) {\n\t\tvar e = document.createElement(\"input\");\n\t\te.setAttribute(\"type\",\"text\");\n\t\te.setAttribute(\"value\",fields[t]);\n\t\tw.appendChild(e);\n\t\te.setAttribute(\"edit\",t);\n\t}\n};\n\nStory.prototype.refreshAllTiddlers = function() \n{\n\tvar place = document.getElementById(this.container);\n\tvar e = place.firstChild;\n\tif(!e)\n\t\treturn;\n\tthis.refreshTiddler(e.getAttribute(\"tiddler\"),e.getAttribute(\"template\"),true);\n\twhile((e = e.nextSibling) != null) \n\t\tthis.refreshTiddler(e.getAttribute(\"tiddler\"),e.getAttribute(\"template\"),true);\n};\n\nStory.prototype.onTiddlerMouseOver = function(e)\n{\n\tif(window.addClass instanceof Function)\n\t\taddClass(this,\"selected\");\n};\n\nStory.prototype.onTiddlerMouseOut = function(e)\n{\n\tif(window.removeClass instanceof Function)\n\t\tremoveClass(this,\"selected\");\n};\n\nStory.prototype.onTiddlerDblClick = function(e)\n{\n\tif(!e) var e = window.event;\n\tvar theTarget = resolveTarget(e);\n\tif(theTarget && theTarget.nodeName.toLowerCase() != \"input\" && theTarget.nodeName.toLowerCase() != \"textarea\") {\n\t\tif(document.selection && document.selection.empty)\n\t\t\tdocument.selection.empty();\n\t\tconfig.macros.toolbar.invokeCommand(this,\"defaultCommand\",e);\n\t\te.cancelBubble = true;\n\t\tif(e.stopPropagation) e.stopPropagation();\n\t\treturn true;\n\t} else {\n\t\treturn false;\n\t}\n};\n\nStory.prototype.onTiddlerKeyPress = function(e)\n{\n\tif(!e) var e = window.event;\n\tclearMessage();\n\tvar consume = false; \n\tvar title = this.getAttribute(\"tiddler\");\n\tvar target = resolveTarget(e);\n\tswitch(e.keyCode) {\n\t\tcase 9: // Tab\n\t\t\tif(config.options.chkInsertTabs && target.tagName.toLowerCase() == \"textarea\") {\n\t\t\t\treplaceSelection(target,String.fromCharCode(9));\n\t\t\t\tconsume = true; \n\t\t\t}\n\t\t\tif(config.isOpera) {\n\t\t\t\ttarget.onblur = function() {\n\t\t\t\t\tthis.focus();\n\t\t\t\t\tthis.onblur = null;\n\t\t\t\t};\n\t\t\t}\n\t\t\tbreak;\n\t\tcase 13: // Ctrl-Enter\n\t\tcase 10: // Ctrl-Enter on IE PC\n\t\tcase 77: // Ctrl-Enter is \"M\" on some platforms\n\t\t\tif(e.ctrlKey) {\n\t\t\t\tblurElement(this);\n\t\t\t\tconfig.macros.toolbar.invokeCommand(this,\"defaultCommand\",e);\n\t\t\t\tconsume = true;\n\t\t\t}\n\t\t\tbreak; \n\t\tcase 27: // Escape\n\t\t\tblurElement(this);\n\t\t\tconfig.macros.toolbar.invokeCommand(this,\"cancelCommand\",e);\n\t\t\tconsume = true;\n\t\t\tbreak;\n\t}\n\te.cancelBubble = consume;\n\tif(consume) {\n\t\tif(e.stopPropagation) e.stopPropagation(); // Stop Propagation\n\t\te.returnValue = true; // Cancel The Event in IE\n\t\tif(e.preventDefault ) e.preventDefault(); // Cancel The Event in Moz\n\t}\n\treturn !consume;\n};\n\nStory.prototype.getTiddlerField = function(title,field)\n{\n\tvar tiddlerElem = document.getElementById(this.idPrefix + title);\n\tvar e = null;\n\tif(tiddlerElem != null) {\n\t\tvar children = tiddlerElem.getElementsByTagName(\"*\");\n\t\tfor(var t=0; t<children.length; t++) {\n\t\t\tvar c = children[t];\n\t\t\tif(c.tagName.toLowerCase() == \"input\" || c.tagName.toLowerCase() == \"textarea\") {\n\t\t\t\tif(!e)\n\t\t\t\t\te = c;\n\t\t\t\tif(c.getAttribute(\"edit\") == field)\n\t\t\t\t\te = c;\n\t\t\t}\n\t\t}\n\t}\n\treturn e;\n};\n\nStory.prototype.focusTiddler = function(title,field)\n{\n\tvar e = this.getTiddlerField(title,field);\n\tif(e) {\n\t\te.focus();\n\t\te.select();\n\t}\n};\n\nStory.prototype.blurTiddler = function(title)\n{\n\tvar tiddlerElem = document.getElementById(this.idPrefix + title);\n\tif(tiddlerElem != null && tiddlerElem.focus && tiddlerElem.blur) {\n\t\ttiddlerElem.focus();\n\t\ttiddlerElem.blur();\n\t}\n};\n\nStory.prototype.setTiddlerField = function(title,tag,mode,field)\n{\n\tvar c = story.getTiddlerField(title,field);\n\n\tvar tags = c.value.readBracketedList();\n\ttags.setItem(tag,mode);\n\tc.value = String.encodeTiddlyLinkList(tags);\n};\n\nStory.prototype.setTiddlerTag = function(title,tag,mode)\n{\n\tStory.prototype.setTiddlerField(title,tag,mode,\"tags\");\n};\n\nStory.prototype.closeTiddler = function(title,animate,unused)\n{\n\tvar tiddlerElem = document.getElementById(this.idPrefix + title);\n\tif(tiddlerElem != null) {\n\t\tclearMessage();\n\t\tthis.scrubTiddler(tiddlerElem);\n\t\tif(config.options.chkAnimate && animate && anim && typeof Slider == \"function\")\n\t\t\tanim.startAnimating(new Slider(tiddlerElem,false,null,\"all\"));\n\t\telse {\n\t\t\tremoveNode(tiddlerElem);\n\t\t\tforceReflow();\n\t\t}\n\t}\n};\n\nStory.prototype.scrubTiddler = function(tiddlerElem)\n{\n\ttiddlerElem.id = null;\n};\n\nStory.prototype.setDirty = function(title,dirty)\n{\n\tvar tiddlerElem = document.getElementById(this.idPrefix + title);\n\tif(tiddlerElem != null)\n\t\ttiddlerElem.setAttribute(\"dirty\",dirty ? \"true\" : \"false\");\n};\n\nStory.prototype.isDirty = function(title)\n{\n\tvar tiddlerElem = document.getElementById(this.idPrefix + title);\n\tif(tiddlerElem != null)\n\t\treturn tiddlerElem.getAttribute(\"dirty\") == \"true\";\n\treturn null;\n};\n\nStory.prototype.areAnyDirty = function()\n{\n\tvar r = false;\n\tthis.forEachTiddler(function(title,element) {\n\t\tif(this.isDirty(title))\n\t\t\tr = true;\n\t});\n\treturn r;\n};\n\nStory.prototype.closeAllTiddlers = function(exclude)\n{\n\tclearMessage();\n\tthis.forEachTiddler(function(title,element) {\n\t\tif((title != exclude) && element.getAttribute(\"dirty\") != \"true\")\n\t\t\tthis.closeTiddler(title);\n\t});\n\twindow.scrollTo(0,ensureVisible(this.container));\n};\n\nStory.prototype.isEmpty = function()\n{\n\tvar place = document.getElementById(this.container);\n\treturn place && place.firstChild == null;\n};\n\nStory.prototype.search = function(text,useCaseSensitive,useRegExp)\n{\n\tthis.closeAllTiddlers();\n\thighlightHack = new RegExp(useRegExp ?\t text : text.escapeRegExp(),useCaseSensitive ? \"mg\" : \"img\");\n\tvar matches = store.search(highlightHack,\"title\",\"excludeSearch\");\n\tvar titles = [];\n\tfor(var t=0;t<matches.length;t++)\n\t\ttitles.push(matches[t].title);\n\tthis.displayTiddlers(null,titles);\n\thighlightHack = null;\n\tvar q = useRegExp ? \"/\" : \"'\";\n\tif(matches.length > 0)\n\t\tdisplayMessage(config.macros.search.successMsg.format([titles.length.toString(),q + text + q]));\n\telse\n\t\tdisplayMessage(config.macros.search.failureMsg.format([q + text + q]));\n};\n\nStory.prototype.findContainingTiddler = function(e)\n{\n\twhile(e && !hasClass(e,\"tiddler\"))\n\t\te = e.parentNode;\n\treturn e;\n};\n\nStory.prototype.gatherSaveFields = function(e,fields)\n{\n\tif(e && e.getAttribute) {\n\t\tvar f = e.getAttribute(\"edit\");\n\t\tif(f)\n\t\t\tfields[f] = e.value.replace(/\\r/mg,\"\");\n\t\tif(e.hasChildNodes()) {\n\t\t\tvar c = e.childNodes;\n\t\t\tfor(var t=0; t<c.length; t++)\n\t\t\t\tthis.gatherSaveFields(c[t],fields);\n\t\t}\n\t}\n};\n\nStory.prototype.hasChanges = function(title)\n{\n\tvar e = document.getElementById(this.idPrefix + title);\n\tif(e != null) {\n\t\tvar fields = {};\n\t\tthis.gatherSaveFields(e,fields);\n\t\tvar tiddler = store.fetchTiddler(title);\n\t\tif(!tiddler)\n\t\t\treturn false;\n\t\tfor(var n in fields) {\n\t\t\tif(store.getValue(title,n) != fields[n])\n\t\t\t\treturn true;\n\t\t}\n\t}\n\treturn false;\n};\n\nStory.prototype.saveTiddler = function(title,minorUpdate)\n{\n\tvar tiddlerElem = document.getElementById(this.idPrefix + title);\n\tif(tiddlerElem != null) {\n\t\tvar fields = {};\n\t\tthis.gatherSaveFields(tiddlerElem,fields);\n\t\tvar newTitle = fields.title ? fields.title : title;\n\t\tif(store.tiddlerExists(newTitle) && newTitle != title) {\n\t\t\tif(!confirm(config.messages.overwriteWarning.format([newTitle.toString()])))\n\t\t\t\treturn null;\n\t\t}\n\t\tif(newTitle != title)\n\t\t\tthis.closeTiddler(newTitle,false);\n\t\ttiddlerElem.id = this.idPrefix + newTitle;\n\t\ttiddlerElem.setAttribute(\"tiddler\",newTitle);\n\t\ttiddlerElem.setAttribute(\"template\",DEFAULT_VIEW_TEMPLATE);\n\t\ttiddlerElem.setAttribute(\"dirty\",\"false\");\n\t\tif(config.options.chkForceMinorUpdate)\n\t\t\tminorUpdate = !minorUpdate;\n\t\tif(!store.tiddlerExists(newTitle))\n\t\t\tminorUpdate = false;\n\t\tvar newDate = new Date();\n\t\tvar extendedFields = store.tiddlerExists(newTitle) ? store.fetchTiddler(newTitle).fields : {};\n\t\tfor(var n in fields) {\n\t\t\tif(!TiddlyWiki.isStandardField(n))\n\t\t\t\textendedFields[n] = fields[n];\n\t\t\t}\n\t\tvar tiddler = store.saveTiddler(title,newTitle,fields.text,minorUpdate ? undefined : config.options.txtUserName,minorUpdate ? undefined : newDate,fields.tags,extendedFields);\n\t\tautoSaveChanges(null,[tiddler]);\n\t\treturn newTitle;\n\t}\n\treturn null;\n};\n\nStory.prototype.permaView = function()\n{\n\tvar links = [];\n\tthis.forEachTiddler(function(title,element) {\n\t\tlinks.push(String.encodeTiddlyLink(title));\n\t});\n\tvar t = encodeURIComponent(links.join(\" \"));\n\tif(t == \"\")\n\t\tt = \"#\";\n\tif(window.location.hash != t)\n\t\twindow.location.hash = t;\n};\n\n//--\n//-- Backstage\n//--\n\nvar backstage = {\n\tarea: null,\n\ttoolbar: null,\n\tbutton: null,\n\tshowButton: null,\n\thideButton: null,\n\tcloak: null,\n\tpanel: null,\n\tpanelBody: null,\n\tpanelFooter: null,\n\tcurrTabName: null,\n\tcurrTabElem: null,\n\tcontent: null,\n\n\tinit: function() {\n\t\tvar cmb = config.messages.backstage;\n\t\tthis.area = document.getElementById(\"backstageArea\");\n\t\tthis.toolbar = document.getElementById(\"backstageToolbar\");\n\t\tthis.button = document.getElementById(\"backstageButton\");\n\t\tthis.button.style.display = \"block\";\n\t\tvar t = cmb.open.text + \" \" + glyph(\"bentArrowLeft\");\n\t\tthis.showButton = createTiddlyButton(this.button,t,cmb.open.tooltip,\n\t\t\t\t\t\tfunction (e) {backstage.show(); return false;},null,\"backstageShow\");\n\t\tt = glyph(\"bentArrowRight\") + \" \" + cmb.close.text;\n\t\tthis.hideButton = createTiddlyButton(this.button,t,cmb.close.tooltip,\n\t\t\t\t\t\tfunction (e) {backstage.hide(); return false;},null,\"backstageHide\");\n\t\tthis.cloak = document.getElementById(\"backstageCloak\");\n\t\tthis.panel = document.getElementById(\"backstagePanel\");\n\t\tthis.panelFooter = createTiddlyElement(this.panel,\"div\",null,\"backstagePanelFooter\");\n\t\tthis.panelBody = createTiddlyElement(this.panel,\"div\",null,\"backstagePanelBody\");\n\t\tthis.cloak.onmousedown = function(e) {\n\t\t\tbackstage.switchTab(null);\n\t\t};\n\t\tcreateTiddlyText(this.toolbar,cmb.prompt);\n\t\tfor(t=0; t<config.backstageTasks.length; t++) {\n\t\t\tvar taskName = config.backstageTasks[t];\n\t\t\tvar task = config.tasks[taskName];\n\t\t\tvar handler = task.action ? this.onClickCommand : this.onClickTab;\n\t\t\tvar text = task.text + (task.action ? \"\" : glyph(\"downTriangle\"));\n\t\t\tvar btn = createTiddlyButton(this.toolbar,text,task.tooltip,handler,\"backstageTab\");\n\t\t\tbtn.setAttribute(\"task\",taskName);\n\t\t\taddClass(btn,task.action ? \"backstageAction\" : \"backstageTask\");\n\t\t\t}\n\t\tthis.content = document.getElementById(\"contentWrapper\");\n\t\tif(config.options.chkBackstage)\n\t\t\tthis.show();\n\t\telse\n\t\t\tthis.hide();\n\t},\n\t\n\tisVisible: function () {\n\t\treturn this.area ? this.area.style.display == \"block\" : false;\n\t},\n\t\n\tshow: function() {\n\t\tthis.area.style.display = \"block\";\n\t\tif(anim && config.options.chkAnimate) {\n\t\t\tbackstage.toolbar.style.left = findWindowWidth() + \"px\";\n\t\t\tvar p = [\n\t\t\t\t{style: \"left\", start: findWindowWidth(), end: 0, template: \"%0px\"}\n\t\t\t];\n\t\t\tanim.startAnimating(new Morpher(backstage.toolbar,config.animDuration,p));\n\t\t} else {\n\t\t\tbackstage.area.style.left = \"0px\";\n\t\t}\n\t\tthis.showButton.style.display = \"none\";\n\t\tthis.hideButton.style.display = \"block\";\n\t\tconfig.options.chkBackstage = true;\n\t\tsaveOptionCookie(\"chkBackstage\");\n\t\taddClass(this.content,\"backstageVisible\");\n\t},\n\n\thide: function() {\n\t\tif(this.currTabElem) {\n\t\t\tthis.switchTab(null);\n\t\t} else {\n\t\t\tbackstage.toolbar.style.left = \"0px\";\n\t\t\tif(anim && config.options.chkAnimate) {\n\t\t\t\tvar p = [\n\t\t\t\t\t{style: \"left\", start: 0, end: findWindowWidth(), template: \"%0px\"}\n\t\t\t\t];\n\t\t\t\tvar c = function(element,properties) {backstage.area.style.display = \"none\";};\n\t\t\t\tanim.startAnimating(new Morpher(backstage.toolbar,config.animDuration,p,c));\n\t\t\t} else {\n\t\t\t\tthis.area.style.display = \"none\";\n\t\t\t}\n\t\t\tthis.showButton.style.display = \"block\";\n\t\t\tthis.hideButton.style.display = \"none\";\n\t\t\tconfig.options.chkBackstage = false;\n\t\t\tsaveOptionCookie(\"chkBackstage\");\n\t\t\tremoveClass(this.content,\"backstageVisible\");\n\t\t}\n\t},\n\n\tonClickCommand: function(e) {\n\t\tvar task = config.tasks[this.getAttribute(\"task\")];\n\t\tdisplayMessage(task);\n\t\tif(task.action) {\n\t\t\tbackstage.switchTab(null);\n\t\t\ttask.action();\n\t\t}\n\t\treturn false;\n\t},\n\n\tonClickTab: function(e) {\n\t\tbackstage.switchTab(this.getAttribute(\"task\"));\n\t\treturn false;\n\t},\n\n\t// Switch to a given tab, or none if null is passed\n\tswitchTab: function(tabName) {\n\t\tvar tabElem = null;\n\t\tvar e = this.toolbar.firstChild;\n\t\twhile(e)\n\t\t\t{\n\t\t\tif(e.getAttribute && e.getAttribute(\"task\") == tabName)\n\t\t\t\ttabElem = e;\n\t\t\te = e.nextSibling;\n\t\t\t}\n\t\tif(tabName == backstage.currTabName)\n\t\t\treturn;\n\t\tif(backstage.currTabElem) {\n\t\t\tremoveClass(this.currTabElem,\"backstageSelTab\");\n\t\t}\n\t\tif(tabElem && tabName) {\n\t\t\tbackstage.preparePanel();\n\t\t\taddClass(tabElem,\"backstageSelTab\");\n\t\t\tvar task = config.tasks[tabName];\n\t\t\twikify(task.content,backstage.panelBody,null,null);\n\t\t\tbackstage.showPanel();\n\t\t} else if(backstage.currTabElem) {\n\t\t\tbackstage.hidePanel();\n\t\t}\n\t\tbackstage.currTabName = tabName;\n\t\tbackstage.currTabElem = tabElem;\n\t},\n\n\tisPanelVisible: function() {\n\t\treturn backstage.panel ? backstage.panel.style.display == \"block\" : false;\n\t},\n\n\tpreparePanel: function() {\n\t\tbackstage.cloak.style.height = findWindowHeight() + \"px\";\n\t\tbackstage.cloak.style.display = \"block\";\n\t\tremoveChildren(backstage.panelBody);\n\t\treturn backstage.panelBody;\n\t},\n\t\n\tshowPanel: function() {\n\t\tbackstage.panel.style.display = \"block\";\n\t\tif(anim && config.options.chkAnimate) {\n\t\t\tbackstage.panel.style.top = (-backstage.panel.offsetHeight) + \"px\";\n\t\t\tvar p = [\n\t\t\t\t{style: \"top\", start: -backstage.panel.offsetHeight, end: 0, template: \"%0px\"}\n\t\t\t];\n\t\t\tanim.startAnimating(new Morpher(backstage.panel,config.animDuration,p),new Scroller(backstage.panel,false));\n\t\t} else {\n\t\t\tbackstage.panel.style.top = \"0px\";\n\t\t}\n\t\treturn backstage.panelBody;\n\t},\n\t\n\thidePanel: function() {\n\t\tbackstage.currTabName = null;\n\t\tbackstage.currTabElem = null;\n\t\tif(anim && config.options.chkAnimate) {\n\t\t\tvar p = [\n\t\t\t\t{style: \"top\", start: 0, end: -(backstage.panel.offsetHeight), template: \"%0px\"},\n\t\t\t\t{style: \"display\", atEnd: \"none\"}\n\t\t\t];\n\t\t\tvar c = function(element,properties) {backstage.cloak.style.display = \"none\";};\n\t\t\tanim.startAnimating(new Morpher(backstage.panel,config.animDuration,p,c));\n\t\t } else {\n\t\t\tbackstage.panel.style.display = \"none\";\n\t\t\tbackstage.cloak.style.display = \"none\";\n\t\t}\n\t}\n};\n\nconfig.macros.backstage = {};\n\nconfig.macros.backstage.handler = function(place,macroName,params,wikifier,paramString,tiddler)\n{\n\tvar backstageTask = config.tasks[params[0]];\n\tif(backstageTask)\n\t\tcreateTiddlyButton(place,backstageTask.text,backstageTask.tooltip,function(e) {backstage.switchTab(params[0]); return false;});\n};\n\n//--\n//-- ImportTiddlers macro\n//--\n\nconfig.macros.importTiddlers.handler = function(place,macroName,params,wikifier,paramString,tiddler)\n{\n\tif(readOnly) {\n\t\tcreateTiddlyElement(place,\"div\",null,\"marked\",this.readOnlyWarning);\n\t\treturn;\n\t}\n\tvar w = new Wizard();\n\tw.createWizard(place,this.wizardTitle);\n\tthis.restart(w);\n};\n\nconfig.macros.importTiddlers.onCancel = function(e)\n{\n\tvar wizard = new Wizard(this);\n\tvar place = wizard.clear();\n\tconfig.macros.importTiddlers.restart(wizard);\n\treturn false;\n};\n\nconfig.macros.importTiddlers.restart = function(wizard)\n{\n\twizard.addStep(this.step1Title,this.step1Html);\n\tvar s = wizard.getElement(\"selTypes\");\n\tfor(var t in config.adaptors) {\n\t\tvar e = createTiddlyElement(s,\"option\",null,null,t);\n\t\te.value = t;\n\t}\n\ts = wizard.getElement(\"selFeeds\");\n\tvar feeds = this.getFeeds();\n\tfor(t in feeds) {\n\t\te = createTiddlyElement(s,\"option\",null,null,t);\n\t\te.value = t;\n\t}\n\twizard.setValue(\"feeds\",feeds);\n\ts.onchange = config.macros.importTiddlers.onFeedChange;\n\tvar fileInput = wizard.getElement(\"txtBrowse\");\n\tfileInput.onchange = config.macros.importTiddlers.onBrowseChange;\n\tfileInput.onkeyup = config.macros.importTiddlers.onBrowseChange;\n\twizard.setButtons([{caption: this.openLabel, tooltip: this.openPrompt, onClick: config.macros.importTiddlers.onOpen}]);\n};\n\nconfig.macros.importTiddlers.getFeeds = function()\n{\n\tvar feeds = {};\n\tvar tagged = store.getTaggedTiddlers(\"systemServer\",\"title\");\n\tfor(var t=0; t<tagged.length; t++) {\n\t\tvar title = tagged[t].title;\n\t\tvar serverType = store.getTiddlerSlice(title,\"Type\");\n\t\tif(!serverType)\n\t\t\tserverType = \"file\";\n\t\tfeeds[title] = {title: title,\n\t\t\t\t\t\turl: store.getTiddlerSlice(title,\"URL\"),\n\t\t\t\t\t\tworkspace: store.getTiddlerSlice(title,\"Workspace\"),\n\t\t\t\t\t\tworkspaceList: store.getTiddlerSlice(title,\"WorkspaceList\"),\n\t\t\t\t\t\ttiddlerFilter: store.getTiddlerSlice(title,\"TiddlerFilter\"),\n\t\t\t\t\t\tserverType: serverType,\n\t\t\t\t\t\tdescription: store.getTiddlerSlice(title,\"Description\")};\n\t}\n\treturn feeds;\n};\n\nconfig.macros.importTiddlers.onFeedChange = function(e)\n{\n\tvar wizard = new Wizard(this);\n\tvar selTypes = wizard.getElement(\"selTypes\");\n\tvar fileInput = wizard.getElement(\"txtPath\");\n\tvar feeds = wizard.getValue(\"feeds\");\n\tvar f = feeds[this.value];\n\tif(f) {\n\t\tselTypes.value = f.serverType;\n\t\tfileInput.value = f.url;\n\t\tthis.selectedIndex = 0;\n\t\twizard.setValue(\"feedName\",f.serverType);\n\t\twizard.setValue(\"feedHost\",f.url);\n\t\twizard.setValue(\"feedWorkspace\",f.workspace);\n\t\twizard.setValue(\"feedWorkspaceList\",f.workspaceList);\n\t\twizard.setValue(\"feedTiddlerFilter\",f.tiddlerFilter);\n\t}\n\treturn false;\n};\n\nconfig.macros.importTiddlers.onBrowseChange = function(e)\n{\n\tvar wizard = new Wizard(this);\n\tvar fileInput = wizard.getElement(\"txtPath\");\n\tfileInput.value = \"file://\" + this.value;\n\tvar serverType = wizard.getElement(\"selTypes\");\n\tserverType.value = \"file\";\n\treturn false;\n};\n\nconfig.macros.importTiddlers.onOpen = function(e)\n{\n\tvar wizard = new Wizard(this);\n\tvar fileInput = wizard.getElement(\"txtPath\");\n\tvar url = fileInput.value;\n\tvar serverType = wizard.getElement(\"selTypes\").value;\n\tvar adaptor = new config.adaptors[serverType];\n\twizard.setValue(\"adaptor\",adaptor);\n\twizard.setValue(\"serverType\",serverType);\n\twizard.setValue(\"host\",url);\n\tvar context = {};\n\tvar ret = adaptor.openHost(url,context,wizard,config.macros.importTiddlers.onOpenHost);\n\tif(ret !== true)\n\t\tdisplayMessage(ret);\n\twizard.setButtons([{caption: config.macros.importTiddlers.cancelLabel, tooltip: config.macros.importTiddlers.cancelPrompt, onClick: config.macros.importTiddlers.onCancel}],config.macros.importTiddlers.statusOpenHost);\n\treturn false;\n};\n\nconfig.macros.importTiddlers.onOpenHost = function(context,wizard)\n{\n\tvar adaptor = wizard.getValue(\"adaptor\");\n\tif(context.status !== true)\n\t\tdisplayMessage(\"Error in importTiddlers.onOpenHost: \" + context.statusText);\n\tvar ret = adaptor.getWorkspaceList(context,wizard,config.macros.importTiddlers.onGetWorkspaceList);\n\tif(ret !== true)\n\t\tdisplayMessage(ret);\n\twizard.setButtons([{caption: config.macros.importTiddlers.cancelLabel, tooltip: config.macros.importTiddlers.cancelPrompt, onClick: config.macros.importTiddlers.onCancel}],config.macros.importTiddlers.statusGetWorkspaceList);\n};\n\nconfig.macros.importTiddlers.onGetWorkspaceList = function(context,wizard)\n{\n\tif(context.status !== true)\n\t\tdisplayMessage(\"Error in importTiddlers.onGetWorkspaceList: \" + context.statusText);\n\twizard.addStep(config.macros.importTiddlers.step2Title,config.macros.importTiddlers.step2Html);\n\tvar s = wizard.getElement(\"selWorkspace\");\n\ts.onchange = config.macros.importTiddlers.onWorkspaceChange;\n\tfor(var t=0; t<context.workspaces.length; t++) {\n\t\tvar e = createTiddlyElement(s,\"option\",null,null,context.workspaces[t].title);\n\t\te.value = context.workspaces[t].title;\n\t}\n\tvar workspaceList = wizard.getValue(\"feedWorkspaceList\");\n\tif(workspaceList) {\n\t\tvar list = workspaceList.parseParams(\"workspace\",null,false,true);\n\t\tfor(var n=1; n<list.length; n++) {\n\t\t\tif(context.workspaces.findByField(\"title\",list[n].value) == null) {\n\t\t\t\te = createTiddlyElement(s,\"option\",null,null,list[n].value);\n\t\t\t\te.value = list[n].value;\n\t\t\t}\n\t\t}\n\t}\n\tvar workspace = wizard.getValue(\"feedWorkspace\");\n\tif(workspace) {\n\t\tt = wizard.getElement(\"txtWorkspace\");\n\t\tt.value = workspace;\n\t}\n\twizard.setButtons([{caption: config.macros.importTiddlers.openLabel, tooltip: config.macros.importTiddlers.openPrompt, onClick: config.macros.importTiddlers.onChooseWorkspace}]);\n};\n\nconfig.macros.importTiddlers.onWorkspaceChange = function(e)\n{\n\tvar wizard = new Wizard(this);\n\tvar t = wizard.getElement(\"txtWorkspace\");\n\tt.value  = this.value;\n\tthis.selectedIndex = 0;\n\treturn false;\n};\n\nconfig.macros.importTiddlers.onChooseWorkspace = function(e)\n{\n\tvar wizard = new Wizard(this);\n\tvar adaptor = wizard.getValue(\"adaptor\");\n\tvar workspace = wizard.getElement(\"txtWorkspace\").value;\n\twizard.setValue(\"workspace\",workspace);\n\tvar context = {};\n\tvar ret = adaptor.openWorkspace(workspace,context,wizard,config.macros.importTiddlers.onOpenWorkspace);\n\tif(ret !== true)\n\t\tdisplayMessage(ret);\n\twizard.setButtons([{caption: config.macros.importTiddlers.cancelLabel, tooltip: config.macros.importTiddlers.cancelPrompt, onClick: config.macros.importTiddlers.onCancel}],config.macros.importTiddlers.statusOpenWorkspace);\n\treturn false;\n};\n\nconfig.macros.importTiddlers.onOpenWorkspace = function(context,wizard)\n{\n\tif(context.status !== true)\n\t\tdisplayMessage(\"Error in importTiddlers.onOpenWorkspace: \" + context.statusText);\n\tvar adaptor = wizard.getValue(\"adaptor\");\n\tvar ret = adaptor.getTiddlerList(context,wizard,config.macros.importTiddlers.onGetTiddlerList,wizard.getValue(\"feedTiddlerFilter\"));\n\tif(ret !== true)\n\t\tdisplayMessage(ret);\n\twizard.setButtons([{caption: config.macros.importTiddlers.cancelLabel, tooltip: config.macros.importTiddlers.cancelPrompt, onClick: config.macros.importTiddlers.onCancel}],config.macros.importTiddlers.statusGetTiddlerList);\n};\n\nconfig.macros.importTiddlers.onGetTiddlerList = function(context,wizard)\n{\n\tif(context.status !== true)\n\t\tdisplayMessage(\"Error in importTiddlers.onGetTiddlerList: \" + context.statusText);\n\t// Extract data for the listview\n\tvar listedTiddlers = [];\n\tif(context.tiddlers) {\n\t\tfor(var n=0; n<context.tiddlers.length; n++) {\n\t\t\tvar tiddler = context.tiddlers[n];\n\t\t\tlistedTiddlers.push({\n\t\t\t\ttitle: tiddler.title,\n\t\t\t\tmodified: tiddler.modified,\n\t\t\t\tmodifier: tiddler.modifier,\n\t\t\t\ttext: tiddler.text ? wikifyPlainText(tiddler.text,100) : \"\",\n\t\t\t\ttags: tiddler.tags,\n\t\t\t\tsize: tiddler.text ? tiddler.text.length : 0,\n\t\t\t\ttiddler: tiddler\n\t\t\t});\n\t\t}\n\t}\n\tlistedTiddlers.sort(function(a,b) {return a.title < b.title ? -1 : (a.title == b.title ? 0 : +1);});\n\t// Display the listview\n\twizard.addStep(config.macros.importTiddlers.step3Title,config.macros.importTiddlers.step3Html);\n\tvar markList = wizard.getElement(\"markList\");\n\tvar listWrapper = document.createElement(\"div\");\n\tmarkList.parentNode.insertBefore(listWrapper,markList);\n\tvar listView = ListView.create(listWrapper,listedTiddlers,config.macros.importTiddlers.listViewTemplate);\n\twizard.setValue(\"listView\",listView);\n\tvar txtSaveTiddler = wizard.getElement(\"txtSaveTiddler\");\n\ttxtSaveTiddler.value = config.macros.importTiddlers.generateSystemServerName(wizard);\n\twizard.setButtons([\n\t\t\t{caption: config.macros.importTiddlers.cancelLabel, tooltip: config.macros.importTiddlers.cancelPrompt, onClick: config.macros.importTiddlers.onCancel},\n\t\t\t{caption: config.macros.importTiddlers.importLabel, tooltip: config.macros.importTiddlers.importPrompt, onClick:  config.macros.importTiddlers.doImport}\n\t\t]);\n};\n\nconfig.macros.importTiddlers.generateSystemServerName = function(wizard)\n{\n\tvar serverType = wizard.getValue(\"serverType\");\n\tvar host = wizard.getValue(\"host\");\n\tvar workspace = wizard.getValue(\"workspace\");\n\tvar pattern = config.macros.importTiddlers[workspace ? \"systemServerNamePattern\" : \"systemServerNamePatternNoWorkspace\"];\n\treturn pattern.format([serverType,host,workspace]);\n};\n\nconfig.macros.importTiddlers.saveServerTiddler = function(wizard)\n{\n\tvar txtSaveTiddler = wizard.getElement(\"txtSaveTiddler\").value;\n\tif(store.tiddlerExists(txtSaveTiddler)) {\n\t\tif(!confirm(config.macros.importTiddlers.confirmOverwriteSaveTiddler.format([txtSaveTiddler])))\n\t\t\treturn;\n\t\tstore.suspendNotifications();\n\t\tstore.removeTiddler(txtSaveTiddler);\n\t\tstore.resumeNotifications();\n\t}\n\tvar serverType = wizard.getValue(\"serverType\");\n\tvar host = wizard.getValue(\"host\");\n\tvar workspace = wizard.getValue(\"workspace\");\n\tvar text = config.macros.importTiddlers.serverSaveTemplate.format([serverType,host,workspace]);\n\tstore.saveTiddler(txtSaveTiddler,txtSaveTiddler,text,config.macros.importTiddlers.serverSaveModifier,new Date(),[\"systemServer\"]);\n};\n\nconfig.macros.importTiddlers.doImport = function(e)\n{\n\tvar wizard = new Wizard(this);\n\tif(wizard.getElement(\"chkSave\").checked)\n\t\tconfig.macros.importTiddlers.saveServerTiddler(wizard);\n\tvar chkSync = wizard.getElement(\"chkSync\").checked;\n\twizard.setValue(\"sync\",chkSync);\n\tvar listView = wizard.getValue(\"listView\");\n\tvar rowNames = ListView.getSelectedRows(listView);\n\tvar adaptor = wizard.getValue(\"adaptor\");\n\tvar overwrite = new Array();\n\tvar t;\n\tfor(t=0; t<rowNames.length; t++) {\n\t\tif(store.tiddlerExists(rowNames[t]))\n\t\t\toverwrite.push(rowNames[t]);\n\t}\n\tif(overwrite.length > 0) {\n\t\tif(!confirm(config.macros.importTiddlers.confirmOverwriteText.format([overwrite.join(\", \")])))\n\t\t\treturn false;\n\t}\n\twizard.addStep(config.macros.importTiddlers.step4Title.format([rowNames.length]),config.macros.importTiddlers.step4Html);\n\tfor(t=0; t<rowNames.length; t++) {\n\t\tvar link = document.createElement(\"div\");\n\t\tcreateTiddlyLink(link,rowNames[t],true);\n\t\tvar place = wizard.getElement(\"markReport\");\n\t\tplace.parentNode.insertBefore(link,place);\n\t}\n\twizard.setValue(\"remainingImports\",rowNames.length);\n\twizard.setButtons([\n\t\t\t{caption: config.macros.importTiddlers.cancelLabel, tooltip: config.macros.importTiddlers.cancelPrompt, onClick: config.macros.importTiddlers.onCancel}\n\t\t],config.macros.importTiddlers.statusDoingImport);\n\tfor(t=0; t<rowNames.length; t++) {\n\t\tvar context = {};\n\t\tcontext.allowSynchronous = true;\n\t\tvar inbound = adaptor.getTiddler(rowNames[t],context,wizard,config.macros.importTiddlers.onGetTiddler);\n\t}\n\treturn false;\n};\n\nconfig.macros.importTiddlers.onGetTiddler = function(context,wizard)\n{\n\tif(!context.status)\n\t\tdisplayMessage(\"Error in importTiddlers.onGetTiddler: \" + context.statusText);\n\tvar tiddler = context.tiddler;\n\tstore.suspendNotifications();\n\tstore.saveTiddler(tiddler.title, tiddler.title, tiddler.text, tiddler.modifier, tiddler.modified, tiddler.tags, tiddler.fields, true, tiddler.created);\n\tif(!wizard.getValue(\"sync\")) {\n\t\tstore.setValue(tiddler.title,'server',null);\n\t}\n\tstore.resumeNotifications();\n\tif(!context.isSynchronous) \n\t\tstore.notify(tiddler.title,true);\n\tvar remainingImports = wizard.getValue(\"remainingImports\")-1;\n\twizard.setValue(\"remainingImports\",remainingImports);\n\tif(remainingImports == 0) {\n\t\tif(context.isSynchronous) {\n\t\t\tstore.notifyAll();\n\t\t\trefreshDisplay();\n\t\t}\n\t\twizard.setButtons([\n\t\t\t\t{caption: config.macros.importTiddlers.doneLabel, tooltip: config.macros.importTiddlers.donePrompt, onClick: config.macros.importTiddlers.onCancel}\n\t\t\t],config.macros.importTiddlers.statusDoneImport);\n\t\tautoSaveChanges();\n\t}\n};\n\n//--\n//-- Sync macro\n//--\n\n// Synchronisation handlers\nconfig.syncers = {};\n\n// Sync state.\nvar currSync = null;\n\n// sync macro\nconfig.macros.sync.handler = function(place,macroName,params,wikifier,paramString,tiddler)\n{\n\tif(!wikifier.isStatic)\n\t\tthis.startSync(place);\n};\n\nconfig.macros.sync.startSync = function(place)\n{\n\tif(currSync)\n\t\tconfig.macros.sync.cancelSync();\n\tcurrSync = {};\n\tcurrSync.syncList = this.getSyncableTiddlers();\n\tthis.createSyncTasks();\n\tthis.preProcessSyncableTiddlers();\n\tvar wizard = new Wizard();\n\tcurrSync.wizard = wizard;\n\twizard.createWizard(place,this.wizardTitle);\n\twizard.addStep(this.step1Title,this.step1Html);\n\tvar markList = wizard.getElement(\"markList\");\n\tvar listWrapper = document.createElement(\"div\");\n\tmarkList.parentNode.insertBefore(listWrapper,markList);\n\tcurrSync.listView = ListView.create(listWrapper,currSync.syncList,this.listViewTemplate);\n\tthis.processSyncableTiddlers();\n\twizard.setButtons([\n\t\t\t{caption: this.syncLabel, tooltip: this.syncPrompt, onClick: this.doSync}\n\t\t]);\n};\n\nconfig.macros.sync.getSyncableTiddlers = function ()\n{\n\tvar list = [];\n\tstore.forEachTiddler(function(title,tiddler) {\n\t\tvar syncItem = {};\n\t\tsyncItem.serverType = tiddler.getServerType();\n\t\tsyncItem.serverHost = tiddler.fields['server.host'];\n\t\tsyncItem.serverWorkspace = tiddler.fields['server.workspace'];\n\t\tsyncItem.tiddler = tiddler;\n\t\tsyncItem.title = tiddler.title;\n\t\tsyncItem.isTouched = tiddler.isTouched();\n\t\tsyncItem.selected = syncItem.isTouched;\n\t\tsyncItem.syncStatus = config.macros.sync.syncStatusList[syncItem.isTouched ? \"changedLocally\" : \"none\"];\n\t\tsyncItem.status = syncItem.syncStatus.text;\n\t\tif(syncItem.serverType && syncItem.serverHost)\n\t\t\tlist.push(syncItem);\n\t\t});\n\tlist.sort(function(a,b) {return a.title < b.title ? -1 : (a.title == b.title ? 0 : +1);});\n\treturn list;\n};\n\nconfig.macros.sync.preProcessSyncableTiddlers = function()\n{\n\tfor(var t=0; t<currSync.syncList.length; t++) {\n\t\tsi = currSync.syncList[t];\n\t\tvar ti = si.syncTask.syncMachine.generateTiddlerInfo(si.tiddler);\n\t\tsi.serverUrl = ti.uri;\n\t}\n};\n\nconfig.macros.sync.processSyncableTiddlers = function()\n{\n\tfor(var t=0; t<currSync.syncList.length; t++) {\n\t\tsi = currSync.syncList[t];\n\t\tsi.rowElement.style.backgroundColor = si.syncStatus.color;\n\t}\n};\n\nconfig.macros.sync.createSyncTasks = function()\n{\n\tcurrSync.syncTasks = [];\n\tfor(var t=0; t<currSync.syncList.length; t++) {\n\t\tvar si = currSync.syncList[t];\n\t\tvar r = null;\n\t\tfor(var st=0; st<currSync.syncTasks.length; st++) {\n\t\t\tvar cst = currSync.syncTasks[st];\n\t\t\tif(si.serverType == cst.serverType && si.serverHost == cst.serverHost && si.serverWorkspace == cst.serverWorkspace)\n\t\t\t\tr = cst;\n\t\t}\n\t\tif(r == null) {\n\t\t\tsi.syncTask = this.createSyncTask(si);\n\t\t\tcurrSync.syncTasks.push(si.syncTask);\n\t\t} else {\n\t\t\tsi.syncTask = r;\n\t\t\tr.syncItems.push(si);\n\t\t}\n\t}\n};\n\nconfig.macros.sync.createSyncTask = function(syncItem)\n{\n\tvar st = {};\n\tst.serverType = syncItem.serverType;\n\tst.serverHost = syncItem.serverHost;\n\tst.serverWorkspace = syncItem.serverWorkspace;\n\tst.syncItems = [syncItem];\n\tst.syncMachine = new SyncMachine(st.serverType,{\n\t\tstart: function() {\n\t\t\treturn this.openHost(st.serverHost,\"openWorkspace\");\n\t\t},\n\t\topenWorkspace: function() {\n\t\t\treturn this.openWorkspace(st.serverWorkspace,\"getTiddlerList\");\n\t\t},\n\t\tgetTiddlerList: function() {\n\t\t\treturn this.getTiddlerList(\"gotTiddlerList\");\n\t\t},\n\t\tgotTiddlerList: function(tiddlers) {\n\t\t\tfor(var t=0; t<st.syncItems.length; t++) {\n\t\t\t\tvar si = st.syncItems[t];\n\t\t\t\tvar f = tiddlers.findByField(\"title\",si.title);\n\t\t\t\tif(f !== null) {\n\t\t\t\t\tif(tiddlers[f].fields['server.page.revision'] > si.tiddler.fields['server.page.revision']) {\n\t\t\t\t\t\tsi.syncStatus = config.macros.sync.syncStatusList[si.isTouched ? 'changedBoth' : 'changedServer'];\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tsi.syncStatus = config.macros.sync.syncStatusList.notFound;\n\t\t\t\t}\n\t\t\t\tconfig.macros.sync.updateSyncStatus(si);\n\t\t\t}\n\t\t},\n\t\tgetTiddler: function(title) {\n\t\t\treturn this.getTiddler(title,\"onGetTiddler\");\n\t\t},\n\t\tonGetTiddler: function(tiddler) {\n\t\t\tvar syncItem = st.syncItems.findByField(\"title\",tiddler.title);\n\t\t\tif(syncItem !== null) {\n\t\t\t\tsyncItem = st.syncItems[syncItem];\n\t\t\t\tstore.saveTiddler(tiddler.title, tiddler.title, tiddler.text, tiddler.modifier, tiddler.modified, tiddler.tags, tiddler.fields, true, tiddler.created);\n\t\t\t\tsyncItem.syncStatus = config.macros.sync.syncStatusList.gotFromServer;\n\t\t\t\tconfig.macros.sync.updateSyncStatus(syncItem);\n\t\t\t}\n\t\t},\n\t\tputTiddler: function(tiddler) {\n\t\t\treturn this.putTiddler(tiddler,\"onPutTiddler\");\n\t\t},\n\t\tonPutTiddler: function(tiddler) {\n\t\t\tvar syncItem = st.syncItems.findByField(\"title\",tiddler.title);\n\t\t\tif(syncItem !== null) {\n\t\t\t\tsyncItem = st.syncItems[syncItem];\n\t\t\t\tstore.resetTiddler(tiddler.title);\n\t\t\t\tsyncItem.syncStatus = config.macros.sync.syncStatusList.putToServer;\n\t\t\t\tconfig.macros.sync.updateSyncStatus(syncItem);\n\t\t\t}\n\t\t}\n\t});\n\tst.syncMachine.go();\n\treturn st;\n};\n\nconfig.macros.sync.updateSyncStatus = function(syncItem)\n{\n\tvar e = syncItem.colElements[\"status\"];\n\tremoveChildren(e);\n\tcreateTiddlyText(e,syncItem.syncStatus.text);\n\tsyncItem.rowElement.style.backgroundColor = syncItem.syncStatus.color;\n};\n\nconfig.macros.sync.doSync = function(e)\n{\n\tvar rowNames = ListView.getSelectedRows(currSync.listView);\n\tfor(var t=0; t<currSync.syncList.length; t++) {\n\t\tvar si = currSync.syncList[t];\n\t\tif(rowNames.indexOf(si.title) != -1) {\n\t\t\tconfig.macros.sync.doSyncItem(si);\n\t\t}\n\t}\n\treturn false;\n};\n\nconfig.macros.sync.doSyncItem = function(syncItem)\n{\n\tvar r = true;\n\tvar sl = config.macros.sync.syncStatusList;\n\tswitch(syncItem.syncStatus) {\n\t\tcase sl.changedServer:\n\t\t\tr = syncItem.syncTask.syncMachine.go(\"getTiddler\",syncItem.title);\n\t\t\tbreak;\n\t\tcase sl.notFound:\n\t\tcase sl.changedLocally:\n\t\tcase sl.changedBoth:\n\t\t\tr = syncItem.syncTask.syncMachine.go(\"putTiddler\",syncItem.tiddler);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t}\n\tif(r !== true)\n\t\tdisplayMessage(\"Error in doSyncItem: \" + r);\n};\n\nconfig.macros.sync.cancelSync = function()\n{\n\tcurrSync = null;\n};\n\nfunction SyncMachine(serverType,steps)\n{\n\tthis.serverType = serverType;\n\tthis.adaptor = new config.adaptors[serverType];\n\tthis.steps = steps;\n}\n\nSyncMachine.prototype.go = function(step,varargs)\n{\n\tif(!step)\n\t\tstep = \"start\";\n\tvar h = this.steps[step];\n\tif(!h)\n\t\treturn null;\n\tvar a = [];\n\tfor(var t=1; t<arguments.length; t++)\n\t\ta.push(arguments[t]);\n\tvar r = h.apply(this,a);\n\tif(typeof r == \"string\")\n\t\tthis.invokeError(r);\n\treturn r;\n};\n\nSyncMachine.prototype.invokeError = function(message)\n{\n\tif(this.steps.error)\n\t\tthis.steps.error(message);\n};\n\nSyncMachine.prototype.openHost = function(host,nextStep)\n{\n\tvar me = this;\n\treturn me.adaptor.openHost(host,null,null,function(context) {\n\t\tif(typeof context.status == \"string\")\n\t\t\tme.invokeError(context.status);\n\t\telse\n\t\t\tme.go(nextStep);\n\t});\n};\n\nSyncMachine.prototype.getWorkspaceList = function(nextStep)\n{\n\tvar me = this;\n\treturn me.adaptor.getWorkspaceList(null,null,function(context) {\n\t\tif(typeof context.status == \"string\")\n\t\t\tme.invokeError(context.status);\n\t\telse\n\t\t\tme.go(nextStep,context.workspaces);\n\t});\n};\n\nSyncMachine.prototype.openWorkspace = function(workspace,nextStep)\n{\n\tvar me = this;\n\treturn me.adaptor.openWorkspace(workspace,null,null,function(context) {\n\t\tif(typeof context.status == \"string\")\n\t\t\tme.invokeError(context.status);\n\t\telse\n\t\t\tme.go(nextStep);\n\t});\n};\n\nSyncMachine.prototype.getTiddlerList = function(nextStep)\n{\n\tvar me = this;\n\treturn me.adaptor.getTiddlerList(null,null,function(context) {\n\t\tif(typeof context.status == \"string\")\n\t\t\tme.invokeError(context.status);\n\t\telse\n\t\t\tme.go(nextStep,context.tiddlers);\n\t});\n};\n\nSyncMachine.prototype.generateTiddlerInfo = function(tiddler)\n{\n\treturn this.adaptor.generateTiddlerInfo(tiddler);\n};\n\nSyncMachine.prototype.getTiddler = function(title,nextStep)\n{\n\tvar me = this;\n\treturn me.adaptor.getTiddler(title,null,null,function(context) {\n\t\tif(typeof context.status == \"string\")\n\t\t\tme.invokeError(context.status);\n\t\telse\n\t\t\tme.go(nextStep,context.tiddler);\n\t});\n};\n\nSyncMachine.prototype.putTiddler = function(tiddler,nextStep)\n{\n\tvar me = this;\n\treturn me.adaptor.putTiddler(tiddler,null,null,function(context) {\n\t\tif(typeof context.status == \"string\")\n\t\t\tme.invokeError(context.status);\n\t\telse\n\t\t\tme.go(nextStep,tiddler);\n\t});\n};\n\n//--\n//-- Manager UI for groups of tiddlers\n//--\n\nconfig.macros.plugins.handler = function(place,macroName,params,wikifier,paramString,tiddler)\n{\n\tvar wizard = new Wizard();\n\twizard.createWizard(place,this.wizardTitle);\n\twizard.addStep(this.step1Title,this.step1Html);\n\tvar markList = wizard.getElement(\"markList\");\n\tvar listWrapper = document.createElement(\"div\");\n\tmarkList.parentNode.insertBefore(listWrapper,markList);\n\tlistWrapper.setAttribute(\"refresh\",\"macro\");\n\tlistWrapper.setAttribute(\"macroName\",\"plugins\");\n\tlistWrapper.setAttribute(\"params\",paramString);\n\tthis.refresh(listWrapper,paramString);\n};\n\nconfig.macros.plugins.refresh = function(listWrapper,params)\n{\n\tvar wizard = new Wizard(listWrapper);\n\tvar selectedRows = [];\n\tListView.forEachSelector(listWrapper,function(e,rowName) {\n\t\t\tif(e.checked)\n\t\t\t\tselectedRows.push(e.getAttribute(\"rowName\"));\n\t\t});\n\tremoveChildren(listWrapper);\n\tparams = params.parseParams(\"anon\");\n\tvar plugins = installedPlugins.slice(0);\n\tvar t,tiddler,p;\n\tvar configTiddlers = store.getTaggedTiddlers(\"systemConfig\");\n\tfor(t=0; t<configTiddlers.length; t++) {\n\t\ttiddler = configTiddlers[t];\n\t\tif(plugins.findByField(\"title\",tiddler.title) == null) {\n\t\t\tp = getPluginInfo(tiddler);\n\t\t\tp.executed = false;\n\t\t\tp.log.splice(0,0,this.skippedText);\n\t\t\tplugins.push(p);\n\t\t}\n\t}\n\tfor(t=0; t<plugins.length; t++) {\n\t\tp = plugins[t];\n\t\tp.size = p.tiddler.text ? p.tiddler.text.length : 0;\n\t\tp.forced = p.tiddler.isTagged(\"systemConfigForce\");\n\t\tp.disabled = p.tiddler.isTagged(\"systemConfigDisable\");\n\t\tp.Selected = selectedRows.indexOf(plugins[t].title) != -1;\n\t}\n\tif(plugins.length == 0) {\n\t\tcreateTiddlyElement(listWrapper,\"em\",null,null,this.noPluginText);\n\t\twizard.setButtons([]);\n\t} else {\n\t\tvar listView = ListView.create(listWrapper,plugins,this.listViewTemplate,this.onSelectCommand);\n\t\twizard.setValue(\"listView\",listView);\n\t\twizard.setButtons([\n\t\t\t\t{caption: config.macros.plugins.removeLabel, tooltip: config.macros.plugins.removePrompt, onClick:  config.macros.plugins.doRemoveTag},\n\t\t\t\t{caption: config.macros.plugins.deleteLabel, tooltip: config.macros.plugins.deletePrompt, onClick:  config.macros.plugins.doDelete}\n\t\t\t]);\n\t}\n};\n\nconfig.macros.plugins.doRemoveTag = function(e)\n{\n\tvar wizard = new Wizard(this);\n\tvar listView = wizard.getValue(\"listView\");\n\tvar rowNames = ListView.getSelectedRows(listView);\n\tif(rowNames.length == 0) {\n\t\talert(config.messages.nothingSelected);\n\t} else {\n\t\tfor(var t=0; t<rowNames.length; t++)\n\t\t\tstore.setTiddlerTag(rowNames[t],false,\"systemConfig\");\n\t}\n};\n\nconfig.macros.plugins.doDelete = function(e)\n{\n\tvar wizard = new Wizard(this);\n\tvar listView = wizard.getValue(\"listView\");\n\tvar rowNames = ListView.getSelectedRows(listView);\n\tif(rowNames.length == 0) {\n\t\talert(config.messages.nothingSelected);\n\t} else {\n\t\tif(confirm(config.macros.plugins.confirmDeleteText.format([rowNames.join(\", \")]))) {\n\t\t\tfor(t=0; t<rowNames.length; t++) {\n\t\t\t\tstore.removeTiddler(rowNames[t]);\n\t\t\t\tstory.closeTiddler(rowNames[t],true);\n\t\t\t}\n\t\t}\n\t}\n};\n\n//--\n//-- Message area\n//--\n\nfunction getMessageDiv()\n{\n\tvar msgArea = document.getElementById(\"messageArea\");\n\tif(!msgArea)\n\t\treturn null;\n\tif(!msgArea.hasChildNodes())\n\t\tcreateTiddlyButton(createTiddlyElement(msgArea,\"div\",null,\"messageToolbar\"),\n\t\t\tconfig.messages.messageClose.text,\n\t\t\tconfig.messages.messageClose.tooltip,\n\t\t\tclearMessage);\n\tmsgArea.style.display = \"block\";\n\treturn createTiddlyElement(msgArea,\"div\");\n}\n\nfunction displayMessage(text,linkText)\n{\n\tvar e = getMessageDiv();\n\tif(!e) {\n\t\talert(text);\n\t\treturn;\n\t}\n\tif(linkText) {\n\t\tvar link = createTiddlyElement(e,\"a\",null,null,text);\n\t\tlink.href = linkText;\n\t\tlink.target = \"_blank\";\n\t} else {\n\t\te.appendChild(document.createTextNode(text));\n\t}\n}\n\nfunction clearMessage()\n{\n\tvar msgArea = document.getElementById(\"messageArea\");\n\tif(msgArea) {\n\t\tremoveChildren(msgArea);\n\t\tmsgArea.style.display = \"none\";\n\t}\n\treturn false;\n}\n\n//--\n//-- Refresh mechanism\n//--\n\nconfig.refreshers = {\n\tlink: function(e,changeList)\n\t\t{\n\t\tvar title = e.getAttribute(\"tiddlyLink\");\n\t\trefreshTiddlyLink(e,title);\n\t\treturn true;\n\t\t},\n\t\n\ttiddler: function(e,changeList)\n\t\t{\n\t\tvar title = e.getAttribute(\"tiddler\");\n\t\tvar template = e.getAttribute(\"template\");\n\t\tif(changeList && changeList.indexOf(title) != -1 && !story.isDirty(title))\n\t\t\tstory.refreshTiddler(title,template,true);\n\t\telse\n\t\t\trefreshElements(e,changeList);\n\t\treturn true;\n\t\t},\n\n\tcontent: function(e,changeList)\n\t\t{\n\t\tvar title = e.getAttribute(\"tiddler\");\n\t\tvar force = e.getAttribute(\"force\");\n\t\tif(force != null || changeList == null || changeList.indexOf(title) != -1) {\n\t\t\tremoveChildren(e);\n\t\t\twikify(store.getTiddlerText(title,title),e,null);\n\t\t\treturn true;\n\t\t} else\n\t\t\treturn false;\n\t\t},\n\n\tmacro: function(e,changeList)\n\t\t{\n\t\tvar macro = e.getAttribute(\"macroName\");\n\t\tvar params = e.getAttribute(\"params\");\n\t\tif(macro)\n\t\t\tmacro = config.macros[macro];\n\t\tif(macro && macro.refresh)\n\t\t\tmacro.refresh(e,params);\n\t\treturn true;\n\t\t}\n};\n\nfunction refreshElements(root,changeList)\n{\n\tvar nodes = root.childNodes;\n\tfor(var c=0; c<nodes.length; c++) {\n\t\tvar e = nodes[c], type = null;\n\t\tif(e.getAttribute  && (e.tagName ? e.tagName != \"IFRAME\" : true))\n\t\t\ttype = e.getAttribute(\"refresh\");\n\t\tvar refresher = config.refreshers[type];\n\t\tvar refreshed = false;\n\t\tif(refresher != undefined)\n\t\t\trefreshed = refresher(e,changeList);\n\t\tif(e.hasChildNodes() && !refreshed)\n\t\t\trefreshElements(e,changeList);\n\t}\n}\n\nfunction applyHtmlMacros(root,tiddler)\n{\n\tvar e = root.firstChild;\n\twhile(e) {\n\t\tvar nextChild = e.nextSibling;\n\t\tif(e.getAttribute) {\n\t\t\tvar macro = e.getAttribute(\"macro\");\n\t\t\tif(macro) {\n\t\t\t\tvar params = \"\";\n\t\t\t\tvar p = macro.indexOf(\" \");\n\t\t\t\tif(p != -1) {\n\t\t\t\t\tparams = macro.substr(p+1);\n\t\t\t\t\tmacro = macro.substr(0,p);\n\t\t\t\t}\n\t\t\t\tinvokeMacro(e,macro,params,null,tiddler);\n\t\t\t}\n\t\t}\n\t\tif(e.hasChildNodes())\n\t\t\tapplyHtmlMacros(e,tiddler);\n\t\te = nextChild;\n\t}\n}\n\nfunction refreshPageTemplate(title)\n{\n\tvar stash = createTiddlyElement(document.body,\"div\");\n\tstash.style.display = \"none\";\n\tvar display = document.getElementById(\"tiddlerDisplay\");\n\tvar nodes,t;\n\tif(display) {\n\t\tnodes = display.childNodes;\n\t\tfor(t=nodes.length-1; t>=0; t--)\n\t\t\tstash.appendChild(nodes[t]);\n\t}\n\tvar wrapper = document.getElementById(\"contentWrapper\");\n\tif(!title)\n\t\ttitle = \"PageTemplate\";\n\tvar html = store.getRecursiveTiddlerText(title,null,10);\n\twrapper.innerHTML = html;\n\tapplyHtmlMacros(wrapper);\n\trefreshElements(wrapper);\n\tdisplay = document.getElementById(\"tiddlerDisplay\");\n\tremoveChildren(display);\n\tif(!display)\n\t\tdisplay = createTiddlyElement(wrapper,\"div\",\"tiddlerDisplay\");\n\tnodes = stash.childNodes;\n\tfor(t=nodes.length-1; t>=0; t--)\n\t\tdisplay.appendChild(nodes[t]);\n\tremoveNode(stash);\n}\n\nfunction refreshDisplay(hint)\n{\n\tif(typeof hint == \"string\")\n\t\thint = [hint];\n\tvar e = document.getElementById(\"contentWrapper\");\n\trefreshElements(e,hint);\n\tif(backstage.isPanelVisible()) {\n\t\te = document.getElementById(\"backstage\");\n\t\trefreshElements(e,hint);\n\t}\n}\n\nfunction refreshPageTitle()\n{\n\tdocument.title = getPageTitle();\n}\n\nfunction getPageTitle()\n{\n\tvar st = wikifyPlain(\"SiteTitle\");\n\tvar ss = wikifyPlain(\"SiteSubtitle\");\n\treturn st + ((st == \"\" || ss == \"\") ? \"\" : \" - \") + ss;\n}\n\nfunction refreshStyles(title,doc)\n{\n\tif(!doc)\n\t\tdoc = document;\n\tsetStylesheet(title == null ? \"\" : store.getRecursiveTiddlerText(title,\"\",10),title,doc);\n}\n\nfunction refreshColorPalette(title)\n{\n\tif(!startingUp)\n\t\trefreshAll();\n}\n\nfunction refreshAll()\n{\n\trefreshPageTemplate();\n\trefreshDisplay();\n\trefreshStyles(\"StyleSheetLayout\");\n\trefreshStyles(\"StyleSheetColors\");\n\trefreshStyles(\"StyleSheet\");\n\trefreshStyles(\"StyleSheetPrint\");\n}\n\n//--\n//-- Options cookie stuff\n//--\n\nconfig.optionHandlers = {\n\t'txt': {\n\t\tget: function(name) {return encodeCookie(config.options[name].toString());},\n\t\tset: function(name,value) {config.options[name] = decodeCookie(value);}\n\t},\n\t'chk': {\n\t\tget: function(name) {return config.options[name] ? \"true\" : \"false\";},\n\t\tset: function(name,value) {config.options[name] = value == \"true\";}\n\t}\n};\n\nfunction loadOptionsCookie()\n{\n\tif(safeMode)\n\t\treturn;\n\tvar cookies = document.cookie.split(\";\");\n\tfor(var c=0; c<cookies.length; c++) {\n\t\tvar p = cookies[c].indexOf(\"=\");\n\t\tif(p != -1) {\n\t\t\tvar name = cookies[c].substr(0,p).trim();\n\t\t\tvar value = cookies[c].substr(p+1).trim();\n\t\t\tvar optType = name.substr(0,3);\n\t\t\tif(config.optionHandlers[optType] && config.optionHandlers[optType].set)\n\t\t\t\tconfig.optionHandlers[optType].set(name,value);\n\t\t}\n\t}\n}\n\nfunction saveOptionCookie(name)\n{\n\tif(safeMode)\n\t\treturn;\n\tvar c = name + \"=\";\n\tvar optType = name.substr(0,3);\n\tif(config.optionHandlers[optType] && config.optionHandlers[optType].get)\n\t\tc += config.optionHandlers[optType].get(name);\n\tc += \"; expires=Fri, 1 Jan 2038 12:00:00 UTC; path=/\";\n\tdocument.cookie = c;\n}\n\nfunction encodeCookie(s)\n{\n\treturn escape(manualConvertUnicodeToUTF8(s));\n}\n\nfunction decodeCookie(s)\n{\n\ts = unescape(s);\n\tvar re = /&#[0-9]{1,5};/g;\n\treturn s.replace(re,function($0) {return String.fromCharCode(eval($0.replace(/[&#;]/g,\"\")));});\n}\n\n//--\n//-- Saving\n//--\n\nvar saveUsingSafari = false;\n\nvar startSaveArea = '<div id=\"' + 'storeArea\">'; // Split up into two so that indexOf() of this source doesn't find it\nvar endSaveArea = '</d' + 'iv>';\n\n// If there are unsaved changes, force the user to confirm before exitting\nfunction confirmExit()\n{\n\thadConfirmExit = true;\n\tif((store && store.isDirty && store.isDirty()) || (story && story.areAnyDirty && story.areAnyDirty()))\n\t\treturn config.messages.confirmExit;\n}\n\n// Give the user a chance to save changes before exitting\nfunction checkUnsavedChanges()\n{\n\tif(store && store.isDirty && store.isDirty() && window.hadConfirmExit === false) {\n\t\tif(confirm(config.messages.unsavedChangesWarning))\n\t\t\tsaveChanges();\n\t}\n}\n\nfunction updateLanguageAttribute(s)\n{\n\tif(config.locale) {\n\t\tvar mRE = /(<html(?:.*?)?)(?: xml:lang\\=\"([a-z]+)\")?(?: lang\\=\"([a-z]+)\")?>/;\n\t\tvar m = mRE.exec(s);\n\t\tif(m) {\n\t\t\tvar t = m[1];\n\t\t\tif(m[2])\n\t\t\t\tt += ' xml:lang=\"' + config.locale + '\"';\n\t\t\tif(m[3])\n\t\t\t\tt += ' lang=\"' + config.locale + '\"';\n\t\t\tt += \">\";\n\t\t\ts = s.substr(0,m.index) + t + s.substr(m.index+m[0].length);\n\t\t}\n\t}\n\treturn s;\n}\n\nfunction updateMarkupBlock(s,blockName,tiddlerName)\n{\n\treturn s.replaceChunk(\n\t\t\t\"<!--%0-START-->\".format([blockName]),\n\t\t\t\"<!--%0-END-->\".format([blockName]),\n\t\t\t\"\\n\" + store.getRecursiveTiddlerText(tiddlerName,\"\") + \"\\n\");\n}\n\nfunction updateOriginal(original,posDiv)\n{\n\tif(!posDiv)\n\t\tposDiv = locateStoreArea(original);\n\tif(!posDiv) {\n\t\talert(config.messages.invalidFileError.format([localPath]));\n\t\treturn null;\n\t}\n\tvar revised = original.substr(0,posDiv[0] + startSaveArea.length) + \"\\n\" +\n\t\t\t\tconvertUnicodeToUTF8(store.allTiddlersAsHtml()) + \"\\n\" +\n\t\t\t\toriginal.substr(posDiv[1]);\n\tvar newSiteTitle = convertUnicodeToUTF8(getPageTitle()).htmlEncode();\n\trevised = revised.replaceChunk(\"<title\"+\">\",\"</title\"+\">\",\" \" + newSiteTitle + \" \");\n\trevised = updateLanguageAttribute(revised);\n\trevised = updateMarkupBlock(revised,\"PRE-HEAD\",\"MarkupPreHead\");\n\trevised = updateMarkupBlock(revised,\"POST-HEAD\",\"MarkupPostHead\");\n\trevised = updateMarkupBlock(revised,\"PRE-BODY\",\"MarkupPreBody\");\n\trevised = updateMarkupBlock(revised,\"POST-SCRIPT\",\"MarkupPostBody\");\n\treturn revised;\n}\n\nfunction locateStoreArea(original)\n{\n\t// Locate the storeArea div's\n\tvar posOpeningDiv = original.indexOf(startSaveArea);\n\tvar limitClosingDiv = original.indexOf(\"<\"+\"!--POST-STOREAREA--\"+\">\");\n\tif(limitClosingDiv == -1)\n\t\tlimitClosingDiv = original.indexOf(\"<\"+\"!--POST-BODY-START--\"+\">\");\n\tvar posClosingDiv = original.lastIndexOf(endSaveArea,limitClosingDiv == -1 ? original.length : limitClosingDiv);\n\treturn (posOpeningDiv != -1 && posClosingDiv != -1) ? [posOpeningDiv,posClosingDiv] : null;\n}\n\nfunction autoSaveChanges(onlyIfDirty,tiddlers)\n{\n\tif(config.options.chkAutoSave)\n\t\tsaveChanges(onlyIfDirty,tiddlers);\n}\n\n// Save this tiddlywiki with the pending changes\nfunction saveChanges(onlyIfDirty,tiddlers)\n{\n\tif(onlyIfDirty && !store.isDirty())\n\t\treturn;\n\tclearMessage();\n\t// Get the URL of the document\n\tvar originalPath = document.location.toString();\n\t// Check we were loaded from a file URL\n\tif(originalPath.substr(0,5) != \"file:\") {\n\t\talert(config.messages.notFileUrlError);\n\t\tif(store.tiddlerExists(config.messages.saveInstructions))\n\t\t\tstory.displayTiddler(null,config.messages.saveInstructions);\n\t\treturn;\n\t}\n\tvar localPath = getLocalPath(originalPath);\n\t// Load the original file\n\tvar original = loadFile(localPath);\n\tif(original == null) {\n\t\talert(config.messages.cantSaveError);\n\t\tif(store.tiddlerExists(config.messages.saveInstructions))\n\t\t\tstory.displayTiddler(null,config.messages.saveInstructions);\n\t\treturn;\n\t}\n\t// Locate the storeArea div's\n\tvar posDiv = locateStoreArea(original);\n\tif(!posDiv) {\n\t\talert(config.messages.invalidFileError.format([localPath]));\n\t\treturn;\n\t}\n\tsaveBackup(localPath,original);\n\tsaveRss(localPath);\n\tsaveEmpty(localPath,original,posDiv);\n\tsaveMain(localPath,original,posDiv);\n}\n\nfunction saveBackup(localPath,original)\n{\n\t// Save the backup\n\tif(config.options.chkSaveBackups) {\n\t\tvar backupPath = getBackupPath(localPath);\n\t\tvar backup = config.browser.isIE ? ieCopyFile(backupPath,localPath) : saveFile(backupPath,original);\n\t\tif(backup)\n\t\t\tdisplayMessage(config.messages.backupSaved,\"file://\" + backupPath);\n\t\telse\n\t\t\talert(config.messages.backupFailed);\n\t}\n}\n\nfunction saveRss(localPath)\n{\n\tif(config.options.chkGenerateAnRssFeed) {\n\t\tvar rssPath = localPath.substr(0,localPath.lastIndexOf(\".\")) + \".xml\";\n\t\tvar rssSave = saveFile(rssPath,convertUnicodeToUTF8(generateRss()));\n\t\tif(rssSave)\n\t\t\tdisplayMessage(config.messages.rssSaved,\"file://\" + rssPath);\n\t\telse\n\t\t\talert(config.messages.rssFailed);\n\t}\n}\n\nfunction saveEmpty(localPath,original,posDiv)\n{\n\tif(config.options.chkSaveEmptyTemplate) {\n\t\tvar emptyPath,p;\n\t\tif((p = localPath.lastIndexOf(\"/\")) != -1)\n\t\t\temptyPath = localPath.substr(0,p) + \"/empty.html\";\n\t\telse if((p = localPath.lastIndexOf(\"\\\\\")) != -1)\n\t\t\temptyPath = localPath.substr(0,p) + \"\\\\empty.html\";\n\t\telse\n\t\t\temptyPath = localPath + \".empty.html\";\n\t\tvar empty = original.substr(0,posDiv[0] + startSaveArea.length) + original.substr(posDiv[1]);\n\t\tvar emptySave = saveFile(emptyPath,empty);\n\t\tif(emptySave)\n\t\t\tdisplayMessage(config.messages.emptySaved,\"file://\" + emptyPath);\n\t\telse\n\t\t\talert(config.messages.emptyFailed);\n\t}\n}\n\nfunction saveMain(localPath,original,posDiv)\n{\n\tvar save;\n\ttry {\n\t\tvar revised = updateOriginal(original,posDiv);\n\t\tsave = saveFile(localPath,revised);\n\t} catch (ex) {\n\t\tshowException(ex);\n\t}\n\tif(save) {\n\t\tdisplayMessage(config.messages.mainSaved,\"file://\" + localPath);\n\t\tstore.setDirty(false);\n\t} else {\n\t\talert(config.messages.mainFailed);\n\t}\n}\n\nfunction getLocalPath(origPath)\n{\n\tvar originalPath = convertUriToUTF8(origPath,config.options.txtFileSystemCharSet);\n\t// Remove any location or query part of the URL\n\tvar argPos = originalPath.indexOf(\"?\");\n\tif(argPos != -1)\n\t\toriginalPath = originalPath.substr(0,argPos);\n\tvar hashPos = originalPath.indexOf(\"#\");\n\tif(hashPos != -1)\n\t\toriginalPath = originalPath.substr(0,hashPos);\n\t// Convert file://localhost/ to file:///\n\tif(originalPath.indexOf(\"file://localhost/\") == 0)\n\t\toriginalPath = \"file://\" + originalPath.substr(16);\n\t// Convert to a native file format\n\tvar localPath;\n\tif(originalPath.charAt(9) == \":\") // pc local file\n\t\tlocalPath = unescape(originalPath.substr(8)).replace(new RegExp(\"/\",\"g\"),\"\\\\\");\n\telse if(originalPath.indexOf(\"file://///\") == 0) // FireFox pc network file\n\t\tlocalPath = \"\\\\\\\\\" + unescape(originalPath.substr(10)).replace(new RegExp(\"/\",\"g\"),\"\\\\\");\n\telse if(originalPath.indexOf(\"file:///\") == 0) // mac/unix local file\n\t\tlocalPath = unescape(originalPath.substr(7));\n\telse if(originalPath.indexOf(\"file:/\") == 0) // mac/unix local file\n\t\tlocalPath = unescape(originalPath.substr(5));\n\telse // pc network file\n\t\tlocalPath = \"\\\\\\\\\" + unescape(originalPath.substr(7)).replace(new RegExp(\"/\",\"g\"),\"\\\\\");\n\treturn localPath;\n}\n\nfunction getBackupPath(localPath)\n{\n\tvar backSlash = true;\n\tvar dirPathPos = localPath.lastIndexOf(\"\\\\\");\n\tif(dirPathPos == -1) {\n\t\tdirPathPos = localPath.lastIndexOf(\"/\");\n\t\tbackSlash = false;\n\t}\n\tvar backupFolder = config.options.txtBackupFolder;\n\tif(!backupFolder || backupFolder == \"\")\n\t\tbackupFolder = \".\";\n\tvar backupPath = localPath.substr(0,dirPathPos) + (backSlash ? \"\\\\\" : \"/\") + backupFolder + localPath.substr(dirPathPos);\n\tbackupPath = backupPath.substr(0,backupPath.lastIndexOf(\".\")) + \".\" + (new Date()).convertToYYYYMMDDHHMMSSMMM() + \".html\";\n\treturn backupPath;\n}\n\nfunction generateRss()\n{\n\tvar s = [];\n\tvar d = new Date();\n\tvar u = store.getTiddlerText(\"SiteUrl\");\n\t// Assemble the header\n\ts.push(\"<\" + \"?xml version=\\\"1.0\\\"?\" + \">\");\n\ts.push(\"<rss version=\\\"2.0\\\">\");\n\ts.push(\"<channel>\");\n\ts.push(\"<title\" + \">\" + wikifyPlain(\"SiteTitle\").htmlEncode() + \"</title\" + \">\");\n\tif(u)\n\t\ts.push(\"<link>\" + u.htmlEncode() + \"</link>\");\n\ts.push(\"<description>\" + wikifyPlain(\"SiteSubtitle\").htmlEncode() + \"</description>\");\n\ts.push(\"<language>en-us</language>\");\n\ts.push(\"<copyright>Copyright \" + d.getFullYear() + \" \" + config.options.txtUserName.htmlEncode() + \"</copyright>\");\n\ts.push(\"<pubDate>\" + d.toGMTString() + \"</pubDate>\");\n\ts.push(\"<lastBuildDate>\" + d.toGMTString() + \"</lastBuildDate>\");\n\ts.push(\"<docs>http://blogs.law.harvard.edu/tech/rss</docs>\");\n\ts.push(\"<generator>TiddlyWiki \" + version.major + \".\" + version.minor + \".\" + version.revision + \"</generator>\");\n\t// The body\n\tvar tiddlers = store.getTiddlers(\"modified\",\"excludeLists\");\n\tvar n = config.numRssItems > tiddlers.length ? 0 : tiddlers.length-config.numRssItems;\n\tfor (var t=tiddlers.length-1; t>=n; t--)\n\t\ts.push(tiddlers[t].saveToRss(u));\n\t// And footer\n\ts.push(\"</channel>\");\n\ts.push(\"</rss>\");\n\t// Save it all\n\treturn s.join(\"\\n\");\n}\n\n//--\n//-- Filesystem code\n//--\n\nfunction convertUTF8ToUnicode(u)\n{\n\tif(window.netscape == undefined)\n\t\treturn manualConvertUTF8ToUnicode(u);\n\telse\n\t\treturn mozConvertUTF8ToUnicode(u);\n}\n\nfunction manualConvertUTF8ToUnicode(utf)\n{\n\tvar uni = utf;\n\tvar src = 0;\n\tvar dst = 0;\n\tvar b1, b2, b3;\n\tvar c;\n\twhile(src < utf.length) {\n\t\tb1 = utf.charCodeAt(src++);\n\t\tif(b1 < 0x80) {\n\t\t\tdst++;\n\t\t} else if(b1 < 0xE0) {\n\t\t\tb2 = utf.charCodeAt(src++);\n\t\t\tc = String.fromCharCode(((b1 & 0x1F) << 6) | (b2 & 0x3F));\n\t\t\tuni = uni.substring(0,dst++).concat(c,utf.substr(src));\n\t\t} else {\n\t\t\tb2 = utf.charCodeAt(src++);\n\t\t\tb3 = utf.charCodeAt(src++);\n\t\t\tc = String.fromCharCode(((b1 & 0xF) << 12) | ((b2 & 0x3F) << 6) | (b3 & 0x3F));\n\t\t\tuni = uni.substring(0,dst++).concat(c,utf.substr(src));\n\t\t}\n\t}\n\treturn uni;\n}\n\nfunction mozConvertUTF8ToUnicode(u)\n{\n\ttry {\n\t\tnetscape.security.PrivilegeManager.enablePrivilege(\"UniversalXPConnect\");\n\t\tvar converter = Components.classes[\"@mozilla.org/intl/scriptableunicodeconverter\"].createInstance(Components.interfaces.nsIScriptableUnicodeConverter);\n\t\tconverter.charset = \"UTF-8\";\n\t} catch(ex) {\n\t\treturn manualConvertUTF8ToUnicode(u);\n\t} // fallback\n\tvar s = converter.ConvertToUnicode(u);\n\tvar fin = converter.Finish();\n\treturn (fin.length > 0) ? s+fin : s;\n}\n\nfunction convertUnicodeToUTF8(s)\n{\n\tif(window.netscape == undefined)\n\t\treturn manualConvertUnicodeToUTF8(s);\n\telse\n\t\treturn mozConvertUnicodeToUTF8(s);\n}\n\nfunction manualConvertUnicodeToUTF8(s)\n{\n\tvar re = /[^\\u0000-\\u007F]/g ;\n\treturn s.replace(re,function($0) {return \"&#\" + $0.charCodeAt(0).toString() + \";\";});\n}\n\nfunction mozConvertUnicodeToUTF8(s)\n{\n\ttry {\n\t\tnetscape.security.PrivilegeManager.enablePrivilege(\"UniversalXPConnect\");\n\t\tvar converter = Components.classes[\"@mozilla.org/intl/scriptableunicodeconverter\"].createInstance(Components.interfaces.nsIScriptableUnicodeConverter);\n\t\tconverter.charset = \"UTF-8\";\n\t} catch(ex) {\n\t\treturn manualConvertUnicodeToUTF8(s);\n\t} // fallback\n\tvar u = converter.ConvertFromUnicode(s);\n\tvar fin = converter.Finish();\n\tif(fin.length > 0)\n\t\treturn u + fin;\n\telse\n\t\treturn u;\n}\n\nfunction convertUriToUTF8(uri,charSet)\n{\n\tif(window.netscape == undefined || charSet == undefined || charSet == \"\")\n\t\treturn uri;\n\ttry {\n\t\tnetscape.security.PrivilegeManager.enablePrivilege(\"UniversalXPConnect\");\n\t\tvar converter = Components.classes[\"@mozilla.org/intl/utf8converterservice;1\"].getService(Components.interfaces.nsIUTF8ConverterService);\n\t} catch(ex) {\n\t\treturn uri;\n\t}\n\treturn converter.convertURISpecToUTF8(uri,charSet);\n}\n\nfunction saveFile(fileUrl,content)\n{\n\tvar r = null;\n\tif(!r)\n\t\tr = mozillaSaveFile(fileUrl,content);\n\tif(!r)\n\t\tr = ieSaveFile(fileUrl,content);\n\tif(!r)\n\t\tr = javaSaveFile(fileUrl,content);\n\treturn r;\n}\n\nfunction loadFile(fileUrl)\n{\n\tvar r = null;\n\tif((r == null) || (r == false))\n\t\tr = mozillaLoadFile(fileUrl);\n\tif((r == null) || (r == false))\n\t\tr = ieLoadFile(fileUrl);\n\tif((r == null) || (r == false))\n\t\tr = javaLoadFile(fileUrl);\n\treturn r;\n}\n\n// Returns null if it can't do it, false if there's an error, true if it saved OK\nfunction ieSaveFile(filePath,content)\n{\n\ttry {\n\t\tvar fso = new ActiveXObject(\"Scripting.FileSystemObject\");\n\t} catch(ex) {\n\t\treturn null;\n\t}\n\tvar file = fso.OpenTextFile(filePath,2,-1,0);\n\tfile.Write(content);\n\tfile.Close();\n\treturn true;\n}\n\n// Returns null if it can't do it, false if there's an error, or a string of the content if successful\nfunction ieLoadFile(filePath)\n{\n\ttry {\n\t\tvar fso = new ActiveXObject(\"Scripting.FileSystemObject\");\n\t\tvar file = fso.OpenTextFile(filePath,1);\n\t\tvar content = file.ReadAll();\n\t\tfile.Close();\n\t} catch(ex) {\n\t\treturn null;\n\t}\n\treturn content;\n}\n\nfunction ieCopyFile(dest,source)\n{\n\ttry {\n\t\tvar fso = new ActiveXObject(\"Scripting.FileSystemObject\");\n\t\tfso.GetFile(source).Copy(dest);\n\t} catch(ex) {\n\t\treturn false;\n\t}\n\treturn true;\n}\n\n// Returns null if it can't do it, false if there's an error, true if it saved OK\nfunction mozillaSaveFile(filePath,content)\n{\n\tif(window.Components) {\n\t\ttry {\n\t\t\tnetscape.security.PrivilegeManager.enablePrivilege(\"UniversalXPConnect\");\n\t\t\tvar file = Components.classes[\"@mozilla.org/file/local;1\"].createInstance(Components.interfaces.nsILocalFile);\n\t\t\tfile.initWithPath(filePath);\n\t\t\tif(!file.exists())\n\t\t\t\tfile.create(0,0664);\n\t\t\tvar out = Components.classes[\"@mozilla.org/network/file-output-stream;1\"].createInstance(Components.interfaces.nsIFileOutputStream);\n\t\t\tout.init(file,0x20|0x02,00004,null);\n\t\t\tout.write(content,content.length);\n\t\t\tout.flush();\n\t\t\tout.close();\n\t\t\treturn true;\n\t\t} catch(ex) {\n\t\t\treturn false;\n\t\t}\n\t}\n\treturn null;\n}\n\n// Returns null if it can't do it, false if there's an error, or a string of the content if successful\nfunction mozillaLoadFile(filePath)\n{\n\tif(window.Components) {\n\t\ttry {\n\t\t\tnetscape.security.PrivilegeManager.enablePrivilege(\"UniversalXPConnect\");\n\t\t\tvar file = Components.classes[\"@mozilla.org/file/local;1\"].createInstance(Components.interfaces.nsILocalFile);\n\t\t\tfile.initWithPath(filePath);\n\t\t\tif(!file.exists())\n\t\t\t\treturn null;\n\t\t\tvar inputStream = Components.classes[\"@mozilla.org/network/file-input-stream;1\"].createInstance(Components.interfaces.nsIFileInputStream);\n\t\t\tinputStream.init(file,0x01,00004,null);\n\t\t\tvar sInputStream = Components.classes[\"@mozilla.org/scriptableinputstream;1\"].createInstance(Components.interfaces.nsIScriptableInputStream);\n\t\t\tsInputStream.init(inputStream);\n\t\t\treturn sInputStream.read(sInputStream.available());\n\t\t} catch(ex) {\n\t\t\treturn false;\n\t\t}\n\t}\n\treturn null;\n}\n\nfunction javaUrlToFilename(url)\n{\n\tvar f = \"//localhost\";\n\tif(url.indexOf(f) == 0)\n\t\treturn url.substring(f.length);\n\tvar i = url.indexOf(\":\");\n\tif(i > 0)\n\t\treturn url.substring(i-1);\n\treturn url;\n}\n\nfunction javaSaveFile(filePath,content)\n{\n\ttry {\n\t\tif(document.applets[\"TiddlySaver\"])\n\t\t\treturn document.applets[\"TiddlySaver\"].saveFile(javaUrlToFilename(filePath),\"UTF-8\",content);\n\t} catch(ex) {\n\t}\n\ttry {\n\t\tvar s = new java.io.PrintStream(new java.io.FileOutputStream(javaUrlToFilename(filePath)));\n\t\ts.print(content);\n\t\ts.close();\n\t} catch(ex) {\n\t\treturn null;\n\t}\n\treturn true;\n}\n\nfunction javaLoadFile(filePath)\n{\n\ttry {\n\t\tif(document.applets[\"TiddlySaver\"])\n\t\t\treturn String(document.applets[\"TiddlySaver\"].loadFile(javaUrlToFilename(filePath),\"UTF-8\"));\n\t} catch(ex) {\n\t}\n\tvar content = [];\n\ttry {\n\t\tvar r = new java.io.BufferedReader(new java.io.FileReader(javaUrlToFilename(filePath)));\n\t\tvar line;\n\t\twhile((line = r.readLine()) != null)\n\t\t\tcontent.push(new String(line));\n\t\tr.close();\n\t} catch(ex) {\n\t\treturn null;\n\t}\n\treturn content.join(\"\\n\");\n}\n\n//--\n//-- Server adaptor for talking to static files\n//--\n\nfunction FileAdaptor()\n{\n\tthis.host = null;\n\tthis.store = null;\n\treturn this;\n}\n\nFileAdaptor.NotLoadedError = \"TiddlyWiki file has not been loaded\";\nFileAdaptor.serverType = 'file';\n\n// Open the specified host/server\nFileAdaptor.prototype.openHost = function(host,context,userParams,callback)\n{\n\tthis.host = host;\n\tif(!context)\n\t\tcontext = {};\n\tcontext.adaptor = this;\n\tcontext.callback = callback;\n\tcontext.userParams = userParams;\n\tvar ret = loadRemoteFile(host,FileAdaptor.openHostCallback,context);\n\treturn typeof(ret) == \"string\" ? ret : true;\n};\n\nFileAdaptor.openHostCallback = function(status,context,responseText,url,xhr)\n{\n\tvar adaptor = context.adaptor;\n\tcontext.status = status;\n\tif(!status) {\n\t\tcontext.statusText = \"Error reading file: \" + xhr.statusText;\n\t} else {\n\t\t// Load the content into a TiddlyWiki() object\n\t\tadaptor.store = new TiddlyWiki();\n\t\tif(!adaptor.store.importTiddlyWiki(responseText))\n\t\t\tcontext.statusText = config.messages.invalidFileError.format([url]);\n\t}\n\tcontext.callback(context,context.userParams);\n};\n\n// Gets the list of workspaces on a given server\nFileAdaptor.prototype.getWorkspaceList = function(context,userParams,callback)\n{\n\tif(!context)\n\t\tcontext = {};\n\tcontext.workspaces = [{title:\"(default)\"}];\n\tcontext.status = true;\n\twindow.setTimeout(function() {callback(context,userParams);},10);\n\treturn true;\n};\n\n// Open the specified workspace\nFileAdaptor.prototype.openWorkspace = function(workspace,context,userParams,callback)\n{\n\tif(!context)\n\t\tcontext = {};\n\tcontext.status = true;\n\twindow.setTimeout(function() {callback(context,userParams);},10);\n\treturn true;\n};\n\n// Gets the list of tiddlers within a given workspace\nFileAdaptor.prototype.getTiddlerList = function(context,userParams,callback)\n{\n\tif(!this.store)\n\t\treturn FileAdaptor.NotLoadedError;\n\tif(!context)\n\t\tcontext = {};\n\tcontext.tiddlers = [];\n\tthis.store.forEachTiddler(function(title,tiddler)\n\t\t{\n\t\tvar t = new Tiddler(title);\n\t\tt.text = tiddler.text;\n\t\tt.modified = tiddler.modified;\n\t\tt.modifier = tiddler.modifier;\n\t\tt.fields['server.page.revision'] = tiddler.modified.convertToYYYYMMDDHHMM();\n\t\tt.tags = tiddler.tags;\n\t\tcontext.tiddlers.push(t);\n\t\t});\n\tcontext.status = true;\n\twindow.setTimeout(function() {callback(context,userParams);},10);\n\treturn true;\n};\n\nFileAdaptor.prototype.generateTiddlerInfo = function(tiddler)\n{\n\tvar info = {};\n\tinfo.uri = tiddler.fields['server.host'] + \"#\" + tiddler.title;\n\treturn info;\n};\n\n// Retrieves a tiddler from a given workspace on a given server\nFileAdaptor.prototype.getTiddler = function(title,context,userParams,callback)\n{\n\tif(!this.store)\n\t\treturn FileAdaptor.NotLoadedError;\n\tif(!context)\n\t\tcontext = {};\n\tcontext.tiddler = this.store.fetchTiddler(title);\n\tif(context.tiddler) {\n\t\tcontext.tiddler.fields['server.type'] = FileAdaptor.serverType;\n\t\tcontext.tiddler.fields['server.host'] = this.host;\n\t\tcontext.tiddler.fields['server.page.revision'] = context.tiddler.modified.convertToYYYYMMDDHHMM();\n\t}\n\tcontext.status = true;\n\tif(context.allowSynchronous) {\n\t\tcontext.isSynchronous = true;\n\t\tcallback(context,userParams);\n\t} else {\n\t\twindow.setTimeout(function() {callback(context,userParams);},10);\n\t}\n\treturn true;\n};\n\nFileAdaptor.prototype.close = function()\n{\n\tdelete this.store;\n\tthis.store = null;\n};\n\nconfig.adaptors[FileAdaptor.serverType] = FileAdaptor;\n\n//--\n//-- Remote HTTP requests\n//--\n\nfunction loadRemoteFile(url,callback,params)\n{\n\treturn doHttp(\"GET\",url,null,null,null,null,callback,params,null);\n}\n\n// HTTP status codes\nvar httpStatus = {\n\tOK: 200,\n\tContentCreated: 201,\n\tNoContent: 204,\n\tUnauthorized: 401,\n\tForbidden: 403,\n\tNotFound: 404,\n\tMethodNotAllowed: 405\n};\n\nfunction doHttp(type,url,data,contentType,username,password,callback,params,headers)\n{\n\t// Get an xhr object\n\tvar x = getXMLHttpRequest();\n\tif(!x)\n\t\treturn \"Can't create XMLHttpRequest object\";\n\t// Install callback\n\tx.onreadystatechange = function() {\n\t\tif (x.readyState == 4 && callback && (x.status !== undefined)) {\n\t\t\tif([0, httpStatus.OK, httpStatus.ContentCreated, httpStatus.NoContent].contains(x.status))\n\t\t\t\tcallback(true,params,x.responseText,url,x);\n\t\t\telse\n\t\t\t\tcallback(false,params,null,url,x);\n\t\t\tx.onreadystatechange = function(){};\n\t\t\tx = null;\n\t\t}\n\t};\n\t// Send request\n\tif(window.Components && window.netscape && window.netscape.security && document.location.protocol.indexOf(\"http\") == -1)\n\t\twindow.netscape.security.PrivilegeManager.enablePrivilege(\"UniversalBrowserRead\");\n\ttry {\n\t\turl = url + (url.indexOf(\"?\") < 0 ? \"?\" : \"&\") + \"nocache=\" + Math.random();\n\t\tx.open(type,url,true,username,password);\n\t\tif (data)\n\t\t\tx.setRequestHeader(\"Content-Type\", contentType ? contentType : \"application/x-www-form-urlencoded\");\n\t\tif (x.overrideMimeType)\n\t\t\tx.setRequestHeader(\"Connection\", \"close\");\n\t\tif(headers) {\n\t\t\tfor(n in headers)\n\t\t\t\tx.setRequestHeader(n,headers[n]);\n\t\t}\n\t\tx.setRequestHeader(\"X-Requested-With\", \"TiddlyWiki \" + version.major + \".\" + version.minor + \".\" + version.revision + (version.beta ? \" (beta \" + version.beta + \")\" : \"\"));\n\t\tx.send(data);\n\t} catch (ex) {\n\t\treturn exceptionText(ex);\n\t}\n\treturn x;\n}\n\nfunction getXMLHttpRequest()\n{\n\ttry {\n\t\tvar x = new XMLHttpRequest(); // Modern\n\t} catch(ex) {\n\t\ttry {\n\t\t\tx = new ActiveXObject(\"Msxml2.XMLHTTP\"); // IE 6\n\t\t} catch (ex2) {\n\t\t\treturn null;\n\t\t}\n\t}\n\treturn x;\n}\n\n//--\n//-- TiddlyWiki-specific utility functions\n//--\n\nfunction createTiddlyButton(theParent,theText,theTooltip,theAction,theClass,theId,theAccessKey)\n{\n\tvar theButton = document.createElement(\"a\");\n\tif(theAction) {\n\t\ttheButton.onclick = theAction;\n\t\ttheButton.setAttribute(\"href\",\"javascript:;\");\n\t}\n\tif(theTooltip)\n\t\ttheButton.setAttribute(\"title\",theTooltip);\n\tif(theText)\n\t\ttheButton.appendChild(document.createTextNode(theText));\n\tif(theClass)\n\t\ttheButton.className = theClass;\n\telse\n\t\ttheButton.className = \"button\";\n\tif(theId)\n\t\ttheButton.id = theId;\n\tif(theParent)\n\t\ttheParent.appendChild(theButton);\n\tif(theAccessKey)\n\t\ttheButton.setAttribute(\"accessKey\",theAccessKey);\n\treturn theButton;\n}\n\nfunction createTiddlyLink(place,title,includeText,theClass,isStatic,linkedFromTiddler,noToggle)\n{\n\tvar text = includeText ? title : null;\n\tvar i = getTiddlyLinkInfo(title,theClass);\n\tvar btn = isStatic ? createExternalLink(place,store.getTiddlerText(\"SiteUrl\",null) + \"#\" + title) : createTiddlyButton(place,text,i.subTitle,onClickTiddlerLink,i.classes);\n\tbtn.setAttribute(\"refresh\",\"link\");\n\tbtn.setAttribute(\"tiddlyLink\",title);\n\tif(noToggle)\n\t\tbtn.setAttribute(\"noToggle\",\"true\");\n\tif(linkedFromTiddler) {\n\t\tvar fields = linkedFromTiddler.getInheritedFields();\n\t\tif(fields)\n\t\t\tbtn.setAttribute(\"tiddlyFields\",fields);\n\t}\n\treturn btn;\n}\n\nfunction refreshTiddlyLink(e,title)\n{\n\tvar i = getTiddlyLinkInfo(title,e.className);\n\te.className = i.classes;\n\te.title = i.subTitle;\n}\n\nfunction getTiddlyLinkInfo(title,currClasses)\n{\n\tvar classes = currClasses ? currClasses.split(\" \") : [];\n\tclasses.pushUnique(\"tiddlyLink\");\n\tvar tiddler = store.fetchTiddler(title);\n\tvar subTitle;\n\tif(tiddler) {\n\t\tsubTitle = tiddler.getSubtitle();\n\t\tclasses.pushUnique(\"tiddlyLinkExisting\");\n\t\tclasses.remove(\"tiddlyLinkNonExisting\");\n\t\tclasses.remove(\"shadow\");\n\t} else {\n\t\tclasses.remove(\"tiddlyLinkExisting\");\n\t\tclasses.pushUnique(\"tiddlyLinkNonExisting\");\n\t\tif(store.isShadowTiddler(title)) {\n\t\t\tsubTitle = config.messages.shadowedTiddlerToolTip.format([title]);\n\t\t\tclasses.pushUnique(\"shadow\");\n\t\t} else {\n\t\t\tsubTitle = config.messages.undefinedTiddlerToolTip.format([title]);\n\t\t\tclasses.remove(\"shadow\");\n\t\t}\n\t}\n\tif(config.annotations[title])\n\t\tsubTitle = config.annotations[title];\n\treturn {classes: classes.join(\" \"),subTitle: subTitle};\n}\n\nfunction createExternalLink(place,url)\n{\n\tvar theLink = document.createElement(\"a\");\n\ttheLink.className = \"externalLink\";\n\ttheLink.href = url;\n\ttheLink.title = config.messages.externalLinkTooltip.format([url]);\n\tif(config.options.chkOpenInNewWindow)\n\t\ttheLink.target = \"_blank\";\n\tplace.appendChild(theLink);\n\treturn theLink;\n}\n\n// Event handler for clicking on a tiddly link\nfunction onClickTiddlerLink(e)\n{\n\tif(!e) e = window.event;\n\tvar theTarget = resolveTarget(e);\n\tvar theLink = theTarget;\n\tvar title = null;\n\tvar fields = null;\n\tvar noToggle = null;\n\tdo {\n\t\ttitle = theLink.getAttribute(\"tiddlyLink\");\n\t\tfields = theLink.getAttribute(\"tiddlyFields\");\n\t\tnoToggle = theLink.getAttribute(\"noToggle\");\n\t\ttheLink = theLink.parentNode;\n\t} while(title == null && theLink != null);\n\tif(!fields && !store.isShadowTiddler(title))\n\t\tfields = String.encodeHashMap(config.defaultCustomFields);\n\tif(title) {\n\t\tvar toggling = e.metaKey || e.ctrlKey;\n\t\tif(config.options.chkToggleLinks)\n\t\t\ttoggling = !toggling;\n\t\tif(noToggle)\n\t\t\ttoggling = false;\n\t\tstory.displayTiddler(theTarget,title,null,true,null,fields,toggling);\n\t}\n\tclearMessage();\n\treturn false;\n}\n\n// Create a button for a tag with a popup listing all the tiddlers that it tags\nfunction createTagButton(place,tag,excludeTiddler)\n{\n\tvar theTag = createTiddlyButton(place,tag,config.views.wikified.tag.tooltip.format([tag]),onClickTag);\n\ttheTag.setAttribute(\"tag\",tag);\n\tif(excludeTiddler)\n\t\ttheTag.setAttribute(\"tiddler\",excludeTiddler);\n\treturn theTag;\n}\n\n// Event handler for clicking on a tiddler tag\nfunction onClickTag(e)\n{\n\tif(!e) var e = window.event;\n\tvar theTarget = resolveTarget(e);\n\tvar popup = Popup.create(this);\n\tvar tag = this.getAttribute(\"tag\");\n\tvar title = this.getAttribute(\"tiddler\");\n\tif(popup && tag) {\n\t\tvar tagged = store.getTaggedTiddlers(tag);\n\t\tvar titles = [];\n\t\tvar li,r;\n\t\tfor(r=0;r<tagged.length;r++) {\n\t\t\tif(tagged[r].title != title)\n\t\t\t\ttitles.push(tagged[r].title);\n\t\t}\n\t\tvar lingo = config.views.wikified.tag;\n\t\tif(titles.length > 0) {\n\t\t\tvar openAll = createTiddlyButton(createTiddlyElement(popup,\"li\"),lingo.openAllText.format([tag]),lingo.openAllTooltip,onClickTagOpenAll);\n\t\t\topenAll.setAttribute(\"tag\",tag);\n\t\t\tcreateTiddlyElement(createTiddlyElement(popup,\"li\",null,\"listBreak\"),\"div\");\n\t\t\tfor(r=0; r<titles.length; r++) {\n\t\t\t\tcreateTiddlyLink(createTiddlyElement(popup,\"li\"),titles[r],true);\n\t\t\t}\n\t\t} else {\n\t\t\tcreateTiddlyText(createTiddlyElement(popup,\"li\",null,\"disabled\"),lingo.popupNone.format([tag]));\n\t\t}\n\t\tcreateTiddlyElement(createTiddlyElement(popup,\"li\",null,\"listBreak\"),\"div\");\n\t\tvar h = createTiddlyLink(createTiddlyElement(popup,\"li\"),tag,false);\n\t\tcreateTiddlyText(h,lingo.openTag.format([tag]));\n\t}\n\tPopup.show();\n\te.cancelBubble = true;\n\tif(e.stopPropagation) e.stopPropagation();\n\treturn false;\n}\n\n// Event handler for 'open all' on a tiddler popup\nfunction onClickTagOpenAll(e)\n{\n\tif(!e) var e = window.event;\n\tvar tag = this.getAttribute(\"tag\");\n\tvar tagged = store.getTaggedTiddlers(tag);\n\tvar titles = [];\n\tfor(var t=0; t<tagged.length; t++)\n\t\ttitles.push(tagged[t].title);\n\tstory.displayTiddlers(this,titles);\n\treturn false;\n}\n\nfunction onClickError(e)\n{\n\tif(!e) var e = window.event;\n\tvar popup = Popup.create(this);\n\tvar lines = this.getAttribute(\"errorText\").split(\"\\n\");\n\tfor(var t=0; t<lines.length; t++)\n\t\tcreateTiddlyElement(popup,\"li\",null,null,lines[t]);\n\tPopup.show();\n\te.cancelBubble = true;\n\tif(e.stopPropagation) e.stopPropagation();\n\treturn false;\n}\n\nfunction createTiddlyDropDown(place,onchange,options,defaultValue)\n{\n\tvar sel = createTiddlyElement(place,\"select\");\n\tsel.onchange = onchange;\n\tfor(var t=0; t<options.length; t++) {\n\t\tvar e = createTiddlyElement(sel,\"option\",null,null,options[t].caption);\n\t\te.value = options[t].name;\n\t\tif(options[t].name == defaultValue)\n\t\t\te.selected = true;\n\t}\n\treturn sel;\n}\n\nfunction createTiddlyPopup(place,caption,tooltip,tiddler)\n{\n\tif(tiddler.text) {\n\t\tcreateTiddlyLink(place,caption,true);\n\t\tvar btn = createTiddlyButton(place,glyph(\"downArrow\"),tooltip,onClickTiddlyPopup,\"tiddlerPopupButton\");\n\t\tbtn.tiddler = tiddler;\n\t} else {\n\t\tcreateTiddlyText(place,caption);\n\t}\n}\n\nfunction onClickTiddlyPopup(e)\n{\n\tif(!e) var e = window.event;\n\tvar tiddler = this.tiddler;\n\tif(tiddler.text) {\n\t\tvar popup = Popup.create(this,\"div\",\"popupTiddler\");\n\t\twikify(tiddler.text,popup,null,tiddler);\n\t\tPopup.show();\n\t}\n\tif(e) e.cancelBubble = true;\n\tif(e && e.stopPropagation) e.stopPropagation();\n\treturn false;\n}\n\nfunction createTiddlyError(place,title,text)\n{\n\tvar btn = createTiddlyButton(place,title,null,onClickError,\"errorButton\");\n\tif(text) btn.setAttribute(\"errorText\",text);\n}\n\nfunction merge(dst,src,preserveExisting)\n{\n\tfor(p in src) {\n\t\tif(!preserveExisting || dst[p] === undefined)\n\t\t\tdst[p] = src[p];\n\t}\n\treturn dst;\n}\n\n// Returns a string containing the description of an exception, optionally prepended by a message\nfunction exceptionText(e,message)\n{\n\tvar s = e.description ? e.description : e.toString();\n\treturn message ? \"%0:\\n%1\".format([message,s]) : s;\n}\n\n// Displays an alert of an exception description with optional message\nfunction showException(e,message)\n{\n\talert(exceptionText(e,message));\n}\n\nfunction alertAndThrow(m)\n{\n\talert(m);\n\tthrow(m);\n}\n\nfunction glyph(name)\n{\n\tvar g = config.glyphs;\n\tvar b = g.currBrowser;\n\tif(b == null) {\n\t\tb = 0;\n\t\twhile(!g.browsers[b]() && b < g.browsers.length-1)\n\t\t\tb++;\n\t\tg.currBrowser = b;\n\t}\n\tif(!g.codes[name])\n\t\treturn \"\";\n\treturn g.codes[name][b];\n}\n//-\n//- Animation engine\n//-\n\nfunction Animator()\n{\n\tthis.running = 0; // Incremented at start of each animation, decremented afterwards. If zero, the interval timer is disabled\n\tthis.timerID = 0; // ID of the timer used for animating\n\tthis.animations = []; // List of animations in progress\n\treturn this;\n}\n\n// Start animation engine\nAnimator.prototype.startAnimating = function() // Variable number of arguments\n{\n\tfor(var t=0; t<arguments.length; t++)\n\t\tthis.animations.push(arguments[t]);\n\tif(this.running == 0) {\n\t\tvar me = this;\n\t\tthis.timerID = window.setInterval(function() {me.doAnimate(me);},10);\n\t}\n\tthis.running += arguments.length;\n};\n\n// Perform an animation engine tick, calling each of the known animation modules\nAnimator.prototype.doAnimate = function(me)\n{\n\tvar a = 0;\n\twhile(a < me.animations.length) {\n\t\tvar animation = me.animations[a];\n\t\tif(animation.tick()) {\n\t\t\ta++;\n\t\t} else {\n\t\t\tme.animations.splice(a,1);\n\t\t\tif(--me.running == 0)\n\t\t\t\twindow.clearInterval(me.timerID);\n\t\t}\n\t}\n};\n\n// Map a 0..1 value to 0..1, but slow down at the start and end\nAnimator.slowInSlowOut = function(progress)\n{\n\treturn(1-((Math.cos(progress * Math.PI)+1)/2));\n};\n\n//--\n//-- Morpher animation\n//--\n\n// Animate a set of properties of an element\nfunction Morpher(element,duration,properties,callback)\n{\n\tthis.element = element;\n\tthis.duration = duration;\n\tthis.properties = properties;\n\tthis.startTime = new Date();\n\tthis.endTime = Number(this.startTime) + duration;\n\tthis.callback = callback;\n\tthis.tick();\n\treturn this;\n}\n\nMorpher.prototype.assignStyle = function(element,style,value)\n{\n\tswitch(style) {\n\t\tcase \"-tw-vertScroll\":\n\t\t\twindow.scrollTo(findScrollX(),value);\n\t\t\tbreak;\n\t\tcase \"-tw-horizScroll\":\n\t\t\twindow.scrollTo(value,findScrollY());\n\t\t\tbreak;\n\t\tdefault:\n\t\t\telement.style[style] = value;\n\t\t\tbreak;\n\t}\n};\n\nMorpher.prototype.stop = function()\n{\n\tfor(var t=0; t<this.properties.length; t++) {\n\t\tvar p = this.properties[t];\n\t\tif(p.atEnd !== undefined) {\n\t\t\tthis.assignStyle(this.element,p.style,p.atEnd);\n\t\t}\n\t}\n\tif(this.callback)\n\t\tthis.callback(this.element,this.properties);\n};\n\nMorpher.prototype.tick = function()\n{\n\tvar currTime = Number(new Date());\n\tprogress = Animator.slowInSlowOut(Math.min(1,(currTime-this.startTime)/this.duration));\n\tfor(var t=0; t<this.properties.length; t++) {\n\t\tvar p = this.properties[t];\n\t\tif(p.start !== undefined && p.end !== undefined) {\n\t\t\tvar template = p.template ? p.template : \"%0\";\n\t\t\tswitch(p.format) {\n\t\t\t\tcase undefined:\n\t\t\t\tcase \"style\":\n\t\t\t\t\tvar v = p.start + (p.end-p.start) * progress;\n\t\t\t\t\tthis.assignStyle(this.element,p.style,template.format([v]));\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"color\":\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\tif(currTime >= this.endTime) {\n\t\tthis.stop();\n\t\treturn false;\n\t}\n\treturn true;\n};\n\n//--\n//-- Zoomer animation\n//--\n\nfunction Zoomer(text,startElement,targetElement,unused)\n{\n\tvar e = createTiddlyElement(document.body,\"div\",null,\"zoomer\");\n\tcreateTiddlyElement(e,\"div\",null,null,text);\n\tvar winWidth = findWindowWidth();\n\tvar winHeight = findWindowHeight();\n\tvar p = [\n\t\t{style: 'left', start: findPosX(startElement), end: findPosX(targetElement), template: '%0px'},\n\t\t{style: 'top', start: findPosY(startElement), end: findPosY(targetElement), template: '%0px'},\n\t\t{style: 'width', start: Math.min(startElement.scrollWidth,winWidth), end: Math.min(targetElement.scrollWidth,winWidth), template: '%0px', atEnd: 'auto'},\n\t\t{style: 'height', start: Math.min(startElement.scrollHeight,winHeight), end: Math.min(targetElement.scrollHeight,winHeight), template: '%0px', atEnd: 'auto'},\n\t\t{style: 'fontSize', start: 8, end: 24, template: '%0pt'}\n\t];\n\tvar c = function(element,properties) {removeNode(element);};\n\treturn new Morpher(e,config.animDuration,p,c);\n}\n\n//--\n//-- Scroller animation\n//--\n\nfunction Scroller(targetElement,unused)\n{\n\tvar p = [\n\t\t{style: '-tw-vertScroll', start: findScrollY(), end: ensureVisible(targetElement)}\n\t];\n\treturn new Morpher(targetElement,config.animDuration,p);\n}\n\n//--\n//-- Slider animation\n//--\n\n// deleteMode - \"none\", \"all\" [delete target element and it's children], [only] \"children\" [but not the target element]\nfunction Slider(element,opening,unused,deleteMode)\n{\n\telement.style.overflow = 'hidden';\n\tif(opening)\n\t\telement.style.height = '0px'; // Resolves a Firefox flashing bug\n\telement.style.display = 'block';\n\tvar left = findPosX(element);\n\tvar width = element.scrollWidth;\n\tvar height = element.scrollHeight;\n\tvar winWidth = findWindowWidth();\n\tvar p = [];\n\tvar c = null;\n\tif(opening) {\n\t\tp.push({style: 'height', start: 0, end: height, template: '%0px', atEnd: 'auto'});\n\t\tp.push({style: 'opacity', start: 0, end: 1, template: '%0'});\n\t\tp.push({style: 'filter', start: 0, end: 100, template: 'alpha(opacity:%0)'});\n\t} else {\n\t\tp.push({style: 'height', start: height, end: 0, template: '%0px'});\n\t\tp.push({style: 'display', atEnd: 'none'});\n\t\tp.push({style: 'opacity', start: 1, end: 0, template: '%0'});\n\t\tp.push({style: 'filter', start: 100, end: 0, template: 'alpha(opacity:%0)'});\n\t\tswitch(deleteMode) {\n\t\t\tcase \"all\":\n\t\t\t\tc = function(element,properties) {removeNode(element);};\n\t\t\t\tbreak;\n\t\t\tcase \"children\":\n\t\t\t\tc = function(element,properties) {removeChildren(element);};\n\t\t\t\tbreak;\n\t\t}\n\t}\n\treturn new Morpher(element,config.animDuration,p,c);\n}\n\n//--\n//-- Popup menu\n//--\n\nvar Popup = {\n\tstack: [] // Array of objects with members root: and popup:\n\t};\n\nPopup.create = function(root,elem,theClass)\n{\n\tPopup.remove();\n\tvar popup = createTiddlyElement(document.body,elem ? elem : \"ol\",\"popup\",theClass ? theClass : \"popup\");\n\tPopup.stack.push({root: root, popup: popup});\n\treturn popup;\n};\n\nPopup.onDocumentClick = function(e)\n{\n\tif (!e) var e = window.event;\n\tvar target = resolveTarget(e);\n\tif(e.eventPhase == undefined)\n\t\tPopup.remove();\n\telse if(e.eventPhase == Event.BUBBLING_PHASE || e.eventPhase == Event.AT_TARGET)\n\t\tPopup.remove();\n\treturn true;\n};\n\nPopup.show = function(unused1,unused2)\n{\n\tvar curr = Popup.stack[Popup.stack.length-1];\n\tthis.place(curr.root,curr.popup);\n\taddClass(curr.root,\"highlight\");\n\tif(config.options.chkAnimate && anim && typeof Scroller == \"function\")\n\t\tanim.startAnimating(new Scroller(curr.popup));\n\telse\n\t\twindow.scrollTo(0,ensureVisible(curr.popup));\n};\n\nPopup.place = function(root,popup,offset)\n{\n\tif(!offset) var offset = {x:0, y:0};\n\tvar rootLeft = findPosX(root);\n\tvar rootTop = findPosY(root);\n\tvar rootHeight = root.offsetHeight;\n\tvar popupLeft = rootLeft + offset.x;\n\tvar popupTop = rootTop + rootHeight + offset.y;\n\tvar winWidth = findWindowWidth();\n\tif(popup.offsetWidth > winWidth*0.75)\n\t\tpopup.style.width = winWidth*0.75 + \"px\";\n\tvar popupWidth = popup.offsetWidth;\n\tif(popupLeft + popupWidth > winWidth)\n\t\tpopupLeft = winWidth - popupWidth;\n\tpopup.style.left = popupLeft + \"px\";\n\tpopup.style.top = popupTop + \"px\";\n\tpopup.style.display = \"block\";\n}\n\nPopup.remove = function()\n{\n\tif(Popup.stack.length > 0) {\n\t\tPopup.removeFrom(0);\n\t}\n};\n\nPopup.removeFrom = function(from)\n{\n\tfor(var t=Popup.stack.length-1; t>=from; t--) {\n\t\tvar p = Popup.stack[t];\n\t\tremoveClass(p.root,\"highlight\");\n\t\tremoveNode(p.popup);\n\t}\n\tPopup.stack = Popup.stack.slice(0,from);\n};\n\n//--\n//-- Wizard support\n//--\n\nfunction Wizard(elem)\n{\n\tif(elem) {\n\t\tthis.formElem = findRelated(elem,\"wizard\",\"className\");\n\t\tthis.bodyElem = findRelated(this.formElem.firstChild,\"wizardBody\",\"className\",\"nextSibling\");\n\t\tthis.footElem = findRelated(this.formElem.firstChild,\"wizardFooter\",\"className\",\"nextSibling\");\n\t} else {\n\t\tthis.formElem = null;\n\t\tthis.bodyElem = null;\n\t\tthis.footElem = null;\n\t}\n}\n\nWizard.prototype.setValue = function(name,value)\n{\n\tif(this.formElem)\n\t\tthis.formElem[name] = value;\n};\n\nWizard.prototype.getValue = function(name)\n{\n\treturn this.formElem ? this.formElem[name] : null;\n};\n\nWizard.prototype.createWizard = function(place,title)\n{\n\tthis.formElem = createTiddlyElement(place,\"form\",null,\"wizard\");\n\tcreateTiddlyElement(this.formElem,\"h1\",null,null,title);\n\tthis.bodyElem = createTiddlyElement(this.formElem,\"div\",null,\"wizardBody\");\n\tthis.footElem = createTiddlyElement(this.formElem,\"div\",null,\"wizardFooter\");\n};\n\nWizard.prototype.clear = function()\n{\n\tremoveChildren(this.bodyElem);\n};\n\nWizard.prototype.setButtons = function(buttonInfo,status)\n{\n\tremoveChildren(this.footElem);\n\tfor(var t=0; t<buttonInfo.length; t++) {\n\t\tcreateTiddlyButton(this.footElem,buttonInfo[t].caption,buttonInfo[t].tooltip,buttonInfo[t].onClick);\n\t\tinsertSpacer(this.footElem);\n\t\t}\n\tif(typeof status == \"string\") {\n\t\tcreateTiddlyElement(this.footElem,\"span\",null,\"status\",status);\n\t}\n};\n\nWizard.prototype.addStep = function(stepTitle,html)\n{\n\tremoveChildren(this.bodyElem);\n\tvar w = createTiddlyElement(this.bodyElem,\"div\");\n\tcreateTiddlyElement(w,\"h2\",null,null,stepTitle);\n\tvar step = createTiddlyElement(w,\"div\",null,\"wizardStep\");\n\tstep.innerHTML = html;\n\tapplyHtmlMacros(step,tiddler);\n};\n\nWizard.prototype.getElement = function(name)\n{\n\treturn this.formElem.elements[name];\n};\n\n//--\n//-- ListView gadget\n//--\n\nvar ListView = {};\n\n// Create a listview\nListView.create = function(place,listObject,listTemplate,callback,className)\n{\n\tvar table = createTiddlyElement(place,\"table\",null,className ? className : \"listView twtable\");\n\tvar thead = createTiddlyElement(table,\"thead\");\n\tvar r = createTiddlyElement(thead,\"tr\");\n\tfor(var t=0; t<listTemplate.columns.length; t++) {\n\t\tvar columnTemplate = listTemplate.columns[t];\n\t\tvar c = createTiddlyElement(r,\"th\");\n\t\tvar colType = ListView.columnTypes[columnTemplate.type];\n\t\tif(colType && colType.createHeader)\n\t\t\tcolType.createHeader(c,columnTemplate,t);\n\t}\n\tvar tbody = createTiddlyElement(table,\"tbody\");\n\tfor(var rc=0; rc<listObject.length; rc++) {\n\t\trowObject = listObject[rc];\n\t\tr = createTiddlyElement(tbody,\"tr\");\n\t\tfor(c=0; c<listTemplate.rowClasses.length; c++) {\n\t\t\tif(rowObject[listTemplate.rowClasses[c].field])\n\t\t\t\taddClass(r,listTemplate.rowClasses[c].className);\n\t\t}\n\t\trowObject.rowElement = r;\n\t\trowObject.colElements = {};\n\t\tfor(var cc=0; cc<listTemplate.columns.length; cc++) {\n\t\t\tc = createTiddlyElement(r,\"td\");\n\t\t\tcolumnTemplate = listTemplate.columns[cc];\n\t\t\tvar field = columnTemplate.field;\n\t\t\tcolType = ListView.columnTypes[columnTemplate.type];\n\t\t\tif(colType && colType.createItem)\n\t\t\t\tcolType.createItem(c,rowObject,field,columnTemplate,cc,rc);\n\t\t\trowObject.colElements[field] = c;\n\t\t}\n\t}\n\tif(callback && listTemplate.actions)\n\t\tcreateTiddlyDropDown(place,ListView.getCommandHandler(callback),listTemplate.actions);\n\tif(callback && listTemplate.buttons) {\n\t\tfor(t=0; t<listTemplate.buttons.length; t++) {\n\t\t\tvar a = listTemplate.buttons[t];\n\t\t\tif(a && a.name != \"\")\n\t\t\t\tcreateTiddlyButton(place,a.caption,null,ListView.getCommandHandler(callback,a.name,a.allowEmptySelection));\n\t\t}\n\t}\n\treturn table;\n};\n\nListView.getCommandHandler = function(callback,name,allowEmptySelection)\n{\n\treturn function(e) {\n\t\tvar view = findRelated(this,\"TABLE\",null,\"previousSibling\");\n\t\tvar tiddlers = [];\n\t\tListView.forEachSelector(view,function(e,rowName) {\n\t\t\t\t\tif(e.checked)\n\t\t\t\t\t\ttiddlers.push(rowName);\n\t\t\t\t\t});\n\t\tif(tiddlers.length == 0 && !allowEmptySelection) {\n\t\t\talert(config.messages.nothingSelected);\n\t\t} else {\n\t\t\tif(this.nodeName.toLowerCase() == \"select\") {\n\t\t\t\tcallback(view,this.value,tiddlers);\n\t\t\t\tthis.selectedIndex = 0;\n\t\t\t} else {\n\t\t\t\tcallback(view,name,tiddlers);\n\t\t\t}\n\t\t}\n\t};\n};\n\n// Invoke a callback for each selector checkbox in the listview\nListView.forEachSelector = function(view,callback)\n{\n\tvar checkboxes = view.getElementsByTagName(\"input\");\n\tvar hadOne = false;\n\tfor(var t=0; t<checkboxes.length; t++) {\n\t\tvar cb = checkboxes[t];\n\t\tif(cb.getAttribute(\"type\") == \"checkbox\") {\n\t\t\tvar rn = cb.getAttribute(\"rowName\");\n\t\t\tif(rn) {\n\t\t\t\tcallback(cb,rn);\n\t\t\t\thadOne = true;\n\t\t\t}\n\t\t}\n\t}\n\treturn hadOne;\n};\n\nListView.getSelectedRows = function(view)\n{\n\tvar rowNames = [];\n\tListView.forEachSelector(view,function(e,rowName) {\n\t\t\t\tif(e.checked)\n\t\t\t\t\trowNames.push(rowName);\n\t\t\t\t});\n\treturn rowNames;\n};\n\nListView.columnTypes = {};\n\nListView.columnTypes.String = {\n\tcreateHeader: function(place,columnTemplate,col)\n\t\t{\n\t\t\tcreateTiddlyText(place,columnTemplate.title);\n\t\t},\n\tcreateItem: function(place,listObject,field,columnTemplate,col,row)\n\t\t{\n\t\t\tvar v = listObject[field];\n\t\t\tif(v != undefined)\n\t\t\t\tcreateTiddlyText(place,v);\n\t\t}\n};\n\nListView.columnTypes.WikiText = {\n\tcreateHeader: ListView.columnTypes.String.createHeader,\n\tcreateItem: function(place,listObject,field,columnTemplate,col,row)\n\t\t{\n\t\t\tvar v = listObject[field];\n\t\t\tif(v != undefined)\n\t\t\t\twikify(v,place,null,null);\n\t\t}\n};\n\nListView.columnTypes.Tiddler = {\n\tcreateHeader: ListView.columnTypes.String.createHeader,\n\tcreateItem: function(place,listObject,field,columnTemplate,col,row)\n\t\t{\n\t\t\tvar v = listObject[field];\n\t\t\tif(v != undefined && v.title)\n\t\t\t\tcreateTiddlyPopup(place,v.title,config.messages.listView.tiddlerTooltip,v);\n\t\t}\n};\n\nListView.columnTypes.Size = {\n\tcreateHeader: ListView.columnTypes.String.createHeader,\n\tcreateItem: function(place,listObject,field,columnTemplate,col,row)\n\t\t{\n\t\t\tvar v = listObject[field];\n\t\t\tif(v != undefined) {\n\t\t\t\tvar t = 0;\n\t\t\t\twhile(t<config.messages.sizeTemplates.length-1 && v<config.messages.sizeTemplates[t].unit)\n\t\t\t\t\tt++;\n\t\t\t\tcreateTiddlyText(place,config.messages.sizeTemplates[t].template.format([Math.round(v/config.messages.sizeTemplates[t].unit)]));\n\t\t\t}\n\t\t}\n};\n\nListView.columnTypes.Link = {\n\tcreateHeader: ListView.columnTypes.String.createHeader,\n\tcreateItem: function(place,listObject,field,columnTemplate,col,row)\n\t\t{\n\t\t\tvar v = listObject[field];\n\t\t\tvar c = columnTemplate.text;\n\t\t\tif(v != undefined)\n\t\t\t\tcreateTiddlyText(createExternalLink(place,v),c ? c : v);\n\t\t}\n};\n\nListView.columnTypes.Date = {\n\tcreateHeader: ListView.columnTypes.String.createHeader,\n\tcreateItem: function(place,listObject,field,columnTemplate,col,row)\n\t\t{\n\t\t\tvar v = listObject[field];\n\t\t\tif(v != undefined)\n\t\t\t\tcreateTiddlyText(place,v.formatString(columnTemplate.dateFormat));\n\t\t}\n};\n\nListView.columnTypes.StringList = {\n\tcreateHeader: ListView.columnTypes.String.createHeader,\n\tcreateItem: function(place,listObject,field,columnTemplate,col,row)\n\t\t{\n\t\t\tvar v = listObject[field];\n\t\t\tif(v != undefined) {\n\t\t\t\tfor(var t=0; t<v.length; t++) {\n\t\t\t\t\tcreateTiddlyText(place,v[t]);\n\t\t\t\t\tcreateTiddlyElement(place,\"br\");\n\t\t\t\t}\n\t\t\t}\n\t\t}\n};\n\nListView.columnTypes.Selector = {\n\tcreateHeader: function(place,columnTemplate,col)\n\t\t{\n\t\t\tcreateTiddlyCheckbox(place,null,false,this.onHeaderChange);\n\t\t},\n\tcreateItem: function(place,listObject,field,columnTemplate,col,row)\n\t\t{\n\t\t\tvar e = createTiddlyCheckbox(place,null,listObject[field],null);\n\t\t\te.setAttribute(\"rowName\",listObject[columnTemplate.rowName]);\n\t\t},\n\tonHeaderChange: function(e)\n\t\t{\n\t\t\tvar state = this.checked;\n\t\t\tvar view = findRelated(this,\"TABLE\");\n\t\t\tif(!view)\n\t\t\t\treturn;\n\t\t\tListView.forEachSelector(view,function(e,rowName) {\n\t\t\t\t\t\t\t\te.checked = state;\n\t\t\t\t\t\t\t});\n\t\t}\n};\n\nListView.columnTypes.Tags = {\n\tcreateHeader: ListView.columnTypes.String.createHeader,\n\tcreateItem: function(place,listObject,field,columnTemplate,col,row)\n\t\t{\n\t\t\tvar tags = listObject[field];\n\t\t\tcreateTiddlyText(place,String.encodeTiddlyLinkList(tags));\n\t\t}\n};\n\nListView.columnTypes.Boolean = {\n\tcreateHeader: ListView.columnTypes.String.createHeader,\n\tcreateItem: function(place,listObject,field,columnTemplate,col,row)\n\t\t{\n\t\t\tif(listObject[field] == true)\n\t\t\t\tcreateTiddlyText(place,columnTemplate.trueText);\n\t\t\tif(listObject[field] == false)\n\t\t\t\tcreateTiddlyText(place,columnTemplate.falseText);\n\t\t}\n};\n\nListView.columnTypes.TagCheckbox = {\n\tcreateHeader: ListView.columnTypes.String.createHeader,\n\tcreateItem: function(place,listObject,field,columnTemplate,col,row)\n\t\t{\n\t\t\tvar e = createTiddlyCheckbox(place,null,listObject[field],this.onChange);\n\t\t\te.setAttribute(\"tiddler\",listObject.title);\n\t\t\te.setAttribute(\"tag\",columnTemplate.tag);\n\t\t},\n\tonChange : function(e)\n\t\t{\n\t\t\tvar tag = this.getAttribute(\"tag\");\n\t\t\tvar tiddler = this.getAttribute(\"tiddler\");\n\t\t\tstore.setTiddlerTag(tiddler,this.checked,tag);\n\t\t}\n};\n\nListView.columnTypes.TiddlerLink = {\n\tcreateHeader: ListView.columnTypes.String.createHeader,\n\tcreateItem: function(place,listObject,field,columnTemplate,col,row)\n\t\t{\n\t\t\tvar v = listObject[field];\n\t\t\tif(v != undefined) {\n\t\t\t\tvar link = createTiddlyLink(place,listObject[columnTemplate.tiddlerLink],false,null);\n\t\t\t\tcreateTiddlyText(link,listObject[field]);\n\t\t\t}\n\t\t}\n};\n\n//--\n//-- Augmented methods for the JavaScript Number(), Array(), String() and Date() objects\n//--\n\n// Clamp a number to a range\nNumber.prototype.clamp = function(min,max)\n{\n\tvar c = this;\n\tif(c < min)\n\t\tc = min;\n\tif(c > max)\n\t\tc = max;\n\treturn c;\n};\n\n// Add indexOf function if browser does not support it\nif(!Array.indexOf) {\nArray.prototype.indexOf = function(item,from)\n{\n\tif(!from)\n\t\tfrom = 0;\n\tfor(var i=from; i<this.length; i++) {\n\t\tif(this[i] === item)\n\t\t\treturn i;\n\t}\n\treturn -1;\n};}\n\n// Find an entry in a given field of the members of an array\nArray.prototype.findByField = function(field,value)\n{\n\tfor(var t=0; t<this.length; t++) {\n\t\tif(this[t][field] == value)\n\t\t\treturn t;\n\t}\n\treturn null;\n};\n\n// Return whether an entry exists in an array\nArray.prototype.contains = function(item)\n{\n\treturn this.indexOf(item) != -1;\n};\n\n// Adds, removes or toggles a particular value within an array\n//  value - value to add\n//  mode - +1 to add value, -1 to remove value, 0 to toggle it\nArray.prototype.setItem = function(value,mode)\n{\n\tvar p = this.indexOf(value);\n\tif(mode == 0)\n\t\tmode = (p == -1) ? +1 : -1;\n\tif(mode == +1) {\n\t\tif(p == -1)\n\t\t\tthis.push(value);\n\t} else if(mode == -1) {\n\t\tif(p != -1)\n\t\t\tthis.splice(p,1);\n\t}\n};\n\n// Return whether one of a list of values exists in an array\nArray.prototype.containsAny = function(items)\n{\n\tfor(var i=0; i<items.length; i++) {\n\t\tif (this.indexOf(items[i]) != -1)\n\t\t\treturn true;\n\t}\n\treturn false;\n};\n\n// Return whether all of a list of values exists in an array\nArray.prototype.containsAll = function(items)\n{\n\tfor (var i = 0; i<items.length; i++) {\n\t\tif (this.indexOf(items[i]) == -1)\n\t\t\treturn false;\n\t}\n\treturn true;\n};\n\n// Push a new value into an array only if it is not already present in the array. If the optional unique parameter is false, it reverts to a normal push\nArray.prototype.pushUnique = function(item,unique)\n{\n\tif(unique === false) {\n\t\tthis.push(item);\n\t} else {\n\t\tif(this.indexOf(item) == -1)\n\t\t\tthis.push(item);\n\t}\n};\n\nArray.prototype.remove = function(item)\n{\n\tvar p = this.indexOf(item);\n\tif(p != -1)\n\t\tthis.splice(p,1);\n};\n\n// Get characters from the right end of a string\nString.prototype.right = function(n)\n{\n\treturn n < this.length ? this.slice(this.length-n) : this;\n};\n\n// Trim whitespace from both ends of a string\nString.prototype.trim = function()\n{\n\treturn this.replace(/^\\s*|\\s*$/g,\"\");\n};\n\n// Convert a string from a CSS style property name to a JavaScript style name (\"background-color\" -> \"backgroundColor\")\nString.prototype.unDash = function()\n{\n\tvar s = this.split(\"-\");\n\tif(s.length > 1) {\n\t\tfor(var t=1; t<s.length; t++)\n\t\t\ts[t] = s[t].substr(0,1).toUpperCase() + s[t].substr(1);\n\t}\n\treturn s.join(\"\");\n};\n\n// Substitute substrings from an array into a format string that includes '%1'-type specifiers\nString.prototype.format = function(substrings)\n{\n\tvar subRegExp = /(?:%(\\d+))/mg;\n\tvar currPos = 0;\n\tvar r = [];\n\tdo {\n\t\tvar match = subRegExp.exec(this);\n\t\tif(match && match[1]) {\n\t\t\tif(match.index > currPos)\n\t\t\t\tr.push(this.substring(currPos,match.index));\n\t\t\tr.push(substrings[parseInt(match[1])]);\n\t\t\tcurrPos = subRegExp.lastIndex;\n\t\t}\n\t} while(match);\n\tif(currPos < this.length)\n\t\tr.push(this.substring(currPos,this.length));\n\treturn r.join(\"\");\n};\n\n// Escape any special RegExp characters with that character preceded by a backslash\nString.prototype.escapeRegExp = function()\n{\n\tvar s = \"\\\\^$*+?()=!|,{}[].\";\n\tvar c = this;\n\tfor(var t=0; t<s.length; t++)\n\t\tc = c.replace(new RegExp(\"\\\\\" + s.substr(t,1),\"g\"),\"\\\\\" + s.substr(t,1));\n\treturn c;\n};\n\n// Convert \"\\\" to \"\\s\", newlines to \"\\n\" (and remove carriage returns)\nString.prototype.escapeLineBreaks = function()\n{\n\treturn this.replace(/\\\\/mg,\"\\\\s\").replace(/\\n/mg,\"\\\\n\").replace(/\\r/mg,\"\");\n};\n\n// Convert \"\\n\" to newlines, \"\\b\" to \" \", \"\\s\" to \"\\\" (and remove carriage returns)\nString.prototype.unescapeLineBreaks = function()\n{\n\treturn this.replace(/\\\\n/mg,\"\\n\").replace(/\\\\b/mg,\" \").replace(/\\\\s/mg,\"\\\\\").replace(/\\r/mg,\"\");\n};\n\n// Convert & to \"&amp;\", < to \"&lt;\", > to \"&gt;\" and \" to \"&quot;\"\nString.prototype.htmlEncode = function()\n{\n\treturn this.replace(/&/mg,\"&amp;\").replace(/</mg,\"&lt;\").replace(/>/mg,\"&gt;\").replace(/\\\"/mg,\"&quot;\");\n};\n\n// Convert \"&amp;\" to &, \"&lt;\" to <, \"&gt;\" to > and \"&quot;\" to \"\nString.prototype.htmlDecode = function()\n{\n\treturn this.replace(/&lt;/mg,\"<\").replace(/&gt;/mg,\">\").replace(/&quot;/mg,\"\\\"\").replace(/&amp;/mg,\"&\");\n};\n\n// Convert a string to it's JSON representation by encoding control characters, double quotes and backslash. See json.org\nString.prototype.toJSONString = function()\n{\n\tvar m = {\n\t\t'\\b': '\\\\b',\n\t\t'\\f': '\\\\f',\n\t\t'\\n': '\\\\n',\n\t\t'\\r': '\\\\r',\n\t\t'\\t': '\\\\t',\n\t\t'\"' : '\\\\\"',\n\t\t'\\\\': '\\\\\\\\'\n\t\t};\n\tvar replaceFn = function(a,b) {\n\t\tvar c = m[b];\n\t\tif(c)\n\t\t\treturn c;\n\t\tc = b.charCodeAt();\n\t\treturn '\\\\u00' + Math.floor(c / 16).toString(16) + (c % 16).toString(16);\n\t\t};\n\tif(/[\"\\\\\\x00-\\x1f]/.test(this))\n\t\treturn '\"' + this.replace(/([\\x00-\\x1f\\\\\"])/g,replaceFn) + '\"';\n\treturn '\"' + this + '\"';\n};\n\n// Parse a space-separated string of name:value parameters\n// The result is an array of objects:\n//   result[0] = object with a member for each parameter name, value of that member being an array of values\n//   result[1..n] = one object for each parameter, with 'name' and 'value' members\nString.prototype.parseParams = function(defaultName,defaultValue,allowEval,noNames,cascadeDefaults)\n{\n\tvar parseToken = function(match,p) {\n\t\tvar n;\n\t\tif(match[p]) // Double quoted\n\t\t\tn = match[p];\n\t\telse if(match[p+1]) // Single quoted\n\t\t\tn = match[p+1];\n\t\telse if(match[p+2]) // Double-square-bracket quoted\n\t\t\tn = match[p+2];\n\t\telse if(match[p+3]) // Double-brace quoted\n\t\t\ttry {\n\t\t\t\tn = match[p+3];\n\t\t\t\tif(allowEval)\n\t\t\t\t\tn = window.eval(n);\n\t\t\t} catch(ex) {\n\t\t\t\tthrow \"Unable to evaluate {{\" + match[p+3] + \"}}: \" + exceptionText(ex);\n\t\t\t}\n\t\telse if(match[p+4]) // Unquoted\n\t\t\tn = match[p+4];\n\t\telse if(match[p+5]) // empty quote\n\t\t\tn = \"\";\n\t\treturn n;\n\t};\n\tvar r = [{}];\n\tvar dblQuote = \"(?:\\\"((?:(?:\\\\\\\\\\\")|[^\\\"])+)\\\")\";\n\tvar sngQuote = \"(?:'((?:(?:\\\\\\\\\\')|[^'])+)')\";\n\tvar dblSquare = \"(?:\\\\[\\\\[((?:\\\\s|\\\\S)*?)\\\\]\\\\])\";\n\tvar dblBrace = \"(?:\\\\{\\\\{((?:\\\\s|\\\\S)*?)\\\\}\\\\})\";\n\tvar unQuoted = noNames ? \"([^\\\"'\\\\s]\\\\S*)\" : \"([^\\\"':\\\\s][^\\\\s:]*)\";\n\tvar emptyQuote = \"((?:\\\"\\\")|(?:''))\";\n\tvar skipSpace = \"(?:\\\\s*)\";\n\tvar token = \"(?:\" + dblQuote + \"|\" + sngQuote + \"|\" + dblSquare + \"|\" + dblBrace + \"|\" + unQuoted + \"|\" + emptyQuote + \")\";\n\tvar re = noNames ? new RegExp(token,\"mg\") : new RegExp(skipSpace + token + skipSpace + \"(?:(\\\\:)\" + skipSpace + token + \")?\",\"mg\");\n\tvar params = [];\n\tdo {\n\t\tvar match = re.exec(this);\n\t\tif(match) {\n\t\t\tvar n = parseToken(match,1);\n\t\t\tif(noNames) {\n\t\t\t\tr.push({name:\"\",value:n});\n\t\t\t} else {\n\t\t\t\tvar v = parseToken(match,8);\n\t\t\t\tif(v == null && defaultName) {\n\t\t\t\t\tv = n;\n\t\t\t\t\tn = defaultName;\n\t\t\t\t} else if(v == null && defaultValue) {\n\t\t\t\t\tv = defaultValue;\n\t\t\t\t}\n\t\t\t\tr.push({name:n,value:v});\n\t\t\t\tif(cascadeDefaults) {\n\t\t\t\t\tdefaultName = n;\n\t\t\t\t\tdefaultValue = v;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t} while(match);\n\t// Summarise parameters into first element\n\tfor(var t=1; t<r.length; t++) {\n\t\tif(r[0][r[t].name])\n\t\t\tr[0][r[t].name].push(r[t].value);\n\t\telse\n\t\t\tr[0][r[t].name] = [r[t].value];\n\t}\n\treturn r;\n};\n\n// Process a string list of macro parameters into an array. Parameters can be quoted with \"\", '',\n// [[]], {{ }} or left unquoted (and therefore space-separated). Double-braces {{}} results in\n// an *evaluated* parameter: e.g. {{config.options.txtUserName}} results in the current user's name.\nString.prototype.readMacroParams = function()\n{\n\tvar p = this.parseParams(\"list\",null,true,true);\n\tvar n = [];\n\tfor(var t=1; t<p.length; t++)\n\t\tn.push(p[t].value);\n\treturn n;\n};\n\n// Process a string list of unique tiddler names into an array. Tiddler names that have spaces in them must be [[bracketed]]\nString.prototype.readBracketedList = function(unique)\n{\n\tvar p = this.parseParams(\"list\",null,false,true);\n\tvar n = [];\n\tfor(var t=1; t<p.length; t++)\n\t\tn.pushUnique(p[t].value,unique);\n\treturn n;\n};\n\n// Returns array with start and end index of chunk between given start and end marker, or undefined.\nString.prototype.getChunkRange = function(start,end) \n{\n\tvar s = this.indexOf(start);\n\tif(s != -1) {\n\t\ts += start.length;\n\t\tvar e = this.indexOf(end,s);\n\t\tif(e != -1)\n\t\t\treturn [s,e];\n\t}\n};\n\n// Replace a chunk of a string given start and end markers\nString.prototype.replaceChunk = function(start,end,sub)\n{\n\tvar r = this.getChunkRange(start,end);\n\treturn r ? this.substring(0,r[0]) + sub + this.substring(r[1]) : this;\n};\n\n// Returns a chunk of a string between start and end markers, or undefined\nString.prototype.getChunk = function(start,end)\n{\n\tvar r = this.getChunkRange(start,end);\n\tif(r)\n\t\treturn this.substring(r[0],r[1]);\n};\n\n\n// Static method to bracket a string with double square brackets if it contains a space\nString.encodeTiddlyLink = function(title)\n{\n\treturn title.indexOf(\" \") == -1 ? title : \"[[\" + title + \"]]\";\n};\n\n// Static method to encodeTiddlyLink for every item in an array and join them with spaces\nString.encodeTiddlyLinkList = function(list)\n{\n\tif(list) {\n\t\tvar results = [];\n\t\tfor(var t=0; t<list.length; t++)\n\t\t\tresults.push(String.encodeTiddlyLink(list[t]));\n\t\treturn results.join(\" \");\n\t} else {\n\t\treturn \"\";\n\t}\n};\n\n// Convert a string as a sequence of name:\"value\" pairs into a hashmap\nString.prototype.decodeHashMap = function()\n{\n\tvar fields = this.parseParams(\"anon\",\"\",false);\n\tvar r = {};\n\tfor(var t=1; t<fields.length; t++)\n\t\tr[fields[t].name] = fields[t].value;\n\treturn r;\n};\n\n// Static method to encode a hashmap into a name:\"value\"... string\nString.encodeHashMap = function(hashmap)\n{\n\tvar r = [];\n\tfor(var t in hashmap)\n\t\tr.push(t + ':\"' + hashmap[t] + '\"');\n\treturn r.join(\" \");\n};\n\n// Static method to left-pad a string with 0s to a certain width\nString.zeroPad = function(n,d)\n{\n\tvar s = n.toString();\n\tif(s.length < d)\n\t\ts = \"000000000000000000000000000\".substr(0,d-s.length) + s;\n\treturn s;\n};\n\nString.prototype.startsWith = function(prefix) \n{\n\treturn !prefix || this.substring(0,prefix.length) == prefix;\n};\n\n// Returns the first value of the given named parameter.\nfunction getParam(params,name,defaultValue)\n{\n\tif(!params)\n\t\treturn defaultValue;\n\tvar p = params[0][name];\n\treturn p ? p[0] : defaultValue;\n}\n\n// Returns the first value of the given boolean named parameter.\nfunction getFlag(params,name,defaultValue)\n{\n\treturn !!getParam(params,name,defaultValue);\n}\n\n// Substitute date components into a string\nDate.prototype.formatString = function(template)\n{\n\tvar t = template.replace(/0hh12/g,String.zeroPad(this.getHours12(),2));\n\tt = t.replace(/hh12/g,this.getHours12());\n\tt = t.replace(/0hh/g,String.zeroPad(this.getHours(),2));\n\tt = t.replace(/hh/g,this.getHours());\n\tt = t.replace(/mmm/g,config.messages.dates.shortMonths[this.getMonth()]);\n\tt = t.replace(/0mm/g,String.zeroPad(this.getMinutes(),2));\n\tt = t.replace(/mm/g,this.getMinutes());\n\tt = t.replace(/0ss/g,String.zeroPad(this.getSeconds(),2));\n\tt = t.replace(/ss/g,this.getSeconds());\n\tt = t.replace(/[ap]m/g,this.getAmPm().toLowerCase());\n\tt = t.replace(/[AP]M/g,this.getAmPm().toUpperCase());\n\tt = t.replace(/wYYYY/g,this.getYearForWeekNo());\n\tt = t.replace(/wYY/g,String.zeroPad(this.getYearForWeekNo()-2000,2));\n\tt = t.replace(/YYYY/g,this.getFullYear());\n\tt = t.replace(/YY/g,String.zeroPad(this.getFullYear()-2000,2));\n\tt = t.replace(/MMM/g,config.messages.dates.months[this.getMonth()]);\n\tt = t.replace(/0MM/g,String.zeroPad(this.getMonth()+1,2));\n\tt = t.replace(/MM/g,this.getMonth()+1);\n\tt = t.replace(/0WW/g,String.zeroPad(this.getWeek(),2));\n\tt = t.replace(/WW/g,this.getWeek());\n\tt = t.replace(/DDD/g,config.messages.dates.days[this.getDay()]);\n\tt = t.replace(/ddd/g,config.messages.dates.shortDays[this.getDay()]);\n\tt = t.replace(/0DD/g,String.zeroPad(this.getDate(),2));\n\tt = t.replace(/DDth/g,this.getDate()+this.daySuffix());\n\tt = t.replace(/DD/g,this.getDate());\n\treturn t;\n};\n\nDate.prototype.getWeek = function()\n{\n\tvar dt = new Date(this.getTime());\n\tvar d = dt.getDay();\n\tif (d==0) d=7;// JavaScript Sun=0, ISO Sun=7\n\tdt.setTime(dt.getTime()+(4-d)*86400000);// shift day to Thurs of same week to calculate weekNo\n\tvar n = Math.floor((dt.getTime()-new Date(dt.getFullYear(),0,1)+3600000)/86400000); \n\treturn Math.floor(n/7)+1;\n};\n\nDate.prototype.getYearForWeekNo = function()\n{\n\tvar dt = new Date(this.getTime());\n\tvar d = dt.getDay();\n\tif (d==0) d=7;// JavaScript Sun=0, ISO Sun=7\n\tdt.setTime(dt.getTime()+(4-d)*86400000);// shift day to Thurs of same week\n\treturn dt.getFullYear();\n};\n\nDate.prototype.getHours12 = function()\n{\n\tvar h = this.getHours();\n\treturn h > 12 ? h-12 : ( h > 0 ? h : 12 );\n};\n\nDate.prototype.getAmPm = function()\n{\n\treturn this.getHours() >= 12 ? config.messages.dates.pm : config.messages.dates.am;\n};\n\nDate.prototype.daySuffix = function()\n{\n\treturn config.messages.dates.daySuffixes[this.getDate()-1];\n};\n\n// Convert a date to local YYYYMMDDHHMM string format\nDate.prototype.convertToLocalYYYYMMDDHHMM = function()\n{\n\treturn String.zeroPad(this.getFullYear(),4) + String.zeroPad(this.getMonth()+1,2) + String.zeroPad(this.getDate(),2) + String.zeroPad(this.getHours(),2) + String.zeroPad(this.getMinutes(),2);\n};\n\n// Convert a date to UTC YYYYMMDDHHMM string format\nDate.prototype.convertToYYYYMMDDHHMM = function()\n{\n\treturn String.zeroPad(this.getUTCFullYear(),4) + String.zeroPad(this.getUTCMonth()+1,2) + String.zeroPad(this.getUTCDate(),2) + String.zeroPad(this.getUTCHours(),2) + String.zeroPad(this.getUTCMinutes(),2);\n};\n\n// Convert a date to UTC YYYYMMDD.HHMMSSMMM string format\nDate.prototype.convertToYYYYMMDDHHMMSSMMM = function()\n{\n\treturn String.zeroPad(this.getUTCFullYear(),4) + String.zeroPad(this.getUTCMonth()+1,2) + String.zeroPad(this.getUTCDate(),2) + \".\" + String.zeroPad(this.getUTCHours(),2) + String.zeroPad(this.getUTCMinutes(),2) + String.zeroPad(this.getUTCSeconds(),2) + String.zeroPad(this.getUTCMilliseconds(),4);\n};\n\n// Static method to create a date from a UTC YYYYMMDDHHMM format string\nDate.convertFromYYYYMMDDHHMM = function(d)\n{\n\treturn new Date(Date.UTC(parseInt(d.substr(0,4),10),\n\t\t\tparseInt(d.substr(4,2),10)-1,\n\t\t\tparseInt(d.substr(6,2),10),\n\t\t\tparseInt(d.substr(8,2),10),\n\t\t\tparseInt(d.substr(10,2),10),0,0));\n};\n\n//--\n//-- Crypto functions and associated conversion routines\n//--\n\n// Crypto \"namespace\"\nfunction Crypto() {}\n\n// Convert a string to an array of big-endian 32-bit words\nCrypto.strToBe32s = function(str)\n{\n\tvar be = Array();\n\tvar len = Math.floor(str.length/4);\n\tvar i, j;\n\tfor(i=0, j=0; i<len; i++, j+=4) {\n\t\tbe[i] = ((str.charCodeAt(j)&0xff) << 24)|((str.charCodeAt(j+1)&0xff) << 16)|((str.charCodeAt(j+2)&0xff) << 8)|(str.charCodeAt(j+3)&0xff);\n\t}\n\twhile (j<str.length) {\n\t\tbe[j>>2] |= (str.charCodeAt(j)&0xff)<<(24-(j*8)%32);\n\t\tj++;\n\t}\n\treturn be;\n};\n\n// Convert an array of big-endian 32-bit words to a string\nCrypto.be32sToStr = function(be)\n{\n\tvar str = \"\";\n\tfor(var i=0;i<be.length*32;i+=8)\n\t\tstr += String.fromCharCode((be[i>>5]>>>(24-i%32)) & 0xff);\n\treturn str;\n};\n\n// Convert an array of big-endian 32-bit words to a hex string\nCrypto.be32sToHex = function(be)\n{\n\tvar hex = \"0123456789ABCDEF\";\n\tvar str = \"\";\n\tfor(var i=0;i<be.length*4;i++)\n\t\tstr += hex.charAt((be[i>>2]>>((3-i%4)*8+4))&0xF) + hex.charAt((be[i>>2]>>((3-i%4)*8))&0xF);\n\treturn str;\n};\n\n// Return, in hex, the SHA-1 hash of a string\nCrypto.hexSha1Str = function(str)\n{\n\treturn Crypto.be32sToHex(Crypto.sha1Str(str));\n};\n\n// Return the SHA-1 hash of a string\nCrypto.sha1Str = function(str)\n{\n\treturn Crypto.sha1(Crypto.strToBe32s(str),str.length);\n};\n\n// Calculate the SHA-1 hash of an array of blen bytes of big-endian 32-bit words\nCrypto.sha1 = function(x,blen)\n{\n\t// Add 32-bit integers, wrapping at 32 bits\n\tadd32 = function(a,b)\n\t{\n\t\tvar lsw = (a&0xFFFF)+(b&0xFFFF);\n\t\tvar msw = (a>>16)+(b>>16)+(lsw>>16);\n\t\treturn (msw<<16)|(lsw&0xFFFF);\n\t};\n\t// Add five 32-bit integers, wrapping at 32 bits\n\tadd32x5 = function(a,b,c,d,e)\n\t{\n\t\tvar lsw = (a&0xFFFF)+(b&0xFFFF)+(c&0xFFFF)+(d&0xFFFF)+(e&0xFFFF);\n\t\tvar msw = (a>>16)+(b>>16)+(c>>16)+(d>>16)+(e>>16)+(lsw>>16);\n\t\treturn (msw<<16)|(lsw&0xFFFF);\n\t};\n\t// Bitwise rotate left a 32-bit integer by 1 bit\n\trol32 = function(n)\n\t{\n\t\treturn (n>>>31)|(n<<1);\n\t};\n\n\tvar len = blen*8;\n\t// Append padding so length in bits is 448 mod 512\n\tx[len>>5] |= 0x80 << (24-len%32);\n\t// Append length\n\tx[((len+64>>9)<<4)+15] = len;\n\tvar w = Array(80);\n\n\tvar k1 = 0x5A827999;\n\tvar k2 = 0x6ED9EBA1;\n\tvar k3 = 0x8F1BBCDC;\n\tvar k4 = 0xCA62C1D6;\n\n\tvar h0 = 0x67452301;\n\tvar h1 = 0xEFCDAB89;\n\tvar h2 = 0x98BADCFE;\n\tvar h3 = 0x10325476;\n\tvar h4 = 0xC3D2E1F0;\n\n\tfor(var i=0;i<x.length;i+=16) {\n\t\tvar j,t;\n\t\tvar a = h0;\n\t\tvar b = h1;\n\t\tvar c = h2;\n\t\tvar d = h3;\n\t\tvar e = h4;\n\t\tfor(j = 0;j<16;j++) {\n\t\t\tw[j] = x[i+j];\n\t\t\tt = add32x5(e,(a>>>27)|(a<<5),d^(b&(c^d)),w[j],k1);\n\t\t\te=d; d=c; c=(b>>>2)|(b<<30); b=a; a = t;\n\t\t}\n\t\tfor(j=16;j<20;j++) {\n\t\t\tw[j] = rol32(w[j-3]^w[j-8]^w[j-14]^w[j-16]);\n\t\t\tt = add32x5(e,(a>>>27)|(a<<5),d^(b&(c^d)),w[j],k1);\n\t\t\te=d; d=c; c=(b>>>2)|(b<<30); b=a; a = t;\n\t\t}\n\t\tfor(j=20;j<40;j++) {\n\t\t\tw[j] = rol32(w[j-3]^w[j-8]^w[j-14]^w[j-16]);\n\t\t\tt = add32x5(e,(a>>>27)|(a<<5),b^c^d,w[j],k2);\n\t\t\te=d; d=c; c=(b>>>2)|(b<<30); b=a; a = t;\n\t\t}\n\t\tfor(j=40;j<60;j++) {\n\t\t\tw[j] = rol32(w[j-3]^w[j-8]^w[j-14]^w[j-16]);\n\t\t\tt = add32x5(e,(a>>>27)|(a<<5),(b&c)|(d&(b|c)),w[j],k3);\n\t\t\te=d; d=c; c=(b>>>2)|(b<<30); b=a; a = t;\n\t\t}\n\t\tfor(j=60;j<80;j++) {\n\t\t\tw[j] = rol32(w[j-3]^w[j-8]^w[j-14]^w[j-16]);\n\t\t\tt = add32x5(e,(a>>>27)|(a<<5),b^c^d,w[j],k4);\n\t\t\te=d; d=c; c=(b>>>2)|(b<<30); b=a; a = t;\n\t\t}\n\n\t\th0 = add32(h0,a);\n\t\th1 = add32(h1,b);\n\t\th2 = add32(h2,c);\n\t\th3 = add32(h3,d);\n\t\th4 = add32(h4,e);\n\t}\n\treturn Array(h0,h1,h2,h3,h4);\n};\n\n//--\n//-- RGB colour object\n//--\n\n// Construct an RGB colour object from a '#rrggbb', '#rgb' or 'rgb(n,n,n)' string or from separate r,g,b values\nfunction RGB(r,g,b)\n{\n\tthis.r = 0;\n\tthis.g = 0;\n\tthis.b = 0;\n\tif(typeof r == \"string\") {\n\t\tif(r.substr(0,1) == \"#\") {\n\t\t\tif(r.length == 7) {\n\t\t\t\tthis.r = parseInt(r.substr(1,2),16)/255;\n\t\t\t\tthis.g = parseInt(r.substr(3,2),16)/255;\n\t\t\t\tthis.b = parseInt(r.substr(5,2),16)/255;\n\t\t\t} else {\n\t\t\t\tthis.r = parseInt(r.substr(1,1),16)/15;\n\t\t\t\tthis.g = parseInt(r.substr(2,1),16)/15;\n\t\t\t\tthis.b = parseInt(r.substr(3,1),16)/15;\n\t\t\t}\n\t\t} else {\n\t\t\tvar rgbPattern = /rgb\\s*\\(\\s*(\\d{1,3})\\s*,\\s*(\\d{1,3})\\s*,\\s*(\\d{1,3})\\s*\\)/;\n\t\t\tvar c = r.match(rgbPattern);\n\t\t\tif(c) {\n\t\t\t\tthis.r = parseInt(c[1],10)/255;\n\t\t\t\tthis.g = parseInt(c[2],10)/255;\n\t\t\t\tthis.b = parseInt(c[3],10)/255;\n\t\t\t}\n\t\t}\n\t} else {\n\t\tthis.r = r;\n\t\tthis.g = g;\n\t\tthis.b = b;\n\t}\n\treturn this;\n}\n\n// Mixes this colour with another in a specified proportion\n// c = other colour to mix\n// f = 0..1 where 0 is this colour and 1 is the new colour\n// Returns an RGB object\nRGB.prototype.mix = function(c,f)\n{\n\treturn new RGB(this.r + (c.r-this.r) * f,this.g + (c.g-this.g) * f,this.b + (c.b-this.b) * f);\n};\n\n// Return an rgb colour as a #rrggbb format hex string\nRGB.prototype.toString = function()\n{\n\treturn \"#\" + (\"0\" + Math.floor(this.r.clamp(0,1) * 255).toString(16)).right(2) +\n\t\t\t\t (\"0\" + Math.floor(this.g.clamp(0,1) * 255).toString(16)).right(2) +\n\t\t\t\t (\"0\" + Math.floor(this.b.clamp(0,1) * 255).toString(16)).right(2);\n};\n\n//--\n//-- DOM utilities - many derived from www.quirksmode.org\n//--\n\nfunction drawGradient(place,horiz,colours)\n{\n\tfor(var t=0; t<= 100; t+=2) {\n\t\tvar bar = document.createElement(\"div\");\n\t\tplace.appendChild(bar);\n\t\tbar.style.position = \"absolute\";\n\t\tbar.style.left = horiz ? t + \"%\" : 0;\n\t\tbar.style.top = horiz ? 0 : t + \"%\";\n\t\tbar.style.width = horiz ? (101-t) + \"%\" : \"100%\";\n\t\tbar.style.height = horiz ? \"100%\" : (101-t) + \"%\";\n\t\tbar.style.zIndex = -1;\n\t\tvar f = t/100;\n\t\tvar p = f*(colours.length-1);\n\t\tbar.style.backgroundColor = colours[Math.floor(p)].mix(colours[Math.ceil(p)],p-Math.floor(p)).toString();\n\t}\n}\n\nfunction createTiddlyText(theParent,theText)\n{\n\treturn theParent.appendChild(document.createTextNode(theText));\n}\n\nfunction createTiddlyCheckbox(theParent,caption,checked,onChange)\n{\n\tvar cb = document.createElement(\"input\");\n\tcb.setAttribute(\"type\",\"checkbox\");\n\tcb.onclick = onChange;\n\ttheParent.appendChild(cb);\n\tcb.checked = checked;\n\tcb.className = \"chkOptionInput\";\n\tif(caption)\n\t\twikify(caption,theParent);\n\treturn cb;\n}\n\nfunction createTiddlyElement(theParent,theElement,theID,theClass,theText)\n{\n\tvar e = document.createElement(theElement);\n\tif(theClass != null)\n\t\te.className = theClass;\n\tif(theID != null)\n\t\te.setAttribute(\"id\",theID);\n\tif(theText != null)\n\t\te.appendChild(document.createTextNode(theText));\n\tif(theParent != null)\n\t\ttheParent.appendChild(e);\n\treturn e;\n}\n\nfunction addEvent(obj,type,fn)\n{\n\tif(obj.attachEvent) {\n\t\tobj['e'+type+fn] = fn;\n\t\tobj[type+fn] = function(){obj['e'+type+fn](window.event);};\n\t\tobj.attachEvent('on'+type,obj[type+fn]);\n\t} else {\n\t\tobj.addEventListener(type,fn,false);\n\t}\n}\n\nfunction removeEvent(obj,type,fn)\n{\n\tif(obj.detachEvent) {\n\t\tobj.detachEvent('on'+type,obj[type+fn]);\n\t\tobj[type+fn] = null;\n\t} else {\n\t\tobj.removeEventListener(type,fn,false);\n\t}\n}\n\nfunction addClass(e,theClass)\n{\n\tvar currClass = e.className.split(\" \");\n\tif(currClass.indexOf(theClass) == -1)\n\t\te.className += \" \" + theClass;\n}\n\nfunction removeClass(e,theClass)\n{\n\tvar currClass = e.className.split(\" \");\n\tvar i = currClass.indexOf(theClass);\n\twhile(i != -1) {\n\t\tcurrClass.splice(i,1);\n\t\ti = currClass.indexOf(theClass);\n\t}\n\te.className = currClass.join(\" \");\n}\n\nfunction hasClass(e,theClass)\n{\n\tif(e.className) {\n\t\tif(e.className.split(\" \").indexOf(theClass) != -1)\n\t\t\treturn true;\n\t}\n\treturn false;\n}\n\n// Find the closest relative with a given property value (property defaults to tagName, relative defaults to parentNode)\nfunction findRelated(e,value,name,relative)\n{\n\tname = name ? name : \"tagName\";\n\trelative = relative ? relative : \"parentNode\";\n\tif(name == \"className\") {\n\t\twhile(e && !hasClass(e,value)) {\n\t\t\te = e[relative];\n\t\t}\n\t} else {\n\t\twhile(e && e[name] != value) {\n\t\t\te = e[relative];\n\t\t}\n\t}\n\treturn e;\n}\n\n// Resolve the target object of an event\nfunction resolveTarget(e)\n{\n\tvar obj;\n\tif(e.target)\n\t\tobj = e.target;\n\telse if(e.srcElement)\n\t\tobj = e.srcElement;\n\tif(obj.nodeType == 3) // defeat Safari bug\n\t\tobj = obj.parentNode;\n\treturn obj;\n}\n\n// Return the content of an element as plain text with no formatting\nfunction getPlainText(e)\n{\n\tvar text = \"\";\n\tif(e.innerText)\n\t\ttext = e.innerText;\n\telse if(e.textContent)\n\t\ttext = e.textContent;\n\treturn text;\n}\n\n// Get the scroll position for window.scrollTo necessary to scroll a given element into view\nfunction ensureVisible(e)\n{\n\tvar posTop = findPosY(e);\n\tvar posBot = posTop + e.offsetHeight;\n\tvar winTop = findScrollY();\n\tvar winHeight = findWindowHeight();\n\tvar winBot = winTop + winHeight;\n\tif(posTop < winTop) {\n\t\treturn posTop;\n\t} else if(posBot > winBot) {\n\t\tif(e.offsetHeight < winHeight)\n\t\t\treturn posTop - (winHeight - e.offsetHeight);\n\t\telse\n\t\t\treturn posTop;\n\t} else {\n\t\treturn winTop;\n\t}\n}\n\n// Get the current width of the display window\nfunction findWindowWidth()\n{\n\treturn window.innerWidth ? window.innerWidth : document.documentElement.clientWidth;\n}\n\n// Get the current height of the display window\nfunction findWindowHeight()\n{\n\treturn window.innerHeight ? window.innerHeight : document.documentElement.clientHeight;\n}\n\n// Get the current horizontal page scroll position\nfunction findScrollX()\n{\n\treturn window.scrollX ? window.scrollX : document.documentElement.scrollLeft;\n}\n\n// Get the current vertical page scroll position\nfunction findScrollY()\n{\n\treturn window.scrollY ? window.scrollY : document.documentElement.scrollTop;\n}\n\nfunction findPosX(obj)\n{\n\tvar curleft = 0;\n\twhile(obj.offsetParent) {\n\t\tcurleft += obj.offsetLeft;\n\t\tobj = obj.offsetParent;\n\t}\n\treturn curleft;\n}\n\nfunction findPosY(obj)\n{\n\tvar curtop = 0;\n\twhile(obj.offsetParent) {\n\t\tcurtop += obj.offsetTop;\n\t\tobj = obj.offsetParent;\n\t}\n\treturn curtop;\n}\n\n// Blur a particular element\nfunction blurElement(e)\n{\n\tif(e != null && e.focus && e.blur) {\n\t\te.focus();\n\t\te.blur();\n\t}\n}\n\n// Create a non-breaking space\nfunction insertSpacer(place)\n{\n\tvar e = document.createTextNode(String.fromCharCode(160));\n\tif(place)\n\t\tplace.appendChild(e);\n\treturn e;\n}\n\n// Remove all children of a node\nfunction removeChildren(e)\n{\n\twhile(e && e.hasChildNodes())\n\t\tremoveNode(e.firstChild);\n}\n\n// Remove a node and all it's children\nfunction removeNode(e)\n{\n\tscrubNode(e);\n\te.parentNode.removeChild(e);\n}\n\n// Remove any event handlers or non-primitve custom attributes\nfunction scrubNode(e)\n{\n\tvar att = e.attributes;\n\tif(att) {\n\t\tfor(var t=0; t<att.length; t++) {\n\t\t\tvar n = att[t].name;\n\t\t\tif(n !== 'style' && (typeof e[n] === 'function' || (typeof e[n] === 'object' && e[n] != null))) {\n\t\t\t\ttry {\n\t\t\t\t\te[n] = null;\n\t\t\t\t} catch(ex) {\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\tvar c = e.firstChild;\n\twhile(c) {\n\t\tscrubNode(c);\n\t\tc = c.nextSibling;\n\t}\n}\n\n// Add a stylesheet, replacing any previous custom stylesheet\nfunction setStylesheet(s,id,doc)\n{\n\tif(!id)\n\t\tid = \"customStyleSheet\";\n\tif(!doc)\n\t\tdoc = document;\n\tvar n = doc.getElementById(id);\n\tif(doc.createStyleSheet) {\n\t\t// Test for IE's non-standard createStyleSheet method\n\t\tif(n)\n\t\t\tn.parentNode.removeChild(n);\n\t\t// This failed without the &nbsp;\n\t\tdoc.getElementsByTagName(\"head\")[0].insertAdjacentHTML(\"beforeEnd\",\"&nbsp;<style id='\" + id + \"'>\" + s + \"</style>\");\n\t} else {\n\t\tif(n) {\n\t\t\tn.replaceChild(doc.createTextNode(s),n.firstChild);\n\t\t} else {\n\t\t\tn = doc.createElement(\"style\");\n\t\t\tn.type = \"text/css\";\n\t\t\tn.id = id;\n\t\t\tn.appendChild(doc.createTextNode(s));\n\t\t\tdoc.getElementsByTagName(\"head\")[0].appendChild(n);\n\t\t}\n\t}\n}\n\n// Force the browser to do a document reflow when needed to workaround browser bugs\nfunction forceReflow()\n{\n\tif(config.browser.isGecko) {\n\t\tsetStylesheet(\"body {top:-1em;margin-top:1em;}\");\n\t\tsetStylesheet(\"\");\n\t}\n}\n\n// Replace the current selection of a textarea or text input and scroll it into view\nfunction replaceSelection(e,text)\n{\n\tif(e.setSelectionRange) {\n\t\tvar oldpos = e.selectionStart;\n\t\tvar isRange = e.selectionEnd > e.selectionStart;\n\t\te.value = e.value.substr(0,e.selectionStart) + text + e.value.substr(e.selectionEnd);\n\t\te.setSelectionRange(isRange ? oldpos : oldpos + text.length,oldpos + text.length);\n\t\tvar linecount = e.value.split('\\n').length;\n\t\tvar thisline = e.value.substr(0,e.selectionStart).split('\\n').length-1;\n\t\te.scrollTop = Math.floor((thisline - e.rows / 2) * e.scrollHeight / linecount);\n\t} else if(document.selection) {\n\t\tvar range = document.selection.createRange();\n\t\tif(range.parentElement() == e) {\n\t\t\tvar isCollapsed = range.text == \"\";\n\t\t\trange.text = text;\n\t\t\tif(!isCollapsed) {\n\t\t\t\trange.moveStart('character', -text.length);\n\t\t\t\trange.select();\n\t\t\t}\n\t\t}\n\t}\n}\n\n// Returns the text of the given (text) node, possibly merging subsequent text nodes\nfunction getNodeText(e)\n{\n\tvar t = \"\"; \n\twhile(e && e.nodeName == \"#text\") {\n\t\tt += e.nodeValue;\n\t\te = e.nextSibling;\n\t}\n\treturn t;\n}\n\n//--\n//-- LoaderBase and SaverBase\n//--\n\nfunction LoaderBase() {}\n\nLoaderBase.prototype.loadTiddler = function(store,node,tiddlers)\n{\n\tvar title = this.getTitle(store,node);\n\tif(title) {\n\t\tvar tiddler = store.createTiddler(title);\n\t\tthis.internalizeTiddler(store,tiddler,title,node);\n\t\ttiddlers.push(tiddler);\n\t}\n};\n\nLoaderBase.prototype.loadTiddlers = function(store,nodes)\n{\n\tvar tiddlers = [];\n\tfor(var t = 0; t < nodes.length; t++) {\n\t\ttry {\n\t\t\tthis.loadTiddler(store,nodes[t],tiddlers);\n\t\t} catch(ex) {\n\t\t\tshowException(ex,config.messages.tiddlerLoadError.format([this.getTitle(store,nodes[t])]));\n\t\t}\n\t}\n\treturn tiddlers;\n};\n\nfunction SaverBase() {}\n\nSaverBase.prototype.externalize = function(store)\n{\n\tvar results = [];\n\tvar tiddlers = store.getTiddlers(\"title\");\n\tfor(var t = 0; t < tiddlers.length; t++)\n\t\tresults.push(this.externalizeTiddler(store,tiddlers[t]));\n\treturn results.join(\"\\n\");\n};\n\n//--\n//-- TW21Loader (inherits from LoaderBase)\n//--\n\nfunction TW21Loader() {}\n\nTW21Loader.prototype = new LoaderBase();\n\nTW21Loader.prototype.getTitle = function(store,node)\n{\n\tvar title = null;\n\tif(node.getAttribute) {\n\t\ttitle = node.getAttribute(\"title\");\n\t\tif(!title)\n\t\t\ttitle = node.getAttribute(\"tiddler\");\n\t}\n\tif(!title && node.id) {\n\t\tvar lenPrefix = store.idPrefix.length;\n\t\tif (node.id.substr(0,lenPrefix) == store.idPrefix)\n\t\t\ttitle = node.id.substr(lenPrefix);\n\t}\n\treturn title;\n};\n\nTW21Loader.prototype.internalizeTiddler = function(store,tiddler,title,node)\n{\n\tvar e = node.firstChild;\n\tvar text = null;\n\tif(node.getAttribute(\"tiddler\")) {\n\t\ttext = getNodeText(e).unescapeLineBreaks();\n\t} else {\n\t\twhile(e.nodeName!=\"PRE\" && e.nodeName!=\"pre\") {\n\t\t\te = e.nextSibling;\n\t\t}\n\t\ttext = e.innerHTML.replace(/\\r/mg,\"\").htmlDecode();\n\t}\n\tvar modifier = node.getAttribute(\"modifier\");\n\tvar c = node.getAttribute(\"created\");\n\tvar m = node.getAttribute(\"modified\");\n\tvar created = c ? Date.convertFromYYYYMMDDHHMM(c) : version.date;\n\tvar modified = m ? Date.convertFromYYYYMMDDHHMM(m) : created;\n\tvar tags = node.getAttribute(\"tags\");\n\tvar fields = {};\n\tvar attrs = node.attributes;\n\tfor(var i = attrs.length-1; i >= 0; i--) {\n\t\tvar name = attrs[i].name;\n\t\tif (attrs[i].specified && !TiddlyWiki.isStandardField(name)) {\n\t\t\tfields[name] = attrs[i].value.unescapeLineBreaks();\n\t\t}\n\t}\n\ttiddler.assign(title,text,modifier,modified,tags,created,fields);\n\treturn tiddler;\n};\n\n//--\n//-- TW21Saver (inherits from SaverBase)\n//--\n\nfunction TW21Saver() {}\n\nTW21Saver.prototype = new SaverBase();\n\nTW21Saver.prototype.externalizeTiddler = function(store,tiddler)\n{\n\ttry {\n\t\tvar extendedAttributes = \"\";\n\t\tvar usePre = config.options.chkUsePreForStorage;\n\t\tstore.forEachField(tiddler,\n\t\t\tfunction(tiddler,fieldName,value) {\n\t\t\t\t// don't store stuff from the temp namespace\n\t\t\t\tif(typeof value != \"string\")\n\t\t\t\t\tvalue = \"\";\n\t\t\t\tif (!fieldName.match(/^temp\\./))\n\t\t\t\t\textendedAttributes += ' %0=\"%1\"'.format([fieldName,value.escapeLineBreaks().htmlEncode()]);\n\t\t\t},true);\n\t\tvar created = tiddler.created.convertToYYYYMMDDHHMM();\n\t\tvar modified = tiddler.modified.convertToYYYYMMDDHHMM();\n\t\tvar vdate = version.date.convertToYYYYMMDDHHMM();\n\t\tvar attributes = tiddler.modifier ? ' modifier=\"' + tiddler.modifier.htmlEncode() + '\"' : \"\";\n\t\tattributes += (usePre && modified == created) ? \"\" : ' modified=\"' + modified +'\"';\n\t\tattributes += (usePre && created == vdate) ? \"\" :' created=\"' + created + '\"';\n\t\tvar tags = tiddler.getTags();\n\t\tif(!usePre || tags)\n\t\t\tattributes += ' tags=\"' + tags.htmlEncode() + '\"';\n\t\treturn ('<div %0=\"%1\"%2%3>%4</'+'div>').format([\n\t\t\t\tusePre ? \"title\" : \"tiddler\",\n\t\t\t\ttiddler.title.htmlEncode(),\n\t\t\t\tattributes,\n\t\t\t\textendedAttributes,\n\t\t\t\tusePre ? \"\\n<pre>\" + tiddler.text.htmlEncode() + \"</pre>\\n\" : tiddler.text.escapeLineBreaks().htmlEncode()\n\t\t\t]);\n\t} catch (ex) {\n\t\tthrow exceptionText(ex,config.messages.tiddlerSaveError.format([tiddler.title]));\n\t}\n};\n\n//--\n//-- Deprecated code\n//--\n\n// @Deprecated: Use createElementAndWikify and this.termRegExp instead\nconfig.formatterHelpers.charFormatHelper = function(w)\n{\n\tw.subWikify(createTiddlyElement(w.output,this.element),this.terminator);\n};\n\n// @Deprecated: Use enclosedTextHelper and this.lookaheadRegExp instead\nconfig.formatterHelpers.monospacedByLineHelper = function(w)\n{\n\tvar lookaheadRegExp = new RegExp(this.lookahead,\"mg\");\n\tlookaheadRegExp.lastIndex = w.matchStart;\n\tvar lookaheadMatch = lookaheadRegExp.exec(w.source);\n\tif(lookaheadMatch && lookaheadMatch.index == w.matchStart) {\n\t\tvar text = lookaheadMatch[1];\n\t\tif(config.browser.isIE)\n\t\t\ttext = text.replace(/\\n/g,\"\\r\");\n\t\tcreateTiddlyElement(w.output,\"pre\",null,null,text);\n\t\tw.nextMatch = lookaheadRegExp.lastIndex;\n\t}\n};\n\n// @Deprecated: Use <br> or <br /> instead of <<br>>\nconfig.macros.br.handler = function(place)\n{\n\tcreateTiddlyElement(place,\"br\");\n};\n\n// Find an entry in an array. Returns the array index or null\n// @Deprecated: Use indexOf instead\nArray.prototype.find = function(item)\n{\n\tvar i = this.indexOf(item);\n\treturn i == -1 ? null : i;\n};\n\n// Load a tiddler from an HTML DIV. The caller should make sure to later call Tiddler.changed()\n// @Deprecated: Use store.getLoader().internalizeTiddler instead\nTiddler.prototype.loadFromDiv = function(divRef,title)\n{\n\treturn store.getLoader().internalizeTiddler(store,this,title,divRef);\n};\n\n// Format the text for storage in an HTML DIV\n// @Deprecated Use store.getSaver().externalizeTiddler instead.\nTiddler.prototype.saveToDiv = function()\n{\n\treturn store.getSaver().externalizeTiddler(store,this);\n};\n\n// @Deprecated: Use store.allTiddlersAsHtml() instead\nfunction allTiddlersAsHtml()\n{\n\treturn store.allTiddlersAsHtml();\n}\n\n// @Deprecated: Use refreshPageTemplate instead\nfunction applyPageTemplate(title)\n{\n\trefreshPageTemplate(title);\n}\n\n// @Deprecated: Use story.displayTiddlers instead\nfunction displayTiddlers(srcElement,titles,template,unused1,unused2,animate,unused3)\n{\n\tstory.displayTiddlers(srcElement,titles,template,animate);\n}\n\n// @Deprecated: Use story.displayTiddler instead\nfunction displayTiddler(srcElement,title,template,unused1,unused2,animate,unused3)\n{\n\tstory.displayTiddler(srcElement,title,template,animate);\n}\n\n// @Deprecated: Use functions on right hand side directly instead\nvar createTiddlerPopup = Popup.create;\nvar scrollToTiddlerPopup = Popup.show;\nvar hideTiddlerPopup = Popup.remove;\n\n// @Deprecated: Use right hand side directly instead\nvar regexpBackSlashEn = new RegExp(\"\\\\\\\\n\",\"mg\");\nvar regexpBackSlash = new RegExp(\"\\\\\\\\\",\"mg\");\nvar regexpBackSlashEss = new RegExp(\"\\\\\\\\s\",\"mg\");\nvar regexpNewLine = new RegExp(\"\\n\",\"mg\");\nvar regexpCarriageReturn = new RegExp(\"\\r\",\"mg\");\n//--\n//-- End of scripts\n//--\n//]]>\n</script>\n<script type=\"text/javascript\">\n//<![CDATA[\nif(useJavaSaver)\n\tdocument.write(\"<applet style='position:absolute;left:-1px' name='TiddlySaver' code='TiddlySaver.class' archive='TiddlySaver.jar' width='1' height='1'></applet>\");\n//]]>\n</script>\n<!--POST-SCRIPT-START-->\n\n<!--POST-SCRIPT-END-->\n</body>\n</html>", "encoding": "utf-8"}