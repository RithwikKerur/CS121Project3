{"url": "https://www.ics.uci.edu/~pattis/ICS-46/lectures/notes/mergesortexternal.txt", "content": "\t\t\tExternal Merge Sort\r\n\r\n\r\nIn this lecture we will continue our examination of algorithms that use more\r\nspace than is available in main memory. We will analyze them with respect to\r\nhow often they move blocks of data between main and external memory (discussed\r\nin the previous lecture). Typically the cost of such memory transfers dominates\r\nthe cost of executing code on the block while it is in memory. That is, a\r\ntransfer between main and external memory might take 10 milliseconds, while\r\nprocessing the data in the block might take microseconds (a few 1/1000ths of a\r\nmillisecond). A processor executing 10^9 instructions per second can process\r\n10^7 (10 million) instructions in 10 ms. So, we can virtually ignore the time\r\ntaken to process each block retrieved from memory.\r\n\r\n\r\n------------------------------------------------------------------------------\r\n\r\nSorting:\r\n\r\nOur external sorting algorithm is a variant of Merge Sort, which can be run\r\nefficiently in terms of external storage use. We will characterize it as\r\nfollows. We will assume the array of T is stored on external memory.\r\n\r\n  template<class T>\r\n  void external_merge_sort(int low, int high) {\r\n    if (high-low < memory_size)\r\n      read_into_memory_sort_write_back(low,high);\r\n    else {\r\n      int mid = (low + high)/2;\r\n\r\n      external_merge_sort(low, mid);\r\n      external_merge_sort(mid+1, high);\r\n\r\n      external_merge(low, mid, mid+1,high);\r\n    }\r\n  }\r\n\r\nTo sort an array that fits in memory (high-low < memory_size) we bring it into\r\nmain memory from from external memory, sort it, and then write it back onto\r\nexternal memory. This operation would take just two large memory transfers and\r\nrunning some fast sorting code. If we were sorting trillions of values in a\r\nmachine whose memory stored billions of values, sorting billions of values\r\ncould take as much time (or more) than transferring the billions.\r\n\r\nTo sort an array that is too big to fit in memory, we recursively sort its first\r\nand second halves, and then use a special external_merge method to merge these.\r\n\r\nMerging is an operation that operates on input and output data linearly,\r\nprocessing values in order, and processing each value only once. Such\r\nprocessing is tailor-made for transfering blocks into main memory, processing\r\nthem, and then transfering the result blocks back to external memory.\r\nSchematically we can represent this process as follows.\r\n\r\n\r\n            Main memory         |       External memory\r\n                                |\r\n    \t   \t  +-+-+...-+-+  |  +-+-+...-+-+  +-+-+...-+-+  +-+-+...-+-+\r\n\t\t  | | |... | |  |  | | |... | |  | | |... | |  | | |... | | ... \r\n\t\t  +-+-+...-+-+  |  +-+-+...-+-+  +-+-+...-+-+  +-+-+...-+-+\r\n+-+-+...+-+-+     input 1 block |  input 1 external blocks\r\n| | |   | | |                   |\r\n+-+-+...+-+-+                   |\r\noutput block                    |\r\n    \t   \t  +-+-+...-+-+  |  +-+-+...-+-+  +-+-+...-+-+  +-+-+...-+-+\r\n\t\t  | | |... | |  |  | | |... | |  | | |... | |  | | |... | | ... \r\n\t\t  +-+-+...-+-+  |  +-+-+...-+-+  +-+-+...-+-+  +-+-+...-+-+\r\n\t\t  input 2 block |  input 2 external blocks\r\n                                |\r\n                                |\r\n\t\t      \t   \t|  +-+-+...-+-+  +-+-+...-+-+  +-+-+...-+-+\r\n\t\t\t\t|  | | |... | |  | | |... | |  | | |... | | ... \r\n\t\t  \t\t|  +-+-+...-+-+  +-+-+...-+-+  +-+-+...-+-+\r\n\t\t\t\t|  output external blocks (twice as many)\r\n\r\nWhen merging starts, the values in each input's external blocks have been\r\nsorted. When merging ends, the output external blocks contain the merge of both\r\ninput's external blocks (sorted)\r\n\r\nMain memory is partitioned into 3 large blocks. Initially we tranfer the first\r\ninput 1 external block and input 2 external block into main memory. The merging\r\nalgorithm process data in these input blocks sequentially, writing information\r\ninto an output block (also in main memory). Main memory operations doing the\r\nmerging continue, but...\r\n\r\n  1) When the output block is filled, it is transferred to external memory\r\n     (and reset to empty)\r\n\r\n  2) When an input block is fully processed (all its values are in an output\r\n     block) it next input external block is transferred to main memory from\r\n     external memory.\r\n\r\nEvery value will participate in exactly 2 block transfers: one to read it into\r\nmain memory and one to write it out to external memory again. So if the inputs\r\nare each N blocks, the output will be 2N blocks: there are  2N block transfers\r\ninto main memory and 2N block transfers back to external memory, for a total\r\nof 4N block transfers.\r\n\r\nHere is an example where the block size if just 4.\r\n\r\n\r\n                +--+--+--+--+  |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n\t\t|  |  |  |  |  |  |12|24|26|34|  |37|49|50|57|  |62|64|70|72|\r\n                +--+--+--+--+  |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n                input 1 block  |  input 1 external blocks\r\n+--+--+--+--+                  |\r\n|  |  |  |  |                  |\r\n+--+--+--+--+                  |\r\noutput block                   |\r\n                +--+--+--+--+  |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n\t\t|  |  |  |  |  |  | 4|25|35|40|  |43|44|53|56|  |58|60|62|90|\r\n                +--+--+--+--+  |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n                input 2 block  |  input 2 external blocks\r\n                               |\r\n                \t       |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n\t\t\t       |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  \r\n                \t       |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n                \t       |  output external blocks\r\n\r\nSo, to start the first two input blocks are transferred into memory.\r\n\r\n                +--+--+--+--+  |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n\t\t|12|24|26|34|  |  |12|24|26|34|  |37|49|50|57|  |62|64|70|72|\r\n                +--+--+--+--+  |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n                input 1 block  |  input 1 external blocks\r\n+--+--+--+--+                  |\r\n|  |  |  |  |                  |\r\n+--+--+--+--+                  |\r\noutput block                   |\r\n                +--+--+--+--+  |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n\t\t| 4|25|35|40|  |  | 4|25|35|40|  |43|44|53|56|  |58|60|62|90|\r\n                +--+--+--+--+  |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n                input 2 block  |  input 2 external blocks\r\n                               |\r\n                \t       |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n\t\t\t       |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  \r\n                \t       |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n                \t       |  output external blocks\r\n\r\nThen we start merging these input blocks. Eventually the output block is filled.\r\nHere I have replaced each value transferred from input block to output block by\r\na blank, just to make the state of the merging clearer.\r\n\r\n                +--+--+--+--+  |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n\t\t|  |  |26|34|  |  |12|24|26|34|  |37|49|50|57|  |62|64|70|72|\r\n                +--+--+--+--+  |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n                input 1 block  |  input 1 external blocks\r\n+--+--+--+--+                  |\r\n| 4|12|24|25|                  |\r\n+--+--+--+--+                  |\r\noutput block                   |\r\n                +--+--+--+--+  |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n\t\t|  |  |35|40|  |  | 4|25|35|40|  |43|44|53|56|  |58|60|62|90|\r\n                +--+--+--+--+  |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n                input 2 block  |  input 2 external blocks\r\n                               |\r\n                \t       |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n\t\t\t       |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  \r\n                \t       |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n                \t       |  output external blocks\r\n\r\nSo we transfer it to the first output external block and clear it.\r\n\r\n                +--+--+--+--+  |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n\t\t|  |  |26|34|  |  |12|24|26|34|  |37|49|50|57|  |62|64|70|72|\r\n                +--+--+--+--+  |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n                input 1 block  |  input 1 external blocks\r\n+--+--+--+--+                  |\r\n|  |  |  |  |                  |\r\n+--+--+--+--+                  |\r\noutput block                   |\r\n                +--+--+--+--+  |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n\t\t|  |  |35|40|  |  | 4|25|35|40|  |43|44|53|56|  |58|60|62|90|\r\n                +--+--+--+--+  |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n                input 2 block  |  input 2 external blocks\r\n                               |\r\n                \t       |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n\t\t\t       |  | 4|12|24|25|  |  |  |  |  |  |  |  |  |  |  \r\n                \t       |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n                \t       |  output external blocks\r\n\r\nThen we continue merging these input blocks. Eventually one input block is\r\nfully processed.\r\n\r\n                +--+--+--+--+  |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n\t\t|  |  |  |  |  |  |12|24|26|34|  |37|49|50|57|  |62|64|70|72|\r\n                +--+--+--+--+  |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n                input 1 block  |  input 1 external blocks\r\n+--+--+--+--+                  |\r\n|26|34|  |  |                  |\r\n+--+--+--+--+                  |\r\noutput block                   |\r\n                +--+--+--+--+  |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n\t\t|  |  |35|40|  |  | 4|25|35|40|  |43|44|53|56|  |58|60|62|90|\r\n                +--+--+--+--+  |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n                input 2 block  |  input 2 external blocks\r\n                               |\r\n                \t       |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n\t\t\t       |  | 4|12|24|25|  |  |  |  |  |  |  |  |  |  |  \r\n                \t       |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n                \t       |  output external blocks\r\n\r\nSo we transfer the second external block from input 1 into the input 1 block.\r\n\r\n                +--+--+--+--+  |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n\t\t|37|49|50|57|  |  |12|24|26|34|  |37|49|50|57|  |62|64|70|72|\r\n                +--+--+--+--+  |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n                input 1 block  |  input 1 external blocks\r\n+--+--+--+--+                  |\r\n|26|34|  |  |                  |\r\n+--+--+--+--+                  |\r\noutput block                   |\r\n                +--+--+--+--+  |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n\t\t|  |  |35|40|  |  | 4|25|35|40|  |43|44|53|56|  |58|60|62|90|\r\n                +--+--+--+--+  |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n                input 2 block  |  input 2 external blocks\r\n                               |\r\n                \t       |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n\t\t\t       |  | 4|12|24|25|  |  |  |  |  |  |  |  |  |  |  \r\n                \t       |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n                \t       |  output external blocks\r\n\r\nThen we continue merging these input blocks. Eventually the output block is\r\nfilled.\r\n                +--+--+--+--+  |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n\t\t|  |49|50|57|  |  |12|24|26|34|  |37|49|50|57|  |62|64|70|72|\r\n                +--+--+--+--+  |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n                input 1 block  |  input 1 external blocks\r\n+--+--+--+--+                  |\r\n|26|34|35|37|                  |\r\n+--+--+--+--+                  |\r\noutput block                   |\r\n                +--+--+--+--+  |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n\t\t|  |  |  |40|  |  | 4|25|35|40|  |43|44|53|56|  |58|60|62|90|\r\n                +--+--+--+--+  |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n                input 2 block  |  input 2 external blocks\r\n                               |\r\n                \t       |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n\t\t\t       |  | 4|12|24|25|  |  |  |  |  |  |  |  |  |  |  \r\n                \t       |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n                \t       |  output external blocks\r\n\r\nSo we transfer it to the second output external block and clear it.\r\n\r\n                +--+--+--+--+  |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n\t\t|  |49|50|57|  |  |12|24|26|34|  |37|49|50|57|  |62|64|70|72|\r\n                +--+--+--+--+  |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n                input 1 block  |  input 1 external blocks\r\n+--+--+--+--+                  |\r\n|  |  |  |  |                  |\r\n+--+--+--+--+                  |\r\noutput block                   |\r\n                +--+--+--+--+  |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n\t\t|  |  |  |40|  |  | 4|25|35|40|  |43|44|53|56|  |58|60|62|90|\r\n                +--+--+--+--+  |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n                input 2 block  |  input 2 external blocks\r\n                               |\r\n                \t       |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n\t\t\t       |  | 4|12|24|25|  |26|34|35|37|  |  |  |  |  |  \r\n                \t       |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n                \t       |  output external blocks\r\n\r\nThen we continue merging these input blocks. Eventually one input block is\r\nfully processed.\r\n\r\n                +--+--+--+--+  |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n\t\t|  |49|50|57|  |  |12|24|26|34|  |37|49|50|57|  |62|64|70|72|\r\n                +--+--+--+--+  |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n                input 1 block  |  input 1 external blocks\r\n+--+--+--+--+                  |\r\n|40|  |  |  |                  |\r\n+--+--+--+--+                  |\r\noutput block                   |\r\n                +--+--+--+--+  |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n\t\t|  |  |  |  |  |  | 4|25|35|40|  |43|44|53|56|  |58|60|62|90|\r\n                +--+--+--+--+  |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n                input 2 block  |  input 2 external blocks\r\n                               |\r\n                \t       |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n\t\t\t       |  | 4|12|24|25|  |26|34|35|37|  |  |  |  |  |  \r\n                \t       |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n                \t       |  output external blocks\r\n\r\n\r\nSo we transfer the second external block from input 2 into the input 2 block.\r\n\r\n                +--+--+--+--+  |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n\t\t|  |49|50|57|  |  |12|24|26|34|  |37|49|50|57|  |62|64|70|72|\r\n                +--+--+--+--+  |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n                input 1 block  |  input 1 external blocks\r\n+--+--+--+--+                  |\r\n|40|  |  |  |                  |\r\n+--+--+--+--+                  |\r\noutput block                   |\r\n                +--+--+--+--+  |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n\t\t|43|44|53|56|  |  | 4|25|35|40|  |43|44|53|56|  |58|60|62|90|\r\n                +--+--+--+--+  |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n                input 2 block  |  input 2 external blocks\r\n                               |\r\n                \t       |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n\t\t\t       |  | 4|12|24|25|  |26|34|35|37|  |  |  |  |  |  \r\n                \t       |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n                \t       |  output external blocks\r\n\r\nThen we continue merging these input blocks. Eventually the output block is\r\nfilled.\r\n\r\n                +--+--+--+--+  |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n\t\t|  |  |50|57|  |  |12|24|26|34|  |37|49|50|57|  |62|64|70|72|\r\n                +--+--+--+--+  |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n                input 1 block  |  input 1 external blocks\r\n+--+--+--+--+                  |\r\n|40|43|44|49|                  |\r\n+--+--+--+--+                  |\r\noutput block                   |\r\n                +--+--+--+--+  |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n\t\t|  |  |53|56|  |  | 4|25|35|40|  |43|44|53|56|  |58|60|62|90|\r\n                +--+--+--+--+  |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n                input 2 block  |  input 2 external blocks\r\n                               |\r\n                \t       |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n\t\t\t       |  | 4|12|24|25|  |26|34|35|37|  |  |  |  |  |  \r\n                \t       |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n                \t       |  output external blocks\r\n\r\nSo we transfer it to the third output external block and clear it.\r\n\r\n                +--+--+--+--+  |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n\t\t|  |  |50|57|  |  |12|24|26|34|  |37|49|50|57|  |62|64|70|72|\r\n                +--+--+--+--+  |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n                input 1 block  |  input 1 external blocks\r\n+--+--+--+--+                  |\r\n|  |  |  |  |                  |\r\n+--+--+--+--+                  |\r\noutput block                   |\r\n                +--+--+--+--+  |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n\t\t|  |  |53|56|  |  | 4|25|35|40|  |43|44|53|56|  |58|60|62|90|\r\n                +--+--+--+--+  |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n                input 2 block  |  input 2 external blocks\r\n                               |\r\n                \t       |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n\t\t\t       |  | 4|12|24|25|  |26|34|35|37|  |40|43|44|49|  \r\n                \t       |  +--+--+--+--+  +--+--+--+--+  +--+--+--+--+\r\n                \t       |  output external blocks\r\n\r\n\r\nThis process continues until all input external block have been transferred to\r\nmain memory and processed, and all output blocks have been transfered to\r\nexternal memory.\r\n\r\nIf needed, the output blocks can be transferred into memory sequentially and\r\nthen transferred back to overwrite the input external blocks (similar to how\r\nmerging overwrites the array it processes). Doing so would up the number of\r\nblock transfers from 4N to 6N.\r\n", "encoding": "ascii"}