{"url": "https://www.ics.uci.edu/~mayur/model-net-details.html", "content": "<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" \"DTD/xhtml1-transitional.dtd\">\r\n<html lang=\"en\">\r\n<head>\r\n\r\n<title>Notes on Modelnet</title>\r\n\r\n<!-- BEGIN META TAG INFO -->\r\n<meta http-equiv=\"Content-Type\" content=\"text/html; charset=iso-8859-1\">\r\n<meta name=\"author\" content=\"Mayur Deshpande\">\r\n<link rel=\"index\" href=\"http://www.ics.uci.edu/~mayur/index.html\">\r\n<link rel=\"stylesheet\" type=\"text/css\" href=\"css/fonts.css\" media=\"screen\">\r\n<link rel=\"stylesheet\" type=\"text/css\" href=\"css/print.css\" media=\"print\">\r\n<link rel=\"shortcut icon\" type=\"image/x-icon\" href=\"./images/favicon.ico\">\r\n<link rel=\"stylesheet\" type=\"text/css\" href=\"css/3col.css\" title=\"style\">\r\n<style type=\"text/css\" media=\"all\"></style>\r\n\r\n<!-- END META TAG INFO -->\r\n</head>\r\n\r\n\r\n<body>\r\n\r\n<div id=\"banner\">\r\n<h4>\r\nSome answers on Modelnet &nbsp;\r\n</h4>\r\n</div>\r\n\r\n\r\n<div id=\"leftcontent\">\r\n<h1>\r\n<a href=\"index.html\"> Home </a>\r\n</h1>\r\n<h1>\r\n<a href=\"Research.html\"> Research </a>\r\n</h1>\r\n<h1>\r\n<a href=\"Software.html\"> Software </a>\r\n</h1>\r\n<h1>\r\n<a href=\"Publications.html\"> Publications </a>\r\n</h1>\r\n<h1>\r\n<a href=\"Industry.html\"> Industry </a>\r\n</h1>\r\n<h1>\r\n<a href=\"Mayur_Resume.pdf\"> Resume </a>\r\n</h1>\r\n<h1>\r\n<a href=\"http://flashback.calit2.uci.edu\"> Flashback! </a>\r\n</h1>\r\n</div>\r\n\r\n\r\n<div id=\"centercontent\">\r\n<h2>:: Introduction</h2>\r\n<p>\r\nThis writeup is intended more as a reminder to myself of what I learnt when setting up Modelnet.\r\nI had never worked with a emulator such as this before, so I had many questions going into it.\r\nThis document is written form the point of view of what questions I would have like to have had\r\nanswered without doing too much RTFM :-) For the definitive page on Modelnet, please visit the\r\n<a href=\"http://issg.cs.duke.edu/modelnet.html\">Modelnet home page</a>.\r\n<p>\r\n\r\n<h2>:: What is Modelnet? </h2>\r\n<p>\r\nModelnet is software that lets you get a feel (or numbers)\r\nfor what would happen if you deployed your next killer-app distributed application (like say, BitTorrent)\r\nover the Internet. What this means is that you can deploy hundreds of instances of the application over\r\nnodes that behave as if they were distributed all over the world. Modelnet will then emulate,\r\nactual packet delays/losses/throughput of packets flowing between the different instances of the app.\r\nThis is quite invaluable if you are testing Peer-to-Peer applications and want to get some\r\nhard numbers.\r\n<p>\r\n\r\n<h2>:: So, how does it work? </h2>\r\n<p>\r\nOK. Here is the whole works.\r\n<br>\r\n<p align=\"center\">.<img border=\"1\" src=\"modelnet-succint.png\" width=\"400\" height=\"300\"><p>\r\n\r\nLooks a bit complicated but the system can be easily broken down and explained in parts. There are two\r\ndifferent types of physical nodes (read PCs) that Modelnet uses: (1) Emulator nodes (that run FreeBSD)\r\nand (2) nodes that run the application processes (Linux nodes). The Emulator node emulates what happens\r\nto packets as they traverse the Internet. Virtual nodes are run on the Linux machines.\r\n\r\nThe concept of a virtual node is a bit `abstract' and is achieved through clever use of\r\n(a)IP-aliasing, (b) Route-setup and a (c) Custom library that intercepts IP packets. We'll look into\r\neach in some more detail and then tie them together. But, first, here is how to run an application\r\non a particular virtual node: \"SRCIP=10.0.x.x LD_PRELOAD=/usr/lib/libipaddr.so [application] [application_params]\".\r\nOnce we get through the details, it'll be more obvious why this command is so.\r\n<br>\r\n</p>\r\n\r\n<h3>IP-Aliasing </h3>\r\n<p>\r\nWhen you install Modelnet on a machine, it sets up\r\n<a href=\"http://www.faqs.org/docs/Linux-mini/IP-Alias.html\">IP-aliases</a> corresponding to the number\r\nof virtual nodes that the physical host will emulate. All the ip-addresses are from the \"10.0.x.x\" domain.\r\nFor example, if a physical host will emulate 2 virtual nodes, expect to see something like\r\nthe following in your /sbin/ifonfig output: \"eth:0:0 inet addr:10.0.0.1\", \"eth:0:1 inet addr:10.0.0.2\" (assuming\r\nyour NIC card is setup as eth0).\r\n</p>\r\n\r\n<h3>Route Setup</h3>\r\n<p>\r\nModelnet also sets up the routing table in each physical host so that all packets (in the 10.0.x.x domain)\r\nare routed to the  emulator node. This is important so that packets from two virtual nodes that are on the\r\nsame physical machine still flow through the emulator and not the loopback interface. Read the\r\n<a href=\"http://issg.cs.duke.edu/modelnet/modelnet.html\"> Modelnet documentation </a> for more details\r\non this. If you have the patience, work out the exact route for two virtual nodes on the same physical node,\r\nusing the route information on a host; it is quite fascinating. These two references\r\n<a href=\"http://www.comptechdoc.org/os/linux/usersguide/linux_ugrouting.html\"> (1) </a> and\r\n<a href=\"http://www.eventhelix.com/RealtimeMantra/Networking/ip_routing.htm\"> (2) </a> on subnetting\r\nand routing might be of aid.\r\n</p>\r\n\r\n<h3>Custom Library</h3>\r\n<p>\r\nModelnet also installs a custom library on the physical host (libipaddr.so). When the command line is invoked\r\nappropriately, all IP packets are handled by this library. The way to specify the library is to prefix\r\nthe following in the command line: \"LD_PRELOAD=/usr/lib/libipaddr.so\" (Btw, the library may get installed in a\r\ndifferent place on your system, say /lib/libipaddr.so, figure that out first). In the prefix of the command line,\r\nwe also add \"SRCIP=10.0.x.x\" (substitute with the actual virtual node IP-address). This is so that the custom\r\nlibrary can write the appropriate host-ip address in each packet (for example, if SRCIP is specified as 10.0.0.1,\r\nthen all outgoing packets will have src-ip as 10.0.0.1).\r\n</p>\r\n\r\n<h3>WTF is LD_PRELOAD?</h3>\r\n<p>\r\nLD_PRELOAD is a way of achieving\r\n<a href=\"http://developers.sun.com/solaris/articles/lib_interposers.html\"> \"library interpositioning\"</a>, a\r\ncool system hack used for achieving, among other things, debugging and performance analysis.\r\nBasically, any system call can be intercepted and custom code can  be run in that call. For example, one\r\ncan write a custom library that prints 'hello world' whenever a packet is sent out; annoying but possible.\r\n</p>\r\n\r\n<h3>Putting it together</h3>\r\n<p>\r\nTo run an executable on a particular virtual node, we therefore prefix the following before the executable name:\r\n\"SRCIP=10.0.x.x LD_PRELOAD=/usr/lib/libipaddr.so\". This tell the custom library to rewrite the IP packets with\r\nthe SRCIP ip address. The packet is then sent out as normal to the destination. If the destination is another\r\nvirtual node, then the packet is sent to the emulator (default gateway for all 10.0.x.x packets). The routes in\r\nthe emulator are so set up, that the packet is then routed to the physical host that has the destination\r\nvirtual-ip. If an application is listening to packets on the remote virtual node, it gets the packets. Further,\r\nif the remote app want to send back a reply, it reverses the src and destination ip addresses. The reverse path\r\nis then followed and the local virtual node get the packet. Inside the emulator appropriate delays and traffic\r\nshaping is done.\r\n<a href=\"http://www.netperf.org/netperf/NetperfPage.html\"> Netperf</a>  is a neat tool that you can use to test\r\nthis out. As the Modelnet tutorial warns you, don't use ping to test connectivity between two virtual nodes. Ping\r\nuses raw sockets and these packets are not intercepted by the Modelnet custom library.\r\n</p>\r\n<br>\r\n\r\n<h2>::What applications can I run on top of Modelenet?</h2>\r\n<p>\r\nModelnet provides a script called vnrunhost that runs a application/executable on a particular virtual node. For some\r\nreason, I found that this raised many questions (before I looked into the script).  Could the application\r\nbe a shell script?, How many paramaters could I pass to the application?, etc. Turns out, that vnrunhost\r\nis a simple wrapper that maps virtual node ids to virtual ips and then calls the usual \"SRCIP= .. LD_PRELOAD=...\".\r\nSo, the short answer is that almost any application can use Modelnet (unless it plays around with Raw sockets or\r\nspecifically binds to a particular local ip-address). Moreover, the presence of Modelnet underneath is totally\r\ntransparent to the application. You can even run `ls' on Modelnet (not that it would be of any\r\nparticular significance).\r\n</p>\r\n\r\n\r\n<h2>:: So, how does the emulator emulate the Internet? </h2>\r\n<p>\r\nFirst, a tool such as\r\n<a href=\"http://topology.eecs.umich.edu/inet/\">Inet</a> is used to generate topology of the routers in the\r\nInternet. Inet cam also spit out `router coordinates' i.e. it places each router in a XY plane and prints\r\nthe cartesian corordinates for each router. Modelnet directly interprets these coordinates, assiging longer\r\nlatencies (in milliseconds) between farther routers. Assigning bandwidth is a different beast. The easiset\r\nsolution is to specify a lower bandwith mark and an upper bandwidth mark. Modelnet will then assign, at random,\r\na bandiwth between these two marks to each end node. Is is assumed that the router backbone can handle all the\r\nend nodes' bandwidths (clearly a simplification but still a reasonable assumption for most experiments). Once\r\nModelnet generates the route and model files, one can also \"hand-code\" different bandwidths for each node.\r\nLastly, Modelnet allows one to specify packet loss rates on each link. Again, a high and low mark can be set and\r\nModelnet will randomly assign packet loss rates within this range to each link.\r\n</p>\r\n\r\n\r\n<h2>:: Troubleshooting</h2>\r\n<p>\r\nAs mentioned, Netperf is a very handy tool to figure out if the bandwidth and latency constraints between\r\ntwo nodes are being emulated correctly. Occasionally, some strange problems crop up. Here are some of the\r\nstranger ones. Might be of use if you see something familiar.\r\n</p>\r\n\r\n<h3>SRCIP not SRC_IP</h3>\r\n<p>\r\nFor some reason, I had switched to writing SRC_IP instead of SRCIP in the prefix on the command line (guess\r\nI was instinctively following my coding guidelines :).\r\nNetperf, applications, everything, stopped working suddenly. Took me a while to see the typo and drove\r\nme insane in the meantime.\r\n</p>\r\n\r\n<h3>IPv6</h3>\r\n<p>\r\nI like to customize my Linux kernels and build them from source. In a particular kernel build, I had enabled\r\nIPv6. For some reason, this interacts very strangely with Modelnet. So, if you are building your own Linux\r\nKernel, disable IPv6.  And don't even ask how I figured this out!\r\n</p>\r\n\r\n\r\n<h2>:: Parting thoughts </h2>\r\n<p>\r\nAs I said before, I had not used a wide area network emulator before. Installing Modelnet and using it\r\nshowed me how some cool hacks have made such a thing possible, and this is without even going into\r\nthe complexity of the emulator code. It is almost magical when you actually run apps on top of it and\r\nsee the whole thing in action. Its like seeing a storm in a bottle or the Internet on a bunch of\r\nlocal-area machines. Years of research (on modelling the Internet topology and such) have made this\r\nemulator possible. If you have any questions feel free to shoot me an email. I'll reply\r\nif I have any answer(s) and maybe add it to this page as well.\r\n</p>\r\n\r\n\r\n</div>\r\n\r\n<div id=\"rightcontent\">\r\n<h2> Links</h2>\r\n<p>\r\n<a href=\"rapid.html\">Rapid</a>\r\n<br>\r\n<a href=\"http://issg.cs.duke.edu/modelnet.html\">Modelnet</a>\r\n<br>\r\n<a href=\"http://topology.eecs.umich.edu/inet/\">Inet</a>\r\n<br>\r\n<a href=\"http://www.faqs.org/docs/Linux-mini/IP-Alias.html\">IP-Aliasing</a>\r\n<br>\r\n<a href=\"http://www.netperf.org/netperf/NetperfPage.html\">  Netperf </a>\r\n</p>\r\n\r\n</div>\r\n\r\n\r\n<script src=\"http://www.google-analytics.com/urchin.js\" type=\"text/javascript\">\r\n</script>\r\n<script type=\"text/javascript\">\r\n_uacct = \"UA-556186-1\";\r\nurchinTracker();\r\n</script>\r\n\r\n\r\n\r\n<!-- START INCLUDED FOOTER -->\r\n<center>\r\n<br>\r\n<br>\r\n<br>\r\n<span class=\"G9G\"><a href=\"http://validator.w3.org/check?uri=referer\" title=\"W3C HTML Validation\" target=\"_blank\">HTML</a> &#8226; <a href=\"http://jigsaw.w3.org/css-validator/check/referer/\" title=\"W3C CSS Validation\" target=\"_blank\">CSS</a> &#8226; <a href=\"http://bobby.watchfire.com/\" title=\"U.S. Section 508 Accessibility\" target=\"_blank\">508</a></span>\r\n\r\n<br>\r\n<!-- END INCLUDED FOOTER -->\r\n</body>\r\n</html>\r\n</center>", "encoding": "ascii"}