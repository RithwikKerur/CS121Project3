{"url": "https://www.ics.uci.edu/~wjohnson/BIDA/Ch12/Ch12Rcode.txt", "content": "# R code for chapter 12  \n\nlibrary(survival)\nlibrary(xlsReadWrite)\nlibrary(R2WinBUGS)\n\n### p(t), S(t), h(t), and hazard ratio for group 1 and group 2\n### FIGURE 12.1\n\n\nxe <- seq(0.00001,20,0.01)\nye <- dgamma(xe,10,2)\nxebar <- seq(0.00001,20,0.01)\nyebar <- dgamma(xe,20,2)\nhe <- ye/(1-pgamma(xe,10,2))\nhebar <- yebar/(1-pgamma(xebar,20,2))\nhr <- he/hebar\n\npar(mfrow=c(2,2))\nplot(xe,ye,type='l',xlab=\"\",ylab=\"\",ylim=c(0,0.32), lwd=2, cex=1.2)\nlines(xebar,yebar,lty=2, lwd=2, cex=1.2)\ntext(5,0.3,\"Group 1\", lwd=2, cex=1.2)\ntext(10,0.22,\"Group 2\", lwd=2, cex=1.2)\nmtext(\"t\",line=3,side=1,cex=1.5)\nmtext(\"f(t)\",line=2.5,side=2,cex=1.5)\n\nplot(xe,1-pgamma(xe,10,2),xlab=\"\",ylab=\"\",type='l',lwd=2, cex=1.5)\nlines(xebar,1-pgamma(xebar,20,2),lty=2,lwd=2, cex=1.2)\ntext(2,0.28,\"Group 1\",lwd=2,cex=1.2)\ntext(16,0.2,\"Group 2\",lwd=2,cex=1.2)\nmtext(\"t\",line=3,side=1,cex=1.5)\nmtext(\"S(t)\",line=2.5,side=2,cex=1.5)\n\nplot(xe,he,xlab=\"\",ylab=\"\",type='l',lwd=2, cex=1.5)\nlines(xebar,hebar,lty=2,lwd=2, cex=1.2)\ntext(3,1,\"Group 1\",lwd=2,cex=1.2)\ntext(15,0.2,\"Group 2\",lwd=2,cex=1.2)\nmtext(\"t\",line=3,side=1,cex=1.5)\nmtext(\"h(t)\",line=2.5,side=2,cex=1.5)\n\nx <- seq(0.5,20,0.01)\nye <- dgamma(x,10,2)\nyebar <- dgamma(x,20,2)\nhe <- ye/(1-pgamma(x,10,2))\nhebar <- yebar/(1-pgamma(x,20,2))\nhr <- he/hebar\n\nplot(x,hr,xlab=\"\",ylab=\"\",type='l',lwd=2, cex=1.5,ylim=c(0,50))\nmtext(\"t\",line=3,side=1,cex=1.5)\nmtext(expression(h[1](t)/h[2](t)),line=2.5,side=2,cex=1.2)\n\n\n\n\n\n### FIGURE 12.2.  HISTOGRAMS OF LEUKEMIA DATA\nn1 <- 17\nn2 <- 16\ny1 <- c(65,156,100,134,16,108,121,4,39,143,56,26,22,1,1,5,65)\ny2 <- c(56,65,17,7,16,22,3,4,2,3,8,4,3,30,4,43)\npar(mfrow=c(2,1))\nhist(y1,main=\"AG Positive\",xlab=\"\",ylab=\"\",xlim=c(0,170),prob=F, ylim=c(0,10))\nmtext(\"Survival time (weeks)\",line=3,side=1,cex=1)\nmtext(\"Count\",line=2.5,side=2,cex=1)\nhist(y2,main=\"AG Negative\",xlab=\"\",ylab=\"\",xlim=c(0,170),prob=F,ylim=c(0,10))\nmtext(\"Survival time (weeks)\",line=3,side=1,cex=1)\nmtext(\"Count\",line=2.5,side=2,cex=1)\n\n\n\n\n\n\n\n### Example 12.2.2\n# Prior on theta1.  Mode=0.02.  95th percentile=0.15\nb1 <- seq(0.001,50,0.01)\na1 <- 0.02*b1+1\ncbind(a1,b1,qgamma(0.95,a1,b1))   #  Look for 0.15.  Answer is [2637,] 1.52722 26.361 1.500113e-01\n\n\n\n# Prior on theta2.  Mode=0.69/20=0.0345.  95th percentile=0.69/5=0.138\nb2 <- seq(0.001,50,0.01)\na2 <- 0.0345*b2+1\ncbind(a2,b2,qgamma(0.95,a2,b2))   #  Look for 0.138.  Answer is [3796,] 2.309310 37.951    0.1380110\n\n\n\n\n### FIGURE 12.3.  \n### Prior and posterior of theta1 and theta2\nn1 <- 17\nn2 <- 16\nt1 <- c(65,156,100,134,16,108,121,4,39,143,56,26,22,1,1,5,65)\nt2 <- c(56,65,17,7,16,22,3,4,2,3,8,4,3,30,4,43)\na1 <- 1.53\nb1 <- 26.4\na2 <- 2.31\nb2 <- 37.95\n\npar(mfrow=c(2,1))\nt <- seq(0,0.15,0.001)\nplot(t,dgamma(t,a1+n1,rate=(b1+sum(t1))),type='l',xlab=\"\",ylab=\"\",main=\"AG Positive\", lwd=3)\nlines(t,dgamma(t,a1,rate=b1),lty=2, lwd=3)\nmtext(expression(theta[1]),line=2.5,side=1,cex=1.5)\n\nplot(t,dgamma(t,a2+n2,rate=(b2+sum(t2))),type='l',xlab=\"\",ylab=\"\",main=\"AG Negative\", lwd=3)\nlines(t,dgamma(t,a2,rate=b2),lty=2, lwd=3)\nmtext(expression(theta[2]),line=2.5,side=1,cex=1.5)\n\n\n\n\n\n\n### EXAMPLE 12.3.3\n### Using R2WinBUGS to fit the 2 parameter exponential model and estimate survival functions\n# Group 1 is AG+\n# Group 2 is AG-\nlibrary(R2WinBUGS)\nn <- c(17,16)\na1 <- 0.0001\nb1 <- 0.0001\na2 <- 0.0001\nb2 <- 0.0001\nt1 <- c(65,156,100,134,16,108,121,4,39,143,56,26,22,1,1,5,65)\nt2 <- c(56,65,17,7,16,22,3,4,2,3,8,4,3,30,4,43)\nleukemiadata <- list(\"n\",\"t1\",\"t2\",\"a1\",\"b1\",\"a2\",\"b2\")\nparameters <- c(\"theta1\",\"theta2\",\"median1\",\"median2\",\"relmedian\",\"S\",\"Sdiff\") \ninits <- list( list(theta1=0.05, theta2=0.02))\n\nleuk.fit <- bugs(leukemiadata, inits, parameters,\"leukemia.txt\", \n                 working.directory = \"H:\\\\MyDocuments\\\\BAYES\\\\SurvivalAnalysis\\\\Code\", \n                 n.chains=1, n.iter=50000, n.thin=1, n.burnin=0)\nround(print(leuk.fit),3)\nattach.bugs(leuk.fit)\n\n\n\n\n\n### Figure 12.4 \npar(mfrow=c(1,2))\n\ntime <- seq(0,170,1)\nplot(time,exp(-theta1[1]*time), type=\"l\", xlab=\"\", ylab=\"\", cex=2, lwd=2)\nmtext(\"t\",line=3,side=1,cex=1.5)\nmtext(expression(S[1](t)),line=2.5,side=2,cex=1.5)\nfor(i in 2:20){\n\tlines(time, exp(-theta1[i]*time), lty=1, cex=2, lwd=2)\n}\n### Plot mean survival curves\ntime <- seq(0,170,1)\nsurvcurves1 <- exp(-theta1%*%t(time))\nsurvmean1 <- apply(survcurves1,2,mean)\nsurvcurves2 <- exp(-theta2%*%t(time))\nsurvmean2 <- apply(survcurves2,2,mean)\nplot(time,survmean1, type=\"l\", xlab=\"\", ylab=\"\", lwd=3)\nlines(time, survmean2, lty=2, lwd=3)\nlegend(\"topright\", c(\"AG Positive\",\"AG Negative\"), lty=1:2, lwd=2, cex=1,bty=\"n\")\nmtext(\"t\",line=3,side=1,cex=1.5)\nmtext(\"S(t)\",line=2.5,side=2,cex=1.5)\n\n\n\n### Figure 12.5.  Plot bands for the survival curves\nsurv1 <- apply(survcurves1,2,quantile,c(0.025,0.50,0.975))\nsurv2 <- apply(survcurves2,2,quantile,c(0.025,0.50,0.975))\nplot(time,surv1[2,], type=\"l\", xlab=\"\", ylab=\"\", lwd=3)\nlines(time, surv1[1,], lty=1, lwd=3)\nlines(time, surv1[3,], lty=1, lwd=3)\nlines(time,surv2[2,],lty=2, lwd=3)\nlines(time, surv2[1,], lty=2, lwd=3)\nlines(time, surv2[3,], lty=2, lwd=3)\nmtext(\"t\",line=3,side=1,cex=1.7,lwd=3)\nmtext(\"S(t)\",line=2.5,side=2,cex=1.7,lwd=3)\n\n\n\n\n\n\n", "encoding": "ascii"}